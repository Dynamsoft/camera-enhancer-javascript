/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2024, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 4.0.1
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */
import{engineResourcePaths as e,workerAutoResources as t,mapPackageRegister as i,_isDSImageData as s,_isDSRect as r,_isRect as n,_isLineSegment as a,_isPolygon as o,_isQuad as h,_isPoint as l,EnumImagePixelFormat as d,CoreModule as c,EnumCapturedResultItemType as f,ImageSourceAdapter as g,EnumImageTagType as u,EnumIntermediateResultUnitType as m,EnumBufferOverflowProtectionMode as w,EnumErrorCode as p}from"dynamsoft-core";import{fabric as _}from"dm-fabric";import{Howl as y}from"dm-howler";const v="undefined"==typeof self,E=(()=>{if(!v&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})();null==e.dce&&(e.dce=E),t.dce={wasm:!1,js:!1},i.dce={};class I{static getVersion(){return"4.0.1"}}function S(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)}function b(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i}let C,T,L,A,x;"function"==typeof SuppressedError&&SuppressedError,"undefined"!=typeof navigator&&(C=navigator,T=C.userAgent,L=C.platform,A=C.mediaDevices),function(){if(!v){const e={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:C.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},t={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:L,search:"Win"},Mac:{str:L},Linux:{str:L}};let i="unknownBrowser",s=0,r="unknownOS";for(let t in e){const r=e[t]||{};let n=r.str||T,a=r.search||t,o=r.verStr||T,h=r.verSearch||t;if(h instanceof Array||(h=[h]),-1!=n.indexOf(a)){i=t;for(let e of h){let t=o.indexOf(e);if(-1!=t){s=parseFloat(o.substring(t+e.length+1));break}}break}}for(let e in t){const i=t[e]||{};let s=i.str||T,n=i.search||e;if(-1!=s.indexOf(n)){r=e;break}}"Linux"==r&&-1!=T.indexOf("Windows NT")&&(r="HarmonyOS"),x={browser:i,version:s,OS:r}}v&&(x={browser:"ssr",version:0,OS:"ssr"})}();const F="undefined"!=typeof WebAssembly&&T&&!(/Safari/.test(T)&&!/Chrome/.test(T)&&/\(.+\s11_2_([2-6]).*\)/.test(T)),D=!("undefined"==typeof Worker),R=!(!A||!A.getUserMedia),M=async()=>{let e=!1;if(R)try{(await A.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()})),e=!0}catch(e){}return e};var O,P,B,k;"Chrome"===x.browser&&x.version>66||"Safari"===x.browser&&x.version>13||"OPR"===x.browser&&x.version>43||"Edge"===x.browser&&x.version,function(e){e[e.DIMT_RECTANGLE=1]="DIMT_RECTANGLE",e[e.DIMT_QUADRILATERAL=2]="DIMT_QUADRILATERAL",e[e.DIMT_TEXT=4]="DIMT_TEXT",e[e.DIMT_ARC=8]="DIMT_ARC",e[e.DIMT_IMAGE=16]="DIMT_IMAGE",e[e.DIMT_POLYGON=32]="DIMT_POLYGON",e[e.DIMT_LINE=64]="DIMT_LINE",e[e.DIMT_GROUP=128]="DIMT_GROUP"}(O||(O={})),function(e){e[e.DIS_DEFAULT=1]="DIS_DEFAULT",e[e.DIS_SELECTED=2]="DIS_SELECTED"}(P||(P={})),function(e){e[e.EF_ENHANCED_FOCUS=4]="EF_ENHANCED_FOCUS",e[e.EF_AUTO_ZOOM=16]="EF_AUTO_ZOOM",e[e.EF_TAP_TO_FOCUS=64]="EF_TAP_TO_FOCUS"}(B||(B={})),function(e){e.GREY="grey",e.GREY32="grey32",e.RGBA="rgba",e.RBGA="rbga",e.GRBA="grba",e.GBRA="gbra",e.BRGA="brga",e.BGRA="bgra"}(k||(k={}));const N=e=>"number"==typeof e&&!Number.isNaN(e),W=e=>"string"==typeof e;var V,U,G,j,H,Y;!function(e){e.ARC="arc",e.IMAGE="image",e.LINE="line",e.POLYGON="polygon",e.QUAD="quad",e.RECT="rect",e.TEXT="text",e.GROUP="group"}(H||(H={})),function(e){e.DEFAULT="default",e.SELECTED="selected"}(Y||(Y={}));class Z{get mediaType(){return new Map([["rect",O.DIMT_RECTANGLE],["quad",O.DIMT_QUADRILATERAL],["text",O.DIMT_TEXT],["arc",O.DIMT_ARC],["image",O.DIMT_IMAGE],["polygon",O.DIMT_POLYGON],["line",O.DIMT_LINE],["group",O.DIMT_GROUP]]).get(this._mediaType)}get styleSelector(){switch(S(this,U,"f")){case P.DIS_DEFAULT:return"default";case P.DIS_SELECTED:return"selected"}}set drawingStyleId(e){this.styleId=e}get drawingStyleId(){return this.styleId}set coordinateBase(e){if(!["view","image"].includes(e))throw new Error("Invalid 'coordinateBase'.");this._drawingLayer&&("image"===S(this,G,"f")&&"view"===e?this.updateCoordinateBaseFromImageToView():"view"===S(this,G,"f")&&"image"===e&&this.updateCoordinateBaseFromViewToImage()),b(this,G,e,"f")}get coordinateBase(){return S(this,G,"f")}get drawingLayerId(){return this._drawingLayerId}constructor(e,t){if(V.add(this),U.set(this,void 0),G.set(this,"image"),this._zIndex=null,this._drawingLayer=null,this._drawingLayerId=null,this._mapStyle=new Map,this._mapState_StyleId=new Map,this.mapEvent_Callbacks=new Map([["selected",new Map],["deselected",new Map],["mousedown",new Map],["mouseup",new Map],["dblclick",new Map],["mouseover",new Map],["mouseout",new Map]]),this.mapNoteName_Content=new Map([]),this.isDrawingItem=!0,null!=t&&!N(t))throw new TypeError("Invalid 'drawingStyleId'.");e&&this._setFabricObject(e),this.setState(P.DIS_DEFAULT),this.styleId=t}_setFabricObject(e){this._fabricObject=e,this._fabricObject.on("selected",(()=>{this.setState(P.DIS_SELECTED)})),this._fabricObject.on("deselected",(()=>{this._fabricObject.canvas&&this._fabricObject.canvas.getActiveObjects().includes(this._fabricObject)?this.setState(P.DIS_SELECTED):this.setState(P.DIS_DEFAULT),"textbox"===this._fabricObject.type&&(this._fabricObject.isEditing&&this._fabricObject.exitEditing(),this._fabricObject.selected=!1)})),e.getDrawingItem=()=>this}_getFabricObject(){return this._fabricObject}setState(e){b(this,U,e,"f")}getState(){return S(this,U,"f")}_on(e,t){if(!t)return;const i=e.toLowerCase(),s=this.mapEvent_Callbacks.get(i);if(!s)throw new Error(`Event '${e}' does not exist.`);let r=s.get(t);r||(r=e=>{const i=e.e;if(!i)return void(t&&t.apply(this,[{targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null}]));const s={targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null};if(this._drawingLayer){let e,t,r,n;const a=i.target.getBoundingClientRect();e=a.left,t=a.top,r=e+window.scrollX,n=t+window.scrollY;const{width:o,height:h}=this._drawingLayer.fabricCanvas.lowerCanvasEl.getBoundingClientRect(),l=this._drawingLayer.width,d=this._drawingLayer.height,c=o/h,f=l/d,g=this._drawingLayer._getObjectFit();let u,m,w,p,_=1;if("contain"===g)c<f?(_=o/l,u=e+this.get("x")*_,m=t+this.get("y")*_+(h-d*_)/2,w=r+this.get("x")*_,p=n+this.get("y")*_+(h-d*_)/2):(_=h/d,u=e+this.get("x")*_+(o-l*_)/2,m=t+this.get("y")*_,w=r+this.get("x")*_+(o-l*_)/2,p=n+this.get("y")*_);else if("cover"===g)if(c<f){_=h/d;let i=this.get("x")*_-(l*_-o)/2;i=Math.max(i,0),i=Math.min(i,o),u=e+i,m=t+this.get("y")*_,w=r+i,p=n+this.get("y")*_}else{_=o/l;let i=this.get("y")*_-(d*_-h)/2;i=Math.max(i,0),i=Math.min(i,h),u=e+this.get("x")*_,m=t+i,w=r+this.get("x")*_,p=n+i}s.itemClientX=Math.round(u),s.itemClientY=Math.round(m),s.itemPageX=Math.round(w),s.itemPageY=Math.round(p)}for(let e of Object.getOwnPropertyNames(s))Object.defineProperty(i,e,{value:s[e],writable:!0});t&&t.apply(this,[i])},s.set(t,r),this._fabricObject.on("dblclick"===i?"mousedblclick":i,r))}on(e,t){this._on(e,t)}_off(e,t){const i=e.toLowerCase(),s=this.mapEvent_Callbacks.get(i);if(!s)throw new Error(`Event '${e}' does not exist.`);let r=s.get(t);r&&(s.delete(t),this._fabricObject.off("dblclick"===i?"mousedblclick":i,r))}off(e,t){this._off(e,t)}_setEditable(e){const t=this._fabricObject;e?(t.selectable=!0,t.hasControls=!0,t.hoverCursor=null):(t.selectable=!1,t.hasControls=!1,t.hoverCursor="default")}hasNote(e){return this.mapNoteName_Content.has(e)}addNote(e,t){if(this.hasNote(e.name)&&!t)throw new Error("A note with the same name already exists, please use a different name.");const i=e.content?JSON.parse(JSON.stringify(e.content)):e.content;this.mapNoteName_Content.set(e.name,[i])}getNote(e){const t=this.mapNoteName_Content.get(e);return t?1===t.length?{name:e,content:t[0]?JSON.parse(JSON.stringify(t[0])):t[0]}:{name:e,content:JSON.parse(JSON.stringify(t))}:null}getNotes(){const e=[];for(let t of this.mapNoteName_Content){let i=1===t[1].length?t[1][0]:t[1];i=i?JSON.parse(JSON.stringify(i)):i,e.push({name:t[0],content:i})}return e}updateNote(e,t,i){const s=this.mapNoteName_Content.get(e);if(!s)throw new Error("The note name does not exist.");i||(s.length=0),t=t?JSON.parse(JSON.stringify(t)):t,s.push(t)}deleteNote(e){this.mapNoteName_Content.delete(e)}clearNotes(){this.mapNoteName_Content.clear()}set(e,t){if(!this.extendSet(e,t))if("x"===e){const e=this._fabricObject.group;e?(this._fabricObject.set("left",t-e.left-e.width/2),e.addWithUpdate()):this._fabricObject.set("left",t)}else if("y"===e){const e=this._fabricObject.group;e?(this._fabricObject.set("top",t-e.top-e.height/2),e.addWithUpdate()):this._fabricObject.set("top",t)}else"styleId"===e?this.styleId=t:this._fabricObject.set(e,t);["vertices","startPoint","endPoint","x","y","left","top","width","height","scaleX","scaleY","skewX","skewY","padding","angle","strokeWidth"].includes(e)&&this._fabricObject.setCoords()}get(e){let t=this.extendGet(e);if(void 0===t)if("x"===e){const e=this._fabricObject.group;t=e?this._fabricObject.get("left")+e.left+e.width/2:this._fabricObject.get("left")}else if("y"===e){const e=this._fabricObject.group;t=e?this._fabricObject.get("top")+e.top+e.height/2:this._fabricObject.get("top")}else t="scaledWidth"===e?this._fabricObject.getScaledWidth():"scaledHeight"===e?this._fabricObject.getScaledHeight():["type","mediaType"].includes(e)?this.mediaType:"state"===e?this.getState():"styleId"===e?this.styleId:"drawingLayerId"===e?this.drawingLayerId:this._fabricObject.get(e);return t}remove(){this._drawingLayer&&this._drawingLayer.removeDrawingItem(this)}convertPropFromImageToView(e){if("number"!=typeof e)throw new TypeError("Invalid value.");return e*S(this,V,"m",j).call(this)}convertPropFromViewToImage(e){if("number"!=typeof e)throw new TypeError("Invalid value.");return e/S(this,V,"m",j).call(this)}_setLineWidth(e){if(this._drawingLayer)if("view"===this.coordinateBase)this.set("strokeWidth",this.convertPropFromViewToImage(e));else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("strokeWidth",e)}}_getLineWidth(){if(this._drawingLayer){if("view"===this.coordinateBase)return this.convertPropFromImageToView(this.get("strokeWidth"));if("image"===this.coordinateBase)return this.get("strokeWidth");throw new Error("Invalid 'coordinateBase'.")}}_setFontSize(e){if(this._drawingLayer)if("view"===this.coordinateBase)this.set("fontSize",this.convertPropFromViewToImage(e));else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("fontSize",e)}}_getFontSize(){if(this._drawingLayer){if("view"===this.coordinateBase)return this.convertPropFromImageToView(this.get("fontSize"));if("image"===this.coordinateBase)return this.get("fontSize");throw new Error("Invalid 'coordinateBase'.")}}}U=new WeakMap,G=new WeakMap,V=new WeakSet,j=function(){const e=this._drawingLayer;if(!e)return 1;const t=e.width,i=e.height,{width:s,height:r}=e.fabricCanvas.wrapperEl.getBoundingClientRect();if(s<=0||r<=0)throw new Error("Unable to get drawing layer dimensions. Layer may not be rendered on the page.");const n=s/t,a=r/i,o=e._getObjectFit();let h=1;if("contain"===o)if(n<a){h=s/t}else{h=r/i}else if("cover"===o)if(n<a){h=r/i}else{h=s/t}return h},Z.arrMediaTypes=["rect","arc","polygon","image","text","line","quad"],Z.mapItemType=new Map([[H.ARC,"arc"],[H.IMAGE,"image"],[H.LINE,"line"],[H.POLYGON,"polygon"],[H.QUAD,"quad"],[H.RECT,"rect"],[H.TEXT,"text"],[H.GROUP,"group"]]),Z.arrStyleSelectors=["default","selected"],Z.mapItemState=new Map([[Y.DEFAULT,"default"],[Y.SELECTED,"selected"]]);const z=e=>null!==e&&"object"==typeof e&&!Array.isArray(e),J=e=>!!W(e)&&""!==e,K=s,X=r,q=a,Q=o,$=l,ee=h,te=n,ie=e=>!!z(e)&&(!("id"in e&&!N(e.id))&&(!("lineWidth"in e&&!N(e.lineWidth))&&(!("fillStyle"in e&&!J(e.fillStyle))&&(!("strokeStyle"in e&&!J(e.strokeStyle))&&(!("paintMode"in e&&!["fill","stroke","strokeAndFill"].includes(e.paintMode))&&(!("fontFamily"in e&&!J(e.fontFamily))&&!("fontSize"in e&&!N(e.fontSize))))))));class se{static convert(e,t,i){const s={x:0,y:0,width:t,height:i};if(!e)return s;if(te(e))e.isMeasuredInPercentage?(s.x=e.x/100*t,s.y=e.y/100*i,s.width=e.width/100*t,s.height=e.height/100*i):(s.x=e.x,s.y=e.y,s.width=e.width,s.height=e.height);else{if(!X(e))throw TypeError("Invalid region.");e.isMeasuredInPercentage?(s.x=e.left/100*t,s.y=e.top/100*i,s.width=(e.right-e.left)/100*t,s.height=(e.bottom-e.top)/100*i):(s.x=e.left,s.y=e.top,s.width=e.right-e.left,s.height=e.bottom-e.top)}return s.x=Math.round(s.x),s.y=Math.round(s.y),s.width=Math.round(s.width),s.height=Math.round(s.height),s}}var re,ne;class ae{constructor(){re.set(this,new Map),ne.set(this,!1)}get disposed(){return S(this,ne,"f")}on(e,t){e=e.toLowerCase();const i=S(this,re,"f").get(e);if(i){if(i.includes(t))return;i.push(t)}else S(this,re,"f").set(e,[t])}off(e,t){e=e.toLowerCase();const i=S(this,re,"f").get(e);if(!i)return;const s=i.indexOf(t);-1!==s&&i.splice(s,1)}offAll(e){e=e.toLowerCase();const t=S(this,re,"f").get(e);t&&(t.length=0)}async fire(e,t=[],i={async:!1,copy:!0}){t||(t=[]),e=e.toLowerCase();const s=S(this,re,"f").get(e);if(s&&s.length){i=Object.assign({async:!1,copy:!0},i);for(let e of s){if(!e)continue;let s=[];if(i.copy)for(let e of t){try{e=JSON.parse(JSON.stringify(e))}catch(e){}s.push(e)}else s=t;let r=!1;if(i.async)setTimeout((()=>{this.disposed||e.apply(i.target,s)}),0);else try{r=await e.apply(i.target,s)}catch(e){}if(!0===r)break}}}dispose(){b(this,ne,!0,"f")}}function oe(e,t,i){return(i.x-e.x)*(t.y-e.y)==(t.x-e.x)*(i.y-e.y)&&Math.min(e.x,t.x)<=i.x&&i.x<=Math.max(e.x,t.x)&&Math.min(e.y,t.y)<=i.y&&i.y<=Math.max(e.y,t.y)}function he(e){return Math.abs(e)<1e-6?0:e<0?-1:1}function le(e,t,i,s){let r=e[0]*(i[1]-t[1])+t[0]*(e[1]-i[1])+i[0]*(t[1]-e[1]),n=e[0]*(s[1]-t[1])+t[0]*(e[1]-s[1])+s[0]*(t[1]-e[1]);return!((r^n)>=0&&0!==r&&0!==n)&&(r=i[0]*(e[1]-s[1])+s[0]*(i[1]-e[1])+e[0]*(s[1]-i[1]),n=i[0]*(t[1]-s[1])+s[0]*(i[1]-t[1])+t[0]*(s[1]-i[1]),!((r^n)>=0&&0!==r&&0!==n))}re=new WeakMap,ne=new WeakMap;const de=async e=>{if("string"!=typeof e)throw new TypeError("Invalid url.");const t=await fetch(e);if(!t.ok)throw Error("Network Error: "+t.statusText);const i=await t.text();if(!i.trim().startsWith("<"))throw Error("Unable to get valid HTMLElement.");const s=document.createElement("div");s.insertAdjacentHTML("beforeend",i);for(let e=0;e<s.childElementCount;++e){let t=s.children[e];t instanceof HTMLStyleElement&&document.head.append(t)}return 1==s.childElementCount?s.children[0]:s};var ce,fe,ge,ue,me;class we extends Z{constructor(e,t){if(super(null,t),ce.set(this,void 0),!te(e))throw new TypeError("Invalid 'rect'.");this._setFabricObject(new _.Rect({left:e.x,top:e.y,width:e.width,height:e.height})),b(this,ce,JSON.parse(JSON.stringify(e)),"f"),this._mediaType="rect"}extendSet(e,t){return!1}extendGet(e){}updateCoordinateBaseFromImageToView(){this.set("left",this.convertPropFromViewToImage(this.get("left"))),this.set("top",this.convertPropFromViewToImage(this.get("top"))),this.set("width",this.convertPropFromViewToImage(this.get("scaledWidth"))),this.set("height",this.convertPropFromViewToImage(this.get("scaledHeight")))}updateCoordinateBaseFromViewToImage(){this.set("left",this.convertPropFromImageToView(this.get("left"))),this.set("top",this.convertPropFromImageToView(this.get("top"))),this.set("width",this.convertPropFromImageToView(this.get("scaledWidth"))),this.set("height",this.convertPropFromImageToView(this.get("scaledHeight")))}setPosition(e){this.setRect(e)}getPosition(){return this.getRect()}updatePosition(){S(this,ce,"f")&&this.setRect(S(this,ce,"f"))}setRect(e){if(!te(e))throw new TypeError("Invalid 'rect'.");if(this._drawingLayer){if("view"===this.coordinateBase)this.set("left",this.convertPropFromViewToImage(e.x)),this.set("top",this.convertPropFromViewToImage(e.y)),this.set("width",this.convertPropFromViewToImage(e.width)),this.set("height",this.convertPropFromViewToImage(e.height));else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("left",e.x),this.set("top",e.y),this.set("width",e.width),this.set("height",e.height)}this._drawingLayer.renderAll()}else b(this,ce,JSON.parse(JSON.stringify(e)),"f")}getRect(){if(this._drawingLayer){if("view"===this.coordinateBase)return{x:this.convertPropFromImageToView(this.get("left")),y:this.convertPropFromImageToView(this.get("top")),width:this.convertPropFromImageToView(this.get("scaledWidth")),height:this.convertPropFromImageToView(this.get("scaledHeight"))};if("image"===this.coordinateBase)return{x:this.get("left"),y:this.get("top"),width:this.get("scaledWidth"),height:this.get("scaledHeight")};throw new Error("Invalid 'coordinateBase'.")}return S(this,ce,"f")?JSON.parse(JSON.stringify(S(this,ce,"f"))):null}}function pe(e,t,i){let s=i.points[this.pointIndex].x-i.pathOffset.x,r=i.points[this.pointIndex].y-i.pathOffset.y;return _.util.transformPoint({x:s,y:r},i.calcTransformMatrix())}function _e(e){let t=new _.Point(e.strokeUniform?1/e.scaleX:1,e.strokeUniform?1/e.scaleY:1).multiply(e.strokeWidth);return new _.Point(e.width+t.x,e.height+t.y)}function ye(e,t,i,s){let r=t.target,n=r.controls[r.__corner],a=r.toLocalPoint(new _.Point(i,s),"center","center"),o=_e(r),h=r._getTransformedDimensions(0,0),l={x:a.x*o.x/h.x+r.pathOffset.x,y:a.y*o.y/h.y+r.pathOffset.y};return r.points[n.pointIndex]=l,!0}function ve(e,t){return function(i,s,r,n){let a=s.target,o=_.util.transformPoint({x:a.points[e].x-a.pathOffset.x,y:a.points[e].y-a.pathOffset.y},a.calcTransformMatrix()),h=t(i,s,r,n);a._setPositionDimensions({});let l=_e(a),d=(a.points[e].x-a.pathOffset.x)/l.x,c=(a.points[e].y-a.pathOffset.y)/l.y;return a.setPositionByOrigin(o,d+.5,c+.5),h}}ce=new WeakMap;class Ee extends Z{constructor(e,t){if(super(null,t),fe.set(this,void 0),!Q(e))throw new TypeError("Invalid 'polygon'.");this._setFabricObject(new _.Polygon(e.points,{objectCaching:!1}));const i=this._fabricObject;let s=i.points.length-1;i.controls=i.points.reduce((function(e,t,i){return e["p"+i]=new _.Control({positionHandler:pe,actionHandler:ve(i>0?i-1:s,ye),actionName:"modifyPolygon",pointIndex:i}),e}),{}),b(this,fe,JSON.parse(JSON.stringify(e)),"f"),this._mediaType="polygon"}extendSet(e,t){if("vertices"===e){const e=this._fabricObject;if(e.group){const i=e.group;e.points=t.map((e=>({x:e.x-i.left-i.width/2,y:e.y-i.top-i.height/2}))),i.addWithUpdate()}else e.points=t;const i=e.points.length-1;return e.controls=e.points.reduce((function(e,t,s){return e["p"+s]=new _.Control({positionHandler:pe,actionHandler:ve(s>0?s-1:i,ye),actionName:"modifyPolygon",pointIndex:s}),e}),{}),e._setPositionDimensions({}),!0}}extendGet(e){if("vertices"===e){const e=[],t=this._fabricObject;if(t.selectable&&!t.group)for(let i in t.oCoords)e.push({x:t.oCoords[i].x,y:t.oCoords[i].y});else for(let i of t.points){let s=i.x-t.pathOffset.x,r=i.y-t.pathOffset.y;const n=_.util.transformPoint({x:s,y:r},t.calcTransformMatrix());e.push({x:n.x,y:n.y})}return e}}updateCoordinateBaseFromImageToView(){const e=this.get("vertices").map((e=>({x:this.convertPropFromViewToImage(e.x),y:this.convertPropFromViewToImage(e.y)})));this.set("vertices",e)}updateCoordinateBaseFromViewToImage(){const e=this.get("vertices").map((e=>({x:this.convertPropFromImageToView(e.x),y:this.convertPropFromImageToView(e.y)})));this.set("vertices",e)}setPosition(e){this.setPolygon(e)}getPosition(){return this.getPolygon()}updatePosition(){S(this,fe,"f")&&this.setPolygon(S(this,fe,"f"))}setPolygon(e){if(!Q(e))throw new TypeError("Invalid 'polygon'.");if(this._drawingLayer){if("view"===this.coordinateBase){const t=e.points.map((e=>({x:this.convertPropFromViewToImage(e.x),y:this.convertPropFromViewToImage(e.y)})));this.set("vertices",t)}else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("vertices",e.points)}this._drawingLayer.renderAll()}else b(this,fe,JSON.parse(JSON.stringify(e)),"f")}getPolygon(){if(this._drawingLayer){if("view"===this.coordinateBase){return{points:this.get("vertices").map((e=>({x:this.convertPropFromImageToView(e.x),y:this.convertPropFromImageToView(e.y)})))}}if("image"===this.coordinateBase)return{points:this.get("vertices")};throw new Error("Invalid 'coordinateBase'.")}return S(this,fe,"f")?JSON.parse(JSON.stringify(S(this,fe,"f"))):null}}fe=new WeakMap;ge=new WeakMap,ue=new WeakMap;const Ie=e=>{let t=(e=>e.split("\n").map((e=>e.split("\t"))))(e);return(e=>{for(let t=0;;t++){let i=-1;for(let s=0;s<e.length;s++){let r=e[s][t];void 0!==r&&(r.length>i&&(i=r.length))}if(-1===i)break;for(let s=0;s<e.length;s++){if(t>=e[s].length-1)continue;let r=" ".repeat(i+2-e[s][t].length);e[s][t]=e[s][t].concat(r)}}})(t),(e=>{let t="";for(let i=0;i<e.length;i++)t=t.concat(...e[i],i===e.length-1?"":"\n");return t})(t)};class Se extends Z{constructor(e,t,i){if(super(null,i),me.set(this,void 0),!W(e))throw new TypeError("Invalid 'text'.");if(!te(t))throw new TypeError("Invalid 'rect'.");this._setFabricObject(new _.Textbox(Ie(e),{left:t.x,top:t.y,width:t.width})),this._text=e,b(this,me,JSON.parse(JSON.stringify(t)),"f"),this._mediaType="text"}extendSet(e,t){if("text"===e)return this._text=t,this._fabricObject.set("text",Ie(t)),!0}extendGet(e){if("text"===e)return this._text}updateCoordinateBaseFromImageToView(){this.set("left",this.convertPropFromViewToImage(this.get("left"))),this.set("top",this.convertPropFromViewToImage(this.get("top"))),this.set("width",this.convertPropFromViewToImage(this.get("scaledWidth")))}updateCoordinateBaseFromViewToImage(){this.set("left",this.convertPropFromImageToView(this.get("left"))),this.set("top",this.convertPropFromImageToView(this.get("top"))),this.set("width",this.convertPropFromImageToView(this.get("scaledWidth")))}setPosition(e){this.setTextRect(e)}getPosition(){return this.getTextRect()}updatePosition(){S(this,me,"f")&&this.setTextRect(S(this,me,"f"))}setText(e){if(!W(e))throw new TypeError("Invalid 'text'.");this.set("text",e)}getText(){return this.get("text")}setTextRect(e){if(!te(e))throw new TypeError("Invalid 'rect'.");if(this._drawingLayer){if("view"===this.coordinateBase)this.set("left",this.convertPropFromViewToImage(e.x)),this.set("top",this.convertPropFromViewToImage(e.y)),this.set("width",this.convertPropFromViewToImage(e.width));else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("left",e.x),this.set("top",e.y),this.set("width",e.width)}this._drawingLayer.renderAll()}else b(this,me,JSON.parse(JSON.stringify(e)),"f")}getTextRect(){if(this._drawingLayer){if("view"===this.coordinateBase)return{x:this.convertPropFromImageToView(this.get("left")),y:this.convertPropFromImageToView(this.get("top")),width:this.convertPropFromImageToView(this.get("scaledWidth")),height:this.convertPropFromImageToView(this.get("scaledHeight"))};if("image"===this.coordinateBase)return{x:this.get("left"),y:this.get("top"),width:this.get("scaledWidth"),height:this.get("scaledHeight")};throw new Error("Invalid 'coordinateBase'.")}return S(this,me,"f")?JSON.parse(JSON.stringify(S(this,me,"f"))):null}}var be,Ce,Te,Le,Ae,xe,Fe,De,Re,Me,Oe,Pe,Be,ke,Ne,We,Ve,Ue,Ge,je,He,Ye,Ze,ze,Je,Ke,Xe,qe,Qe,$e,et,tt,it,st,rt,nt,at,ot,ht,lt;me=new WeakMap;be=new WeakMap;class dt extends Ee{constructor(e,t){if(super({points:null==e?void 0:e.points},t),Ce.set(this,void 0),!ee(e))throw new TypeError("Invalid 'quad'.");b(this,Ce,JSON.parse(JSON.stringify(e)),"f"),this._mediaType="quad"}setPosition(e){this.setQuad(e)}getPosition(){return this.getQuad()}updatePosition(){S(this,Ce,"f")&&this.setQuad(S(this,Ce,"f"))}setPolygon(){}getPolygon(){return null}setQuad(e){if(!ee(e))throw new TypeError("Invalid 'quad'.");if(this._drawingLayer){if("view"===this.coordinateBase){const t=e.points.map((e=>({x:this.convertPropFromViewToImage(e.x),y:this.convertPropFromViewToImage(e.y)})));this.set("vertices",t)}else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("vertices",e.points)}this._drawingLayer.renderAll()}else b(this,Ce,JSON.parse(JSON.stringify(e)),"f")}getQuad(){if(this._drawingLayer){if("view"===this.coordinateBase){return{points:this.get("vertices").map((e=>({x:this.convertPropFromImageToView(e.x),y:this.convertPropFromImageToView(e.y)})))}}if("image"===this.coordinateBase)return{points:this.get("vertices")};throw new Error("Invalid 'coordinateBase'.")}return S(this,Ce,"f")?JSON.parse(JSON.stringify(S(this,Ce,"f"))):null}}Ce=new WeakMap;class ct extends Z{constructor(e){super(new _.Group(e.map((e=>e._getFabricObject())))),this._fabricObject.on("selected",(()=>{this.setState(P.DIS_SELECTED);const e=this._fabricObject._objects;for(let t of e)setTimeout((()=>{t&&t.fire("selected")}),0);setTimeout((()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())}),0)})),this._fabricObject.on("deselected",(()=>{this.setState(P.DIS_DEFAULT);const e=this._fabricObject._objects;for(let t of e)setTimeout((()=>{t&&t.fire("deselected")}),0);setTimeout((()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())}),0)})),this._mediaType="group"}extendSet(e,t){return!1}extendGet(e){}updateCoordinateBaseFromImageToView(){}updateCoordinateBaseFromViewToImage(){}setPosition(){}getPosition(){}updatePosition(){}getChildDrawingItems(){return this._fabricObject._objects.map((e=>e.getDrawingItem()))}setChildDrawingItems(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");this._drawingLayer?this._drawingLayer._updateGroupItem(this,e,"add"):this._fabricObject.addWithUpdate(e._getFabricObject())}removeChildItem(e){e&&e.isDrawingItem&&(this._drawingLayer?this._drawingLayer._updateGroupItem(this,e,"remove"):this._fabricObject.removeWithUpdate(e._getFabricObject()))}}class ft{static createDrawingStyle(e){if(!ie(e))throw new Error("Invalid style definition.");let t,i=ft.USER_START_STYLE_ID;for(;S(ft,Te,"f",Le).has(i);)i++;t=i;const s=JSON.parse(JSON.stringify(e));s.id=t;for(let e in S(ft,Te,"f",Ae))s.hasOwnProperty(e)||(s[e]=S(ft,Te,"f",Ae)[e]);return S(ft,Te,"f",Le).set(t,s),s.id}static _getDrawingStyle(e,t){if("number"!=typeof e)throw new Error("Invalid style id.");const i=S(ft,Te,"f",Le).get(e);return i?t?JSON.parse(JSON.stringify(i)):i:null}static getDrawingStyle(e){return this._getDrawingStyle(e,!0)}static getDrawingStyles(){return JSON.parse(JSON.stringify(Array.from(S(ft,Te,"f",Le).values())))}static _updateDrawingStyle(e,t){if(!ie(t))throw new Error("Invalid style definition.");const i=S(ft,Te,"f",Le).get(e);if(i)for(let e in t)i.hasOwnProperty(e)&&(i[e]=t[e])}static updateDrawingStyle(e,t){this._updateDrawingStyle(e,t)}}Te=ft,ft.STYLE_BLUE_STROKE=1,ft.STYLE_GREEN_STROKE=2,ft.STYLE_ORANGE_STROKE=3,ft.STYLE_YELLOW_STROKE=4,ft.STYLE_BLUE_STROKE_FILL=5,ft.STYLE_GREEN_STROKE_FILL=6,ft.STYLE_ORANGE_STROKE_FILL=7,ft.STYLE_YELLOW_STROKE_FILL=8,ft.STYLE_BLUE_STROKE_TRANSPARENT=9,ft.STYLE_GREEN_STROKE_TRANSPARENT=10,ft.STYLE_ORANGE_STROKE_TRANSPARENT=11,ft.USER_START_STYLE_ID=1024,Le={value:new Map([[ft.STYLE_BLUE_STROKE,{id:ft.STYLE_BLUE_STROKE,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[ft.STYLE_GREEN_STROKE,{id:ft.STYLE_GREEN_STROKE,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[ft.STYLE_ORANGE_STROKE,{id:ft.STYLE_ORANGE_STROKE,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[ft.STYLE_YELLOW_STROKE,{id:ft.STYLE_YELLOW_STROKE,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[ft.STYLE_BLUE_STROKE_FILL,{id:ft.STYLE_BLUE_STROKE_FILL,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[ft.STYLE_GREEN_STROKE_FILL,{id:ft.STYLE_GREEN_STROKE_FILL,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[ft.STYLE_ORANGE_STROKE_FILL,{id:ft.STYLE_ORANGE_STROKE_FILL,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[ft.STYLE_YELLOW_STROKE_FILL,{id:ft.STYLE_YELLOW_STROKE_FILL,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[ft.STYLE_BLUE_STROKE_TRANSPARENT,{id:ft.STYLE_BLUE_STROKE_TRANSPARENT,lineWidth:4,fillStyle:"rgba(73, 245, 73, 0.2)",strokeStyle:"transparent",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[ft.STYLE_GREEN_STROKE_TRANSPARENT,{id:ft.STYLE_GREEN_STROKE_TRANSPARENT,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.2)",strokeStyle:"transparent",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[ft.STYLE_ORANGE_STROKE_TRANSPARENT,{id:ft.STYLE_ORANGE_STROKE_TRANSPARENT,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.2)",strokeStyle:"transparent",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}]])},Ae={value:{lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}},"undefined"!=typeof document&&"undefined"!=typeof window&&(_.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(_.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject((function(e){e.dispose&&e.dispose()})),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),_.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},_.Object.prototype.transparentCorners=!1,_.Object.prototype.cornerSize=20,_.Object.prototype.touchCornerSize=100,_.Object.prototype.cornerColor="rgb(254,142,20)",_.Object.prototype.cornerStyle="circle",_.Object.prototype.strokeUniform=!0,_.Object.prototype.hasBorders=!1,_.Canvas.prototype.containerClass="",_.Canvas.prototype.getPointer=function(e,t){if(this._absolutePointer&&!t)return this._absolutePointer;if(this._pointer&&t)return this._pointer;var i,s=this.upperCanvasEl,r=_.util.getPointer(e,s),n=s.getBoundingClientRect(),a=n.width||0,o=n.height||0;a&&o||("top"in n&&"bottom"in n&&(o=Math.abs(n.top-n.bottom)),"right"in n&&"left"in n&&(a=Math.abs(n.right-n.left))),this.calcOffset(),r.x=r.x-this._offset.left,r.y=r.y-this._offset.top,t||(r=this.restorePointerVpt(r));var h=this.getRetinaScaling();if(1!==h&&(r.x/=h,r.y/=h),0!==a&&0!==o){var l=window.getComputedStyle(s).objectFit,d=s.width,c=s.height,f=a,g=o;i={width:d/f,height:c/g};var u,m,w=d/c,p=f/g;return"contain"===l?w>p?(u=f,m=f/w,{x:r.x*i.width,y:(r.y-(g-m)/2)*i.width}):(u=g*w,m=g,{x:(r.x-(f-u)/2)*i.height,y:r.y*i.height}):"cover"===l?w>p?{x:(d-i.height*f)/2+r.x*i.height,y:r.y*i.height}:{x:r.x*i.width,y:(c-i.width*g)/2+r.y*i.width}:{x:r.x*i.width,y:r.y*i.height}}return i={width:1,height:1},{x:r.x*i.width,y:r.y*i.height}},_.Canvas.prototype._onTouchStart=function(e){var t=this.findTarget(e);!this.allowTouchScrolling&&e.cancelable&&e.preventDefault&&e.preventDefault(),t&&e.cancelable&&e.preventDefault&&e.preventDefault(),null===this.mainTouchId&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),this._resetTransformEventData();var i=this.upperCanvasEl,s=this._getEventPrefix();_.util.addListener(_.document,"touchend",this._onTouchEnd,{passive:!1}),_.util.addListener(_.document,"touchmove",this._onMouseMove,{passive:!1}),_.util.removeListener(i,s+"down",this._onMouseDown)},_.Textbox.prototype._wrapLine=function(e,t,i,s){const r=e.match(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g),n=!(!r||!r.length);var a=0,o=this.splitByGrapheme||n,h=[],l=[],d=o?_.util.string.graphemeSplit(e):e.split(this._wordJoiners),c="",f=0,g=o?"":" ",u=0,m=0,w=0,p=!0,y=this._getWidthOfCharSpacing();s=s||0;0===d.length&&d.push([]),i-=s;for(var v=0;v<d.length;v++)c=o?d[v]:_.util.string.graphemeSplit(d[v]),u=this._measureWord(c,t,f),f+=c.length,(a+=m+u-y)>i&&!p?(h.push(l),l=[],a=u,p=!0):a+=y,p||o||l.push(g),l=l.concat(c),m=o?0:this._measureWord([g],t,f),f++,p=!1,u>w&&(w=u);return v&&h.push(l),w+s>this.dynamicMinWidth&&(this.dynamicMinWidth=w-y+s),h});class gt{get width(){return this.fabricCanvas.width}get height(){return this.fabricCanvas.height}set _allowMultiSelect(e){this.fabricCanvas.selection=e,this.fabricCanvas.renderAll()}get _allowMultiSelect(){return this.fabricCanvas.selection}constructor(e,t,i){let s,r;switch(this.mapMediaType_Style=new Map,this.mapType_StateAndStyleId=new Map,this.mode="viewer",this.onSelectionChanged=null,this._arrDrwaingItem=[],this._arrFabricObject=[],this._visible=!0,e.hasOwnProperty("getFabricCanvas")?this.fabricCanvas=e.getFabricCanvas():(this.fabricCanvas=new _.Canvas(e,Object.assign(i,{allowTouchScrolling:!0,selection:!1})),this.fabricCanvas.setDimensions({width:"100%",height:"100%"},{cssOnly:!0}),this.fabricCanvas.lowerCanvasEl.className="",this.fabricCanvas.upperCanvasEl.className="",this.fabricCanvas.on("selection:created",(function(e){const t=e.selected,i=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!i.includes(t)&&i.push(t)}for(let e of i){const i=[];for(let s of t){const t=s.getDrawingItem();t._drawingLayer===e&&i.push(t)}setTimeout((()=>{e.onSelectionChanged&&e.onSelectionChanged(i,[])}),0)}})),this.fabricCanvas.on("before:selection:cleared",(function(e){const t=this.getActiveObjects(),i=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!i.includes(t)&&i.push(t)}for(let e of i){const i=[];for(let s of t){const t=s.getDrawingItem();t._drawingLayer===e&&i.push(t)}setTimeout((()=>{const t=[];for(let s of i)e.hasDrawingItem(s)&&t.push(s);t.length>0&&e.onSelectionChanged&&e.onSelectionChanged([],t)}),0)}})),this.fabricCanvas.on("selection:updated",(function(e){const t=e.selected,i=e.deselected,s=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!s.includes(t)&&s.push(t)}for(let e of i){const t=e.getDrawingItem()._drawingLayer;t&&!s.includes(t)&&s.push(t)}for(let e of s){const s=[],r=[];for(let i of t){const t=i.getDrawingItem();t._drawingLayer===e&&s.push(t)}for(let t of i){const i=t.getDrawingItem();i._drawingLayer===e&&r.push(i)}setTimeout((()=>{e.onSelectionChanged&&e.onSelectionChanged(s,r)}),0)}})),this.fabricCanvas.wrapperEl.style.position="absolute",e.getFabricCanvas=()=>this.fabricCanvas),this.id=t,t){case gt.DDN_LAYER_ID:s=ft.getDrawingStyle(ft.STYLE_BLUE_STROKE),r=ft.getDrawingStyle(ft.STYLE_BLUE_STROKE_FILL);break;case gt.DBR_LAYER_ID:s=ft.getDrawingStyle(ft.STYLE_ORANGE_STROKE),r=ft.getDrawingStyle(ft.STYLE_ORANGE_STROKE_FILL);break;case gt.DLR_LAYER_ID:s=ft.getDrawingStyle(ft.STYLE_GREEN_STROKE),r=ft.getDrawingStyle(ft.STYLE_GREEN_STROKE_FILL);break;default:s=ft.getDrawingStyle(ft.STYLE_YELLOW_STROKE),r=ft.getDrawingStyle(ft.STYLE_YELLOW_STROKE_FILL)}for(let e of Z.arrMediaTypes)this.mapType_StateAndStyleId.set(e,{default:s.id,selected:r.id})}getId(){return this.id}setVisible(e){if(e){for(let e of this._arrFabricObject)e.visible=!0,e.hasControls=!0;this._visible=!0}else{for(let e of this._arrFabricObject)e.visible=!1,e.hasControls=!1;this._visible=!1}this.fabricCanvas.renderAll()}isVisible(){return this._visible}_getItemCurrentStyleId(e){return e.styleId?e.styleId:this.mapType_StateAndStyleId.get(e._mediaType)[e.styleSelector]}_getItemCurrentStyle(e){if(e.styleId)return ft.getDrawingStyle(e.styleId);const t=ft.getDrawingStyle(e._mapState_StyleId.get(e.styleSelector));return t||null}_changeMediaTypeCurStyleInStyleSelector(e,t,i,s){const r=this.getDrawingItems((t=>t._mediaType===e));for(let e of r)e.styleSelector===t&&this._changeItemStyle(e,i,!0);s||this.fabricCanvas.renderAll()}_changeItemStyle(e,t,i){if(!e||!t)return;const s=e._getFabricObject();"number"==typeof e.styleId&&(t=ft.getDrawingStyle(e.styleId)),s.strokeWidth=t.lineWidth,"fill"===t.paintMode?(s.fill=t.fillStyle,s.stroke=t.fillStyle):"stroke"===t.paintMode?(s.fill="transparent",s.stroke=t.strokeStyle):"strokeAndFill"===t.paintMode&&(s.fill=t.fillStyle,s.stroke=t.strokeStyle),s.fontFamily&&(s.fontFamily=t.fontFamily),s.fontSize&&(s.fontSize=t.fontSize),s.group||(s.dirty=!0),i||this.fabricCanvas.renderAll()}_updateGroupItem(e,t,i){if(!e||!t)return;const s=e.getChildDrawingItems();if("add"===i){if(s.includes(t))return;const i=t._getFabricObject();if(this.fabricCanvas.getObjects().includes(i)){if(!this._arrFabricObject.includes(i))throw new Error("Existed in other drawing layers.");t._zIndex=null}else{let i;if(t.styleId)i=ft.getDrawingStyle(t.styleId);else{const s=this.mapType_StateAndStyleId.get(t._mediaType);i=ft.getDrawingStyle(s[e.styleSelector]);const r=()=>{this._changeItemStyle(t,ft.getDrawingStyle(this.mapType_StateAndStyleId.get(t._mediaType).selected),!0)},n=()=>{this._changeItemStyle(t,ft.getDrawingStyle(this.mapType_StateAndStyleId.get(t._mediaType).default),!0)};t._on("selected",r),t._on("deselected",n),t._funcChangeStyleToSelected=r,t._funcChangeStyleToDefault=n}t._drawingLayer=this,t._drawingLayerId=this.id,this._changeItemStyle(t,i,!0)}e._fabricObject.addWithUpdate(t._getFabricObject())}else{if("remove"!==i)return;if(!s.includes(t))return;t._zIndex=null,t._drawingLayer=null,t._drawingLayerId=null,t._off("selected",t._funcChangeStyleToSelected),t._off("deselected",t._funcChangeStyleToDefault),t._funcChangeStyleToSelected=null,t._funcChangeStyleToDefault=null,e._fabricObject.removeWithUpdate(t._getFabricObject())}this.fabricCanvas.renderAll()}_addDrawingItem(e,t){if(!(e instanceof Z))throw new TypeError("Invalid 'drawingItem'.");if(e._drawingLayer){if(e._drawingLayer==this)return;throw new Error("This drawing item has existed in other layer.")}let i=e._getFabricObject();const s=this.fabricCanvas.getObjects();let r,n;if(s.includes(i)){if(this._arrFabricObject.includes(i))return;throw new Error("Existed in other drawing layers.")}if("group"===e._mediaType){r=e.getChildDrawingItems();for(let e of r)if(e._drawingLayer&&e._drawingLayer!==this)throw new Error("The childItems of DT_Group have existed in other drawing layers.")}if(t&&"object"==typeof t&&!Array.isArray(t))for(let e in t)i.set(e,t[e]);if(r){for(let e of r){const t=this.mapType_StateAndStyleId.get(e._mediaType);for(let i of Z.arrStyleSelectors)e._mapState_StyleId.set(i,t[i]);if(e.styleId)n=ft.getDrawingStyle(e.styleId);else{n=ft.getDrawingStyle(t.default);const i=()=>{this._changeItemStyle(e,ft.getDrawingStyle(this.mapType_StateAndStyleId.get(e._mediaType).selected),!0)},s=()=>{this._changeItemStyle(e,ft.getDrawingStyle(this.mapType_StateAndStyleId.get(e._mediaType).default),!0)};e._on("selected",i),e._on("deselected",s),e._funcChangeStyleToSelected=i,e._funcChangeStyleToDefault=s}e._drawingLayer=this,e._drawingLayerId=this.id,this._changeItemStyle(e,n,!0)}i.dirty=!0,this.fabricCanvas.renderAll()}else{const t=this.mapType_StateAndStyleId.get(e._mediaType);for(let i of Z.arrStyleSelectors)e._mapState_StyleId.set(i,t[i]);if(e.styleId)n=ft.getDrawingStyle(e.styleId);else{n=ft.getDrawingStyle(t.default);const i=()=>{this._changeItemStyle(e,ft.getDrawingStyle(this.mapType_StateAndStyleId.get(e._mediaType).selected))},s=()=>{this._changeItemStyle(e,ft.getDrawingStyle(this.mapType_StateAndStyleId.get(e._mediaType).default))};e._on("selected",i),e._on("deselected",s),e._funcChangeStyleToSelected=i,e._funcChangeStyleToDefault=s}this._changeItemStyle(e,n)}e._zIndex=this.id,e._drawingLayer=this,e._drawingLayerId=this.id;const a=this._arrFabricObject.length;let o=s.length;if(a)o=s.indexOf(this._arrFabricObject[a-1])+1;else for(let t=0;t<s.length;t++)if(e._zIndex<s[t].getDrawingItem()._zIndex){o=t;break}this._arrDrwaingItem.push(e),this._arrFabricObject.push(i),this._visible?i.visible=!0:i.visible=!1,this.fabricCanvas.insertAt(i,o,!1)}addDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");if("viewer"===this.mode)e._setEditable(!1);else{if("editor"!==this.mode)throw new Error("Illegal 'mode'.");e._setEditable(!0)}this._addDrawingItem(e),e.updatePosition()}addDrawingItems(e){for(let t of e)this.addDrawingItem(t)}removeDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");if(!this.hasDrawingItem(e))return;if(e._zIndex=null,e._drawingLayer=null,e._drawingLayerId=null,"group"===e._mediaType){const t=e.getChildDrawingItems();for(let e of t)e._zIndex=null,e._drawingLayer=null,e._drawingLayerId=null,e._off("selected",e._funcChangeStyleToSelected),e._off("deselected",e._funcChangeStyleToDefault),e._funcChangeStyleToSelected=null,e._funcChangeStyleToDefault=null,e._mapState_StyleId.clear()}else e._off("selected",e._funcChangeStyleToSelected),e._off("deselected",e._funcChangeStyleToDefault),e._funcChangeStyleToSelected=null,e._funcChangeStyleToDefault=null,e._mapState_StyleId.clear();const t=e._getFabricObject();"selected"===e.styleSelector&&(t.group?t.group.removeWithUpdate(t):this.fabricCanvas._activeObject=null,e.setState(P.DIS_DEFAULT)),this.fabricCanvas.remove(t),this._arrDrwaingItem.splice(this._arrDrwaingItem.indexOf(e),1),this._arrFabricObject.splice(this._arrFabricObject.indexOf(t),1)}removeDrawingItems(e){for(let t of e)this.removeDrawingItem(t)}setDrawingItems(e){this.clearDrawingItems(),this.addDrawingItems(e)}getDrawingItems(e){return e&&"function"==typeof e?this._arrDrwaingItem.filter(e):Array.from(this._arrDrwaingItem)}getSelectedDrawingItems(){const e=this.fabricCanvas.getActiveObjects(),t=[];for(let i of e)this._arrFabricObject.includes(i)&&t.push(i.getDrawingItem());return t}hasDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");return this._arrDrwaingItem.includes(e)}clearDrawingItems(){this.removeDrawingItems(Array.from(this._arrDrwaingItem))}_setDefaultStyle(e,t,i){t?t.forEach((e=>e.toLowerCase())):t=Z.arrMediaTypes,i?i.forEach((e=>e.toLowerCase())):i=Z.arrStyleSelectors;const s=ft.getDrawingStyle(e);if(!s)throw new Error(`The 'drawingStyle' with id '${e}' doesn't exist.`);let r;for(let n of t)if(r=this.mapType_StateAndStyleId.get(n),r)for(let t of i){this._changeMediaTypeCurStyleInStyleSelector(n,t,s,!0),r[t]=e;for(let i of this._arrDrwaingItem)i._mediaType===n&&i._mapState_StyleId.set(t,e)}this.fabricCanvas.renderAll()}setDefaultStyle(e,t,i){const s=[];i&O.DIMT_RECTANGLE&&s.push("rect"),i&O.DIMT_QUADRILATERAL&&s.push("quad"),i&O.DIMT_TEXT&&s.push("text"),i&O.DIMT_ARC&&s.push("arc"),i&O.DIMT_IMAGE&&s.push("image"),i&O.DIMT_POLYGON&&s.push("polygon"),i&O.DIMT_LINE&&s.push("line");const r=[];t&P.DIS_DEFAULT&&r.push("default"),t&P.DIS_SELECTED&&r.push("selected"),this._setDefaultStyle(e,s.length?s:null,r.length?r:null)}setMode(e){if("viewer"===(e=e.toLowerCase())){for(let e of this._arrDrwaingItem)e._setEditable(!1);this.fabricCanvas.discardActiveObject(),this.fabricCanvas.renderAll(),this.mode="viewer"}else{if("editor"!==e)throw new RangeError("Invalid value.");for(let e of this._arrDrwaingItem)e._setEditable(!0);this.mode="editor"}this._manager._switchPointerEvent()}getMode(){return this.mode}_setDimensions(e,t){this.fabricCanvas.setDimensions(e,t)}_setObjectFit(e){if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`Unsupported value '${e}'.`);this.fabricCanvas.lowerCanvasEl.style.objectFit=e,this.fabricCanvas.upperCanvasEl.style.objectFit=e}_getObjectFit(){return this.fabricCanvas.lowerCanvasEl.style.objectFit}renderAll(){for(let e of this._arrDrwaingItem){const t=this._getItemCurrentStyle(e);this._changeItemStyle(e,t,!0)}this.fabricCanvas.renderAll()}dispose(){this.clearDrawingItems(),1===this._manager._arrDrawingLayer.length&&(this.fabricCanvas.wrapperEl.style.pointerEvents="none",this.fabricCanvas.dispose(),this._arrDrwaingItem.length=0,this._arrFabricObject.length=0)}}gt.DDN_LAYER_ID=1,gt.DBR_LAYER_ID=2,gt.DLR_LAYER_ID=3,gt.USER_DEFINED_LAYER_BASE_ID=100,gt.TIP_LAYER_ID=999;class ut{constructor(){this._arrDrawingLayer=[]}createDrawingLayer(e,t){if(this.getDrawingLayer(t))throw new Error("Existed drawing layer id.");const i=new gt(e,t,{enableRetinaScaling:!1});return i._manager=this,this._arrDrawingLayer.push(i),this._switchPointerEvent(),i}deleteDrawingLayer(e){const t=this.getDrawingLayer(e);if(!t)return;const i=this._arrDrawingLayer;t.dispose(),i.splice(i.indexOf(t),1),this._switchPointerEvent()}clearDrawingLayers(){for(let e of this._arrDrawingLayer)e.dispose();this._arrDrawingLayer.length=0}getDrawingLayer(e){for(let t of this._arrDrawingLayer)if(t.getId()===e)return t;return null}getAllDrawingLayers(){return Array.from(this._arrDrawingLayer)}getSelectedDrawingItems(){if(!this._arrDrawingLayer.length)return;const e=this._arrDrawingLayer[0].fabricCanvas.getActiveObjects(),t=[];for(let i of e)t.push(i.getDrawingItem());return t}setDimensions(e,t){this._arrDrawingLayer.length&&this._arrDrawingLayer[0]._setDimensions(e,t)}setObjectFit(e){for(let t of this._arrDrawingLayer)t&&t._setObjectFit(e)}getObjectFit(){return this._arrDrawingLayer.length?this._arrDrawingLayer[0]._getObjectFit():null}setVisible(e){this._arrDrawingLayer.length&&(this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.display=e?"block":"none")}_switchPointerEvent(){if(this._arrDrawingLayer.length)for(let e of this._arrDrawingLayer)e.getMode()}}class mt extends Se{constructor(e,t,i,s,r){super(e,{x:t,y:i,width:s,height:0},r),xe.set(this,void 0),Fe.set(this,void 0),this._fabricObject.paddingTop=15,this._fabricObject.calcTextHeight=function(){for(var e=0,t=0,i=this._textLines.length;t<i;t++)e+=this.getHeightOfLine(t);return e+=2*this.paddingTop},this._fabricObject._getTopOffset=function(){return-this.height/2+this.getHeightOfLine(0)*(1-1/this.lineHeight)/2+this.paddingTop},this.set("backgroundColor","rgba(50, 50, 52, .8)"),this.set("lineHeight",1.3),this.set("textAlign","center")}setDuration(e){b(this,xe,e,"f"),S(this,Fe,"f")&&clearTimeout(S(this,Fe,"f")),S(this,xe,"f")>=0&&b(this,Fe,setTimeout((()=>{this.set("visible",!1),this._drawingLayer&&this._drawingLayer.renderAll()}),S(this,xe,"f")),"f")}getDuration(){return S(this,xe,"f")}}xe=new WeakMap,Fe=new WeakMap;class wt{constructor(){De.add(this),Re.set(this,void 0),Me.set(this,void 0),Oe.set(this,void 0),Pe.set(this,!0),this._drawingLayersManager=new ut}createDrawingLayerBaseCvs(e,t,i="contain"){if("number"!=typeof e||e<=1)throw new Error("Invalid 'width'.");if("number"!=typeof t||t<=1)throw new Error("Invalid 'height'.");if(!["contain","cover"].includes(i))throw new Error("Unsupported 'objectFit'.");const s=document.createElement("canvas");return s.width==e&&s.height==t||(s.width=e,s.height=t),s.style.objectFit=i,s}_createDrawingLayer(e,t,i,s){if(!this._layerBaseCvs){let e;try{e=this.getContentDimensions()}catch(e){if("Invalid content dimensions."!==(e.message||e))throw e}t||(t=(null==e?void 0:e.width)||1280),i||(i=(null==e?void 0:e.height)||720),s||(s=(null==e?void 0:e.objectFit)||"contain"),this._layerBaseCvs=this.createDrawingLayerBaseCvs(t,i,s)}const r=this._layerBaseCvs,n=this._drawingLayersManager.createDrawingLayer(r,e);return this._innerComponent.getElement("drawing-layer")||this._innerComponent.setElement("drawing-layer",r.parentElement),n}createDrawingLayer(){let e;for(let t=gt.USER_DEFINED_LAYER_BASE_ID;;t++)if(!this._drawingLayersManager.getDrawingLayer(t)&&t!==gt.TIP_LAYER_ID){e=t;break}return this._createDrawingLayer(e)}deleteDrawingLayer(e){var t;this._drawingLayersManager.deleteDrawingLayer(e),this._drawingLayersManager.getAllDrawingLayers().length||(null===(t=this._innerComponent)||void 0===t||t.removeElement("drawing-layer"),this._layerBaseCvs=null)}deleteUserDefinedDrawingLayer(e){if("number"!=typeof e)throw new TypeError("Invalid id.");if(e<gt.USER_DEFINED_LAYER_BASE_ID)throw new Error(`The drawing layer with id ${e} is not defined by users.`);this.deleteDrawingLayer(e)}_clearDrawingLayers(){const e=this.getAllDrawingLayers();for(let t of e)this.deleteDrawingLayer(t.getId())}clearUserDefinedDrawingLayers(){const e=this.getAllDrawingLayers();for(let t of e){const e=t.getId();e<gt.USER_DEFINED_LAYER_BASE_ID||this.deleteUserDefinedDrawingLayer(e)}}getDrawingLayer(e){if(e==gt.TIP_LAYER_ID)return null;const t=this._drawingLayersManager.getDrawingLayer(e);return t||([gt.DDN_LAYER_ID,gt.DBR_LAYER_ID,gt.DLR_LAYER_ID].includes(e)?this._createDrawingLayer(e):null)}getAllDrawingLayers(){return this._drawingLayersManager.getAllDrawingLayers().filter((e=>e.getId()>=0&&e.getId()!==gt.TIP_LAYER_ID))}updateDrawingLayers(e){((e,t,i)=>{if(!(e<=1||t<=1)){if(!["contain","cover"].includes(i))throw new Error("Unsupported 'objectFit'.");this._drawingLayersManager.setDimensions({width:e,height:t},{backstoreOnly:!0}),this._drawingLayersManager.setObjectFit(i)}})(e.width,e.height,e.objectFit)}getSelectedDrawingItems(){return this._drawingLayersManager.getSelectedDrawingItems()}setTipConfig(e){if(!(z(t=e)&&$(t.topLeftPoint)&&N(t.width))||t.width<=0||!N(t.duration)||"coordinateBase"in t&&!["view","image"].includes(t.coordinateBase))throw new Error("Invalid tip config.");var t;b(this,Re,JSON.parse(JSON.stringify(e)),"f"),S(this,Re,"f").coordinateBase||(S(this,Re,"f").coordinateBase="view"),b(this,Oe,e.duration,"f"),S(this,De,"m",We).call(this)}getTipConfig(){return S(this,Re,"f")?S(this,Re,"f"):null}setTipVisible(e){if("boolean"!=typeof e)throw new TypeError("Invalid value.");this._tip&&(this._tip.set("visible",e),this._drawingLayerOfTip&&this._drawingLayerOfTip.renderAll()),b(this,Pe,e,"f")}isTipVisible(){return S(this,Pe,"f")}updateTipMessage(e){if(!S(this,Re,"f"))throw new Error("Tip config is not set.");this._tipStyleId||(this._tipStyleId=ft.createDrawingStyle({fillStyle:"#FFFFFF",paintMode:"fill",fontFamily:"Open Sans",fontSize:40})),this._drawingLayerOfTip||(this._drawingLayerOfTip=this._drawingLayersManager.getDrawingLayer(gt.TIP_LAYER_ID)||this._createDrawingLayer(gt.TIP_LAYER_ID)),this._tip?this._tip.set("text",e):this._tip=S(this,De,"m",Be).call(this,e,S(this,Re,"f").topLeftPoint.x,S(this,Re,"f").topLeftPoint.y,S(this,Re,"f").width,S(this,Re,"f").coordinateBase,this._tipStyleId),S(this,De,"m",ke).call(this,this._tip,this._drawingLayerOfTip),this._tip.set("visible",S(this,Pe,"f")),this._drawingLayerOfTip&&this._drawingLayerOfTip.renderAll(),S(this,Me,"f")&&clearTimeout(S(this,Me,"f")),S(this,Oe,"f")>=0&&b(this,Me,setTimeout((()=>{S(this,De,"m",Ne).call(this)}),S(this,Oe,"f")),"f")}}Re=new WeakMap,Me=new WeakMap,Oe=new WeakMap,Pe=new WeakMap,De=new WeakSet,Be=function(e,t,i,s,r,n){const a=new mt(e,t,i,s,n);return a.coordinateBase=r,a},ke=function(e,t){t.hasDrawingItem(e)||t.addDrawingItems([e])},Ne=function(){this._tip&&this._drawingLayerOfTip.removeDrawingItems([this._tip])},We=function(){if(!this._tip)return;const e=S(this,Re,"f");this._tip.coordinateBase=e.coordinateBase,this._tip.setTextRect({x:e.topLeftPoint.x,y:e.topLeftPoint.y,width:e.width,height:0}),this._tip.set("width",this._tip.get("width")),this._tip._drawingLayer&&this._tip._drawingLayer.renderAll()};class pt extends HTMLElement{constructor(){super(),Ve.set(this,void 0);const e=document.createElement("template").content,t=document.createElement("div");t.setAttribute("class","wrapper"),e.appendChild(t),b(this,Ve,t,"f");const i=document.createElement("slot");i.setAttribute("name","single-frame-input-container"),t.append(i);const s=document.createElement("slot");s.setAttribute("name","content"),t.append(s);const r=document.createElement("slot");r.setAttribute("name","drawing-layer"),t.append(r);const n=document.createElement("style");n.textContent='\n.wrapper {\n  position: relative;\n  width: 100%;\n  height: 100%;\n}\n::slotted(canvas[slot="content"]) {\n  object-fit: contain;\n  pointer-events: none;\n}\n::slotted(div[slot="single-frame-input-container"]) {\n  width: 1px;\n  height: 1px;\n  overflow: hidden;\n  pointer-events: none;\n}\n::slotted(*) {\n  position: absolute;\n  left: 0;\n  top: 0;\n  width: 100%;\n  height: 100%;\n}\n    ',e.appendChild(n),this.attachShadow({mode:"open"}).appendChild(e.cloneNode(!0))}getWrapper(){return S(this,Ve,"f")}setElement(e,t){if(!(t instanceof HTMLElement))throw new TypeError("Invalid 'el'.");if(!["content","single-frame-input-container","drawing-layer"].includes(e))throw new TypeError("Invalid 'slot'.");this.removeElement(e),t.setAttribute("slot",e),this.appendChild(t)}getElement(e){if(!["content","single-frame-input-container","drawing-layer"].includes(e))throw new TypeError("Invalid 'slot'.");return this.querySelector(`[slot="${e}"]`)}removeElement(e){var t;if(!["content","single-frame-input-container","drawing-layer"].includes(e))throw new TypeError("Invalid 'slot'.");null===(t=this.querySelectorAll(`[slot="${e}"]`))||void 0===t||t.forEach((e=>e.remove()))}}Ve=new WeakMap,customElements.get("dce-component")||customElements.define("dce-component",pt);class _t extends HTMLElement{constructor(){super();const e=window._dce_default_template.content;this.attachShadow({mode:"open"}).appendChild(e.cloneNode(!0))}showScanLaser(){const e=this.shadowRoot.querySelector(".dce-scanlight");e&&(e.style.display="")}hideScanLaser(){const e=this.shadowRoot.querySelector(".dce-scanlight");e&&(e.style.display="none")}getElement(e){return this.shadowRoot.querySelector(e)}getVideoContainer(){return this.shadowRoot.querySelector(".dce-video-container")}getScanAreaEl(){return this.shadowRoot.querySelector(".dce-scanarea")}getScanLightEl(){return this.shadowRoot.querySelector(".dce-scanlight")}getLoadingBackgroundEl(){return this.shadowRoot.querySelector(".dce-bg-loading")}getCameraBackgroundEl(){return this.shadowRoot.querySelector(".dce-bg-camera")}getCameraSelectEl(){return this.shadowRoot.querySelector(".dce-sel-camera")}getResolutionSelectEl(){return this.shadowRoot.querySelector(".dce-sel-resolution")}getResolutionOptionEl(){return this.shadowRoot.querySelector(".dce-opt-gotResolution")}getCloseBtnEl(){return this.shadowRoot.querySelector(".dce-btn-close")}getDLRSelectEl(){return this.shadowRoot.querySelector(".dlr-sel-minletter")}getDLROptionEl(){return this.shadowRoot.querySelector(".dlr-opt-gotMinLtr")}}class yt extends wt{static get engineResourcePath(){return c.engineResourcePaths.dce}static set defaultUIElementURL(e){yt._defaultUIElementURL=e}static get defaultUIElementURL(){var e;return null===(e=yt._defaultUIElementURL)||void 0===e?void 0:e.replace("@engineResourcePath/",yt.engineResourcePath)}static async createInstance(e){customElements.get(yt.uiComponentName)||customElements.define(yt.uiComponentName,_t);const t=new yt;return await t.setUIElement(e||yt.defaultUIElementURL),t}static _transformCoordinates(e,t,i,s,r,n,a){const o=n/s,h=a/r;e.x=Math.round(e.x/o+t),e.y=Math.round(e.y/h+i)}set _singleFrameMode(e){if(!["disabled","image","camera"].includes(e))throw new Error("Invalid value.");e!==S(this,Xe,"f")&&(this._unbindUI(),b(this,Xe,e,"f"),this._bindUI())}get _singleFrameMode(){return S(this,Xe,"f")}get disposed(){return S(this,Qe,"f")}constructor(){super(),Ue.add(this),Ge.set(this,void 0),je.set(this,void 0),He.set(this,void 0),this.containerClassName="dce-video-container",Ye.set(this,void 0),this.videoFit="contain",this._hideDefaultSelection=!1,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,Ze.set(this,null),this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=6,ze.set(this,!1),Je.set(this,!1),Ke.set(this,{width:0,height:0}),this._updateLayersTimeout=500,this._videoResizeListener=()=>{S(this,Ue,"m",rt).call(this),this._updateLayersTimeoutId&&clearTimeout(this._updateLayersTimeoutId),this._updateLayersTimeoutId=setTimeout((()=>{this.disposed||(this.eventHandler.fire("videoEl:resized",null,{async:!1}),this.eventHandler.fire("content:updated",null,{async:!1}),this.isScanLaserVisible()&&S(this,Ue,"m",st).call(this))}),this._updateLayersTimeout)},this._windowResizeListener=()=>{yt._onLog&&yt._onLog("window resize event triggered."),S(this,Ke,"f").width===document.documentElement.clientWidth&&S(this,Ke,"f").height===document.documentElement.clientHeight||(S(this,Ke,"f").width=document.documentElement.clientWidth,S(this,Ke,"f").height=document.documentElement.clientHeight,this._videoResizeListener())},Xe.set(this,"disabled"),this._clickIptSingleFrameMode=()=>{if(!S(this,Ue,"m",$e).call(this))return;let e;if(this._singleFrameInputContainer)e=this._singleFrameInputContainer.firstElementChild;else{e=document.createElement("input"),e.setAttribute("type","file"),"camera"===this._singleFrameMode?(e.setAttribute("capture",""),e.setAttribute("accept","image/*")):"image"===this._singleFrameMode&&(e.removeAttribute("capture"),e.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp")),e.addEventListener("change",(async()=>{const t=e.files[0];e.value="";{const e=async e=>{let t=null,i=null;if("undefined"!=typeof createImageBitmap)try{if(t=await createImageBitmap(e),t)return t}catch(e){}var s;return t||(i=await(s=e,new Promise(((e,t)=>{let i=URL.createObjectURL(s),r=new Image;r.src=i,r.onload=()=>{URL.revokeObjectURL(r.src),e(r)},r.onerror=e=>{t(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}})))),i},i=(e,t,i,s)=>{e.width==i&&e.height==s||(e.width=i,e.height=s);const r=e.getContext("2d");r.clearRect(0,0,e.width,e.height),r.drawImage(t,0,0)},s=await e(t),r=s instanceof HTMLImageElement?s.naturalWidth:s.width,n=s instanceof HTMLImageElement?s.naturalHeight:s.height;let a=this._cvsSingleFrameMode;const o=null==a?void 0:a.width,h=null==a?void 0:a.height;a||(a=document.createElement("canvas"),this._cvsSingleFrameMode=a),i(a,s,r,n),this._innerComponent.setElement("content",a),o===a.width&&h===a.height||this.eventHandler.fire("content:updated",null,{async:!1})}this._onSingleFrameAcquired&&setTimeout((()=>{this._onSingleFrameAcquired(this._cvsSingleFrameMode)}),0)})),e.style.position="absolute",e.style.top="-9999px",e.style.backgroundColor="transparent",e.style.color="transparent";const t=document.createElement("div");t.append(e),this._innerComponent.setElement("single-frame-input-container",t),this._singleFrameInputContainer=t}null==e||e.click()},this.extraBindings=[],qe.set(this,[]),this._capturedResultReceiver={onCapturedResultReceived:(e,t)=>{var i,s,r,n;if(this.disposed)return;if(this.clearAllInnerDrawingItems(),!e)return;const a=e.originalImageTag;if(!a)return;const o=e.items;if(!(null==o?void 0:o.length))return;const h=(null===(i=a.cropRegion)||void 0===i?void 0:i.left)||0,l=(null===(s=a.cropRegion)||void 0===s?void 0:s.top)||0,d=(null===(r=a.cropRegion)||void 0===r?void 0:r.right)?a.cropRegion.right-h:a.originalWidth,c=(null===(n=a.cropRegion)||void 0===n?void 0:n.bottom)?a.cropRegion.bottom-l:a.originalHeight,g=a.currentWidth,u=a.currentHeight,m=(e,t,i,s,r,n,a,o,h=[],l)=>{t.forEach((e=>yt._transformCoordinates(e,i,s,r,n,a,o)));const d=new dt({points:[{x:t[0].x,y:t[0].y},{x:t[1].x,y:t[1].y},{x:t[2].x,y:t[2].y},{x:t[3].x,y:t[3].y}]},l);for(let e of h)d.addNote(e);e.addDrawingItems([d]),S(this,qe,"f").push(d)};let w,p;for(let e of o)switch(e.type){case f.CRIT_ORIGINAL_IMAGE:break;case f.CRIT_BARCODE:w=this.getDrawingLayer(gt.DBR_LAYER_ID),p=[{name:"format",content:e.formatString},{name:"text",content:e.text}],(null==t?void 0:t.isBarcodeVerifyOpen)?e.verified?m(w,e.location.points,h,l,d,c,g,u,p):m(w,e.location.points,h,l,d,c,g,u,p,ft.STYLE_ORANGE_STROKE_TRANSPARENT):m(w,e.location.points,h,l,d,c,g,u,p);break;case f.CRIT_TEXT_LINE:w=this.getDrawingLayer(gt.DLR_LAYER_ID),p=[{name:"text",content:e.text}],t.isLabelVerifyOpen?e.verified?m(w,e.location.points,h,l,d,c,g,u,p):m(w,e.location.points,h,l,d,c,g,u,p,ft.STYLE_GREEN_STROKE_TRANSPARENT):m(w,e.location.points,h,l,d,c,g,u,p);break;case f.CRIT_DETECTED_QUAD:w=this.getDrawingLayer(gt.DDN_LAYER_ID),(null==t?void 0:t.isDetectVerifyOpen)?e.verified?m(w,e.location.points,h,l,d,c,g,u,[]):m(w,e.location.points,h,l,d,c,g,u,[],ft.STYLE_BLUE_STROKE_TRANSPARENT):m(w,e.location.points,h,l,d,c,g,u,[]);break;case f.CRIT_NORMALIZED_IMAGE:w=this.getDrawingLayer(gt.DDN_LAYER_ID),(null==t?void 0:t.isNormalizeVerifyOpen)?e.verified?m(w,e.location.points,h,l,d,c,g,u,[]):m(w,e.location.points,h,l,d,c,g,u,[],ft.STYLE_BLUE_STROKE_TRANSPARENT):m(w,e.location.points,h,l,d,c,g,u,[]);break;case f.CRIT_PARSED_RESULT:break;default:throw new Error("Illegal item type.")}}},Qe.set(this,!1),this.eventHandler=new ae,this.eventHandler.on("content:updated",(()=>{S(this,Ge,"f")&&clearTimeout(S(this,Ge,"f")),b(this,Ge,setTimeout((()=>{if(this.disposed)return;let e;this._updateVideoContainer();try{e=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}this.updateDrawingLayers(e),this.updateConvertedRegion(e)}),0),"f")})),this.eventHandler.on("videoEl:resized",(()=>{S(this,je,"f")&&clearTimeout(S(this,je,"f")),b(this,je,setTimeout((()=>{this.disposed||this._updateVideoContainer()}),0),"f")}))}_setUIElement(e){e instanceof HTMLTemplateElement?(window._dce_default_template=e,this.UIElement=new _t):this.UIElement=e,this._unbindUI(),this._bindUI()}async setUIElement(e){let t;if(t="string"==typeof e?await de(e):e,t instanceof HTMLDivElement&&0==t.childElementCount){const e=await de(yt.defaultUIElementURL);e instanceof HTMLTemplateElement?(window._dce_default_template=e,t.append(new _t)):t.append(e),this._setUIElement(t)}else this._setUIElement(t)}getUIElement(){return this.UIElement}_bindUI(){var e;if(!this.UIElement)throw new Error("Need to set 'UIElement'.");if(this._innerComponent)return;let t,i=this.UIElement;if(i instanceof _t?t=i.getElement(`.${this.containerClassName}`):i instanceof HTMLDivElement&&1===i.childElementCount&&i.firstElementChild instanceof _t?(t=i.firstElementChild.getElement(`.${this.containerClassName}`),i=i.firstElementChild):t=i.classList.contains(this.containerClassName)?i:i.querySelector(`.${this.containerClassName}`),!t)throw Error(`Can not find the element with class '${this.containerClassName}'.`);if(this._innerComponent=new pt,t.appendChild(this._innerComponent),S(this,Ue,"m",$e).call(this));else{const e=document.createElement("video");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.objectFit=this.getVideoFit(),e.setAttribute("autoplay","true"),e.setAttribute("playsinline","true"),e.setAttribute("muted","true"),["iPhone","iPad","Mac"].includes(x.OS)&&e.setAttribute("poster","data:image/gif;base64,R0lGODlhAQABAIEAAAAAAAAAAAAAAAAAACH5BAEAAAAALAAAAAABAAEAAAgEAAEEBAA7"),b(this,Ye,e,"f");const t=document.createElement("div");t.append(e),t.style.overflow="hidden",this._videoContainer=t,this._innerComponent.setElement("content",t)}if(i instanceof _t?(this._selRsl=i.getElement(".dce-sel-resolution"),this._selMinLtr=i.getElement(".dlr-sel-minletter"),this._divScanArea=i.getElement(".dce-scanarea"),this._divScanLight=i.getElement(".dce-scanlight"),this._bgLoading=i.getElement(".dce-bg-loading"),this._bgCamera=i.getElement(".dce-bg-camera"),this._selCam=i.getElement(".dce-sel-camera"),this._optGotRsl=i.getElement(".dce-opt-gotResolution"),this._btnClose=i.getElement(".dce-btn-close"),this._optGotMinLtr=i.getElement(".dlr-opt-gotMinLtr")):(this._selRsl=i.querySelector(".dce-sel-resolution"),this._selMinLtr=i.querySelector(".dlr-sel-minletter"),this._divScanArea=i.querySelector(".dce-scanarea"),this._divScanLight=i.querySelector(".dce-scanlight"),this._bgLoading=i.querySelector(".dce-bg-loading"),this._bgCamera=i.querySelector(".dce-bg-camera"),this._selCam=i.querySelector(".dce-sel-camera"),this._optGotRsl=i.querySelector(".dce-opt-gotResolution"),this._btnClose=i.querySelector(".dce-btn-close"),this._optGotMinLtr=i.querySelector(".dlr-opt-gotMinLtr")),this._selRsl&&(this._hideDefaultSelection||S(this,Ue,"m",$e).call(this)||this._selRsl.options.length||(this._selRsl.innerHTML=['<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="1920" data-height="1080">ask 1920x1080</option>','<option data-width="1280" data-height="720">ask 1280x720</option>','<option data-width="640" data-height="480">ask 640x480</option>'].join(""),this._optGotRsl=this._selRsl.options[0])),this._selMinLtr&&(this._hideDefaultSelection||S(this,Ue,"m",$e).call(this)||this._selMinLtr.options.length||(this._selMinLtr.innerHTML=['<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="17">17+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._selMinLtr.options[0])),this.isScanLaserVisible()||S(this,Ue,"m",rt).call(this),S(this,Ue,"m",$e).call(this)||this._hideDefaultSelection?(S(this,Ue,"m",$e).call(this)&&(this._innerComponent&&(this._innerComponent.addEventListener("click",this._clickIptSingleFrameMode),this._innerComponent.setAttribute("title","Take a photo")),this._bgCamera&&(this._bgCamera.style.display="block")),this._selCam&&(this._selCam.style.display="none"),this._selRsl&&(this._selRsl.style.display="none"),this._selMinLtr&&(this._selMinLtr.style.display="none")):(this._selCam&&(this._selCam.style.display="block"),this._selRsl&&(this._selRsl.style.display="block"),this._selMinLtr&&(this._selMinLtr.style.display="block"),this._stopLoading()),window.ResizeObserver){this._resizeObserver||(this._resizeObserver=new ResizeObserver((e=>{var t;yt._onLog&&yt._onLog("resize observer triggered.");for(let i of e)i.target===(null===(t=this._innerComponent)||void 0===t?void 0:t.getWrapper())&&this._videoResizeListener()})));const t=null===(e=this._innerComponent)||void 0===e?void 0:e.getWrapper();t&&this._resizeObserver.observe(t)}S(this,Ke,"f").width=document.documentElement.clientWidth,S(this,Ke,"f").height=document.documentElement.clientHeight,window.addEventListener("resize",this._windowResizeListener)}_unbindUI(){var e,t,i,s;S(this,Ue,"m",$e).call(this)?(this._innerComponent&&(this._innerComponent.removeEventListener("click",this._clickIptSingleFrameMode),this._innerComponent.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._stopLoading(),S(this,Ue,"m",rt).call(this),null===(e=this._drawingLayersManager)||void 0===e||e.clearDrawingLayers(),null===(t=this._innerComponent)||void 0===t||t.removeElement("drawing-layer"),this._layerBaseCvs=null,this._drawingLayerOfMask=null,this._drawingLayerOfTip=null,null===(i=this._innerComponent)||void 0===i||i.remove(),this._innerComponent=null,b(this,Ye,null,"f"),null===(s=this._videoContainer)||void 0===s||s.remove(),this._videoContainer=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this._divScanArea=null,this._divScanLight=null,this._singleFrameInputContainer&&(this._singleFrameInputContainer.remove(),this._singleFrameInputContainer=null),window.ResizeObserver&&this._resizeObserver&&this._resizeObserver.disconnect(),window.removeEventListener("resize",this._windowResizeListener)}_startLoading(){this._bgLoading&&(this._bgLoading.style.display="",this._bgLoading.style.animationPlayState="")}_stopLoading(){this._bgLoading&&(this._bgLoading.style.display="none",this._bgLoading.style.animationPlayState="paused")}_renderCamerasInfo(e,t){if(!this._selCam)return;let i;this._selCam.textContent="";for(let s of t){const t=document.createElement("option");t.value=s.deviceId,t.innerText=s.label,this._selCam.append(t),s.deviceId&&e&&e.deviceId==s.deviceId&&(i=t)}this._selCam.value=i?i.value:""}_renderResolutionInfo(e){this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",e.width),this._optGotRsl.setAttribute("data-height",e.height),this._optGotRsl.innerText="got "+e.width+"x"+e.height,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got"))}getVideoElement(){return S(this,Ye,"f")}isVideoLoaded(){return!!S(this,Ye,"f")&&4==S(this,Ye,"f").readyState}setVideoFit(e){if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`Unsupported value '${e}'.`);if(this.videoFit=e,!S(this,Ye,"f"))return;if(S(this,Ye,"f").style.objectFit=e,S(this,Ue,"m",$e).call(this))return;let t;this._updateVideoContainer();try{t=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}S(this,Ue,"m",nt).call(this,t,this.getConvertedRegion()),this.updateDrawingLayers(t)}getVideoFit(){return this.videoFit}getContentDimensions(){var e,t,i,s;let r,n,a;if(S(this,Ue,"m",$e).call(this)?(r=null===(i=this._cvsSingleFrameMode)||void 0===i?void 0:i.width,n=null===(s=this._cvsSingleFrameMode)||void 0===s?void 0:s.height,a="contain"):(r=null===(e=S(this,Ye,"f"))||void 0===e?void 0:e.videoWidth,n=null===(t=S(this,Ye,"f"))||void 0===t?void 0:t.videoHeight,a=this.getVideoFit()),!r||!n)throw new Error("Invalid content dimensions.");return{width:r,height:n,objectFit:a}}updateConvertedRegion(e){const t=se.convert(this.scanRegion,e.width,e.height);b(this,Ze,t,"f"),S(this,He,"f")&&clearTimeout(S(this,He,"f")),b(this,He,setTimeout((()=>{let e;try{e=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}S(this,Ue,"m",et).call(this,e,t),S(this,Ue,"m",nt).call(this,e,t)}),0),"f")}getConvertedRegion(){return S(this,Ze,"f")}setScanRegion(e){if(null!=e&&!X(e)&&!te(e))throw TypeError("Invalid 'region'.");let t;this.scanRegion=e?JSON.parse(JSON.stringify(e)):null;try{t=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}this.updateConvertedRegion(t)}getScanRegion(){return JSON.parse(JSON.stringify(this.scanRegion))}getVisibleRegionOfVideo(e){if(!this.isVideoLoaded())throw new Error("The video is not loaded.");const t=S(this,Ye,"f").videoWidth,i=S(this,Ye,"f").videoHeight,s=this.getVideoFit(),{width:r,height:n}=this._innerComponent.getBoundingClientRect();if(r<=0||n<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");let a;const o={x:0,y:0,width:t,height:i,isMeasuredInPercentage:!1};if("cover"===s&&(r/n<t/i?(a=n/i,o.x=Math.floor((t-r/a)/2),o.y=0,o.width=Math.ceil(r/a),o.height=i):(a=r/t,o.x=0,o.y=Math.floor((i-n/a)/2),o.width=t,o.height=Math.ceil(n/a))),null==e?void 0:e.inPixels)return o;const h=o;return h.x=Math.ceil(h.x/i*100),h.y=Math.ceil(h.y/t*100),h.width=Math.floor(h.width/t*100),h.height=Math.floor(h.height/i*100),h.isMeasuredInPercentage=!0,o}setScanRegionMask(e,t,i,s){this._drawingLayerOfMask||(this._drawingLayerOfMask=this._createDrawingLayer(-2),this.isScanRegionMaskVisible()||S(this,Ue,"m",it).call(this)),this.clearScanRegionMask(),this._maskBackRectStyleId||(this._maskBackRectStyleId=ft.createDrawingStyle({paintMode:"fill",fillStyle:this.regionMaskFillStyle,lineWidth:0})),this._maskCenterRectStyleId||(this._maskCenterRectStyleId=ft.createDrawingStyle({paintMode:"stroke",strokeStyle:this.regionMaskStrokeStyle,lineWidth:this.regionMaskLineWidth}));const r=this._drawingLayerOfMask.width,n=this._drawingLayerOfMask.height,a=new we({x:0,y:0,width:r,height:n},this._maskBackRectStyleId),o=new we({x:-r/2,y:-n/2+t,width:e,height:s}),h=new we({x:-r/2+e+i,y:-n/2+t,width:r-e-i<0?0:r-e-i,height:s}),l=new we({x:-r/2,y:-n/2,width:r,height:t}),d=new we({x:-r/2,y:-n/2+t+s,width:r,height:n-t-s<0?0:n-t-s});o.set("strokeWidth",0),h.set("strokeWidth",0),l.set("strokeWidth",0),d.set("strokeWidth",0);const c=new ct([o,h,l,d])._getFabricObject();a.set("clipPath",c);const f=new we({x:e,y:t,width:i,height:s},this._maskCenterRectStyleId);this._drawingLayerOfMask.addDrawingItems([a,f])}clearScanRegionMask(){this._drawingLayerOfMask&&this._drawingLayerOfMask.clearDrawingItems()}deleteScanRegionMask(){this._drawingLayerOfMask&&this.deleteDrawingLayer(this._drawingLayerOfMask.getId())}_setScanRegionMaskVisible(e){b(this,ze,e,"f"),e?S(this,Ue,"m",tt).call(this):S(this,Ue,"m",it).call(this)}setScanRegionMaskVisible(e){this._setScanRegionMaskVisible(e),this._userSetMaskVisible=e}isScanRegionMaskVisible(){return S(this,ze,"f")}setScanRegionMaskStyle(e){if(!e)return;let t;e.fillStyle&&(this.regionMaskFillStyle=e.fillStyle),e.strokeStyle&&(this.regionMaskStrokeStyle=e.strokeStyle),e.lineWidth&&(this.regionMaskLineWidth=e.lineWidth),this._maskBackRectStyleId&&ft.updateDrawingStyle(this._maskBackRectStyleId,{fillStyle:this.regionMaskFillStyle}),this._maskCenterRectStyleId&&ft.updateDrawingStyle(this._maskCenterRectStyleId,{strokeStyle:this.regionMaskStrokeStyle,lineWidth:this.regionMaskLineWidth});try{t=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}S(this,Ue,"m",et).call(this,t,this.getConvertedRegion())}getScanRegionMaskStyle(){return{fillStyle:this.regionMaskFillStyle,strokeStyle:this.regionMaskStrokeStyle,lineWidth:this.regionMaskLineWidth}}_setScanLaserVisible(e){b(this,Je,e,"f"),e?S(this,Ue,"m",st).call(this):S(this,Ue,"m",rt).call(this)}setScanLaserVisible(e){this._setScanLaserVisible(e),this._userSetLaserVisible=e}isScanLaserVisible(){return S(this,Je,"f")}_updateVideoContainer(){if(!S(this,Ye,"f"))return;if(S(this,Ue,"m",$e).call(this))return;let e=1;const t=S(this,Ye,"f").style.transform.match(/scale\((.+)\)/);t&&(e=parseFloat(t[1]));const i=this._videoContainer;if("contain"===this.videoFit&&e>1){const e=S(this,Ye,"f").videoWidth,t=S(this,Ye,"f").videoHeight,{width:s,height:r}=this._innerComponent.getBoundingClientRect(),n=e/t;if(s/r<n){let e=s/n;i.style.left="0",i.style.top=(r-e)/2/r*100+"%",i.style.width="100%",i.style.height=e/r*100+"%"}else{let e=r*n;i.style.left=(s-e)/2/s*100+"%",i.style.top="0",i.style.width=e/s*100+"%",i.style.height="100%"}}else i.style.left="0",i.style.top="0",i.style.width="100%",i.style.height="100%"}updateLayers(){let e;this._updateVideoContainer();try{e=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}const t=this.getConvertedRegion();S(this,Ue,"m",nt).call(this,e,t),this.updateDrawingLayers(e),S(this,Ue,"m",et).call(this,e,t)}clearAllInnerDrawingItems(){S(this,qe,"f").forEach((e=>e.remove())),S(this,qe,"f").length=0}dispose(){this._unbindUI(),delete window._dce_default_template,this.__proto__=null;for(let e in this)delete this[e];Object.defineProperty(this,"disposed",{value:!0})}}Ge=new WeakMap,je=new WeakMap,He=new WeakMap,Ye=new WeakMap,Ze=new WeakMap,ze=new WeakMap,Je=new WeakMap,Ke=new WeakMap,Xe=new WeakMap,qe=new WeakMap,Qe=new WeakMap,Ue=new WeakSet,$e=function(){return"disabled"!==this._singleFrameMode},et=function(e,t){t&&(0!==t.x||0!==t.y||t.width!==e.width||t.height!==e.height)?this.setScanRegionMask(t.x,t.y,t.width,t.height):this.clearScanRegionMask()},tt=function(){this._drawingLayerOfMask&&this._drawingLayerOfMask.setVisible(!0)},it=function(){this._drawingLayerOfMask&&this._drawingLayerOfMask.setVisible(!1)},st=function(){this._divScanLight&&"none"==this._divScanLight.style.display&&(this._divScanLight.style.display="block")},rt=function(){this._divScanLight&&(this._divScanLight.style.display="none")},nt=function(e,t){if(!this._divScanArea)return;if(!this._innerComponent.getElement("content"))return;const{width:i,height:s,objectFit:r}=e;t||(t={x:0,y:0,width:i,height:s});const{width:n,height:a}=this._innerComponent.getBoundingClientRect();if(n<=0||a<=0)return;const o=n/a,h=i/s;let l,d,c,f,g=1;if("contain"===r)o<h?(g=n/i,l=0,d=(a-s*g)/2):(g=a/s,l=(n-i*g)/2,d=0),l+=t.x*g,d+=t.y*g,c=t.width*g,f=t.height*g;else if("cover"===r)if(o<h){g=a/s,l=t.x*g-(i*g-n)/2,l=Math.max(l,0),l=Math.min(l,n),d=t.y*g;let e=(t.x+t.width)*g-(i*g-n)/2;e=Math.max(e,0),e=Math.min(e,n),c=e-l,f=t.height*g}else{g=n/i,l=t.x*g,d=t.y*g-(s*g-a)/2,d=Math.max(d,0),d=Math.min(d,a);let e=(t.y+t.height)*g-(s*g-a)/2;e=Math.max(e,0),e=Math.min(e,a),c=t.width*g,f=e-d}else l=0,d=0,c=0,f=0;this._divScanArea.style.left=l+"px",this._divScanArea.style.top=d+"px",this._divScanArea.style.width=c+"px",this._divScanArea.style.height=f+"px"},yt.uiComponentName="default-camera-view",yt._defaultUIElementURL="@engineResourcePath/dce.ui.html";class vt extends wt{static async createInstance(e){const t=new vt;return await t.setUIElement(e||S(t,at,"m",lt).call(t)),t}get disposed(){return S(this,ht,"f")}constructor(){super(),at.add(this),this.containerClassName="dce-image-container",ot.set(this,void 0),ht.set(this,!1)}_setUIElement(e){this.UIElement=e,this._unbindUI(),this._bindUI()}async setUIElement(e){let t;if(t="string"==typeof e?await de(e):e,t instanceof HTMLDivElement&&0==t.childElementCount){const e=S(this,at,"m",lt).call(this);this._setUIElement(e),t.append(this.getUIElement()),this.UIElement=t}else this._setUIElement(t)}getUIElement(){return this.UIElement}_bindUI(){if(!this.UIElement)throw new Error("Need to set 'UIElement'.");if(this._innerComponent)return;const e=this.UIElement;let t=e.classList.contains(this.containerClassName)?e:e.querySelector(`.${this.containerClassName}`);t||(t=document.createElement("div"),t.style.width="100%",t.style.height="100%",t.className=this.containerClassName,e.append(t)),this._innerComponent=new pt,t.appendChild(this._innerComponent)}_unbindUI(){var e,t,i;null===(e=this._drawingLayersManager)||void 0===e||e.clearDrawingLayers(),null===(t=this._innerComponent)||void 0===t||t.removeElement("drawing-layer"),this._layerBaseCvs=null,null===(i=this._innerComponent)||void 0===i||i.remove(),this._innerComponent=null}setImage(e,t,i){if(!this._innerComponent)throw new Error("Need to set 'UIElement'.");let s=this._innerComponent.getElement("content");s||(s=document.createElement("canvas"),s.style.objectFit="contain",this._innerComponent.setElement("content",s)),s.width===t&&s.height===i||(s.width=t,s.height=i);const r=s.getContext("2d");r.clearRect(0,0,s.width,s.height),e instanceof Uint8Array||e instanceof Uint8ClampedArray?(e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),r.putImageData(new ImageData(e,t,i),0,0)):(e instanceof HTMLCanvasElement||e instanceof HTMLImageElement)&&r.drawImage(e,0,0)}getImage(){return this._innerComponent.getElement("content")}clearImage(){if(!this._innerComponent)return;let e=this._innerComponent.getElement("content");e&&e.getContext("2d").clearRect(0,0,e.width,e.height)}removeImage(){this._innerComponent&&this._innerComponent.removeElement("content")}setOriginalImage(e){if(K(e)){b(this,ot,e,"f");const{width:t,height:i,bytes:s,format:r}=Object.assign({},e);let n;if(r===d.IPF_GRAYSCALED){n=new Uint8ClampedArray(t*i*4);for(let e=0;e<n.length;e+=4)n[e]=s[e/4],n[e+1]=s[e/4],n[e+2]=s[e/4],n[e+3]=255}else n=new Uint8ClampedArray(s.buffer);this.setImage(n,t,i)}else if(e instanceof HTMLCanvasElement)b(this,ot,e,"f"),this.setImage(e,e.width,e.height);else{if(!(e instanceof HTMLImageElement))throw new TypeError("Invalid img.");b(this,ot,e,"f"),this.setImage(e,e.naturalWidth,e.naturalHeight)}let t;try{t=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}this.updateDrawingLayers(t)}getOriginalImage(){return S(this,ot,"f")}getContentDimensions(){let e,t,i;if(this._innerComponent){const s=this._innerComponent.getElement("content");e=null==s?void 0:s.width,t=null==s?void 0:s.height,i="contain"}if(!e||!t)throw new Error("Invalid content dimensions.");return{width:e,height:t,objectFit:i}}_createDrawingLayer(e,t,i,s){if(!this._layerBaseCvs){let e;try{e=this.getContentDimensions()}catch(e){if("Invalid content dimensions."!==(e.message||e))throw e}t||(t=(null==e?void 0:e.width)||300),i||(i=(null==e?void 0:e.height)||150),s||(s=(null==e?void 0:e.objectFit)||"contain"),this._layerBaseCvs=this.createDrawingLayerBaseCvs(t,i,s)}const r=this._layerBaseCvs,n=this._drawingLayersManager.createDrawingLayer(r,e);return this._innerComponent.getElement("drawing-layer")||this._innerComponent.setElement("drawing-layer",r.parentElement),e!=gt.TIP_LAYER_ID&&n.setMode("editor"),n}dispose(){this._unbindUI(),this.__proto__=null;for(let e in this)delete this[e];Object.defineProperty(this,"disposed",{value:!0})}}function Et(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)}function It(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i}ot=new WeakMap,ht=new WeakMap,at=new WeakSet,lt=function(){const e=document.createElement("div");return e.className=this.containerClassName,e.style.width="100%",e.style.height="100%",e},"function"==typeof SuppressedError&&SuppressedError;const St="undefined"==typeof self;let bt,Ct,Tt,Lt,At;function xt(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)}function Ft(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i}"undefined"!=typeof navigator&&(bt=navigator,Ct=bt.userAgent,Tt=bt.platform,Lt=bt.mediaDevices),function(){if(!St){const e={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:bt.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},t={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:Tt,search:"Win"},Mac:{str:Tt},Linux:{str:Tt}};let i="unknownBrowser",s=0,r="unknownOS";for(let t in e){const r=e[t]||{};let n=r.str||Ct,a=r.search||t,o=r.verStr||Ct,h=r.verSearch||t;if(h instanceof Array||(h=[h]),-1!=n.indexOf(a)){i=t;for(let e of h){let t=o.indexOf(e);if(-1!=t){s=parseFloat(o.substring(t+e.length+1));break}}break}}for(let e in t){const i=t[e]||{};let s=i.str||Ct,n=i.search||e;if(-1!=s.indexOf(n)){r=e;break}}"Linux"==r&&-1!=Ct.indexOf("Windows NT")&&(r="HarmonyOS"),At={browser:i,version:s,OS:r}}St&&(At={browser:"ssr",version:0,OS:"ssr"})}(),"undefined"!=typeof WebAssembly&&Ct&&(!/Safari/.test(Ct)||/Chrome/.test(Ct)||/\(.+\s11_2_([2-6]).*\)/.test(Ct)),Lt&&Lt.getUserMedia,"Chrome"===At.browser&&At.version>66||"Safari"===At.browser&&At.version>13||"OPR"===At.browser&&At.version>43||"Edge"===At.browser&&At.version,"function"==typeof SuppressedError&&SuppressedError;class Dt{static multiply(e,t){const i=[];for(let s=0;s<3;s++){const r=t.slice(3*s,3*s+3);for(let t=0;t<3;t++){const s=[e[t],e[t+3],e[t+6]].reduce(((e,t,i)=>e+t*r[i]),0);i.push(s)}}return i}static identity(){return[1,0,0,0,1,0,0,0,1]}static translate(e,t,i){return Dt.multiply(e,[1,0,0,0,1,0,t,i,1])}static rotate(e,t){var i=Math.cos(t),s=Math.sin(t);return Dt.multiply(e,[i,-s,0,s,i,0,0,0,1])}static scale(e,t,i){return Dt.multiply(e,[t,0,0,0,i,0,0,0,1])}}var Rt,Mt,Ot,Pt,Bt,kt,Nt,Wt,Vt;!function(e){e.GREY="grey",e.GREY32="grey32",e.RGBA="rgba",e.RBGA="rbga",e.GRBA="grba",e.GBRA="gbra",e.BRGA="brga",e.BGRA="bgra"}(Rt||(Rt={}));class Ut{static get version(){return"1.1.1-0"}static checkWebGLSupport(){return null===document.createElement("canvas").getContext("webgl")?(Ft(Ut,Mt,!1,"f",Ot),!1):(Ft(Ut,Mt,!0,"f",Ot),!0)}get disposed(){return xt(this,Vt,"f")}constructor(){Pt.set(this,Rt.RGBA),Bt.set(this,null),kt.set(this,null),Nt.set(this,null),this.useWebGLByDefault=!0,this._reusedCvs=null,this._reusedWebGLCvs=null,Wt.set(this,null),Vt.set(this,!1)}drawImage(e,t,i,s,r,n){if(this.disposed)throw Error("The 'ImageDataGetter' instance has been disposed.");if(!i||!s)throw new Error("Invalid 'sourceWidth' or 'sourceHeight'.");if(null==xt(Ut,Mt,"f",Ot)&&Ut.checkWebGLSupport(),(null==n?void 0:n.bUseWebGL)&&!xt(Ut,Mt,"f",Ot))throw new Error("Your browser or machine may not support WebGL.");if(t instanceof HTMLVideoElement&&4!==t.readyState||t instanceof HTMLImageElement&&!t.complete)throw new Error("The source is not loaded.");let a;Ut._onLog&&(a=Date.now(),Ut._onLog("drawImage(), START: "+a));let o=0,h=0,l=i,d=s,c=0,f=0,g=i,u=s;r&&(r.sx&&(o=Math.round(r.sx)),r.sy&&(h=Math.round(r.sy)),r.sWidth&&(l=Math.round(r.sWidth)),r.sHeight&&(d=Math.round(r.sHeight)),r.dx&&(c=Math.round(r.dx)),r.dy&&(f=Math.round(r.dy)),r.dWidth&&(g=Math.round(r.dWidth)),r.dHeight&&(u=Math.round(r.dHeight)));let m,w=Rt.RGBA;if((null==n?void 0:n.pixelFormat)&&(w=n.pixelFormat),(null==n?void 0:n.bufferContainer)&&(m=n.bufferContainer,m.length<4*g*u))throw new Error("Unexpected size of the 'bufferContainer'.");const p=e;if(!xt(Ut,Mt,"f",Ot)||!(this.useWebGLByDefault&&null==(null==n?void 0:n.bUseWebGL)||(null==n?void 0:n.bUseWebGL))){Ut._onLog&&Ut._onLog("drawImage() in context2d."),p.ctx2d||(p.ctx2d=p.getContext("2d",{willReadFrequently:!0}));const e=p.ctx2d;if(!e)throw new Error("Unable to get 'CanvasRenderingContext2D' from canvas.");return(p.width<c+g||p.height<f+u)&&(p.width=c+g,p.height=f+u),e.drawImage(t,o,h,l,d,c,f,g,u),Ut._onLog&&Ut._onLog("drawImage() in context2d end. Costs: "+(Date.now()-a)),{context:e,pixelFormat:Rt.RGBA,bUseWebGL:!1}}Ut._onLog&&Ut._onLog("drawImage() in WebGL.");try{(p.width<c+g||p.height<f+u)&&(p.width=c+g,p.height=f+u,p.ctxWebGL&&p.ctxWebGL.viewport(0,0,c+g,f+u));const e=p.ctxWebGL||p.getContext("webgl",{antialias:!1})||p.getContext("experimental-webgl",{antialias:!1});if(!e){Ut._onLog&&Ut._onLog("Browser or machine may not support WebGL, or the canvas has already been set to a different context mode.");const e=new Error("Unable to get 'WebGLRenderingContext'. Your browser or machine may not support WebGL, or the canvas has already been set to a different context mode.");throw e.name="WebGLError",e}if(!p.ctxWebGL||w!==xt(this,Pt,"f")){p.ctxWebGL=e;const t=e=>{const t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW);const i=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW),{positions:t,texCoords:i}},i=e=>{const t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t},s=(e,t)=>{const i=e.createProgram();if(t.forEach((t=>e.attachShader(i,t))),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS)){const t=new Error(`An error occured linking the program: ${e.getProgramInfoLog(i)}.`);throw t.name="WebGLError",t}return e.useProgram(i),i},r=(e,t,i)=>{const s=e.createShader(t);if(e.shaderSource(s,i),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const t=new Error(`An error occured compiling the shader: ${e.getShaderInfoLog(s)}.`);throw t.name="WebGLError",t}return s},n="\n                  attribute vec2 a_position;\n                  attribute vec2 a_texCoord;\n  \n                  uniform mat3 u_matrix;\n                  uniform mat3 u_textureMatrix;\n  \n                  varying vec2 v_texCoord;\n                  void main(void) {\n                  gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1.0);\n                  v_texCoord = vec4((u_textureMatrix * vec3(a_texCoord, 1)).xy, 0, 1.0).xy;\n                  }\n              ";let a="rgb";["rgba","rbga","grba","gbra","brga","bgra"].includes(w)&&(a=w.slice(0,3));const o=`\n                  precision mediump float;\n                  varying vec2 v_texCoord;\n                  uniform sampler2D u_image;\n                  uniform float uColorFactor;\n  \n                  void main() {\n                      vec4 sample = texture2D(u_image, v_texCoord);\n                      float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                      gl_FragColor = vec4(sample.${a} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                  }\n              `,h=s(e,[r(e,e.VERTEX_SHADER,n),r(e,e.FRAGMENT_SHADER,o)]);Ft(this,kt,{program:h,attribLocations:{vertexPosition:e.getAttribLocation(h,"a_position"),texPosition:e.getAttribLocation(h,"a_texCoord")},uniformLocations:{uSampler:e.getUniformLocation(h,"u_image"),uColorFactor:e.getUniformLocation(h,"uColorFactor"),uMatrix:e.getUniformLocation(h,"u_matrix"),uTextureMatrix:e.getUniformLocation(h,"u_textureMatrix")}},"f"),Ft(this,Nt,t(e),"f"),Ft(this,Bt,i(e),"f"),Ft(this,Pt,w,"f")}const r=(e,t,i)=>{e.bindBuffer(e.ARRAY_BUFFER,t),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0)},n=(e,t,i)=>{const s=e.RGBA,r=e.RGBA,n=e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,s,r,n,i)},_=(e,t,n,a)=>{e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),r(e,n.positions,t.attribLocations.vertexPosition),r(e,n.texCoords,t.attribLocations.texPosition),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,a),e.uniform1i(t.uniformLocations.uSampler,0),e.uniform1f(t.uniformLocations.uColorFactor,[Rt.GREY,Rt.GREY32].includes(w)?1:0);let m,p,_=Dt.translate(Dt.identity(),-1,-1);_=Dt.scale(_,2,2),_=Dt.scale(_,1/e.canvas.width,1/e.canvas.height),m=Dt.translate(_,c,f),m=Dt.scale(m,g,u),e.uniformMatrix3fv(t.uniformLocations.uMatrix,!1,m),p=Dt.translate(Dt.identity(),o/i,h/s),p=Dt.scale(p,l/i,d/s),e.uniformMatrix3fv(t.uniformLocations.uTextureMatrix,!1,p),e.drawArrays(e.TRIANGLES,0,6)};n(e,xt(this,Bt,"f"),t),_(e,xt(this,kt,"f"),xt(this,Nt,"f"),xt(this,Bt,"f"));const y=m||new Uint8Array(4*g*u);if(e.readPixels(c,f,g,u,e.RGBA,e.UNSIGNED_BYTE,y),255!==y[3]){Ut._onLog&&Ut._onLog("Incorrect WebGL drawing .");const e=new Error("WebGL error: incorrect drawing.");throw e.name="WebGLError",e}return Ut._onLog&&Ut._onLog("drawImage() in WebGL end. Costs: "+(Date.now()-a)),{context:e,pixelFormat:w===Rt.GREY?Rt.GREY32:w,bUseWebGL:!0}}catch(a){if(this.forceLoseContext(),console.log(a),null==(null==n?void 0:n.bUseWebGL))return Ut._onLog&&Ut._onLog("'drawImage()' in WebGL failed, try again in context2d."),this.useWebGLByDefault=!1,this.drawImage(e,t,i,s,r,Object.assign({},n,{bUseWebGL:!1}));throw a.name="WebGLError",a}}readCvsData(e,t,i){if(!(e instanceof CanvasRenderingContext2D||e instanceof WebGLRenderingContext))throw new Error("Invalid 'context'.");let s,r=0,n=0,a=e.canvas.width,o=e.canvas.height;if(t&&(t.x&&(r=t.x),t.y&&(n=t.y),t.width&&(a=t.width),t.height&&(o=t.height)),(null==i?void 0:i.length)<4*a*o)throw new Error("Unexpected size of the 'bufferContainer'.");if(e instanceof WebGLRenderingContext){const t=e;i?(t.readPixels(r,n,a,o,t.RGBA,t.UNSIGNED_BYTE,i),s=new Uint8Array(i.buffer,0,4*a*o)):(s=new Uint8Array(4*a*o),t.readPixels(r,n,a,o,t.RGBA,t.UNSIGNED_BYTE,s))}else if(e instanceof CanvasRenderingContext2D){let t;t=e.getImageData(r,n,a,o),s=new Uint8Array(t.data.buffer),null==i||i.set(s)}return s}transformPixelFormat(e,t,i,s){let r,n;if(Ut._onLog&&(r=Date.now(),Ut._onLog("transformPixelFormat(), START: "+r)),t===i)return Ut._onLog&&Ut._onLog("transformPixelFormat() end. Costs: "+(Date.now()-r)),s?new Uint8Array(e):e;const a=[Rt.RGBA,Rt.RBGA,Rt.GRBA,Rt.GBRA,Rt.BRGA,Rt.BGRA];if(a.includes(t))if(i===Rt.GREY){n=new Uint8Array(e.length/4);for(let t=0;t<e.length;t+=4){const i=.21*e[t]+.71*e[t+1]+.07*e[t+2];n[t/4]=i}}else if(i===Rt.GREY32){n=s?new Uint8Array(e):e;for(let t=0;t<e.length;t+=4){const i=.21*e[t]+.71*e[t+1]+.07*e[t+2];n[t]=i,n[t+1]=i,n[t+2]=i}}else{if(!a.includes(i))throw new Error("Unable to transform.");if(s){n=new Uint8Array(e);const s=t.indexOf("r"),r=t.indexOf("g"),a=t.indexOf("b"),o=i.indexOf("r"),h=i.indexOf("g"),l=i.indexOf("b");for(let t=0;t<e.length;t+=4)n[t+o]=e[t+s],n[t+h]=e[t+r],n[t+l]=e[t+a]}else{n=e;const s=t.indexOf("r"),r=t.indexOf("g"),a=t.indexOf("b"),o=i.indexOf("r"),h=i.indexOf("g"),l=i.indexOf("b");for(let t=0;t<e.length;t+=4){let i=[e[t],e[t+1],e[t+2]];n[t+o]=i[s],n[t+h]=i[r],n[t+l]=i[a]}}}else if(t===Rt.GREY){if(i!==Rt.GREY32)throw new Error("Unable to transform.");n=new Uint8Array(4*e.length);for(let t=0;t<e.length;t++)n[4*t]=e[t],n[4*t+1]=e[t],n[4*t+2]=e[t],n[4*t+3]=255}else{if(t!==Rt.GREY32)throw new Error("Unable to transform.");if(i!==Rt.GREY)throw new Error("Unable to transform.");n=new Uint8Array(e.length/4);for(let t=0;t<e.length;t+=4)n[t/4]=e[t]}return Ut._onLog&&Ut._onLog("transformPixelFormat() end. Costs: "+(Date.now()-r)),n}getImageData(e,t,i,s,r){if(this.disposed)throw Error("The 'ImageDataGetter' instance has been disposed.");if(!t||!i)throw new Error("Invalid 'sourceWidth' or 'sourceHeight'.");if(null==xt(Ut,Mt,"f",Ot)&&Ut.checkWebGLSupport(),(null==r?void 0:r.bUseWebGL)&&!xt(Ut,Mt,"f",Ot))throw new Error("Your browser or machine may not support WebGL.");if(s.sx>t||s.sy>i||s.sx+s.sWidth>t||s.sy+s.sHeight>i)throw new Error("Invalid position.");if(e instanceof HTMLVideoElement&&4!==e.readyState||e instanceof HTMLImageElement&&!e.complete)throw new Error("The source is not loaded.");let n;Ut._onLog&&(n=Date.now(),Ut._onLog("getImageData(), START: "+n));const a=Math.round(s.sx),o=Math.round(s.sy),h=Math.round(s.sWidth),l=Math.round(s.sHeight),d=Math.round(s.dWidth),c=Math.round(s.dHeight);let f=Rt.RGBA;(null==r?void 0:r.pixelFormat)&&(f=r.pixelFormat);let g,u,m,w=null;if((null==r?void 0:r.bufferContainer)&&(w=r.bufferContainer),xt(Ut,Mt,"f",Ot)&&(this.useWebGLByDefault&&null==(null==r?void 0:r.bUseWebGL)||(null==r?void 0:r.bUseWebGL))){Ut._onLog&&Ut._onLog("getImageData() in WebGL."),this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas")),g=this._reusedWebGLCvs;try{if(w)if(f===Rt.GREY){if(m=new Uint8Array(4*d*c),u=this.drawImage(g,e,t,i,{sx:a,sy:o,sWidth:h,sHeight:l,dWidth:d,dHeight:c},{pixelFormat:f,bUseWebGL:!0,bufferContainer:m}),m=this.transformPixelFormat(m,u.pixelFormat,f),w){if(w.length<m.length)throw new Error("Unexpected size of the 'bufferContainer'.");w.set(m)}}else u=this.drawImage(g,e,t,i,{sx:a,sy:o,sWidth:h,sHeight:l,dWidth:d,dHeight:c},{pixelFormat:f,bUseWebGL:!0,bufferContainer:w}),m=new Uint8Array(w.buffer,0,4*d*c),m=this.transformPixelFormat(m,u.pixelFormat,f);else f===Rt.GREY?((!xt(this,Wt,"f")||xt(this,Wt,"f").length<4*d*c)&&Ft(this,Wt,new Uint8Array(4*d*c),"f"),m=new Uint8Array(xt(this,Wt,"f").buffer,0,4*d*c)):m=new Uint8Array(4*d*c),u=this.drawImage(g,e,t,i,{sx:a,sy:o,sWidth:h,sHeight:l,dWidth:d,dHeight:c},{pixelFormat:f,bUseWebGL:!0,bufferContainer:m}),m=this.transformPixelFormat(m,u.pixelFormat,f)}catch(s){if("WebGLError"===s.name&&(this.forceLoseContext(),null==(null==r?void 0:r.bUseWebGL)))return Ut._onLog&&Ut._onLog("getImageData() in WebGL failed, try again in context2d."),this.useWebGLByDefault=!1,this.getImageData(e,t,i,{sx:a,sy:o,sWidth:h,sHeight:l,dWidth:d,dHeight:c},Object.assign({},r,{bUseWebGL:!1}));throw s}}else if(Ut._onLog&&Ut._onLog("getImageData() in context2d."),this._reusedCvs||(this._reusedCvs=document.createElement("canvas")),g=this._reusedCvs,u=this.drawImage(g,e,t,i,{sx:a,sy:o,sWidth:h,sHeight:l,dWidth:d,dHeight:c},{pixelFormat:Rt.RGBA,bUseWebGL:!1}),m=this.readCvsData(u.context,{width:d,height:c},null),m=this.transformPixelFormat(m,u.pixelFormat,f),w){if(w.length<m.length)throw new Error("Unexpected size of the 'bufferContainer'.");w.set(m)}return Ut._onLog&&Ut._onLog("getImageData() end. Costs: "+(Date.now()-n)),{data:m,pixelFormat:f,width:d,height:c,bUseWebGL:u.bUseWebGL}}convertDataToCvs(e,t,i,s){if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new TypeError("Invalid 'data'.");if("number"!=typeof t||t<=0)throw new Error("Invalid 'width'.");if("number"!=typeof i||i<=0)throw new Error("Invalid 'height'.");const r=document.createElement("canvas");let n;if(r.width=t,r.height=i,s===Rt.GREY){n=new Uint8ClampedArray(4*t*i);for(let t=0;t<n.length;t+=4)n[t]=e[t/4],n[t+1]=e[t/4],n[t+2]=e[t/4],n[t+3]=255}else n=new Uint8ClampedArray(e.buffer);const a=new ImageData(n,t,i);return r.getContext("2d").putImageData(a,0,0),r}forceLoseContext(){if(!this._reusedWebGLCvs)return;const e=this._reusedWebGLCvs.ctxWebGL;e&&!e.isContextLost()&&e.getExtension("WEBGL_lose_context")&&e.getExtension("WEBGL_lose_context").loseContext(),Ft(this,Bt,null,"f"),Ft(this,kt,null,"f"),Ft(this,Nt,null,"f"),this._reusedWebGLCvs=null}dispose(){this.forceLoseContext(),Ft(this,Vt,!0,"f")}}Mt=Ut,Pt=new WeakMap,Bt=new WeakMap,kt=new WeakMap,Nt=new WeakMap,Wt=new WeakMap,Vt=new WeakMap,Ot={value:void 0};var Gt,jt,Ht,Yt,Zt,zt,Jt,Kt,Xt,qt,Qt,$t,ei,ti,ii,si,ri,ni,ai,oi,hi,li,di,ci,fi,gi,ui,mi,wi,pi,_i,yi,vi,Ei,Ii,Si,bi,Ci,Ti,Li,Ai,xi,Fi;class Di{constructor(){Gt.set(this,new Map),jt.set(this,!1)}get disposed(){return Et(this,jt,"f")}on(e,t){e=e.toLowerCase();const i=Et(this,Gt,"f").get(e);if(i){if(i.includes(t))return;i.push(t)}else Et(this,Gt,"f").set(e,[t])}off(e,t){e=e.toLowerCase();const i=Et(this,Gt,"f").get(e);if(!i)return;const s=i.indexOf(t);-1!==s&&i.splice(s,1)}offAll(e){e=e.toLowerCase();const t=Et(this,Gt,"f").get(e);t&&(t.length=0)}async fire(e,t=[],i={async:!1,copy:!0}){t||(t=[]),e=e.toLowerCase();const s=Et(this,Gt,"f").get(e);if(s&&s.length){i=Object.assign({async:!1,copy:!0},i);for(let e of s){if(!e)continue;let s=[];if(i.copy)for(let e of t){try{e=JSON.parse(JSON.stringify(e))}catch(e){}s.push(e)}else s=t;let r=!1;if(i.async)setTimeout((()=>{this.disposed||e.apply(i.target,s)}),0);else try{r=await e.apply(i.target,s)}catch(e){}if(!0===r)break}}}dispose(){It(this,jt,!0,"f")}}Gt=new WeakMap,jt=new WeakMap;const Ri=(e,t,i,s)=>{if(!i)return e;let r=t+Math.round((e-t)/i)*i;return s&&(r=Math.min(r,s)),r};class Mi{static get version(){return"2.0.0"}static isStorageAvailable(e){let t;try{t=window[e];const i="__storage_test__";return t.setItem(i,i),t.removeItem(i),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}}static findBestRearCameraInIOS(e,t){if(!e||!e.length)return null;let i=!1;if((null==t?void 0:t.getMainCamera)&&(i=!0),i){const t=["후면 카메라","背面カメラ","後置鏡頭","后置相机","กล้องด้านหลัง","बैक कैमरा","الكاميرا الخلفية","מצלמה אחורית","камера на задней панели","задня камера","задна камера","артқы камера","πίσω κάμερα","zadní fotoaparát","zadná kamera","tylny aparat","takakamera","stražnja kamera","rückkamera","kamera på baksidan","kamera belakang","kamera bak","hátsó kamera","fotocamera (posteriore)","câmera traseira","câmara traseira","cámara trasera","càmera posterior","caméra arrière","cameră spate","camera mặt sau","camera aan achterzijde","bagsidekamera","back camera","arka kamera"],i=e.find((e=>t.includes(e.label.toLowerCase())));return null==i?void 0:i.deviceId}{const t=["후면","背面","後置","后置","านหลัง","बैक","خلفية","אחורית","задняя","задней","задна","πίσω","zadní","zadná","tylny","trasera","traseira","taka","stražnja","spate","sau","rück","posteriore","posterior","hátsó","belakang","baksidan","bakre","bak","bagside","back","aртқы","arrière","arka","achterzijde"],i=["트리플","三镜头","三鏡頭","トリプル","สาม","ट्रिपल","ثلاثية","משולשת","үштік","тройная","тройна","потроєна","τριπλή","üçlü","trójobiektywowy","trostruka","trojný","trojitá","trippelt","trippel","triplă","triple","tripla","tiga","kolmois","ba camera"],s=["듀얼 와이드","雙廣角","双广角","デュアル広角","คู่ด้านหลังมุมกว้าง","ड्युअल वाइड","مزدوجة عريضة","כפולה רחבה","қос кең бұрышты","здвоєна ширококутна","двойная широкоугольная","двойна широкоъгълна","διπλή ευρεία","çift geniş","laajakulmainen kaksois","kép rộng mặt sau","kettős, széles látószögű","grande angular dupla","ganda","dwuobiektywowy","dwikamera","dvostruka široka","duální širokoúhlý","duálna širokouhlá","dupla grande-angular","dublă","dubbel vidvinkel","dual-weitwinkel","dual wide","dual con gran angular","dual","double","doppia con grandangolo","doble","dobbelt vidvinkelkamera"],r=e.filter((e=>{const i=e.label.toLowerCase();return t.some((e=>i.includes(e)))}));if(!r.length)return null;const n=r.find((e=>{const t=e.label.toLowerCase();return i.some((e=>t.includes(e)))}));if(n)return n.deviceId;const a=r.find((e=>{const t=e.label.toLowerCase();return s.some((e=>t.includes(e)))}));return a?a.deviceId:r[0].deviceId}}static findBestRearCamera(e,t){if(!e||!e.length)return null;if(["iPhone","iPad","Mac"].includes(At.OS))return Mi.findBestRearCameraInIOS(e,{getMainCamera:null==t?void 0:t.getMainCameraInIOS});const i=["후","背面","背置","後面","後置","后面","后置","านหลัง","หลัง","बैक","خلفية","אחורית","задняя","задня","задней","задна","πίσω","zadní","zadná","tylny","trás","trasera","traseira","taka","stražnja","spate","sau","rück","rear","posteriore","posterior","hátsó","darrere","belakang","baksidan","bakre","bak","bagside","back","aртқы","arrière","arka","achterzijde"];for(let t of e){const e=t.label.toLowerCase();if(e&&i.some((t=>e.includes(t)))&&/\b0(\b)?/.test(e))return t.deviceId}return["Android","HarmonyOS"].includes(At.OS)?e[e.length-1].deviceId:null}static findBestCamera(e,t,i){return e&&e.length?"environment"===t?this.findBestRearCamera(e,i):"user"===t?null:t?void 0:null:null}static async playVideo(e,t,i){if(!e)throw new Error("Invalid 'videoEl'.");if(!t)throw new Error("Invalid 'source'.");return"string"==typeof t||t instanceof String?e.src=t:e.srcObject=t,new Promise(((t,s)=>{let r;const n=()=>{e.removeEventListener("loadstart",h),e.removeEventListener("abort",l),e.removeEventListener("play",d),e.removeEventListener("error",c)},a=()=>{r&&clearTimeout(r),n(),t(e)},o=e=>{r&&clearTimeout(r),n(),s(e)},h=()=>{e.addEventListener("abort",l,{once:!0})},l=()=>{const e=new Error("Video playing was interrupted.");e.name="AbortError",o(e)},d=()=>{a()},c=()=>{o(new Error(`Video error ${e.error.code}: ${e.error.message}.`))};e.addEventListener("loadstart",h,{once:!0}),e.autoplay&&["iPhone","iPad","Mac"].includes(At.OS)&&At.version>=17?(e.addEventListener("play",d,{once:!0}),e.addEventListener("error",c,{once:!0})):(e.load(),e.play().then((()=>{a()})).catch((e=>{o(e)}))),i&&(r=setTimeout((()=>{n(),s(new Error("Failed to play video. Timeout."))}),i))}))}static async testCameraAccess(e){var t,i;if(!(null===(i=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===i?void 0:i.getUserMedia))return{ok:!1,errorName:"InsecureContext",errorMessage:"Insecure context."};let s;try{s=e?await navigator.mediaDevices.getUserMedia(e):await navigator.mediaDevices.getUserMedia({video:!0})}catch(e){return{ok:!1,errorName:e.name,errorMessage:e.message}}finally{null==s||s.getTracks().forEach((e=>{e.stop()}))}return{ok:!0}}get state(){if(!Et(this,si,"f"))return"closed";if("pending"===Et(this,si,"f"))return"opening";if("fulfilled"===Et(this,si,"f"))return"opened";throw new Error("Unknown state.")}set ifSaveLastUsedCamera(e){e?Mi.isStorageAvailable("localStorage")?It(this,$t,!0,"f"):(It(this,$t,!1,"f"),console.warn("Local storage is unavailable")):It(this,$t,!1,"f")}get ifSaveLastUsedCamera(){return Et(this,$t,"f")}get isVideoPlaying(){return!(!Et(this,Zt,"f")||Et(this,Zt,"f").paused)&&"opened"===this.state}set tapFocusEventBoundEl(e){var t,i,s;if(!(e instanceof HTMLElement)&&null!=e)throw new TypeError("Invalid 'element'.");null===(t=Et(this,li,"f"))||void 0===t||t.removeEventListener("click",Et(this,hi,"f")),null===(i=Et(this,li,"f"))||void 0===i||i.removeEventListener("touchend",Et(this,hi,"f")),null===(s=Et(this,li,"f"))||void 0===s||s.removeEventListener("touchmove",Et(this,oi,"f")),It(this,li,e,"f"),e&&(window.TouchEvent&&["Android","HarmonyOS","iPhone","iPad"].includes(At.OS)?(e.addEventListener("touchend",Et(this,hi,"f")),e.addEventListener("touchmove",Et(this,oi,"f"))):e.addEventListener("click",Et(this,hi,"f")))}get tapFocusEventBoundEl(){return Et(this,li,"f")}get disposed(){return Et(this,_i,"f")}constructor(e){var t,i;Yt.add(this),Zt.set(this,null),zt.set(this,void 0),Jt.set(this,(()=>{"opened"===this.state&&Et(this,gi,"f").fire("resumed",null,{target:this,async:!0})})),Kt.set(this,(()=>{Et(this,gi,"f").fire("paused",null,{target:this,async:!1})})),Xt.set(this,void 0),qt.set(this,void 0),this.cameraOpenTimeout=4e3,this._arrCameras=[],Qt.set(this,void 0),$t.set(this,!1),this.ifSkipCameraInspection=!1,this.selectIOSRearMainCameraAsDefault=!1,ei.set(this,void 0),ti.set(this,!0),ii.set(this,void 0),si.set(this,void 0),ri.set(this,!1),this._focusParameters={maxTimeout:400,minTimeout:300,kTimeout:void 0,oldDistance:null,fds:null,isDoingFocus:0,taskBackToContinous:null,curFocusTaskId:0,focusCancelableTime:1500,defaultFocusAreaSizeRatio:6,focusBackToContinousTime:5e3,tapFocusMinDistance:null,tapFocusMaxDistance:null,focusArea:null,tempBufferContainer:null,defaultTempBufferContainerLenRatio:1/4},ni.set(this,!1),this._focusSupported=!0,this.calculateCoordInVideo=(e,t)=>{let i,s;const r=window.getComputedStyle(Et(this,Zt,"f")).objectFit,n=this.getResolution(),a=Et(this,Zt,"f").getBoundingClientRect(),o=a.left,h=a.top,{width:l,height:d}=Et(this,Zt,"f").getBoundingClientRect();if(l<=0||d<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");const c=l/d,f=n.width/n.height;let g=1;if("contain"===r)f>c?(g=l/n.width,i=(e-o)/g,s=(t-h-(d-l/f)/2)/g):(g=d/n.height,s=(t-h)/g,i=(e-o-(l-d*f)/2)/g);else{if("cover"!==r)throw new Error("Unsupported object-fit.");f>c?(g=d/n.height,s=(t-h)/g,i=(e-o+(d*f-l)/2)/g):(g=l/n.width,i=(e-o)/g,s=(t-h+(l/f-d)/2)/g)}return{x:i,y:s}},ai.set(this,!1),oi.set(this,(()=>{It(this,ai,!0,"f")})),hi.set(this,(async e=>{var t;if(Et(this,ai,"f"))return void It(this,ai,!1,"f");if(!Et(this,ni,"f"))return;if(!this.isVideoPlaying)return;if(!Et(this,zt,"f"))return;if(!this._focusSupported)return;if(!this._focusParameters.fds&&(this._focusParameters.fds=null===(t=this.getCameraCapabilities())||void 0===t?void 0:t.focusDistance,!this._focusParameters.fds))return void(this._focusSupported=!1);if(null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),1==this._focusParameters.isDoingFocus)return;let i,s;if(this._focusParameters.taskBackToContinous&&(clearTimeout(this._focusParameters.taskBackToContinous),this._focusParameters.taskBackToContinous=null),e instanceof MouseEvent)i=e.clientX,s=e.clientY;else{if(!(e instanceof TouchEvent))throw new Error("Unknown event type.");if(!e.changedTouches.length)return;i=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY}const r=this.getResolution(),n=2*Math.round(Math.min(r.width,r.height)/this._focusParameters.defaultFocusAreaSizeRatio/2);let a;try{a=this.calculateCoordInVideo(i,s)}catch(e){}if(a.x<0||a.x>r.width||a.y<0||a.y>r.height)return;const o={x:a.x+"px",y:a.y+"px"},h=n+"px",l=h;let d;Mi._onLog&&(d=Date.now());try{await Et(this,Yt,"m",Ai).call(this,o,h,l,this._focusParameters.tapFocusMinDistance,this._focusParameters.tapFocusMaxDistance)}catch(e){if(Mi._onLog)throw Mi._onLog(e),e}Mi._onLog&&Mi._onLog(`Tap focus costs: ${Date.now()-d} ms`),this._focusParameters.taskBackToContinous=setTimeout((()=>{var e;Mi._onLog&&Mi._onLog("Back to continuous focus."),null===(e=Et(this,zt,"f"))||void 0===e||e.applyConstraints({advanced:[{focusMode:"continuous"}]}).catch((()=>{}))}),this._focusParameters.focusBackToContinousTime),Et(this,gi,"f").fire("tapfocus",null,{target:this,async:!0})})),li.set(this,null),di.set(this,1),ci.set(this,{x:0,y:0}),this.updateVideoElWhenSoftwareScaled=()=>{if(!Et(this,Zt,"f"))return;const e=Et(this,di,"f");if(e<1)throw new RangeError("Invalid scale value.");if(1===e)Et(this,Zt,"f").style.transform="";else{const t=window.getComputedStyle(Et(this,Zt,"f")).objectFit,i=Et(this,Zt,"f").videoWidth,s=Et(this,Zt,"f").videoHeight,{width:r,height:n}=Et(this,Zt,"f").getBoundingClientRect();if(r<=0||n<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");const a=r/n,o=i/s;let h=1;"contain"===t?h=a<o?r/(i/e):n/(s/e):"cover"===t&&(h=o>a?n/(i/e):r/(s/e));const l=h*(1-1/e)*(i/2-Et(this,ci,"f").x),d=h*(1-1/e)*(s/2-Et(this,ci,"f").y);Et(this,Zt,"f").style.transform=`translate(${l}px, ${d}px) scale(${e})`}},fi.set(this,(function(){if(!(this.data instanceof Uint8Array||this.data instanceof Uint8ClampedArray))throw new TypeError("Invalid data.");if("number"!=typeof this.width||this.width<=0)throw new Error("Invalid width.");if("number"!=typeof this.height||this.height<=0)throw new Error("Invalid height.");const e=document.createElement("canvas");let t;if(e.width=this.width,e.height=this.height,this.pixelFormat===Rt.GREY){t=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<t.length;e+=4)t[e]=this.data[e/4],t[e+1]=this.data[e/4],t[e+2]=this.data[e/4],t[e+3]=255}else t=new Uint8ClampedArray(this.data.buffer);const i=new ImageData(t,this.width,this.height);return e.getContext("2d").putImageData(i,0,0),e})),gi.set(this,void 0),ui.set(this,["before:open","opened","before:close","closed","before:camera:change","camera:changed","before:resolution:change","resolution:changed","played","paused","resumed","tapfocus"]),this.detectedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],mi.set(this,new Map),wi.set(this,!1),pi.set(this,(async()=>{var e,t;if("visible"===document.visibilityState){if(Mi._onLog&&Mi._onLog("document visible. video paused: "+(null===(e=Et(this,Zt,"f"))||void 0===e?void 0:e.paused)),Et(this,wi,"f")&&Et(this,Zt,"f")&&this.videoSrc&&"opened"===this.state)return void this.resume().catch((()=>{}));if(!this._mediaStream)return;if(this._mediaStream.active&&Et(this,zt,"f"))if(Et(this,zt,"f").muted&&["iPhone","iPad","Mac"].includes(At.OS)){if(At.version>=17)return;await Et(this,Yt,"m",Si).call(this)}else Et(this,wi,"f")&&this.resume().catch((()=>{}));else await Et(this,Yt,"m",Si).call(this)}else if("hidden"===document.visibilityState&&(Mi._onLog&&Mi._onLog("document hidden. video paused: "+(null===(t=Et(this,Zt,"f"))||void 0===t?void 0:t.paused)),["iPhone","iPad","Mac"].includes(At.OS)?It(this,wi,!0,"f"):It(this,wi,this.isVideoPlaying,"f"),this.isVideoLoaded()&&"opened"==this.state)){if(["iPhone","iPad","Mac"].includes(At.OS)&&At.version>=17)return;this.pause()}})),_i.set(this,!1),(null===(i=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===i?void 0:i.getUserMedia)||setTimeout((()=>{Mi.onWarning&&Mi.onWarning("The browser is too old or the page is loaded from an insecure origin.")}),0),this.defaultConstraints={video:{facingMode:{ideal:"environment"}}},this.resetMediaStreamConstraints(),e instanceof HTMLVideoElement&&this.setVideoEl(e),It(this,gi,new Di,"f"),this.imageDataGetter=new Ut,document.addEventListener("visibilitychange",Et(this,pi,"f"))}setVideoEl(e){if(!(e&&e instanceof HTMLVideoElement))throw new Error("Invalid 'videoEl'.");e.addEventListener("play",Et(this,Jt,"f")),e.addEventListener("pause",Et(this,Kt,"f")),It(this,Zt,e,"f")}getVideoEl(){return Et(this,Zt,"f")}releaseVideoEl(){var e,t;null===(e=Et(this,Zt,"f"))||void 0===e||e.removeEventListener("play",Et(this,Jt,"f")),null===(t=Et(this,Zt,"f"))||void 0===t||t.removeEventListener("pause",Et(this,Kt,"f")),It(this,Zt,null,"f")}isVideoLoaded(){return!!Et(this,Zt,"f")&&4==Et(this,Zt,"f").readyState}async open(){if(Et(this,ii,"f")&&!Et(this,ti,"f")){if("pending"===Et(this,si,"f"))return Et(this,ii,"f");if("fulfilled"===Et(this,si,"f"))return}Et(this,gi,"f").fire("before:open",null,{target:this}),await Et(this,Yt,"m",Si).call(this),Et(this,gi,"f").fire("opened",null,{target:this,async:!0}),Et(this,gi,"f").fire("played",null,{target:this,async:!0})}async close(){if("closed"===this.state)return;Et(this,gi,"f").fire("before:close",null,{target:this});const e=Et(this,ii,"f");if(Et(this,Yt,"m",Ci).call(this),e&&"pending"===Et(this,si,"f")){try{await e}catch(e){}if(!1===Et(this,ti,"f")){const e=new Error("'close()' was interrupted.");throw e.name="AbortError",e}}It(this,ii,null,"f"),It(this,si,null,"f"),Et(this,gi,"f").fire("closed",null,{target:this,async:!0})}pause(){if(!this.isVideoLoaded())throw new Error("Video is not loaded.");if("opened"!==this.state)throw new Error("Camera or video is not open.");Et(this,Zt,"f").pause()}async resume(){if(!this.isVideoLoaded())throw new Error("Video is not loaded.");if("opened"!==this.state)throw new Error("Camera or video is not open.");await Et(this,Zt,"f").play()}async setCamera(e){if("string"!=typeof e)throw new TypeError("Invalid 'deviceId'.");if("object"!=typeof Et(this,Xt,"f").video&&(Et(this,Xt,"f").video={}),delete Et(this,Xt,"f").video.facingMode,Et(this,Xt,"f").video.deviceId={exact:e},!("closed"===this.state||this.videoSrc||"opening"===this.state&&Et(this,ti,"f"))){Et(this,gi,"f").fire("before:camera:change",[],{target:this,async:!1}),await Et(this,Yt,"m",bi).call(this);try{this.resetSoftwareScale()}catch(e){}return Et(this,qt,"f")}}async switchToFrontCamera(e){if("object"!=typeof Et(this,Xt,"f").video&&(Et(this,Xt,"f").video={}),(null==e?void 0:e.resolution)&&(Et(this,Xt,"f").video.width={ideal:e.resolution.width},Et(this,Xt,"f").video.height={ideal:e.resolution.height}),delete Et(this,Xt,"f").video.deviceId,Et(this,Xt,"f").video.facingMode={exact:"user"},It(this,Qt,null,"f"),!("closed"===this.state||this.videoSrc||"opening"===this.state&&Et(this,ti,"f"))){Et(this,gi,"f").fire("before:camera:change",[],{target:this,async:!1}),Et(this,Yt,"m",bi).call(this);try{this.resetSoftwareScale()}catch(e){}return Et(this,qt,"f")}}getCamera(){var e;if(Et(this,qt,"f"))return Et(this,qt,"f");{let t=(null===(e=Et(this,Xt,"f").video)||void 0===e?void 0:e.deviceId)||"";if(t){t=t.exact||t.ideal||t;for(let e of this._arrCameras)if(e.deviceId===t)return JSON.parse(JSON.stringify(e))}return{deviceId:"",label:"",_checked:!1}}}async _getCameras(e){var t,i;if(!(null===(i=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let s;if(e){let e=await navigator.mediaDevices.getUserMedia({video:!0});s=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),e.getTracks().forEach((e=>{e.stop()}))}else s=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));const r=[],n=[];if(this._arrCameras)for(let e of this._arrCameras)e._checked&&n.push(e);for(let e=0;e<s.length;e++){let t,i=s[e];for(let e of n)if(i.deviceId==e.deviceId){t=e;break}t||(t={deviceId:i.deviceId,label:i.label?i.label:"camera "+e,_checked:!1}),t.deviceId&&r.push(t)}return this._arrCameras=r,Mi._onLog&&Mi._onLog(JSON.stringify(this._arrCameras)),r}async getCameras(){var e,t;if(!(null===(t=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===t?void 0:t.enumerateDevices))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");const i=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));return i&&i.length&&!i[0].deviceId?this._getCameras(!0):this._getCameras(!1)}async getAllCameras(){return this.getCameras()}async setResolution(e,t,i){if("number"!=typeof e||e<=0)throw new TypeError("Invalid 'width'.");if("number"!=typeof t||t<=0)throw new TypeError("Invalid 'height'.");if("object"!=typeof Et(this,Xt,"f").video&&(Et(this,Xt,"f").video={}),i?(Et(this,Xt,"f").video.width={exact:e},Et(this,Xt,"f").video.height={exact:t}):(Et(this,Xt,"f").video.width={ideal:e},Et(this,Xt,"f").video.height={ideal:t}),"closed"===this.state||this.videoSrc||"opening"===this.state&&Et(this,ti,"f"))return null;Et(this,gi,"f").fire("before:resolution:change",[],{target:this,async:!1}),await Et(this,Yt,"m",bi).call(this);try{this.resetSoftwareScale()}catch(e){}const s=this.getResolution();return{width:s.width,height:s.height}}getResolution(){if("opened"===this.state&&this.videoSrc&&Et(this,Zt,"f"))return{width:Et(this,Zt,"f").videoWidth,height:Et(this,Zt,"f").videoHeight};if(Et(this,zt,"f")){const e=Et(this,zt,"f").getSettings();return{width:e.width,height:e.height}}if(this.isVideoLoaded())return{width:Et(this,Zt,"f").videoWidth,height:Et(this,Zt,"f").videoHeight};{const e={width:0,height:0};let t=Et(this,Xt,"f").video.width||0,i=Et(this,Xt,"f").video.height||0;return t&&(e.width=t.exact||t.ideal||t),i&&(e.height=i.exact||i.ideal||i),e}}async getResolutions(e){var t,i,s,r,n,a,o,h,l,d,c;if(!(null===(i=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let f="";const g=(e,t)=>{const i=Et(this,mi,"f").get(e);if(!i||!i.length)return!1;for(let e of i)if(e.width===t.width&&e.height===t.height)return!0;return!1};if(this._mediaStream){f=null===(c=Et(this,qt,"f"))||void 0===c?void 0:c.deviceId;let t=Et(this,mi,"f").get(f);if(t&&!e)return JSON.parse(JSON.stringify(t));t=[],Et(this,mi,"f").set(f,t),It(this,ri,!0,"f");try{for(let e of this.detectedResolutions){await Et(this,zt,"f").applyConstraints({width:{ideal:e.width},height:{ideal:e.height}}),Et(this,Yt,"m",vi).call(this);const i=Et(this,zt,"f").getSettings(),s={width:i.width,height:i.height};g(f,s)||t.push({width:s.width,height:s.height})}}catch(e){throw Et(this,Yt,"m",Ci).call(this),It(this,ri,!1,"f"),e}try{await Et(this,Yt,"m",Si).call(this)}catch(e){if("AbortError"===e.name)return t;throw e}finally{It(this,ri,!1,"f")}return t}{const t=async(e,t,i)=>{const s={video:{deviceId:{exact:e},width:{ideal:t},height:{ideal:i}}};let r=null;try{r=await navigator.mediaDevices.getUserMedia(s)}catch(e){return null}if(!r)return null;const n=r.getVideoTracks();let a=null;try{const e=n[0].getSettings();a={width:e.width,height:e.height}}catch(e){const t=document.createElement("video");t.srcObject=r,a={width:t.videoWidth,height:t.videoHeight},t.srcObject=null}return n.forEach((e=>{e.stop()})),a};let i=(null===(n=null===(r=null===(s=Et(this,Xt,"f"))||void 0===s?void 0:s.video)||void 0===r?void 0:r.deviceId)||void 0===n?void 0:n.exact)||(null===(h=null===(o=null===(a=Et(this,Xt,"f"))||void 0===a?void 0:a.video)||void 0===o?void 0:o.deviceId)||void 0===h?void 0:h.ideal)||(null===(d=null===(l=Et(this,Xt,"f"))||void 0===l?void 0:l.video)||void 0===d?void 0:d.deviceId);if(!i)return[];let c=Et(this,mi,"f").get(i);if(c&&!e)return JSON.parse(JSON.stringify(c));c=[],Et(this,mi,"f").set(i,c);for(let e of this.detectedResolutions){const s=await t(i,e.width,e.height);s&&!g(i,s)&&c.push({width:s.width,height:s.height})}return c}}async setMediaStreamConstraints(e,t){if(!(e=>{return null!==e&&"[object Object]"===(t=e,Object.prototype.toString.call(t));var t})(e))throw new TypeError("Invalid 'mediaStreamConstraints'.");It(this,Xt,JSON.parse(JSON.stringify(e)),"f"),It(this,Qt,null,"f"),t&&Et(this,Yt,"m",bi).call(this)}getMediaStreamConstraints(){return JSON.parse(JSON.stringify(Et(this,Xt,"f")))}resetMediaStreamConstraints(){It(this,Xt,this.defaultConstraints?JSON.parse(JSON.stringify(this.defaultConstraints)):null,"f")}getCameraCapabilities(){if(!Et(this,zt,"f")||"opened"!==this.state)throw new Error("Camera is not open.");return Et(this,zt,"f").getCapabilities?Et(this,zt,"f").getCapabilities():{}}getCameraSettings(){if(!Et(this,zt,"f")||"opened"!==this.state)throw new Error("Camera is not open.");return Et(this,zt,"f").getSettings()}async turnOnTorch(){if(!Et(this,zt,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const e=this.getCameraCapabilities();if(!(null==e?void 0:e.torch))throw Error("Not supported.");await Et(this,zt,"f").applyConstraints({advanced:[{torch:!0}]})}async turnOffTorch(){if(!Et(this,zt,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const e=this.getCameraCapabilities();if(!(null==e?void 0:e.torch))throw Error("Not supported.");await Et(this,zt,"f").applyConstraints({advanced:[{torch:!1}]})}async setColorTemperature(e,t){var i;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(!Et(this,zt,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.colorTemperature;if(!s)throw Error("Not supported.");return t&&(e<s.min?e=s.min:e>s.max&&(e=s.max),e=Ri(e,s.min,s.step,s.max)),await Et(this,zt,"f").applyConstraints({advanced:[{colorTemperature:e,whiteBalanceMode:"manual"}]}),e}getColorTemperature(){return this.getCameraSettings().colorTemperature||0}async setExposureCompensation(e,t){var i;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(!Et(this,zt,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.exposureCompensation;if(!s)throw Error("Not supported.");return t&&(e<s.min?e=s.min:e>s.max&&(e=s.max),e=Ri(e,s.min,s.step,s.max)),await Et(this,zt,"f").applyConstraints({advanced:[{exposureCompensation:e}]}),e}getExposureCompensation(){return this.getCameraSettings().exposureCompensation||0}async setFrameRate(e,t){var i;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(!Et(this,zt,"f")||"opened"!==this.state)throw new Error("Camera is not open.");let s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.frameRate;if(!s)throw Error("Not supported.");t&&(e<s.min?e=s.min:e>s.max&&(e=s.max));const r=this.getResolution();return await Et(this,zt,"f").applyConstraints({width:{ideal:Math.max(r.width,r.height)},frameRate:e}),e}getFrameRate(){return this.getCameraSettings().frameRate}async setFocus(e,t){if("object"!=typeof e||Array.isArray(e)||null==e)throw new TypeError("Invalid 'settings'.");if(!Et(this,zt,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const i=this.getCameraCapabilities(),s=null==i?void 0:i.focusMode,r=null==i?void 0:i.focusDistance;if(!s)throw Error("Not supported.");if("string"!=typeof e.mode)throw TypeError("Invalid 'mode'.");const n=e.mode.toLowerCase();if(!s.includes(n))throw Error("Unsupported focus mode.");if("manual"===n){if(!r)throw Error("Manual focus unsupported.");if(e.hasOwnProperty("distance")){let i=e.distance;t&&(i<r.min?i=r.min:i>r.max&&(i=r.max),i=Ri(i,r.min,r.step,r.max)),this._focusParameters.focusArea=null,await Et(this,zt,"f").applyConstraints({advanced:[{focusMode:n,focusDistance:i}]})}else{if(!e.area)throw new Error("'distance' or 'area' should be specified in 'manual' mode.");{const t=e.area.centerPoint;let i=e.area.width,s=e.area.height;if(!i||!s){const e=this.getResolution();i||(i=2*Math.round(Math.min(e.width,e.height)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px"),s||(s=2*Math.round(Math.min(e.width,e.height)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px")}this._focusParameters.focusArea={centerPoint:{x:t.x,y:t.y},width:i,height:s},await Et(this,Yt,"m",Ai).call(this,t,i,s)}}}else this._focusParameters.focusArea=null,await Et(this,zt,"f").applyConstraints({advanced:[{focusMode:n}]})}getFocus(){const e=this.getCameraSettings(),t=e.focusMode;return t?"manual"===t?this._focusParameters.focusArea?{mode:"manual",area:JSON.parse(JSON.stringify(this._focusParameters.focusArea))}:{mode:"manual",distance:e.focusDistance}:{mode:t}:null}async enableTapToFocus(){It(this,ni,!0,"f")}disableTapToFocus(){It(this,ni,!1,"f")}isTapToFocusEnabled(){return Et(this,ni,"f")}async setZoom(e){if("object"!=typeof e||Array.isArray(e)||null==e)throw new TypeError("Invalid 'settings'.");if("number"!=typeof e.factor)throw new TypeError("Illegal type of 'factor'.");if(e.factor<1)throw new RangeError("Invalid 'factor'.");if("opened"!==this.state)throw new Error("Video is not playing.");e.centerPoint?Et(this,Yt,"m",xi).call(this,e.centerPoint):this.resetScaleCenter();try{if(Et(this,Yt,"m",Fi).call(this,Et(this,ci,"f"))){const t=await this.setHardwareScale(e.factor,!0);let i=this.getHardwareScale();1==i&&1!=t&&(i=t),e.factor>i?this.setSoftwareScale(e.factor/i):this.setSoftwareScale(1)}else await this.setHardwareScale(1),this.setSoftwareScale(e.factor)}catch(t){const i=t.message||t;if("Not supported."!==i&&"Camera is not open."!==i)throw t;this.setSoftwareScale(e.factor)}}getZoom(){if("opened"!==this.state)throw new Error("Video is not playing.");let e=1;try{e=this.getHardwareScale()}catch(e){if("Camera is not open."!==(e.message||e))throw e}return{factor:e*Et(this,di,"f")}}async resetZoom(){await this.setZoom({factor:1})}async setHardwareScale(e,t){var i;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(e<1)throw new RangeError("Invalid 'value'.");if(!Et(this,zt,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.zoom;if(!s)throw Error("Not supported.");return t&&(e<s.min?e=s.min:e>s.max&&(e=s.max),e=Ri(e,s.min,s.step,s.max)),await Et(this,zt,"f").applyConstraints({advanced:[{zoom:e}]}),e}getHardwareScale(){return this.getCameraSettings().zoom||1}setSoftwareScale(e,t){if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(e<1)throw new RangeError("Invalid 'value'.");if("opened"!==this.state)throw new Error("Video is not playing.");t&&Et(this,Yt,"m",xi).call(this,t),It(this,di,e,"f"),this.updateVideoElWhenSoftwareScaled()}getSoftwareScale(){return Et(this,di,"f")}resetScaleCenter(){if("opened"!==this.state)throw new Error("Video is not playing.");const e=this.getResolution();It(this,ci,{x:e.width/2,y:e.height/2},"f")}resetSoftwareScale(){this.setSoftwareScale(1),this.resetScaleCenter()}getFrameData(e){if(this.disposed)throw Error("The 'Camera' instance has been disposed.");if(!this.isVideoLoaded())return null;if(Et(this,ri,"f"))return null;const t=Date.now();Mi._onLog&&Mi._onLog("getFrameData() START: "+t);const i=Et(this,Zt,"f").videoWidth,s=Et(this,Zt,"f").videoHeight;let r={sx:0,sy:0,sWidth:i,sHeight:s,dWidth:i,dHeight:s};(null==e?void 0:e.position)&&(r=JSON.parse(JSON.stringify(e.position)));let n=Rt.RGBA;(null==e?void 0:e.pixelFormat)&&(n=e.pixelFormat);let a=Et(this,di,"f");(null==e?void 0:e.scale)&&(a=e.scale);let o=Et(this,ci,"f");if(null==e?void 0:e.scaleCenter){if("string"!=typeof e.scaleCenter.x||"string"!=typeof e.scaleCenter.y)throw new Error("Invalid scale center.");let t=0,r=0;if(e.scaleCenter.x.endsWith("px"))t=parseFloat(e.scaleCenter.x);else{if(!e.scaleCenter.x.endsWith("%"))throw new Error("Invalid scale center.");t=parseFloat(e.scaleCenter.x)/100*i}if(e.scaleCenter.y.endsWith("px"))r=parseFloat(e.scaleCenter.y);else{if(!e.scaleCenter.y.endsWith("%"))throw new Error("Invalid scale center.");r=parseFloat(e.scaleCenter.y)/100*s}if(isNaN(t)||isNaN(r))throw new Error("Invalid scale center.");o.x=Math.round(t),o.y=Math.round(r)}let h=null;if((null==e?void 0:e.bufferContainer)&&(h=e.bufferContainer),0==i||0==s)return null;1!==a&&(r.sWidth=Math.round(r.sWidth/a),r.sHeight=Math.round(r.sHeight/a),r.sx=Math.round((1-1/a)*o.x+r.sx/a),r.sy=Math.round((1-1/a)*o.y+r.sy/a));const l=this.imageDataGetter.getImageData(Et(this,Zt,"f"),i,s,r,{pixelFormat:n,bufferContainer:h});if(!l)return null;const d=Date.now();return Mi._onLog&&Mi._onLog("getFrameData() END: "+d),{data:l.data,width:l.width,height:l.height,pixelFormat:l.pixelFormat,timeSpent:d-t,timeStamp:d,toCanvas:Et(this,fi,"f")}}on(e,t){if(!Et(this,ui,"f").includes(e.toLowerCase()))throw new Error(`Event '${e}' does not exist.`);Et(this,gi,"f").on(e,t)}off(e,t){Et(this,gi,"f").off(e,t)}async dispose(){this.tapFocusEventBoundEl=null,await this.close(),this.releaseVideoEl(),Et(this,gi,"f").dispose(),this.imageDataGetter.dispose(),document.removeEventListener("visibilitychange",Et(this,pi,"f")),It(this,_i,!0,"f")}}var Oi,Pi,Bi,ki,Ni,Wi,Vi,Ui,Gi,ji,Hi,Yi,Zi,zi,Ji,Ki,Xi,qi,Qi,$i,es,ts,is,ss,rs,ns,as,os,hs,ls,ds,cs,fs;Zt=new WeakMap,zt=new WeakMap,Jt=new WeakMap,Kt=new WeakMap,Xt=new WeakMap,qt=new WeakMap,Qt=new WeakMap,$t=new WeakMap,ei=new WeakMap,ti=new WeakMap,ii=new WeakMap,si=new WeakMap,ri=new WeakMap,ni=new WeakMap,ai=new WeakMap,oi=new WeakMap,hi=new WeakMap,li=new WeakMap,di=new WeakMap,ci=new WeakMap,fi=new WeakMap,gi=new WeakMap,ui=new WeakMap,mi=new WeakMap,wi=new WeakMap,pi=new WeakMap,_i=new WeakMap,Yt=new WeakSet,yi=async function(){const e=this.getMediaStreamConstraints();if("boolean"==typeof e.video&&(e.video={}),e.video.deviceId);else if(Et(this,Qt,"f"))delete e.video.facingMode,e.video.deviceId={exact:Et(this,Qt,"f")};else if(this.ifSaveLastUsedCamera&&Mi.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete e.video.facingMode,e.video.deviceId={ideal:window.localStorage.getItem("dce_last_camera_id")};const t=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),i=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));t&&i&&(e.video.width=t,e.video.height=i)}else if(this.ifSkipCameraInspection);else{const t=async e=>{let t=null;return"environment"===e&&["Android","HarmonyOS","iPhone","iPad"].includes(At.OS)?(await this._getCameras(!1),Et(this,Yt,"m",vi).call(this),t=Mi.findBestCamera(this._arrCameras,"environment",{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault})):e||["Android","HarmonyOS","iPhone","iPad"].includes(At.OS)||(await this._getCameras(!1),Et(this,Yt,"m",vi).call(this),t=Mi.findBestCamera(this._arrCameras,null,{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault})),t};let i=e.video.facingMode;i instanceof Array&&i.length&&(i=i[0]),"object"==typeof i&&(i=i.exact||i.ideal);const s=await t(i);s&&(delete e.video.facingMode,e.video.deviceId={exact:s})}return e},vi=function(){if(Et(this,ti,"f")){const e=new Error("The operation was interrupted.");throw e.name="AbortError",e}},Ei=async function(e){var t,i;if(!(null===(i=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let s;try{Mi._onLog&&Mi._onLog("======try getUserMedia========");let t=[0,500],i=null;const r=async e=>{for(let r of t){r&&(await new Promise((e=>setTimeout(e,r))),Et(this,Yt,"m",vi).call(this));try{Mi._onLog&&Mi._onLog("ask "+JSON.stringify(e)),s=await navigator.mediaDevices.getUserMedia(e),Et(this,Yt,"m",vi).call(this);break}catch(e){if("NotFoundError"===e.name||"NotAllowedError"===e.name||"AbortError"===e.name||"OverconstrainedError"===e.name)throw e;i=e,Mi._onLog&&Mi._onLog(e.message||e)}}};if(await r(e),s||(Mi._onLog&&Mi._onLog("======try getUserMedia again========"),Mi._onLog&&Mi._onLog(e),await r(e)),s||(t=[1e3,2e3],await r(e)),s||await r(e),!s)throw i;return s}catch(e){throw null==s||s.getTracks().forEach((e=>{e.stop()})),"NotFoundError"===e.name&&(DOMException?e=new DOMException("No camera available, please use a device with an accessible camera.",e.name):(e=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),e}},Ii=function(){this._mediaStream&&(this._mediaStream.getTracks().forEach((e=>{e.stop()})),this._mediaStream=null),It(this,zt,null,"f")},Si=async function(){It(this,ti,!1,"f");const e=It(this,ei,Symbol(),"f");if(Et(this,ii,"f")&&"pending"===Et(this,si,"f")){try{await Et(this,ii,"f")}catch(e){}Et(this,Yt,"m",vi).call(this)}if(e!==Et(this,ei,"f"))return;const t=It(this,ii,(async()=>{It(this,si,"pending","f");try{if(this.videoSrc){if(!Et(this,Zt,"f"))throw new Error("'videoEl' should be set.");await Mi.playVideo(Et(this,Zt,"f"),this.videoSrc,this.cameraOpenTimeout),Et(this,Yt,"m",vi).call(this)}else{let e=await Et(this,Yt,"m",yi).call(this);Et(this,Yt,"m",Ii).call(this);let t=await Et(this,Yt,"m",Ei).call(this,e);await this._getCameras(!1),Et(this,Yt,"m",vi).call(this);const i=()=>{const e=t.getVideoTracks();let i,s;if(e.length&&(i=e[0]),i){const e=i.getSettings();if(e)for(let t of this._arrCameras)if(e.deviceId===t.deviceId){t._checked=!0,t.label=i.label,s=t;break}}return s},s=Et(this,Xt,"f");if("object"==typeof s.video){let r=s.video.facingMode;if(r instanceof Array&&r.length&&(r=r[0]),"object"==typeof r&&(r=r.exact||r.ideal),!(Et(this,Qt,"f")||this.ifSaveLastUsedCamera&&Mi.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")||this.ifSkipCameraInspection||s.video.deviceId)){const s=i(),n=Mi.findBestCamera(this._arrCameras,r,{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault});n&&n!=(null==s?void 0:s.deviceId)&&(t.getTracks().forEach((e=>{e.stop()})),e.video.deviceId={exact:n},t=await Et(this,Yt,"m",Ei).call(this,e),Et(this,Yt,"m",vi).call(this))}}const r=i();(null==r?void 0:r.deviceId)&&(It(this,Qt,r&&r.deviceId,"f"),this.ifSaveLastUsedCamera&&Mi.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",Et(this,Qt,"f")),"object"==typeof e.video&&e.video.width&&e.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(e.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(e.video.height))))),Et(this,Zt,"f")&&(await Mi.playVideo(Et(this,Zt,"f"),t,this.cameraOpenTimeout),Et(this,Yt,"m",vi).call(this)),this._mediaStream=t;const n=t.getVideoTracks();(null==n?void 0:n.length)&&It(this,zt,n[0],"f"),It(this,qt,r,"f")}}catch(e){throw Et(this,Yt,"m",Ci).call(this),It(this,si,null,"f"),e}It(this,si,"fulfilled","f")})(),"f");return t},bi=async function(){var e;if("closed"===this.state||this.videoSrc)return;const t=null===(e=Et(this,qt,"f"))||void 0===e?void 0:e.deviceId,i=this.getResolution();await Et(this,Yt,"m",Si).call(this);const s=this.getResolution();t&&t!==Et(this,qt,"f").deviceId&&Et(this,gi,"f").fire("camera:changed",[Et(this,qt,"f").deviceId,t],{target:this,async:!0}),i.width==s.width&&i.height==s.height||Et(this,gi,"f").fire("resolution:changed",[{width:s.width,height:s.height},{width:i.width,height:i.height}],{target:this,async:!0}),Et(this,gi,"f").fire("played",null,{target:this,async:!0})},Ci=function(){Et(this,Yt,"m",Ii).call(this),It(this,qt,null,"f"),Et(this,Zt,"f")&&(Et(this,Zt,"f").srcObject=null,this.videoSrc&&(Et(this,Zt,"f").pause(),Et(this,Zt,"f").currentTime=0)),It(this,ti,!0,"f");try{this.resetSoftwareScale()}catch(e){}},Ti=async function e(t,i){const s=e=>{if(!Et(this,zt,"f")||!this.isVideoPlaying||e.focusTaskId!=this._focusParameters.curFocusTaskId){Et(this,zt,"f")&&this.isVideoPlaying||(this._focusParameters.isDoingFocus=0);const t=new Error(`Focus task ${e.focusTaskId} canceled.`);throw t.name="DeprecatedTaskError",t}1===this._focusParameters.isDoingFocus&&Date.now()-e.timeStart>this._focusParameters.focusCancelableTime&&(this._focusParameters.isDoingFocus=-1)};let r;i=Ri(i,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),await Et(this,zt,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:i}]}),s(t),r=null==this._focusParameters.oldDistance?this._focusParameters.kTimeout*Math.max(Math.abs(1/this._focusParameters.fds.min-1/i),Math.abs(1/this._focusParameters.fds.max-1/i))+this._focusParameters.minTimeout:this._focusParameters.kTimeout*Math.abs(1/this._focusParameters.oldDistance-1/i)+this._focusParameters.minTimeout,this._focusParameters.oldDistance=i,await new Promise((e=>{setTimeout(e,r)})),s(t);let n=t.focusL-t.focusW/2,a=t.focusT-t.focusH/2,o=t.focusW,h=t.focusH;const l=this.getResolution();if(n>=l.width||a>=l.height)throw new Error("Invalid area.");n+o>l.width&&(o=l.width-n),a+h>l.height&&(h=l.height-a),n=Math.round(n),a=Math.round(a),o=Math.round(o),h=Math.round(h);const d=4*l.width*l.height*this._focusParameters.defaultTempBufferContainerLenRatio,c=4*o*h;let f=this._focusParameters.tempBufferContainer;if(f){const e=f.length;d>e&&d>=c?f=new Uint8Array(d):c>e&&c>=d&&(f=new Uint8Array(c))}else f=this._focusParameters.tempBufferContainer=new Uint8Array(Math.max(d,c));if(!this.imageDataGetter.getImageData(Et(this,Zt,"f"),l.width,l.height,{sx:n,sy:a,sWidth:o,sHeight:h,dWidth:o,dHeight:h},{pixelFormat:Rt.RGBA,bufferContainer:f}))return Et(this,Yt,"m",e).call(this,t,i);const g=f;let u=0;for(let e=0,t=c-8;e<t;++e){let t=g[e]-g[e+8];++e;let i=g[e]-g[e+8];++e;let s=g[e]-g[e+8];++e,u+=t*t+i*i+s*s}return-u},Li=async function e(t,i,s,r,n,a,o){let h;if(i=Ri(i,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),r=Ri(r,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),a?a=Ri(a,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max):(a=Ri(Math.sqrt((i||this._focusParameters.fds.step)*(r||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),o=await Et(this,Yt,"m",Ti).call(this,t,a)),o<=s&&o<=n?h=3:s<n&&s<o?h=1:n<s&&n<o&&(h=2),(r-i)/2<=this._focusParameters.fds.step)return 3===h||(1===h?await Et(this,zt,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:i}]}):2===h&&await Et(this,zt,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:r}]})),!0;if(1===h)return await Et(this,Yt,"m",e).call(this,t,i,s,a,o);if(2===h)return await Et(this,Yt,"m",e).call(this,t,a,o,r,n);if(3!==h)return s=await Et(this,Yt,"m",Ti).call(this,t,i),n=await Et(this,Yt,"m",Ti).call(this,t,r),await Et(this,Yt,"m",e).call(this,t,i,s,r,n);let l=Ri(Math.sqrt((i||this._focusParameters.fds.step)*(a||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),d=Ri(Math.sqrt((r||this._focusParameters.fds.step)*(a||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max);if(Math.abs(1/this._focusParameters.oldDistance-1/l)<=Math.abs(1/this._focusParameters.oldDistance-1/d)){let h=await Et(this,Yt,"m",Ti).call(this,t,l);if(h<o)return await Et(this,Yt,"m",e).call(this,t,i,s,a,o,l,h);if(h==o)return await Et(this,Yt,"m",e).call(this,t,l,h,a,o);let c=await Et(this,Yt,"m",Ti).call(this,t,d);if(h>o&&o<c)return await Et(this,Yt,"m",e).call(this,t,l,h,d,c,a,o);if(o==c)return await Et(this,Yt,"m",e).call(this,t,a,o,d,c);if(o>c)return await Et(this,Yt,"m",e).call(this,t,a,o,r,n,d,c)}else{let h=await Et(this,Yt,"m",Ti).call(this,t,d);if(o>h)return await Et(this,Yt,"m",e).call(this,t,a,o,r,n,d,h);if(o==h)return await Et(this,Yt,"m",e).call(this,t,a,o,d,h);let c=await Et(this,Yt,"m",Ti).call(this,t,l);if(c>o&&o<h)return await Et(this,Yt,"m",e).call(this,t,l,c,d,h,a,o);if(c==o)return await Et(this,Yt,"m",e).call(this,t,l,c,a,o);if(c<o)return await Et(this,Yt,"m",e).call(this,t,i,s,a,o,l,c)}return!1},Ai=async function(e,t,i,s,r){var n;if(1==this._focusParameters.isDoingFocus)return!1;if(!e||"string"!=typeof e.x||"string"!=typeof e.y)throw new Error("Invalid 'centerPoint'.");if(!t||"string"!=typeof t)throw new Error("Invalid 'width'.");if(!i||"string"!=typeof i)throw new Error("Invalid 'height'.");const a=this.getResolution();let o=0,h=0;if(e.x.endsWith("px"))o=parseFloat(e.x);else{if(!e.x.endsWith("%"))throw new Error("Invalid 'centerPoint'.");o=parseFloat(e.x)/100*a.width}if(e.y.endsWith("px"))h=parseFloat(e.y);else{if(!e.y.endsWith("%"))throw new Error("Invalid 'centerPoint'.");h=parseFloat(e.y)/100*a.height}if(isNaN(o)||isNaN(h)||o<0||o>a.width||h<0||h>a.height)throw new Error("Invalid 'centerPoint'.");let l=0;if(t.endsWith("px"))l=parseFloat(t);else{if(!t.endsWith("%"))throw new Error("Invalid 'width'.");l=parseFloat(t)/100*a.width}if(isNaN(l)||l<0)throw new Error("Invalid 'width'.");let d=0;if(i.endsWith("px"))d=parseFloat(i);else{if(!i.endsWith("%"))throw new Error("Invalid 'height'.");d=parseFloat(i)/100*a.height}if(isNaN(d)||d<0)throw new Error("Invalid 'height'.");if(1!==Et(this,di,"f")){const e=Et(this,di,"f"),t=Et(this,ci,"f");l/=e,d/=e,o=(1-1/e)*t.x+o/e,h=(1-1/e)*t.y+h/e}if(!this._focusSupported)throw new Error("Manual focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=null===(n=this.getCameraCapabilities())||void 0===n?void 0:n.focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,new Error("Manual focus unsupported.");null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus=1;const c={focusL:o,focusT:h,focusW:l,focusH:d,focusTaskId:++this._focusParameters.curFocusTaskId,timeStart:Date.now()},f=async(e,t,i)=>{try{(null==t||t<this._focusParameters.fds.min)&&(t=this._focusParameters.fds.min),(null==i||i>this._focusParameters.fds.max)&&(i=this._focusParameters.fds.max),this._focusParameters.oldDistance=null;let s=Ri(Math.sqrt(i*(t||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),r=Ri(Math.sqrt((t||this._focusParameters.fds.step)*s),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),n=Ri(Math.sqrt(s*i),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),a=await Et(this,Yt,"m",Ti).call(this,e,n),o=await Et(this,Yt,"m",Ti).call(this,e,r),h=await Et(this,Yt,"m",Ti).call(this,e,s);if(o>h&&h<a){const t=await Et(this,Yt,"m",Li).call(this,e,r,o,n,a,s,h);return this._focusParameters.isDoingFocus=0,t}if(o<h&&o<a){let i=await Et(this,Yt,"m",Ti).call(this,e,t);const n=await Et(this,Yt,"m",Li).call(this,e,t,i,s,h,r,o);return this._focusParameters.isDoingFocus=0,n}if(h>a&&o>a){let t=await Et(this,Yt,"m",Ti).call(this,e,i);const r=await Et(this,Yt,"m",Li).call(this,e,s,h,i,t,n,a);return this._focusParameters.isDoingFocus=0,r}if(o==h&&h<a){const t=await Et(this,Yt,"m",Li).call(this,e,r,o,s,h);return this._focusParameters.isDoingFocus=0,t}if(h==a&&o>h){const t=await Et(this,Yt,"m",Li).call(this,e,s,h,n,a);return this._focusParameters.isDoingFocus=0,t}return f(e,t,i)}catch(e){if("DeprecatedTaskError"!==e.name)throw e}};return f(c,s,r)},xi=function(e){if("opened"!==this.state)throw new Error("Video is not playing.");if(!e||"string"!=typeof e.x||"string"!=typeof e.y)throw new Error("Invalid 'center'.");const t=this.getResolution();let i=0,s=0;if(e.x.endsWith("px"))i=parseFloat(e.x);else{if(!e.x.endsWith("%"))throw new Error("Invalid scale center.");i=parseFloat(e.x)/100*t.width}if(e.y.endsWith("px"))s=parseFloat(e.y);else{if(!e.y.endsWith("%"))throw new Error("Invalid scale center.");s=parseFloat(e.y)/100*t.height}if(isNaN(i)||isNaN(s))throw new Error("Invalid scale center.");It(this,ci,{x:i,y:s},"f")},Fi=function(e){if("opened"!==this.state)throw new Error("Video is not playing.");const t=this.getResolution();return e&&e.x==t.width/2&&e.y==t.height/2},Mi.browserInfo=At,Mi.onWarning=null===(Ht=null===window||void 0===window?void 0:window.console)||void 0===Ht?void 0:Ht.warn;class gs{constructor(e){Oi.add(this),Pi.set(this,void 0),Bi.set(this,0),ki.set(this,void 0),Ni.set(this,0),Wi.set(this,!1),b(this,Pi,e,"f")}startCharging(){S(this,Wi,"f")||(gs._onLog&&gs._onLog("start charging."),S(this,Oi,"m",Ui).call(this),b(this,Wi,!0,"f"))}stopCharging(){S(this,ki,"f")&&clearTimeout(S(this,ki,"f")),S(this,Wi,"f")&&(gs._onLog&&gs._onLog("stop charging."),b(this,Bi,Date.now()-S(this,Ni,"f"),"f"),b(this,Wi,!1,"f"))}}Pi=new WeakMap,Bi=new WeakMap,ki=new WeakMap,Ni=new WeakMap,Wi=new WeakMap,Oi=new WeakSet,Vi=function(){c.cfd(1),gs._onLog&&gs._onLog("charge 1.")},Ui=function e(){0==S(this,Bi,"f")&&S(this,Oi,"m",Vi).call(this),b(this,Ni,Date.now(),"f"),S(this,ki,"f")&&clearTimeout(S(this,ki,"f")),b(this,ki,setTimeout((()=>{b(this,Bi,0,"f"),S(this,Oi,"m",e).call(this)}),S(this,Pi,"f")-S(this,Bi,"f")),"f")};const us=new Map([[d.IPF_GRAYSCALED,Rt.GREY],[d.IPF_ABGR_8888,Rt.RGBA],[d.IPF_ARGB_8888,Rt.BGRA]]),ms=new Map([[Rt.GREY,d.IPF_GRAYSCALED],[Rt.RGBA,d.IPF_ABGR_8888],[Rt.BGRA,d.IPF_ARGB_8888]]),ws="function"==typeof BigInt?{BF_NULL:BigInt(0),BF_ALL:BigInt(0x10000000000000000),BF_DEFAULT:BigInt(4265345023),BF_ONED:BigInt(3147775),BF_GS1_DATABAR:BigInt(260096),BF_CODE_39:BigInt(1),BF_CODE_128:BigInt(2),BF_CODE_93:BigInt(4),BF_CODABAR:BigInt(8),BF_ITF:BigInt(16),BF_EAN_13:BigInt(32),BF_EAN_8:BigInt(64),BF_UPC_A:BigInt(128),BF_UPC_E:BigInt(256),BF_INDUSTRIAL_25:BigInt(512),BF_CODE_39_EXTENDED:BigInt(1024),BF_GS1_DATABAR_OMNIDIRECTIONAL:BigInt(2048),BF_GS1_DATABAR_TRUNCATED:BigInt(4096),BF_GS1_DATABAR_STACKED:BigInt(8192),BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL:BigInt(16384),BF_GS1_DATABAR_EXPANDED:BigInt(32768),BF_GS1_DATABAR_EXPANDED_STACKED:BigInt(65536),BF_GS1_DATABAR_LIMITED:BigInt(131072),BF_PATCHCODE:BigInt(262144),BF_CODE_32:BigInt(16777216),BF_PDF417:BigInt(33554432),BF_QR_CODE:BigInt(67108864),BF_DATAMATRIX:BigInt(134217728),BF_AZTEC:BigInt(268435456),BF_MAXICODE:BigInt(536870912),BF_MICRO_QR:BigInt(1073741824),BF_MICRO_PDF417:BigInt(524288),BF_GS1_COMPOSITE:BigInt(2147483648),BF_MSI_CODE:BigInt(1048576),BF_CODE_11:BigInt(2097152),BF_TWO_DIGIT_ADD_ON:BigInt(4194304),BF_FIVE_DIGIT_ADD_ON:BigInt(8388608),BF_MATRIX_25:BigInt(68719476736),BF_POSTALCODE:BigInt(0x3f0000000000000),BF_NONSTANDARD_BARCODE:BigInt(4294967296),BF_USPSINTELLIGENTMAIL:BigInt(4503599627370496),BF_POSTNET:BigInt(9007199254740992),BF_PLANET:BigInt(0x40000000000000),BF_AUSTRALIANPOST:BigInt(0x80000000000000),BF_RM4SCC:BigInt(72057594037927940),BF_KIX:BigInt(0x200000000000000),BF_DOTCODE:BigInt(8589934592),BF_PHARMACODE_ONE_TRACK:BigInt(17179869184),BF_PHARMACODE_TWO_TRACK:BigInt(34359738368),BF_PHARMACODE:BigInt(51539607552)}:{BF_NULL:"0x00",BF_ALL:"0xFFFFFFFFFFFFFFFF",BF_DEFAULT:"0xFE3BFFFF",BF_ONED:"0x003007FF",BF_GS1_DATABAR:"0x0003F800",BF_CODE_39:"0x1",BF_CODE_128:"0x2",BF_CODE_93:"0x4",BF_CODABAR:"0x8",BF_ITF:"0x10",BF_EAN_13:"0x20",BF_EAN_8:"0x40",BF_UPC_A:"0x80",BF_UPC_E:"0x100",BF_INDUSTRIAL_25:"0x200",BF_CODE_39_EXTENDED:"0x400",BF_GS1_DATABAR_OMNIDIRECTIONAL:"0x800",BF_GS1_DATABAR_TRUNCATED:"0x1000",BF_GS1_DATABAR_STACKED:"0x2000",BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL:"0x4000",BF_GS1_DATABAR_EXPANDED:"0x8000",BF_GS1_DATABAR_EXPANDED_STACKED:"0x10000",BF_GS1_DATABAR_LIMITED:"0x20000",BF_PATCHCODE:"0x00040000",BF_CODE_32:"0x01000000",BF_PDF417:"0x02000000",BF_QR_CODE:"0x04000000",BF_DATAMATRIX:"0x08000000",BF_AZTEC:"0x10000000",BF_MAXICODE:"0x20000000",BF_MICRO_QR:"0x40000000",BF_MICRO_PDF417:"0x00080000",BF_GS1_COMPOSITE:"0x80000000",BF_MSI_CODE:"0x100000",BF_CODE_11:"0x200000",BF_TWO_DIGIT_ADD_ON:"0x400000",BF_FIVE_DIGIT_ADD_ON:"0x800000",BF_MATRIX_25:"0x1000000000",BF_POSTALCODE:"0x3F0000000000000",BF_NONSTANDARD_BARCODE:"0x100000000",BF_USPSINTELLIGENTMAIL:"0x10000000000000",BF_POSTNET:"0x20000000000000",BF_PLANET:"0x40000000000000",BF_AUSTRALIANPOST:"0x80000000000000",BF_RM4SCC:"0x100000000000000",BF_KIX:"0x200000000000000",BF_DOTCODE:"0x200000000",BF_PHARMACODE_ONE_TRACK:"0x400000000",BF_PHARMACODE_TWO_TRACK:"0x800000000",BF_PHARMACODE:"0xC00000000"};class ps extends g{static set _onLog(e){b(ps,ji,e,"f",Hi),Mi._onLog=e,gs._onLog=e}static get _onLog(){return S(ps,ji,"f",Hi)}static async detectEnvironment(){return await(async()=>({wasm:F,worker:D,getUserMedia:R,camera:await M(),browser:x.browser,version:x.version,OS:x.OS}))()}static async testCameraAccess(){const e=await Mi.testCameraAccess();return e.ok?{ok:!0,message:"Successfully accessed the camera."}:"InsecureContext"===e.errorName?{ok:!1,message:"Insecure context."}:"OverconstrainedError"===e.errorName||"NotFoundError"===e.errorName?{ok:!1,message:"No camera detected."}:"NotAllowedError"===e.errorName?{ok:!1,message:"No permission to access camera."}:"AbortError"===e.errorName?{ok:!1,message:"Some problem occurred which prevented the device from being used."}:"NotReadableError"===e.errorName?{ok:!1,message:"A hardware error occurred."}:"SecurityError"===e.errorName?{ok:!1,message:"User media support is disabled."}:{ok:!1,message:e.errorMessage}}static async createInstance(e){var t,s;if(e&&!(e instanceof yt))throw new TypeError("Invalid view.");if(null===(t=i.license)||void 0===t?void 0:t.LicenseManager){if(!(null===(s=i.license)||void 0===s?void 0:s.LicenseManager.bCallInitLicense))throw new Error("License is not set.");await c.loadWasm(["license"]),await i.license.dynamsoft()}const r=new ps(e);return ps.onWarning&&(location&&"file:"===location.protocol?setTimeout((()=>{ps.onWarning&&ps.onWarning({id:1,message:"The page is opened over file:// and Dynamsoft Camera Enhancer may not work properly. Please open the page via https://."})}),0):!1!==window.isSecureContext&&navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||setTimeout((()=>{ps.onWarning&&ps.onWarning({id:2,message:"Dynamsoft Camera Enhancer may not work properly in a non-secure context. Please open the page via https://."})}),0)),r}get video(){return S(this,Yi,"f").getVideoEl()}set videoSrc(e){if(!S(this,Yi,"f"))throw new Error("Camera manager is null.");S(this,Zi,"f")&&(S(this,Zi,"f")._hideDefaultSelection=!0),S(this,Yi,"f").videoSrc=e}get videoSrc(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.videoSrc}set ifSaveLastUsedCamera(e){if(!S(this,Yi,"f"))throw new Error("Camera manager is null.");S(this,Yi,"f").ifSaveLastUsedCamera=e}get ifSaveLastUsedCamera(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.ifSaveLastUsedCamera}set ifSkipCameraInspection(e){if(!S(this,Yi,"f"))throw new Error("Camera manager is null.");S(this,Yi,"f").ifSkipCameraInspection=e}get ifSkipCameraInspection(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.ifSkipCameraInspection}set cameraOpenTimeout(e){if(!S(this,Yi,"f"))throw new Error("Camera manager is null.");S(this,Yi,"f").cameraOpenTimeout=e}get cameraOpenTimeout(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.cameraOpenTimeout}set singleFrameMode(e){if(!["disabled","image","camera"].includes(e))throw new Error("Invalid value.");if(this.isOpen())throw new Error("It is not allowed to change `singleFrameMode` when the camera is open.");b(this,Xi,e,"f")}get singleFrameMode(){return S(this,Xi,"f")}get _isFetchingStarted(){return S(this,is,"f")}get disposed(){return S(this,os,"f")}constructor(e){if(super(),Gi.add(this),Yi.set(this,void 0),Zi.set(this,void 0),zi.set(this,"closed"),Ji.set(this,void 0),Ki.set(this,!1),Xi.set(this,void 0),this._onCameraSelChange=async()=>{this.isOpen()&&S(this,Zi,"f")&&!S(this,Zi,"f").disposed&&await this.selectCamera(S(this,Zi,"f")._selCam.value)},this._onResolutionSelChange=async()=>{if(!this.isOpen())return;if(!S(this,Zi,"f")||S(this,Zi,"f").disposed)return;let e,t;if(S(this,Zi,"f")._selRsl&&-1!=S(this,Zi,"f")._selRsl.selectedIndex){let i=S(this,Zi,"f")._selRsl.options[S(this,Zi,"f")._selRsl.selectedIndex];e=parseInt(i.getAttribute("data-width")),t=parseInt(i.getAttribute("data-height"))}await this.setResolution({width:e,height:t})},this._onCloseBtnClick=async()=>{this.isOpen()&&S(this,Zi,"f")&&!S(this,Zi,"f").disposed&&this.close()},qi.set(this,((e,t,i,s)=>{const r=Date.now(),n={sx:s.x,sy:s.y,sWidth:s.width,sHeight:s.height,dWidth:s.width,dHeight:s.height},a=Math.max(n.dWidth,n.dHeight);if(this.canvasSizeLimit&&a>this.canvasSizeLimit){const e=this.canvasSizeLimit/a;n.dWidth>n.dHeight?(n.dWidth=this.canvasSizeLimit,n.dHeight=Math.round(n.dHeight*e)):(n.dWidth=Math.round(n.dWidth*e),n.dHeight=this.canvasSizeLimit)}const o=S(this,Yi,"f").imageDataGetter.getImageData(e,t,i,n,{pixelFormat:us.get(this.getPixelFormat())});let h=null;if(o){const e=Date.now();let a;if(o.pixelFormat===Rt.GREY)a=o.width;else a=4*o.width;let l=!0;0===n.sx&&0===n.sy&&n.sWidth===t&&n.sHeight===i&&(l=!1),h={bytes:o.data,width:o.width,height:o.height,stride:a,format:ms.get(o.pixelFormat),tag:{imageId:this._imageId==Number.MAX_VALUE?this._imageId=0:++this._imageId,type:u.ITT_FILE_IMAGE,isCropped:l,cropRegion:{left:s.x,top:s.y,right:s.x+s.width,bottom:s.y+s.height,isMeasuredInPercentage:!1},originalWidth:t,originalHeight:i,currentWidth:o.width,currentHeight:o.height,timeSpent:e-r,timeStamp:e},toCanvas:S(this,Qi,"f"),isDCEFrame:!0}}return h})),this._onSingleFrameAcquired=e=>{let t;t=S(this,Zi,"f")?S(this,Zi,"f").getConvertedRegion():se.convert(S(this,es,"f"),e.width,e.height),t||(t={x:0,y:0,width:e.width,height:e.height});const i=S(this,qi,"f").call(this,e,e.width,e.height,t);S(this,Ji,"f").fire("singleFrameAcquired",[i],{async:!1,copy:!1})},Qi.set(this,(function(){if(!(this.bytes instanceof Uint8Array||this.bytes instanceof Uint8ClampedArray))throw new TypeError("Invalid bytes.");if("number"!=typeof this.width||this.width<=0)throw new Error("Invalid width.");if("number"!=typeof this.height||this.height<=0)throw new Error("Invalid height.");const e=document.createElement("canvas");let t;e.width=this.width,e.height=this.height;if(this.format===d.IPF_GRAYSCALED){t=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<t.length;e+=4)t[e]=this.bytes[e/4],t[e+1]=this.bytes[e/4],t[e+2]=this.bytes[e/4],t[e+3]=255}else t=new Uint8ClampedArray(this.bytes.buffer);return e.getContext("2d").putImageData(new ImageData(t,this.width,this.height),0,0),e})),$i.set(this,void 0),es.set(this,void 0),ts.set(this,d.IPF_ABGR_8888),is.set(this,!1),this._imageId=-1,ss.set(this,void 0),this.fetchInterval=0,rs.set(this,{enhancedFocus:!1,autoZoom:!1,tapToFocus:!1}),ns.set(this,{minValue:1,maxValue:999,autoFocusFrameArray:[],autoFocusFrameLimit:[5,3],autoZoomDetectionArea:.5,autoZoomTargetBorder:.9,autoZoomIdealArea:[0,.05],autoZoomInFrameArray:[],autoZoomInFrameLimit:[5,3],autoZoomInMaxTimes:5,autoZoomInMinStep:Math.pow(10,.2),autoZoomInIdealModuleSize:6,autoZoomOutFrameCount:0,autoZoomOutFrameLimit:3,autoZoomOutStepRate:1/3,autoZoomOutStepRate_2:.05,autoZoomOutMinStep:2,frameArrayInIdealZoom:[],frameLimitInIdealZoom:[5,3],nextActionInIdealZoom:"focus",noIntermediateResultsCount:[],enableZoomOutInIdealZoom:!1}),as.set(this,void 0),os.set(this,!1),this.isCameraEnhancer=!0,e&&!(e instanceof yt))throw new TypeError("Invalid view.");b(this,Ji,new ae,"f"),b(this,Yi,new Mi,"f"),this._imageDataGetter=S(this,Yi,"f").imageDataGetter;S(this,Yi,"f").updateVideoElWhenSoftwareScaled=()=>{if(!this.video)return;const e=S(this,Yi,"f").getSoftwareScale();if(e<1)throw new RangeError("Invalid scale value.");S(this,Zi,"f")&&!S(this,Zi,"f").disposed?(this.video.style.transform=1===e?"":`scale(${e})`,S(this,Zi,"f")._updateVideoContainer()):this.video.style.transform=1===e?"":`scale(${e})`},["iPhone","iPad","Android","HarmonyOS"].includes(x.OS)?S(this,Yi,"f").setResolution(1280,720):S(this,Yi,"f").setResolution(1920,1080),navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?this.singleFrameMode="disabled":this.singleFrameMode="image",e&&this.setCameraView(e),this._on("before:camera:change",(()=>{S(this,as,"f").stopCharging();const e=S(this,Zi,"f");e&&!e.disposed&&(e._startLoading(),e.clearAllInnerDrawingItems())})),this._on("camera:changed",(()=>{this.clearBuffer()})),this._on("before:resolution:change",(()=>{const e=S(this,Zi,"f");e&&!e.disposed&&(e._startLoading(),e.clearAllInnerDrawingItems())})),this._on("resolution:changed",(()=>{this.clearBuffer(),e.eventHandler.fire("content:updated",null,{async:!1})})),this._on("paused",(()=>{S(this,as,"f").stopCharging();const e=S(this,Zi,"f");e&&e.disposed})),this._on("resumed",(()=>{const e=S(this,Zi,"f");e&&e.disposed})),this._on("tapfocus",(()=>{S(this,rs,"f").tapToFocus&&S(this,as,"f").startCharging()})),this._intermediateResultReceiver={},this._intermediateResultReceiver.onTaskResultsReceived=async(e,t)=>{var i,s,r,n;if(S(this,Gi,"m",hs).call(this)||!this.isOpen()||this.isPaused())return;const a=e.intermediateResultUnits;ps._onLog&&(ps._onLog("intermediateResultUnits:"),ps._onLog(a));let o=!1,h=!1;for(let e of a){if(e.unitType===m.IRUT_DECODED_BARCODES&&e.decodedBarcodes.length){o=!0;break}e.unitType===m.IRUT_LOCALIZED_BARCODES&&e.localizedBarcodes.length&&(h=!0)}if(ps._onLog&&(ps._onLog("hasLocalizedBarcodes:"),ps._onLog(h)),S(this,rs,"f").autoZoom||S(this,rs,"f").enhancedFocus)if(o)S(this,ns,"f").autoZoomInFrameArray.length=0,S(this,ns,"f").autoZoomOutFrameCount=0,S(this,ns,"f").frameArrayInIdealZoom.length=0,S(this,rs,"f").autoZoom&&S(this,rs,"f").enhancedFocus&&(S(this,ns,"f").nextActionInIdealZoom="focus"),S(this,ns,"f").autoFocusFrameArray.length=0,S(this,ns,"f").noIntermediateResultsCount=0;else{const e=async e=>{await this.setZoom(e),S(this,rs,"f").autoZoom&&S(this,as,"f").startCharging()},t=async e=>{await this.setFocus(e),S(this,rs,"f").enhancedFocus&&S(this,as,"f").startCharging()};if(h){const o=a[0].originalImageTag,h=(null===(i=o.cropRegion)||void 0===i?void 0:i.left)||0,l=(null===(s=o.cropRegion)||void 0===s?void 0:s.top)||0,d=(null===(r=o.cropRegion)||void 0===r?void 0:r.right)?o.cropRegion.right-h:o.originalWidth,c=(null===(n=o.cropRegion)||void 0===n?void 0:n.bottom)?o.cropRegion.bottom-l:o.originalHeight,f=o.currentWidth,g=o.currentHeight;let u;{let e,t,i,s,r;{const e=this.video.videoWidth*(1-S(this,ns,"f").autoZoomDetectionArea)/2,t=this.video.videoWidth*(1+S(this,ns,"f").autoZoomDetectionArea)/2,i=t,s=e,n=this.video.videoHeight*(1-S(this,ns,"f").autoZoomDetectionArea)/2,a=n,o=this.video.videoHeight*(1+S(this,ns,"f").autoZoomDetectionArea)/2;r=[{x:e,y:n},{x:t,y:a},{x:i,y:o},{x:s,y:o}]}ps._onLog&&(ps._onLog("detectionArea:"),ps._onLog(r));const n=[];{const e=(e,t)=>{const i=(e,t)=>{if(!e&&!t)throw new Error("Invalid arguments.");return function(e,t,i){let s=!1;const r=e.length;if(r<=2)return!1;for(let n=0;n<r;n++){const a=e[n],o=e[(n+1)%r];if(oe(a,o,{x:t,y:i}))return!0;he(a.y-i)>0!=he(o.y-i)>0&&he(t-(i-a.y)*(a.x-o.x)/(a.y-o.y)-a.x)<0&&(s=!s)}return s}(t,e.x,e.y)},s=(e,t)=>!!(le([e[0],e[1]],[e[2],e[3]],[t[0].x,t[0].y],[t[1].x,t[1].y])||le([e[0],e[1]],[e[2],e[3]],[t[1].x,t[1].y],[t[2].x,t[2].y])||le([e[0],e[1]],[e[2],e[3]],[t[2].x,t[2].y],[t[3].x,t[3].y])||le([e[0],e[1]],[e[2],e[3]],[t[3].x,t[3].y],[t[0].x,t[0].y]));return!!(i({x:e[0].x,y:e[0].y},t)||i({x:e[1].x,y:e[1].y},t)||i({x:e[2].x,y:e[2].y},t)||i({x:e[3].x,y:e[3].y},t))||(!!(i({x:t[0].x,y:t[0].y},e)||i({x:t[1].x,y:t[1].y},e)||i({x:t[2].x,y:t[2].y},e)||i({x:t[3].x,y:t[3].y},e))||!!(s([t[0].x,t[0].y,t[1].x,t[1].y],e)||s([t[1].x,t[1].y,t[2].x,t[2].y],e)||s([t[2].x,t[2].y,t[3].x,t[3].y],e)||s([t[3].x,t[3].y,t[0].x,t[0].y],e)))};for(let t of a)if(t.unitType===m.IRUT_LOCALIZED_BARCODES)for(let i of t.localizedBarcodes){if(!i)continue;const t=i.location.points;t.forEach((e=>{yt._transformCoordinates(e,h,l,d,c,f,g)})),e(r,t)&&n.push(i)}if(ps._debug&&S(this,Zi,"f")){const e=this.__layer||(this.__layer=S(this,Zi,"f")._createDrawingLayer(99));e.clearDrawingItems();const t=this.__styleId2||(this.__styleId2=ft.createDrawingStyle({strokeStyle:"red"}));for(let i of a)if(i.unitType===m.IRUT_LOCALIZED_BARCODES)for(let s of i.localizedBarcodes){if(!s)continue;const i=s.location.points,r=new Ee({points:i},t);e.addDrawingItems([r])}}}if(ps._onLog&&(ps._onLog("intersectedResults:"),ps._onLog(n)),!n.length)return;let o;if(n.length){let e=n.filter((e=>e.possibleFormats==ws.BF_QR_CODE||e.possibleFormats==ws.BF_DATAMATRIX));if(e.length||(e=n.filter((e=>e.possibleFormats==ws.BF_ONED)),e.length||(e=n)),e.length){const t=e=>{const t=e.location.points,i=(t[0].x+t[1].x+t[2].x+t[3].x)/4,s=(t[0].y+t[1].y+t[2].y+t[3].y)/4;return(i-f/2)*(i-f/2)+(s-g/2)*(s-g/2)};o=e[0];let i=t(o);if(1!=e.length)for(let s=1;s<e.length;s++){const r=t(e[s]);e[s].confidence>1.1*o.confidence?(o=e[s],i=r):e[s].confidence>.9*o.confidence&&r<i&&(o=e[s],i=r)}}}if(ps._onLog&&(ps._onLog("highPriorityResult:"),ps._onLog(o)),o){const r=o.location.points;e=Math.min(r[0].x,r[1].x,r[2].x,r[3].x),t=Math.max(r[0].x,r[1].x,r[2].x,r[3].x),i=Math.min(r[0].y,r[1].y,r[2].y,r[3].y),s=Math.max(r[0].y,r[1].y,r[2].y,r[3].y),u={points:[{x:e,y:i},{x:t,y:i},{x:t,y:s},{x:e,y:s}],result:o}}}if(ps._onLog&&(ps._onLog("boundingRect:"),ps._onLog(u)),!u)return;if(ps._debug&&S(this,Zi,"f")&&(null==u?void 0:u.points)){const e=this.__layer||(this.__layer=S(this,Zi,"f")._createDrawingLayer(99)),t=this.__styleId1||(this.__styleId1=ft.createDrawingStyle({strokeStyle:"blue"})),i=new Ee({points:u.points},t);e.addDrawingItems([i])}if(S(this,ns,"f").autoZoomOutFrameCount=0,S(this,ns,"f").noIntermediateResultsCount=0,S(this,rs,"f").autoZoom){const i=S(this,ns,"f").autoZoomIdealArea[1];let s=(1-S(this,ns,"f").autoZoomTargetBorder)/2;const r=u.points[0].x/d,n=(d-u.points[2].x)/d,a=u.points[0].y/c,o=(c-u.points[2].y)/c;if(r>i&&n>i&&a>i&&o>i&&u.result.moduleSize<S(this,ns,"f").autoZoomInIdealModuleSize){if(S(this,ns,"f").autoZoomInFrameArray.push(!0),S(this,ns,"f").autoZoomInFrameArray.splice(0,S(this,ns,"f").autoZoomInFrameArray.length-S(this,ns,"f").autoZoomInFrameLimit[0]),S(this,ns,"f").frameArrayInIdealZoom.length=0,S(this,rs,"f").enhancedFocus&&(S(this,ns,"f").nextActionInIdealZoom="focus",t({mode:"continuous"}).catch((()=>{}))),S(this,ns,"f").autoZoomInFrameArray.filter((e=>!0===e)).length>=S(this,ns,"f").autoZoomInFrameLimit[1]){S(this,ns,"f").autoZoomInFrameArray.length=0;const t=[(.5-s)/(.5-r),(.5-s)/(.5-n),(.5-s)/(.5-a),(.5-s)/(.5-o)].filter((e=>e>0)),i=Math.min(...t,S(this,ns,"f").autoZoomInIdealModuleSize/u.result.moduleSize),h=this.getZoomSettings().factor;let l=Math.max(Math.pow(h*i,1/S(this,ns,"f").autoZoomInMaxTimes),S(this,ns,"f").autoZoomInMinStep);l=Math.min(l,i);let d=h*l;d=Math.max(S(this,ns,"f").minValue,d),d=Math.min(S(this,ns,"f").maxValue,d);try{await e({factor:d})}catch(e){const t=e.message||e;console.warn(t)}this.clearBuffer()}}else if(S(this,ns,"f").autoZoomInFrameArray.length=0,S(this,ns,"f").frameArrayInIdealZoom.push(!0),S(this,ns,"f").frameArrayInIdealZoom.splice(0,S(this,ns,"f").frameArrayInIdealZoom.length-S(this,ns,"f").frameLimitInIdealZoom[0]),S(this,ns,"f").frameArrayInIdealZoom.filter((e=>!0===e)).length>=S(this,ns,"f").frameLimitInIdealZoom[1])if(S(this,ns,"f").frameArrayInIdealZoom.length=0,"focus"===S(this,ns,"f").nextActionInIdealZoom&&S(this,rs,"f").enhancedFocus){const e=u.points;try{await t({mode:"manual",area:{centerPoint:{x:(e[0].x+e[2].x)/2+"px",y:(e[0].y+e[2].y)/2+"px"},width:e[2].x-e[0].x+"px",height:e[2].y-e[0].y+"px"}})}catch(e){const t=e.message||e;console.warn(t)}this.clearBuffer()}else{if("zoomOut"!==S(this,ns,"f").nextActionInIdealZoom&&S(this,rs,"f").enhancedFocus)throw new Error("Invalid action.");if(S(this,ns,"f").enableZoomOutInIdealZoom){s=S(this,ns,"f").autoZoomIdealArea[1]+S(this,ns,"f").autoZoomOutStepRate_2;const i=[(.5-s)/(.5-r),(.5-s)/(.5-n),(.5-s)/(.5-a),(.5-s)/(.5-o)].filter((e=>e>0));let h=Math.min(...i)*this.getZoomSettings().factor;h=Math.max(S(this,ns,"f").minValue,h),h=Math.min(S(this,ns,"f").maxValue,h);try{await e({factor:h})}catch(e){const t=e.message||e;console.warn(t)}this.clearBuffer(),S(this,rs,"f").enhancedFocus&&(S(this,ns,"f").nextActionInIdealZoom="focus",t({mode:"continuous"}).catch((()=>{})))}}}if(!S(this,rs,"f").autoZoom&&S(this,rs,"f").enhancedFocus&&(S(this,ns,"f").autoFocusFrameArray.push(!0),S(this,ns,"f").autoFocusFrameArray.splice(0,S(this,ns,"f").autoFocusFrameArray.length-S(this,ns,"f").autoFocusFrameLimit[0]),S(this,ns,"f").autoFocusFrameArray.filter((e=>!0===e)).length>=S(this,ns,"f").autoFocusFrameLimit[1])){S(this,ns,"f").autoFocusFrameArray.length=0;try{const e=u.points;await t({mode:"manual",area:{centerPoint:{x:(e[0].x+e[2].x)/2+"px",y:(e[0].y+e[2].y)/2+"px"},width:e[2].x-e[0].x+"px",height:e[2].y-e[0].y+"px"}})}catch(e){const t=e.message||e;console.warn(t)}this.clearBuffer()}}else{if(S(this,ns,"f").noIntermediateResultsCount++,S(this,rs,"f").autoZoom){if(S(this,ns,"f").autoZoomInFrameArray.push(!1),S(this,ns,"f").autoZoomInFrameArray.splice(0,S(this,ns,"f").autoZoomInFrameArray.length-S(this,ns,"f").autoZoomInFrameLimit[0]),S(this,ns,"f").autoZoomOutFrameCount++,S(this,ns,"f").frameArrayInIdealZoom.push(!1),S(this,ns,"f").frameArrayInIdealZoom.splice(0,S(this,ns,"f").frameArrayInIdealZoom.length-S(this,ns,"f").frameLimitInIdealZoom[0]),S(this,ns,"f").autoZoomOutFrameCount>=S(this,ns,"f").autoZoomOutFrameLimit){S(this,ns,"f").autoZoomOutFrameCount=0;const t=this.getZoomSettings().factor;let i=t-Math.max((t-1)*S(this,ns,"f").autoZoomOutStepRate,S(this,ns,"f").autoZoomOutMinStep);i=Math.max(S(this,ns,"f").minValue,i),i=Math.min(S(this,ns,"f").maxValue,i);try{await e({factor:i})}catch(e){const t=e.message||e;console.warn(t)}this.clearBuffer()}S(this,rs,"f").enhancedFocus&&(S(this,ns,"f").nextActionInIdealZoom="focus",t({mode:"continuous"}).catch((()=>{})))}!S(this,rs,"f").autoZoom&&S(this,rs,"f").enhancedFocus&&(S(this,ns,"f").autoFocusFrameArray.length=0,t({mode:"continuous"}).catch((()=>{})))}}},b(this,as,new gs(1e4),"f")}setCameraView(e){if(!(e instanceof yt))throw new TypeError("Invalid view.");if(e.disposed)throw new Error("The camera view has been disposed.");if(this.isOpen())throw new Error("It is not allowed to change camera view when the camera is open.");this.releaseCameraView(),e._singleFrameMode=this.singleFrameMode,e._onSingleFrameAcquired=this._onSingleFrameAcquired,this.videoSrc&&(S(this,Zi,"f")._hideDefaultSelection=!0),S(this,Gi,"m",hs).call(this)||S(this,Yi,"f").setVideoEl(e.getVideoElement()),b(this,Zi,e,"f"),this.addListenerToView()}getCameraView(){return S(this,Zi,"f")}releaseCameraView(){S(this,Zi,"f")&&(this.removeListenerFromView(),S(this,Zi,"f").disposed||(S(this,Zi,"f")._singleFrameMode="disabled",S(this,Zi,"f")._onSingleFrameAcquired=null,S(this,Zi,"f")._hideDefaultSelection=!1),S(this,Yi,"f").releaseVideoEl(),b(this,Zi,null,"f"))}addListenerToView(){if(!S(this,Zi,"f"))return;if(S(this,Zi,"f").disposed)throw new Error("'cameraView' has been disposed.");const e=S(this,Zi,"f");S(this,Gi,"m",hs).call(this)||this.videoSrc||(e._innerComponent&&(S(this,Yi,"f").tapFocusEventBoundEl=e._innerComponent),e._selCam&&e._selCam.addEventListener("change",this._onCameraSelChange),e._selRsl&&e._selRsl.addEventListener("change",this._onResolutionSelChange)),e._btnClose&&e._btnClose.addEventListener("click",this._onCloseBtnClick)}removeListenerFromView(){if(!S(this,Zi,"f")||S(this,Zi,"f").disposed)return;const e=S(this,Zi,"f");S(this,Yi,"f").tapFocusEventBoundEl=null,e._selCam&&e._selCam.removeEventListener("change",this._onCameraSelChange),e._selRsl&&e._selRsl.removeEventListener("change",this._onResolutionSelChange),e._btnClose&&e._btnClose.removeEventListener("click",this._onCloseBtnClick)}getCameraState(){return S(this,Gi,"m",hs).call(this)?S(this,zi,"f"):new Map([["closed","closed"],["opening","opening"],["opened","open"]]).get(S(this,Yi,"f").state)}isOpen(){return"open"===this.getCameraState()}getVideoEl(){return this.video}async open(){const e=S(this,Zi,"f");if(null==e?void 0:e.disposed)throw new Error("'cameraView' has been disposed.");e&&(e._singleFrameMode=this.singleFrameMode,S(this,Gi,"m",hs).call(this)?e._clickIptSingleFrameMode():(S(this,Yi,"f").setVideoEl(e.getVideoElement()),e._startLoading()));let t={width:0,height:0,deviceId:""};if(S(this,Gi,"m",hs).call(this));else{try{await S(this,Yi,"f").open()}catch(t){throw e&&e._stopLoading(),t}S(this,Ki,"f")&&this.turnOnTorch().catch((()=>{}));const i=this.getResolution();t.width=i.width,t.height=i.height,t.deviceId=this.getSelectedCamera().deviceId}return b(this,zi,"open","f"),e&&(e._innerComponent.style.display="",S(this,Gi,"m",hs).call(this)||(e._stopLoading(),e._renderCamerasInfo(this.getSelectedCamera(),S(this,Yi,"f")._arrCameras),e._renderResolutionInfo({width:t.width,height:t.height}),e.eventHandler.fire("content:updated",null,{async:!0}),e.eventHandler.fire("videoEl:resized",null,{async:!0}))),S(this,Ji,"f").fire("opened",null,{target:this,async:!0}),t}close(){const e=S(this,Zi,"f");if(null==e?void 0:e.disposed)throw new Error("'cameraView' has been disposed.");this.stopFetching(),this.clearBuffer(),S(this,Gi,"m",hs).call(this)||S(this,Yi,"f").close(),b(this,zi,"closed","f"),S(this,as,"f").stopCharging(),e&&(e._innerComponent.style.display="none",S(this,Gi,"m",hs).call(this)&&e._innerComponent.removeElement("content"),e._stopLoading()),S(this,Ji,"f").fire("closed",null,{target:this,async:!0})}pause(){if(S(this,Gi,"m",hs).call(this))throw new Error("'pause()' is invalid in 'singleFrameMode'.");S(this,Yi,"f").pause()}isPaused(){var e;return!S(this,Gi,"m",hs).call(this)&&!0===(null===(e=this.video)||void 0===e?void 0:e.paused)}async resume(){if(S(this,Gi,"m",hs).call(this))throw new Error("'resume()' is invalid in 'singleFrameMode'.");await S(this,Yi,"f").resume()}async selectCamera(e){if(!e)throw new Error("Invalid value.");let t;t="string"==typeof e?e:e.deviceId,await S(this,Yi,"f").setCamera(t),b(this,Ki,!1,"f");const i=this.getResolution(),s=S(this,Zi,"f");return s&&!s.disposed&&(s._stopLoading(),s._renderCamerasInfo(this.getSelectedCamera(),S(this,Yi,"f")._arrCameras),s._renderResolutionInfo({width:i.width,height:i.height})),{width:i.width,height:i.height,deviceId:this.getSelectedCamera().deviceId}}getSelectedCamera(){return S(this,Yi,"f").getCamera()}async getAllCameras(){return S(this,Yi,"f").getCameras()}async setResolution(e){await S(this,Yi,"f").setResolution(e.width,e.height),S(this,Ki,"f")&&this.turnOnTorch().catch((()=>{}));const t=this.getResolution(),i=S(this,Zi,"f");return i&&!i.disposed&&(i._stopLoading(),i._renderResolutionInfo({width:t.width,height:t.height})),{width:t.width,height:t.height,deviceId:this.getSelectedCamera().deviceId}}getResolution(){return S(this,Yi,"f").getResolution()}getAvailableResolutions(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.getResolutions()}_on(e,t){["opened","closed","singleframeacquired","frameaddedtobuffer"].includes(e.toLowerCase())?S(this,Ji,"f").on(e,t):S(this,Yi,"f").on(e,t)}_off(e,t){["opened","closed","singleframeacquired","frameaddedtobuffer"].includes(e.toLowerCase())?S(this,Ji,"f").off(e,t):S(this,Yi,"f").off(e,t)}on(e,t){const i=e.toLowerCase(),s=new Map([["cameraopen","opened"],["cameraclose","closed"],["camerachange","camera:changed"],["resolutionchange","resolution:changed"],["played","played"],["singleframeacquired","singleFrameAcquired"],["frameaddedtobuffer","frameAddedToBuffer"]]).get(i);if(!s)throw new Error("Invalid event.");this._on(s,t)}off(e,t){const i=e.toLowerCase(),s=new Map([["cameraopen","opened"],["cameraclose","closed"],["camerachange","camera:changed"],["resolutionchange","resolution:changed"],["played","played"],["singleframeacquired","singleFrameAcquired"],["frameaddedtobuffer","frameAddedToBuffer"]]).get(i);if(!s)throw new Error("Invalid event.");this._off(s,t)}getVideoSettings(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.getMediaStreamConstraints()}async updateVideoSettings(e){var t;await(null===(t=S(this,Yi,"f"))||void 0===t?void 0:t.setMediaStreamConstraints(e,!0))}getCapabilities(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.getCameraCapabilities()}getCameraSettings(){return S(this,Yi,"f").getCameraSettings()}async turnOnTorch(){var e;if(S(this,Gi,"m",hs).call(this))throw new Error("'turnOnTorch()' is invalid in 'singleFrameMode'.");await(null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.turnOnTorch()),b(this,Ki,!0,"f")}async turnOffTorch(){var e;if(S(this,Gi,"m",hs).call(this))throw new Error("'turnOffTorch()' is invalid in 'singleFrameMode'.");await(null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.turnOffTorch()),b(this,Ki,!1,"f")}async setColorTemperature(e){if(S(this,Gi,"m",hs).call(this))throw new Error("'setColorTemperature()' is invalid in 'singleFrameMode'.");await S(this,Yi,"f").setColorTemperature(e,!0)}getColorTemperature(){return S(this,Yi,"f").getColorTemperature()}async setExposureCompensation(e){var t;if(S(this,Gi,"m",hs).call(this))throw new Error("'setExposureCompensation()' is invalid in 'singleFrameMode'.");await(null===(t=S(this,Yi,"f"))||void 0===t?void 0:t.setExposureCompensation(e,!0))}getExposureCompensation(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.getExposureCompensation()}async _setZoom(e){var t;if(S(this,Gi,"m",hs).call(this))throw new Error("'setZoom()' is invalid in 'singleFrameMode'.");await(null===(t=S(this,Yi,"f"))||void 0===t?void 0:t.setZoom(e))}async setZoom(e){await this._setZoom(e)}getZoomSettings(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.getZoom()}async resetZoom(){var e;if(S(this,Gi,"m",hs).call(this))throw new Error("'resetZoom()' is invalid in 'singleFrameMode'.");await(null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.resetZoom())}async setFrameRate(e){var t;if(S(this,Gi,"m",hs).call(this))throw new Error("'setFrameRate()' is invalid in 'singleFrameMode'.");await(null===(t=S(this,Yi,"f"))||void 0===t?void 0:t.setFrameRate(e,!0))}getFrameRate(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.getFrameRate()}async setFocus(e){var t;if(S(this,Gi,"m",hs).call(this))throw new Error("'setFocus()' is invalid in 'singleFrameMode'.");await(null===(t=S(this,Yi,"f"))||void 0===t?void 0:t.setFocus(e,!0))}getFocusSettings(){var e;return null===(e=S(this,Yi,"f"))||void 0===e?void 0:e.getFocus()}setAutoZoomRange(e){S(this,ns,"f").minValue=e.min,S(this,ns,"f").maxValue=e.max}getAutoZoomRange(){return{min:S(this,ns,"f").minValue,max:S(this,ns,"f").maxValue}}async enableEnhancedFeatures(e){var t,s;if(!(null===(s=null===(t=i.license)||void 0===t?void 0:t.LicenseManager)||void 0===s?void 0:s.bPassValidation))throw new Error("License is not verified, or license is invalid.");if(0!==c.bSupportDce4Module)throw new Error("Please set a license containing the DCE module.");e&B.EF_ENHANCED_FOCUS&&(S(this,rs,"f").enhancedFocus=!0),e&B.EF_AUTO_ZOOM&&(S(this,rs,"f").autoZoom=!0),e&B.EF_TAP_TO_FOCUS&&(S(this,rs,"f").tapToFocus=!0,S(this,Yi,"f").enableTapToFocus())}disableEnhancedFeatures(e){e&B.EF_ENHANCED_FOCUS&&(S(this,rs,"f").enhancedFocus=!1,this.setFocus({mode:"continuous"}).catch((()=>{}))),e&B.EF_AUTO_ZOOM&&(S(this,rs,"f").autoZoom=!1,this.resetZoom().catch((()=>{}))),e&B.EF_TAP_TO_FOCUS&&(S(this,rs,"f").tapToFocus=!1,S(this,Yi,"f").disableTapToFocus()),S(this,Gi,"m",ds).call(this)&&S(this,Gi,"m",ls).call(this)||S(this,as,"f").stopCharging()}_setScanRegion(e){if(null!=e&&!X(e)&&!te(e))throw TypeError("Invalid 'region'.");b(this,es,e?JSON.parse(JSON.stringify(e)):null,"f"),S(this,Zi,"f")&&!S(this,Zi,"f").disposed&&S(this,Zi,"f").setScanRegion(e)}setScanRegion(e){this._setScanRegion(e),S(this,Zi,"f")&&!S(this,Zi,"f").disposed&&(null===e?S(this,Zi,"f").setScanRegionMaskVisible(!1):S(this,Zi,"f").setScanRegionMaskVisible(!0))}getScanRegion(){return JSON.parse(JSON.stringify(S(this,es,"f")))}setErrorListener(e){if(!e)throw new TypeError("Invalid 'listener'");b(this,$i,e,"f")}hasNextImageToFetch(){return!("open"!==this.getCameraState()||!S(this,Yi,"f").isVideoLoaded()||S(this,Gi,"m",hs).call(this))}startFetching(){if(S(this,Gi,"m",hs).call(this))throw Error("'startFetching()' is unavailable in 'singleFrameMode'.");S(this,is,"f")||(b(this,is,!0,"f"),S(this,Gi,"m",cs).call(this))}stopFetching(){S(this,is,"f")&&(ps._onLog&&ps._onLog("DCE: stop fetching loop: "+Date.now()),S(this,ss,"f")&&clearTimeout(S(this,ss,"f")),b(this,is,!1,"f"))}fetchImage(){if(S(this,Gi,"m",hs).call(this))throw new Error("'fetchImage()' is unavailable in 'singleFrameMode'.");if(!this.video)throw new Error("The video element does not exist.");if(4!==this.video.readyState)throw new Error("The video is not loaded.");const e=this.getResolution();if(!(null==e?void 0:e.width)||!(null==e?void 0:e.height))throw new Error("The video is not loaded.");let t;if(t=se.convert(S(this,es,"f"),e.width,e.height),t||(t={x:0,y:0,width:e.width,height:e.height}),t.x>e.width||t.y>e.height)throw new Error("Invalid scan region.");t.x+t.width>e.width&&(t.width=e.width-t.x),t.y+t.height>e.height&&(t.height=e.height-t.y);const i={sx:t.x,sy:t.y,sWidth:t.width,sHeight:t.height,dWidth:t.width,dHeight:t.height},s=Math.max(i.dWidth,i.dHeight);if(this.canvasSizeLimit&&s>this.canvasSizeLimit){const e=this.canvasSizeLimit/s;i.dWidth>i.dHeight?(i.dWidth=this.canvasSizeLimit,i.dHeight=Math.round(i.dHeight*e)):(i.dWidth=Math.round(i.dWidth*e),i.dHeight=this.canvasSizeLimit)}const r=S(this,Yi,"f").getFrameData({position:i,pixelFormat:us.get(this.getPixelFormat())});if(!r)return null;let n;if(r.pixelFormat===Rt.GREY)n=r.width;else n=4*r.width;let a=!0;0===i.sx&&0===i.sy&&i.sWidth===e.width&&i.sHeight===e.height&&(a=!1);return{bytes:r.data,width:r.width,height:r.height,stride:n,format:ms.get(r.pixelFormat),tag:{imageId:this._imageId==Number.MAX_VALUE?this._imageId=0:++this._imageId,type:u.ITT_VIDEO_FRAME,isCropped:a,cropRegion:{left:t.x,top:t.y,right:t.x+t.width,bottom:t.y+t.height,isMeasuredInPercentage:!1},originalWidth:e.width,originalHeight:e.height,currentWidth:r.width,currentHeight:r.height,timeSpent:r.timeSpent,timeStamp:r.timeStamp},toCanvas:S(this,Qi,"f"),isDCEFrame:!0}}setImageFetchInterval(e){this.fetchInterval=e,S(this,is,"f")&&(S(this,ss,"f")&&clearTimeout(S(this,ss,"f")),b(this,ss,setTimeout((()=>{this.disposed||S(this,Gi,"m",cs).call(this)}),e),"f"))}getImageFetchInterval(){return this.fetchInterval}setPixelFormat(e){b(this,ts,e,"f")}getPixelFormat(){return S(this,ts,"f")}takePhoto(e){if(!this.isOpen())throw new Error("Not open.");if(S(this,Gi,"m",hs).call(this))throw new Error("'takePhoto()' is unavailable in 'singleFrameMode'.");const t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),t.setAttribute("capture",""),t.style.position="fixed",t.style.left="-1px",t.style.top="-1px",t.style.width="1px",t.style.height="1px",t.style.backgroundColor="transparent",t.style.color="transparent",t.addEventListener("click",(()=>{const e=this.isOpen();this.close(),window.addEventListener("focus",(()=>{e&&this.open(),t.remove()}),{once:!0})})),t.addEventListener("change",(async()=>{const i=t.files[0],s=await(async e=>{let t=null,i=null;if("undefined"!=typeof createImageBitmap)try{if(t=await createImageBitmap(e),t)return t}catch(e){}var s;return t||(i=await(s=e,new Promise(((e,t)=>{let i=URL.createObjectURL(s),r=new Image;r.src=i,r.onload=()=>{URL.revokeObjectURL(r.src),e(r)},r.onerror=e=>{t(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}})))),i})(i),r=s instanceof HTMLImageElement?s.naturalWidth:s.width,n=s instanceof HTMLImageElement?s.naturalHeight:s.height;let a=se.convert(S(this,es,"f"),r,n);a||(a={x:0,y:0,width:r,height:n});const o=S(this,qi,"f").call(this,s,r,n,a);e&&e(o)})),document.body.appendChild(t),t.click()}convertToPageCoordinates(e){const t=S(this,Gi,"m",fs).call(this,e);return{x:t.pageX,y:t.pageY}}convertToClientCoordinates(e){const t=S(this,Gi,"m",fs).call(this,e);return{x:t.clientX,y:t.clientY}}dispose(){this.close(),S(this,Yi,"f").dispose(),this.releaseCameraView(),this.__proto__=null;for(let e in this)delete this[e];Object.defineProperty(this,"isCameraEnhancer",{value:!0}),Object.defineProperty(this,"disposed",{value:!0})}}var _s,ys,vs,Es;ji=ps,Yi=new WeakMap,Zi=new WeakMap,zi=new WeakMap,Ji=new WeakMap,Ki=new WeakMap,Xi=new WeakMap,qi=new WeakMap,Qi=new WeakMap,$i=new WeakMap,es=new WeakMap,ts=new WeakMap,is=new WeakMap,ss=new WeakMap,rs=new WeakMap,ns=new WeakMap,as=new WeakMap,os=new WeakMap,Gi=new WeakSet,hs=function(){return"disabled"!==this.singleFrameMode},ls=function(){return!this.videoSrc&&"opened"===S(this,Yi,"f").state},ds=function(){for(let e in S(this,rs,"f"))if(1==S(this,rs,"f")[e])return!0;return!1},cs=function e(){if(this.disposed)return;if("open"!==this.getCameraState()||!S(this,is,"f"))return S(this,ss,"f")&&clearTimeout(S(this,ss,"f")),void b(this,ss,setTimeout((()=>{this.disposed||S(this,Gi,"m",e).call(this)}),this.fetchInterval),"f");const t=()=>{var e;let t;ps._onLog&&ps._onLog("DCE: start fetching a frame into buffer: "+Date.now());try{t=this.fetchImage()}catch(t){const i=t.message||t;if("The video is not loaded."===i)return;if(null===(e=S(this,$i,"f"))||void 0===e?void 0:e.onErrorReceived)return void setTimeout((()=>{var e;null===(e=S(this,$i,"f"))||void 0===e||e.onErrorReceived(p.EC_IMAGE_READ_FAILED,i)}),0);throw t}t?(this.addImageToBuffer(t),ps._onLog&&ps._onLog("DCE: finish fetching a frame into buffer: "+Date.now()),S(this,Ji,"f").fire("frameAddedToBuffer",null,{async:!0})):ps._onLog&&ps._onLog("DCE: get a invalid frame, abandon it: "+Date.now())};if(this.getImageCount()>=this.getMaxImageCount())switch(this.getBufferOverflowProtectionMode()){case w.BOPM_BLOCK:break;case w.BOPM_UPDATE:t()}else t();S(this,ss,"f")&&clearTimeout(S(this,ss,"f")),b(this,ss,setTimeout((()=>{this.disposed||S(this,Gi,"m",e).call(this)}),this.fetchInterval),"f")},fs=function(e){if(!S(this,Zi,"f"))throw new Error("Camera view is not set.");if(S(this,Zi,"f").disposed)throw new Error("'cameraView' has been disposed.");if(!this.isOpen())throw new Error("Not open.");if(!S(this,Gi,"m",hs).call(this)&&!S(this,Yi,"f").isVideoLoaded())throw new Error("Video is not loaded.");if(S(this,Gi,"m",hs).call(this)&&!S(this,Zi,"f")._cvsSingleFrameMode)throw new Error("No image is selected.");const t=S(this,Zi,"f")._innerComponent.getBoundingClientRect(),i=t.left,s=t.top,r=i+window.scrollX,n=s+window.scrollY,{width:a,height:o}=S(this,Zi,"f")._innerComponent.getBoundingClientRect();if(a<=0||o<=0)throw new Error("Unable to get content dimensions. Camera view may not be rendered on the page.");let h,l,d;if(S(this,Gi,"m",hs).call(this)){const e=S(this,Zi,"f")._innerComponent.getElement("content");h=e.width,l=e.height,d="contain"}else{const e=this.getVideoEl();h=e.videoWidth,l=e.videoHeight,d=S(this,Zi,"f").getVideoFit()}const c=a/o,f=h/l;let g,u,m,w,p=1;if("contain"===d)c<f?(p=a/h,g=i+e.x*p,u=s+e.y*p+(o-l*p)/2,m=r+e.x*p,w=n+e.y*p+(o-l*p)/2):(p=o/l,g=i+e.x*p+(a-h*p)/2,u=s+e.y*p,m=r+e.x*p+(a-h*p)/2,w=n+e.y*p);else if("cover"===d)if(c<f){p=o/l;let t=e.x*p-(h*p-a)/2;t=Math.max(t,0),t=Math.min(t,a),g=i+t,u=s+e.y*p,m=r+t,w=n+e.y*p}else{p=a/h;let t=e.y*p-(l*p-o)/2;t=Math.max(t,0),t=Math.min(t,o),g=i+e.x*p,u=s+t,m=r+e.x*p,w=n+t}return{clientX:g,clientY:u,pageX:m,pageY:w}},ps._debug=!1,Hi={value:void 0},ps.browserInfo=x;class Is{static get beepSoundSource(){return S(Is,_s,"f",Es)}static set beepSoundSource(e){b(Is,_s,e,"f",Es),b(Is,_s,new y({src:[S(Is,_s,"f",Es)],onplayerror:(e,t)=>{console.warn(`Sound '${e}' playback failure: ${t}`)}}),"f",vs)}static vibrate(){if(!navigator||!navigator.vibrate)throw new Error("Not supported.");navigator.vibrate(Is.vibrateDuration)}static beep(){S(Is,_s,"f",vs)&&(S(Is,_s,"f",vs).stop(),S(Is,_s,"f",vs).play())}}_s=Is,Is.vibrateDuration=300,vs={value:new y({src:[S(Is,_s,"f",ys={value:"data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAABQAAAkAAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCgoKCgoKCgoKCgoKCgwMDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODg4ODg4ODg4ODg4P//////////////////////////AAAAAExhdmM1OC41NAAAAAAAAAAAAAAAACQEUQAAAAAAAAJAk0uXRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAANQAbGeUEQAAHZYZ3fASqD4P5TKBgocg+Bw/8+CAYBA4XB9/4EBAEP4nB9+UOf/6gfUCAIKyjgQ/Kf//wfswAAAwQA/+MYxAYOqrbdkZGQAMA7DJLCsQxNOij///////////+tv///3RWiZGBEhsf/FO/+LoCSFs1dFVS/g8f/4Mhv0nhqAieHleLy/+MYxAYOOrbMAY2gABf/////////////////usPJ66R0wI4boY9/8jQYg//g2SPx1M0N3Z0kVJLIs///Uw4aMyvHJJYmPBYG/+MYxAgPMALBucAQAoGgaBoFQVBUFQWDv6gZBUFQVBUGgaBr5YSgqCoKhIGg7+IQVBUFQVBoGga//SsFSoKnf/iVTEFNRTMu/+MYxAYAAANIAAAAADEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"})],onplayerror:(e,t)=>{console.warn(`Sound '${e}' playback failure: ${t}`)}})},Es={value:S(Is,_s,"f",ys)};const Ss={RectDrawingItem:we,ImageDrawingItem:class extends Z{set maintainAspectRatio(e){e&&this.set("scaleY",this.get("scaleX"))}get maintainAspectRatio(){return S(this,ue,"f")}constructor(e,t,i,s){if(super(null,s),ge.set(this,void 0),ue.set(this,void 0),!te(t))throw new TypeError("Invalid 'rect'.");if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement)this._setFabricObject(new _.Image(e,{left:t.x,top:t.y}));else{if(!K(e))throw new TypeError("Invalid 'image'.");{const i=document.createElement("canvas");let s;i.width=e.width,i.height=e.height;if(e.format===d.IPF_GRAYSCALED){s=new Uint8ClampedArray(e.width*e.height*4);for(let t=0;t<s.length;t+=4)s[t]=e.bytes[t/4],s[t+1]=e.bytes[t/4],s[t+2]=e.bytes[t/4],s[t+3]=255}else s=new Uint8ClampedArray(e.bytes.buffer);i.getContext("2d").putImageData(new ImageData(s,e.width,e.height),0,0),this._setFabricObject(new _.Image(i,{left:t.x,top:t.y}))}}if(i){const e=t.width/this.get("width");this.set("scaleX",e),this.set("scaleY",e)}else this.set("scaleX",t.width/this.get("width")),this.set("scaleY",t.height/this.get("height"));this.image=e,b(this,ge,JSON.parse(JSON.stringify(t)),"f"),b(this,ue,i,"f"),this._mediaType="image"}extendSet(e,t){if("image"===e){if(t instanceof HTMLImageElement)return this._fabricObject.setElement(t),this.image=t,!0;if(t instanceof HTMLCanvasElement){const e=new Image;return e.src=t.toDataURL(),this._fabricObject.setElement(e),this.image=t,!0}throw new Error("Unsupported value.")}}extendGet(e){if("image"===e)return this.image}updateCoordinateBaseFromImageToView(){if(this.set("left",this.convertPropFromViewToImage(this.get("left"))),this.set("top",this.convertPropFromViewToImage(this.get("top"))),S(this,ue,"f")){const e=this.convertPropFromViewToImage(this.get("width"))/this.get("width");this.set("scaleX",e),this.set("scaleY",e)}else this.set("scaleX",this.convertPropFromViewToImage(this.get("width"))/this.get("width")),this.set("scaleY",this.convertPropFromViewToImage(this.get("height"))/this.get("height"))}updateCoordinateBaseFromViewToImage(){if(this.set("left",this.convertPropFromImageToView(this.get("left"))),this.set("top",this.convertPropFromImageToView(this.get("top"))),S(this,ue,"f")){const e=this.convertPropFromImageToView(this.get("width"))/this.get("width");this.set("scaleX",e),this.set("scaleY",e)}else this.set("scaleX",this.convertPropFromImageToView(this.get("width"))/this.get("width")),this.set("scaleY",this.convertPropFromImageToView(this.get("height"))/this.get("height"))}setPosition(e){this.setImageRect(e)}getPosition(){return this.getImageRect()}updatePosition(){S(this,ge,"f")&&this.setImageRect(S(this,ge,"f"))}setImage(e){const t=this.getImageRect();if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement)this.set("image",e);else{if(!K(e))throw new TypeError("Invalid 'image'.");{const t=document.createElement("canvas");let i;t.width=e.width,t.height=e.height;if(e.format===d.IPF_GRAYSCALED){i=new Uint8ClampedArray(e.width*e.height*4);for(let t=0;t<i.length;t+=4)i[t]=e.bytes[t/4],i[t+1]=e.bytes[t/4],i[t+2]=e.bytes[t/4],i[t+3]=255}else i=new Uint8ClampedArray(e.bytes.buffer);t.getContext("2d").putImageData(new ImageData(i,e.width,e.height),0,0),this.set("image",t)}}if(S(this,ue,"f")){const e=t.width/this.get("width");this.set("scaleX",e),this.set("scaleY",e)}else this.set("scaleX",t.width/this.get("width")),this.set("scaleY",t.height/this.get("height"))}getImage(){return this.image}setImageRect(e){if(!te(e))throw new TypeError("Invalid 'rect'.");if(this._drawingLayer){if("view"===this.coordinateBase)if(this.set("left",this.convertPropFromViewToImage(e.x)),this.set("top",this.convertPropFromViewToImage(e.y)),S(this,ue,"f")){const t=this.convertPropFromViewToImage(e.width)/this.get("width");this.set("scaleX",t),this.set("scaleY",t)}else this.set("scaleX",this.convertPropFromViewToImage(e.width)/this.get("width")),this.set("scaleY",this.convertPropFromViewToImage(e.height)/this.get("height"));else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");if(this.set("left",e.x),this.set("top",e.y),S(this,ue,"f")){const t=e.width/this.get("width");this.set("scaleX",t),this.set("scaleY",t)}else this.set("scaleX",e.width/this.get("width")),this.set("scaleY",e.height/this.get("height"))}this._drawingLayer.renderAll()}else b(this,ge,JSON.parse(JSON.stringify(e)),"f")}getImageRect(){if(this._drawingLayer){if("view"===this.coordinateBase)return{x:this.convertPropFromImageToView(this.get("left")),y:this.convertPropFromImageToView(this.get("top")),width:this.convertPropFromImageToView(this.get("scaledWidth")),height:this.convertPropFromImageToView(this.get("scaledHeight"))};if("image"===this.coordinateBase)return{x:this.get("left"),y:this.get("top"),width:this.get("scaledWidth"),height:this.get("scaledHeight")};throw new Error("Invalid 'coordinateBase'.")}return S(this,ge,"f")?JSON.parse(JSON.stringify(S(this,ge,"f"))):null}},TextDrawingItem:Se,LineDrawingItem:class extends Ee{constructor(e,t){if(super({points:[null==e?void 0:e.startPoint,null==e?void 0:e.endPoint]},t),be.set(this,void 0),!q(e))throw new TypeError("Invalid 'line'.");b(this,be,JSON.parse(JSON.stringify(e)),"f"),this._mediaType="line"}extendSet(e,t){if("startPoint"===e||"endPoint"===e){t="startPoint"===e?[t,this.get("endPoint")]:[this.get("startPoint"),t];const i=this._fabricObject;if(i.group){const e=i.group;i.points=t.map((t=>({x:t.x-e.left-e.width/2,y:t.y-e.top-e.height/2}))),e.addWithUpdate()}else i.points=t;const s=i.points.length-1;return i.controls=i.points.reduce((function(e,t,i){return e["p"+i]=new _.Control({positionHandler:pe,actionHandler:ve(i>0?i-1:s,ye),actionName:"modifyPolygon",pointIndex:i}),e}),{}),i._setPositionDimensions({}),!0}}extendGet(e){if("startPoint"===e||"endPoint"===e){const t=[],i=this._fabricObject;if(i.selectable&&!i.group)for(let e in i.oCoords)t.push({x:i.oCoords[e].x,y:i.oCoords[e].y});else for(let e of i.points){let s=e.x-i.pathOffset.x,r=e.y-i.pathOffset.y;const n=_.util.transformPoint({x:s,y:r},i.calcTransformMatrix());t.push({x:n.x,y:n.y})}return"startPoint"===e?t[0]:t[1]}}updateCoordinateBaseFromImageToView(){const e=this.get("startPoint"),t=this.get("endPoint");this.set("startPoint",{x:this.convertPropFromViewToImage(e.x),y:this.convertPropFromViewToImage(e.y)}),this.set("endPoint",{x:this.convertPropFromViewToImage(t.x),y:this.convertPropFromViewToImage(t.y)})}updateCoordinateBaseFromViewToImage(){const e=this.get("startPoint"),t=this.get("endPoint");this.set("startPoint",{x:this.convertPropFromImageToView(e.x),y:this.convertPropFromImageToView(e.y)}),this.set("endPoint",{x:this.convertPropFromImageToView(t.x),y:this.convertPropFromImageToView(t.y)})}setPosition(e){this.setLine(e)}getPosition(){return this.getLine()}updatePosition(){S(this,be,"f")&&this.setLine(S(this,be,"f"))}setPolygon(){}getPolygon(){return null}setLine(e){if(!q(e))throw new TypeError("Invalid 'line'.");if(this._drawingLayer){if("view"===this.coordinateBase)this.set("startPoint",{x:this.convertPropFromViewToImage(e.startPoint.x),y:this.convertPropFromViewToImage(e.startPoint.y)}),this.set("endPoint",{x:this.convertPropFromViewToImage(e.endPoint.x),y:this.convertPropFromViewToImage(e.endPoint.y)});else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("startPoint",e.startPoint),this.set("endPoint",e.endPoint)}this._drawingLayer.renderAll()}else b(this,be,JSON.parse(JSON.stringify(e)),"f")}getLine(){if(this._drawingLayer){if("view"===this.coordinateBase)return{startPoint:{x:this.convertPropFromImageToView(this.get("startPoint").x),y:this.convertPropFromImageToView(this.get("startPoint").y)},endPoint:{x:this.convertPropFromImageToView(this.get("endPoint").x),y:this.convertPropFromImageToView(this.get("endPoint").y)}};if("image"===this.coordinateBase)return{startPoint:this.get("startPoint"),endPoint:this.get("endPoint")};throw new Error("Invalid 'coordinateBase'.")}return S(this,be,"f")?JSON.parse(JSON.stringify(S(this,be,"f"))):null}},QuadDrawingItem:dt};export{ps as CameraEnhancer,I as CameraEnhancerModule,yt as CameraView,Ss as DrawingItem,ft as DrawingStyleManager,O as EnumDrawingItemMediaType,P as EnumDrawingItemState,B as EnumEnhancedFeatures,Is as Feedback,vt as ImageEditorView};
