/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2023, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 3.3.1 (js 20230217)
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */
import{fabric as e}from"dm-fabric";const t="undefined"==typeof self;let i,s,r,a,o;if("undefined"!=typeof navigator&&(i=navigator,s=i.userAgent,r=i.platform,a=i.mediaDevices),!t){const e={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:i.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},t={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:r,search:"Win"},Mac:{str:r},Linux:{str:r}};let a="unknownBrowser",n=0,h="unknownOS";for(let t in e){const i=e[t]||{};let r=i.str||s,o=i.search||t,h=i.verStr||s,l=i.verSearch||t;if(l instanceof Array||(l=[l]),-1!=r.indexOf(o)){a=t;for(let e of l){let t=h.indexOf(e);if(-1!=t){n=parseFloat(h.substring(t+e.length+1));break}}break}}for(let e in t){const i=t[e]||{};let r=i.str||s,a=i.search||e;if(-1!=r.indexOf(a)){h=e;break}}"Linux"==h&&-1!=s.indexOf("Windows NT")&&(h="HarmonyOS"),o={browser:a,version:n,OS:h}}t&&(o={browser:"ssr",version:0,OS:"ssr"});const n="undefined"!=typeof WebAssembly&&s&&!(/Safari/.test(s)&&!/Chrome/.test(s)&&/\(.+\s11_2_([2-6]).*\)/.test(s)),h=!("undefined"==typeof Worker),l=!(!a||!a.getUserMedia),d=async()=>{let e=!1;if(l)try{(await a.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()})),e=!0}catch(e){}return e};"Chrome"===o.browser&&o.version>66||"Safari"===o.browser&&o.version>13||"OPR"===o.browser&&o.version>43||"Edge"===o.browser&&o.version;const c=(()=>{if(!t&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})();class g{constructor(e,t){this._zIndex=null,this._drawingLayer=null,this._drawingLayerId=null,this._mapStyle=new Map,this.mapEvent_Callbacks=new Map([["selected",new Map],["deselected",new Map],["mousedown",new Map],["mouseup",new Map],["dblclick",new Map],["mouseover",new Map],["mouseout",new Map]]),this.mapNoteName_Content=new Map([]),this.isDrawingItem=!0,this._setFabricObject(e),this._mediaType=e.type,this.styleSelector="default",this.styleId=t}get mediaType(){return this._mediaType}get drawingLayerId(){return this._drawingLayerId}_setFabricObject(e){this._fabricObject=e,this._fabricObject.on("selected",(()=>{this.styleSelector="selected"})),this._fabricObject.on("deselected",(()=>{this._fabricObject.canvas&&this._fabricObject.canvas.getActiveObjects().includes(this._fabricObject)?this.styleSelector="selected":this.styleSelector="default","textbox"===this._fabricObject.type&&(this._fabricObject.isEditing&&this._fabricObject.exitEditing(),this._fabricObject.selected=!1)})),e.getDrawingItem=()=>this}_getFabricObject(){return this._fabricObject}_on(e,t){if(!t)return;const i=e.toLowerCase(),s=this.mapEvent_Callbacks.get(i);if(!s)throw new Error(`Event '${e}' does not exist.`);let r=s.get(t);r||(r=e=>{const i=e.e;if(!i)return void(t&&t.apply(this,[{targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null}]));const s={targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null};if(this._drawingLayer){let e,t,r,a;const o=i.target.getBoundingClientRect();e=o.left,t=o.top,r=e+window.scrollX,a=t+window.scrollY;const n=this._drawingLayer.fabricCanvas.lowerCanvasEl.width,h=this._drawingLayer.fabricCanvas.lowerCanvasEl.height,l=parseFloat(window.getComputedStyle(this._drawingLayer.fabricCanvas.lowerCanvasEl).width),d=parseFloat(window.getComputedStyle(this._drawingLayer.fabricCanvas.lowerCanvasEl).height),c=l/d,g=n/h,u=this._drawingLayer._getObjectFit();let _,f,p,m,w=1;if("contain"===u)c<g?(w=l/n,_=e+this.get("x")*w,f=t+this.get("y")*w+(d-h*w)/2,p=r+this.get("x")*w,m=a+this.get("y")*w+(d-h*w)/2):(w=d/h,_=e+this.get("x")*w+(l-n*w)/2,f=t+this.get("y")*w,p=r+this.get("x")*w+(l-n*w)/2,m=a+this.get("y")*w);else if("cover"===u)if(c<g){w=d/h;let i=this.get("x")*w-(n*w-l)/2;i=Math.max(i,0),i=Math.min(i,l),_=e+i,f=t+this.get("y")*w,p=r+i,m=a+this.get("y")*w}else{w=l/n;let i=this.get("y")*w-(h*w-d)/2;i=Math.max(i,0),i=Math.min(i,d),_=e+this.get("x")*w,f=t+i,p=r+this.get("x")*w,m=a+i}s.itemClientX=Math.round(_),s.itemClientY=Math.round(f),s.itemPageX=Math.round(p),s.itemPageY=Math.round(m)}for(let e of Object.getOwnPropertyNames(s))Object.defineProperty(i,e,{value:s[e],writable:!0});t&&t.apply(this,[i])},s.set(t,r),this._fabricObject.on("dblclick"===i?"mousedblclick":i,r))}on(e,t){this._on(e,t)}_off(e,t){const i=e.toLowerCase(),s=this.mapEvent_Callbacks.get(i);if(!s)throw new Error(`Event '${e}' does not exist.`);let r=s.get(t);r&&(s.delete(t),this._fabricObject.off("dblclick"===i?"mousedblclick":i,r))}off(e,t){this._off(e,t)}_setEditable(e){const t=this._fabricObject;e?(t.selectable=!0,t.hasControls=!0,t.hoverCursor=null):(t.selectable=!1,t.hasControls=!1,t.hoverCursor="default")}hasNote(e){return this.mapNoteName_Content.has(e)}addNote(e,t){if(this.hasNote(e.name)&&!t)throw new Error("A note with the same name already exists, please use a different name.");const i=e.content?JSON.parse(JSON.stringify(e.content)):e.content;this.mapNoteName_Content.set(e.name,[i])}getNote(e){const t=this.mapNoteName_Content.get(e);return t?1===t.length?{name:e,content:t[0]?JSON.parse(JSON.stringify(t[0])):t[0]}:{name:e,content:JSON.parse(JSON.stringify(t))}:null}getNotes(){const e=[];for(let t of this.mapNoteName_Content){let i=1===t[1].length?t[1][0]:t[1];i=i?JSON.parse(JSON.stringify(i)):i,e.push({name:t[0],content:i})}return e}updateNote(e,t,i){const s=this.mapNoteName_Content.get(e);if(!s)throw new Error("The note name does not exist.");i||(s.length=0),t=t?JSON.parse(JSON.stringify(t)):t,s.push(t)}deleteNote(e){this.mapNoteName_Content.delete(e)}clearNotes(){this.mapNoteName_Content.clear()}_extendSet(e,t){return!1}_extendGet(e){}set(e,t){if(!this._extendSet(e,t))if("x"===e){const e=this._fabricObject.group;e?(this._fabricObject.set("left",t-e.left-e.width/2),e.addWithUpdate()):this._fabricObject.set("left",t)}else if("y"===e){const e=this._fabricObject.group;e?(this._fabricObject.set("top",t-e.top-e.height/2),e.addWithUpdate()):this._fabricObject.set("top",t)}else"styleId"===e?this.styleId=t:this._fabricObject.set(e,t);["vertices","startPoint","endPoint","x","y","left","top","width","height","scaleX","scaleY","skewX","skewY","padding","angle","strokeWidth"].includes(e)&&this._fabricObject.setCoords()}get(e){let t=this._extendGet(e);if(void 0===t)if("x"===e){const e=this._fabricObject.group;t=e?this._fabricObject.get("left")+e.left+e.width/2:this._fabricObject.get("left")}else if("y"===e){const e=this._fabricObject.group;t=e?this._fabricObject.get("top")+e.top+e.height/2:this._fabricObject.get("top")}else t=["type","mediaType"].includes(e)?this.mediaType:"styleSelector"===e?this.styleSelector:"styleId"===e?this.styleId:"drawingLayerId"===e?this.drawingLayerId:this._fabricObject.get(e);return t}setAttribute(e,t){this.set(e,t)}getAttribute(e){return this.get(e)}}g.arrMediaTypes=["rect","arc","polygon","image","text","line","path"],g.arrStyleSelectors=["default","selected"];function u(t,i,s){let r=s.points[this.pointIndex].x-s.pathOffset.x,a=s.points[this.pointIndex].y-s.pathOffset.y;return e.util.transformPoint({x:r,y:a},s.calcTransformMatrix())}function _(t){let i=new e.Point(t.strokeUniform?1/t.scaleX:1,t.strokeUniform?1/t.scaleY:1).multiply(t.strokeWidth);return new e.Point(t.width+i.x,t.height+i.y)}function f(t,i,s,r){let a=i.target,o=a.controls[a.__corner],n=a.toLocalPoint(new e.Point(s,r),"center","center"),h=_(a),l=a._getTransformedDimensions(0,0),d={x:n.x*h.x/l.x+a.pathOffset.x,y:n.y*h.y/l.y+a.pathOffset.y};return a.points[o.pointIndex]=d,!0}function p(t,i){return function(s,r,a,o){let n=r.target,h=e.util.transformPoint({x:n.points[t].x-n.pathOffset.x,y:n.points[t].y-n.pathOffset.y},n.calcTransformMatrix()),l=i(s,r,a,o);n._setPositionDimensions({});let d=_(n),c=(n.points[t].x-n.pathOffset.x)/d.x,g=(n.points[t].y-n.pathOffset.y)/d.y;return n.setPositionByOrigin(h,c+.5,g+.5),l}}class m extends g{constructor(t,i){super(new e.Polygon(t,{objectCaching:!1}),i);const s=this._fabricObject;let r=s.points.length-1;s.controls=s.points.reduce((function(t,i,s){return t["p"+s]=new e.Control({positionHandler:u,actionHandler:p(s>0?s-1:r,f),actionName:"modifyPolygon",pointIndex:s}),t}),{})}_extendSet(t,i){if("vertices"===t){const t=this._fabricObject;if(t.group){const e=t.group;t.points=i.map((t=>({x:t.x-e.left-e.width/2,y:t.y-e.top-e.height/2}))),e.addWithUpdate()}else t.points=i;const s=t.points.length-1;return t.controls=t.points.reduce((function(t,i,r){return t["p"+r]=new e.Control({positionHandler:u,actionHandler:p(r>0?r-1:s,f),actionName:"modifyPolygon",pointIndex:r}),t}),{}),t._setPositionDimensions({}),!0}}_extendGet(t){if("vertices"===t){const t=[],i=this._fabricObject;if(i.selectable&&!i.group)for(let e in i.oCoords)t.push({x:i.oCoords[e].x,y:i.oCoords[e].y});else for(let s of i.points){let r=s.x-i.pathOffset.x,a=s.y-i.pathOffset.y;const o=e.util.transformPoint({x:r,y:a},i.calcTransformMatrix());t.push({x:o.x,y:o.y})}return t}}}const w=e=>{let t=(e=>e.split("\n").map((e=>e.split("\t"))))(e);return(e=>{for(let t=0;;t++){let i=-1;for(let s=0;s<e.length;s++){let r=e[s][t];void 0!==r&&(r.length>i&&(i=r.length))}if(-1===i)break;for(let s=0;s<e.length;s++){if(t>=e[s].length-1)continue;let r=" ".repeat(i+2-e[s][t].length);e[s][t]=e[s][t].concat(r)}}})(t),(e=>{let t="";for(let i=0;i<e.length;i++)t=t.concat(...e[i],i===e.length-1?"":"\n");return t})(t)};class v extends g{constructor(t,i,s,r,a){if("number"!=typeof r||r<=0)throw new RangeError("Invalid width.");super(new e.Textbox(w(t),{left:i,top:s,width:r}),a),this._mediaType="text",this._text=t}_extendSet(e,t){if("text"===e)return this._text=t,this._fabricObject.set("text",w(t)),!0}_extendGet(e){if("text"===e)return this._text}}"undefined"!=typeof document&&"undefined"!=typeof window&&(e.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(e.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject((function(e){e.dispose&&e.dispose()})),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),e.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},e.Object.prototype.transparentCorners=!1,e.Object.prototype.cornerSize=20,e.Object.prototype.touchCornerSize=100,e.Object.prototype.cornerColor="rgb(254,142,20)",e.Object.prototype.cornerStyle="circle",e.Object.prototype.strokeUniform=!0,e.Object.prototype.hasBorders=!1,e.Canvas.prototype.containerClass="",e.Canvas.prototype.getPointer=function(t,i){if(this._absolutePointer&&!i)return this._absolutePointer;if(this._pointer&&i)return this._pointer;var s,r=this.upperCanvasEl,a=e.util.getPointer(t,r),o=r.getBoundingClientRect(),n=o.width||0,h=o.height||0;n&&h||("top"in o&&"bottom"in o&&(h=Math.abs(o.top-o.bottom)),"right"in o&&"left"in o&&(n=Math.abs(o.right-o.left))),this.calcOffset(),a.x=a.x-this._offset.left,a.y=a.y-this._offset.top,i||(a=this.restorePointerVpt(a));var l=this.getRetinaScaling();if(1!==l&&(a.x/=l,a.y/=l),0!==n&&0!==h){var d=window.getComputedStyle(r).objectFit,c=r.width,g=r.height,u=n,_=h;s={width:c/u,height:g/_};var f,p,m=c/g,w=u/_;return"contain"===d?m>w?(f=u,p=u/m,{x:a.x*s.width,y:(a.y-(_-p)/2)*s.width}):(f=_*m,p=_,{x:(a.x-(u-f)/2)*s.height,y:a.y*s.height}):"cover"===d?m>w?{x:(c-s.height*u)/2+a.x*s.height,y:a.y*s.height}:{x:a.x*s.width,y:(g-s.width*_)/2+a.y*s.width}:{x:a.x*s.width,y:a.y*s.height}}return s={width:1,height:1},{x:a.x*s.width,y:a.y*s.height}},e.Canvas.prototype._onTouchStart=function(t){var i=this.findTarget(t);!this.allowTouchScrolling&&t.cancelable&&t.preventDefault&&t.preventDefault(),i&&t.cancelable&&t.preventDefault&&t.preventDefault(),null===this.mainTouchId&&(this.mainTouchId=this.getPointerId(t)),this.__onMouseDown(t),this._resetTransformEventData();var s=this.upperCanvasEl,r=this._getEventPrefix();e.util.addListener(e.document,"touchend",this._onTouchEnd,{passive:!1}),e.util.addListener(e.document,"touchmove",this._onMouseMove,{passive:!1}),e.util.removeListener(s,r+"down",this._onMouseDown)},e.Textbox.prototype._wrapLine=function(t,i,s,r){const a=t.match(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g),o=!(!a||!a.length);var n=0,h=this.splitByGrapheme||o,l=[],d=[],c=h?e.util.string.graphemeSplit(t):t.split(this._wordJoiners),g="",u=0,_=h?"":" ",f=0,p=0,m=0,w=!0,v=this._getWidthOfCharSpacing();r=r||0;0===c.length&&c.push([]),s-=r;for(var y=0;y<c.length;y++)g=h?c[y]:e.util.string.graphemeSplit(c[y]),f=this._measureWord(g,i,u),u+=g.length,(n+=p+f-v)>s&&!w?(l.push(d),d=[],n=f,w=!0):n+=v,w||h||d.push(_),d=d.concat(g),p=h?0:this._measureWord([_],i,u),u++,w=!1,f>m&&(m=f);return y&&l.push(d),m+r>this.dynamicMinWidth&&(this.dynamicMinWidth=m-v+r),l});class y{constructor(t,i,s,r){let a,o;switch(this.mapMediaType_Style=new Map,this.mode="viewer",this.onSelectionChange=null,this._arrDrwaingItem=[],this._arrFabricObject=[],this._visible=!0,t.hasOwnProperty("getFabricCanvas")?this.fabricCanvas=t.getFabricCanvas():(this.fabricCanvas=new e.Canvas(t,Object.assign(r,{allowTouchScrolling:!0})),this.fabricCanvas.setDimensions({width:"100%",height:"100%"},{cssOnly:!0}),this.fabricCanvas.lowerCanvasEl.className="",this.fabricCanvas.upperCanvasEl.className="",this.fabricCanvas.on("selection:created",(function(e){const t=e.selected,i=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!i.includes(t)&&i.push(t)}for(let e of i){const i=[];for(let s of t){const t=s.getDrawingItem();t._drawingLayer===e&&i.push(t)}setTimeout((()=>{e.onSelectionChange&&e.onSelectionChange(i,[])}),0)}})),this.fabricCanvas.on("before:selection:cleared",(function(e){const t=this.getActiveObjects(),i=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!i.includes(t)&&i.push(t)}for(let e of i){const i=[];for(let s of t){const t=s.getDrawingItem();t._drawingLayer===e&&i.push(t)}setTimeout((()=>{const t=[];for(let s of i)e.hasDrawingItem(s)&&t.push(s);t.length>0&&e.onSelectionChange&&e.onSelectionChange([],t)}),0)}})),this.fabricCanvas.on("selection:updated",(function(e){const t=e.selected,i=e.deselected,s=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!s.includes(t)&&s.push(t)}for(let e of i){const t=e.getDrawingItem()._drawingLayer;t&&!s.includes(t)&&s.push(t)}for(let e of s){const s=[],r=[];for(let i of t){const t=i.getDrawingItem();t._drawingLayer===e&&s.push(t)}for(let t of i){const i=t.getDrawingItem();i._drawingLayer===e&&r.push(i)}setTimeout((()=>{e.onSelectionChange&&e.onSelectionChange(s,r)}),0)}})),this.fabricCanvas.wrapperEl.style.position="absolute",t.getFabricCanvas=()=>this.fabricCanvas),this.id=i,this._mapDrawingStyles=s,i){case 1:a=s.get(1),o=s.get(5);break;case 2:a=s.get(2),o=s.get(6);break;case 3:a=s.get(3),o=s.get(7);break;default:a=s.get(4),o=s.get(8)}for(let e of g.arrMediaTypes)this.mapMediaType_Style.set(e,{default:a,selected:o})}getId(){return this.id}_getDrawingStyle(e,t){if("number"!=typeof e)throw new Error("Invalid style id.");const i=this._mapDrawingStyles.get(e);return i?t?JSON.parse(JSON.stringify(i)):i:null}setVisible(e){if(e){for(let e of this._arrFabricObject)e.visible=!0;this._visible=!0}else{for(let e of this._arrFabricObject)e.visible=!1;this._visible=!1}this.fabricCanvas.renderAll()}isVisible(){return this._visible}_getItemCurrentStyleId(e){return e.styleId?e.styleId:this.mapMediaType_Style.get(e._mediaType)[e.styleSelector].styleId}_getItemCurrentStyle(e){if(e.styleId)return this._getDrawingStyle(e.styleId);const t=e._mapStyle.get(e.styleSelector);return t||null}_changeMediaTypeCurStyleInStyleSelector(e,t,i,s){let r;switch(e){case"rect":r=this.fabricCanvas.getObjects("rect");break;case"arc":r=this.fabricCanvas.getObjects("circle");break;case"polygon":r=this.fabricCanvas.getObjects("polygon");break;case"image":r=this.fabricCanvas.getObjects("image");break;case"text":r=this.fabricCanvas.getObjects("textbox");break;case"line":r=this.fabricCanvas.getObjects("line");break;case"path":r=this.fabricCanvas.getObjects("path")}for(let e of r){if(!this._arrFabricObject.includes(e))continue;const s=e.getDrawingItem();s.styleSelector===t&&this._changeItemStyle(s,i,!0)}s||this.fabricCanvas.renderAll()}_changeItemStyle(e,t,i){if(!e||!t)return;const s=e._getFabricObject();"number"==typeof e.styleId&&(t=this._getDrawingStyle(e.styleId)),s.strokeWidth=t.lineWidth,"fill"===t.paintMode?(s.fill=t.fillStyle,s.stroke=t.fillStyle):"stroke"===t.paintMode?(s.fill="transparent",s.stroke=t.strokeStyle):"strokeAndFill"===t.paintMode&&(s.fill=t.fillStyle,s.stroke=t.strokeStyle),s.fontFamily&&(s.fontFamily=t.fontFamily),s.fontSize&&(s.fontSize=t.fontSize),s.group||(s.dirty=!0),i||this.fabricCanvas.renderAll()}_updateGroupItem(e,t,i){if(!e||!t)return;const s=e.getChildItems();if("add"===i){if(s.includes(t))return;const i=t._getFabricObject();if(this.fabricCanvas.getObjects().includes(i)){if(!this._arrFabricObject.includes(i))throw new Error("Existed in other drawing layers.");t._zIndex=null}else{let i;if(t.styleId)i=this._getDrawingStyle(t.styleId);else{i=this.mapMediaType_Style.get(t._mediaType)[e.styleSelector];const s=()=>{this._changeItemStyle(t,this.mapMediaType_Style.get(t._mediaType).selected,!0)},r=()=>{this._changeItemStyle(t,this.mapMediaType_Style.get(t._mediaType).default,!0)};t._on("selected",s),t._on("deselected",r),t._funcChangeStyleToSelected=s,t._funcChangeStyleToDefault=r}t._drawingLayer=this,t._drawingLayerId=this.id,this._changeItemStyle(t,i,!0)}e._fabricObject.addWithUpdate(t._getFabricObject())}else{if("remove"!==i)return;if(!s.includes(t))return;t._zIndex=null,t._drawingLayer=null,t._drawingLayerId=null,t._off("selected",t._funcChangeStyleToSelected),t._off("deselected",t._funcChangeStyleToDefault),t._funcChangeStyleToSelected=null,t._funcChangeStyleToDefault=null,e._fabricObject.removeWithUpdate(t._getFabricObject())}this.fabricCanvas.renderAll()}_addDrawingItem(e,t){let i=e._getFabricObject();const s=this.fabricCanvas.getObjects();let r,a;if(s.includes(i)){if(this._arrFabricObject.includes(i))return;throw new Error("Existed in other drawing layers.")}if("group"===e._mediaType){r=e.getChildItems();for(let e of r)if(e._drawingLayer&&e._drawingLayer!==this)throw new Error("The childItems of DT_Group have existed in other drawing layers.")}if(t&&"object"==typeof t&&!Array.isArray(t))for(let e in t)i.set(e,t[e]);if(r){for(let e of r){const t=this.mapMediaType_Style.get(e._mediaType);for(let i of g.arrStyleSelectors)e._mapStyle.set(i,t[i]);if(e.styleId)a=this._getDrawingStyle(e.styleId);else{a=t.default;const i=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).selected,!0)},s=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).default,!0)};e._on("selected",i),e._on("deselected",s),e._funcChangeStyleToSelected=i,e._funcChangeStyleToDefault=s}e._drawingLayer=this,e._drawingLayerId=this.id,this._changeItemStyle(e,a,!0)}i.dirty=!0,this.fabricCanvas.renderAll()}else{const t=this.mapMediaType_Style.get(e._mediaType);for(let i of g.arrStyleSelectors)e._mapStyle.set(i,t[i]);if(e.styleId)a=this._getDrawingStyle(e.styleId);else{a=t.default;const i=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).selected)},s=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).default)};e._on("selected",i),e._on("deselected",s),e._funcChangeStyleToSelected=i,e._funcChangeStyleToDefault=s}this._changeItemStyle(e,a)}e._zIndex=this.id,e._drawingLayer=this,e._drawingLayerId=this.id;const o=this._arrFabricObject.length;let n=s.length;if(o)n=s.indexOf(this._arrFabricObject[o-1])+1;else for(let t=0;t<s.length;t++)if(e._zIndex<s[t].getDrawingItem()._zIndex){n=t;break}this._arrDrwaingItem.push(e),this._arrFabricObject.push(i),this._visible?i.visible=!0:i.visible=!1,this.fabricCanvas.insertAt(i,n,!1)}addDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");if("viewer"===this.mode)e._setEditable(!1);else{if("editor"!==this.mode)throw new Error("Illegal 'mode'.");e._setEditable(!0)}this._addDrawingItem(e)}addDrawingItems(e){for(let t of e)this.addDrawingItem(t)}removeDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");if(!this.hasDrawingItem(e))return;if(e._zIndex=null,e._drawingLayer=null,e._drawingLayerId=null,"group"===e._mediaType){const t=e.getChildItems();for(let e of t)e._zIndex=null,e._drawingLayer=null,e._drawingLayerId=null,e._off("selected",e._funcChangeStyleToSelected),e._off("deselected",e._funcChangeStyleToDefault),e._funcChangeStyleToSelected=null,e._funcChangeStyleToDefault=null,e._mapStyle.clear()}else e._off("selected",e._funcChangeStyleToSelected),e._off("deselected",e._funcChangeStyleToDefault),e._funcChangeStyleToSelected=null,e._funcChangeStyleToDefault=null,e._mapStyle.clear();const t=e._getFabricObject();"selected"===e.styleSelector&&(t.group?t.group.removeWithUpdate(t):this.fabricCanvas._activeObject=null,e.styleSelector="default"),this.fabricCanvas.remove(t),this._arrDrwaingItem.splice(this._arrDrwaingItem.indexOf(e),1),this._arrFabricObject.splice(this._arrFabricObject.indexOf(t),1)}removeDrawingItems(e){for(let t of e)this.removeDrawingItem(t)}setDrawingItems(e){this.clearDrawingItems(),this.addDrawingItems(e)}getDrawingItems(e){return e&&"function"==typeof e?this._arrDrwaingItem.filter(e):Array.from(this._arrDrwaingItem)}getSelectedDrawingItems(){const e=this.fabricCanvas.getActiveObjects(),t=[];for(let i of e)this._arrFabricObject.includes(i)&&t.push(i.getDrawingItem());return t}hasDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");return this._arrDrwaingItem.includes(e)}clearDrawingItems(){this.removeDrawingItems(Array.from(this._arrDrwaingItem))}setDrawingStyle(e,t,i){t=t?t.toLocaleLowerCase():"all",i=i?i.toLocaleLowerCase():"all";let s,r=this._getDrawingStyle(e);if("all"===t){const e=this.mapMediaType_Style.keys();for(let t of e)if(s=this.mapMediaType_Style.get(t),"all"===i)for(let e of g.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(t,e,r,!0),s[e]=r;for(let t of this._arrDrwaingItem)t._mapStyle.set(e,r)}else{this._changeMediaTypeCurStyleInStyleSelector(t,i,r,!0),s[i]=r;for(let e of this._arrDrwaingItem)e._mapStyle.set(i,r)}this.fabricCanvas.renderAll()}else if(s=this.mapMediaType_Style.get(t),"all"===i)for(let e of g.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(t,e,r,!0),s[e]=r;for(let i of this._arrDrwaingItem)i._mediaType===t&&i._mapStyle.set(e,r)}else{this._changeMediaTypeCurStyleInStyleSelector(t,i,r,!0),s[i]=r;for(let e of this._arrDrwaingItem)e._mediaType===t&&e._mapStyle.set(i,r)}}setMode(e){if("viewer"===(e=e.toLocaleLowerCase())){for(let e of this._arrDrwaingItem)e._setEditable(!1);this.fabricCanvas.discardActiveObject(),this.fabricCanvas.renderAll(),this.mode="viewer"}else{if("editor"!==e)throw new RangeError("Invalid value.");for(let e of this._arrDrwaingItem)e._setEditable(!0);this.mode="editor"}this._manager._switchPointerEvent()}getMode(){return this.mode}_setDimensions(e,t){this.fabricCanvas.setDimensions(e,t)}_setObjectFit(e){if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`Unsupported value '${e}'.`);this.fabricCanvas.lowerCanvasEl.style.objectFit=e,this.fabricCanvas.upperCanvasEl.style.objectFit=e}_getObjectFit(){return this.fabricCanvas.lowerCanvasEl.style.objectFit}renderAll(){for(let e of this._arrDrwaingItem){const t=this._getItemCurrentStyle(e);this._changeItemStyle(e,t,!0)}this.fabricCanvas.renderAll()}dispose(){this.clearDrawingItems(),1===this._manager._arrDrawingLayer.length&&(this.fabricCanvas.wrapperEl.style.pointerEvents="none",this.fabricCanvas.dispose(),this._arrDrwaingItem.length=0,this._arrFabricObject.length=0)}}class S{constructor(){this._arrDrawingLayer=[],this._mapDrawingStyles=new Map([[1,{id:1,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[2,{id:2,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[3,{id:3,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[4,{id:4,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[5,{id:5,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[6,{id:6,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[7,{id:7,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[8,{id:8,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}]]),this._defaultStyleTemplate={lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}}createDrawingStyle(e){if(!e)throw new Error("Invalid style definition.");let t;if(e.hasOwnProperty("id")){if(this._mapDrawingStyles.has(e.id))throw new Error("Existing drawing style id.");t=e.id}else{let e=100;for(;this._mapDrawingStyles.has(e);)e++;t=e}const i=JSON.parse(JSON.stringify(e));i.id=t;for(let e in this._defaultStyleTemplate)i.hasOwnProperty(e)||(i[e]=this._defaultStyleTemplate[e]);return this._mapDrawingStyles.set(t,i),i.id}_getDrawingStyle(e,t){if("number"!=typeof e)throw new Error("Invalid style id.");const i=this._mapDrawingStyles.get(e);return i?t?JSON.parse(JSON.stringify(i)):i:null}getDrawingStyle(e){return this._getDrawingStyle(e,!0)}getDrawingStyles(){return JSON.parse(JSON.stringify(Array.from(this._mapDrawingStyles.values())))}_updateDrawingStyle(e,t){const i=this._mapDrawingStyles.get(e);if(i)for(let e in t)i.hasOwnProperty(e)&&(i[e]=t[e])}updateDrawingStyle(e,t){this._updateDrawingStyle(e,t);for(let e of this._arrDrawingLayer)e.renderAll()}createDrawingLayer(e,t){const i=e=>{for(let t of this._arrDrawingLayer)if(t.getId()===e)return!0;return!1};if(void 0===t){for(let e=100;;e++)if(!i(e)){t=e;break}}else if(i(t))throw new Error("Existed drawing layer id.");const s=new y(e,t,this._mapDrawingStyles,{enableRetinaScaling:!1});return s._manager=this,this._arrDrawingLayer.push(s),this._switchPointerEvent(),s}deleteDrawingLayer(e){const t=this.getDrawingLayer(e);if(!t)return;const i=this._arrDrawingLayer;t.dispose(),i.splice(i.indexOf(t),1),this._switchPointerEvent()}clearDrawingLayers(){for(let e of this._arrDrawingLayer)e.dispose();this._arrDrawingLayer.length=0}getDrawingLayer(e){for(let t of this._arrDrawingLayer)if(t.getId()===e)return t;return null}getDrawingLayers(){return Array.from(this._arrDrawingLayer)}getSelectedDrawingItems(){if(!this._arrDrawingLayer.length)return;const e=this._arrDrawingLayer[0].fabricCanvas.getActiveObjects(),t=[];for(let i of e)t.push(i.getDrawingItem());return t}setDimensions(e,t){this._arrDrawingLayer.length&&this._arrDrawingLayer[0]._setDimensions(e,t)}setObjectFit(e){for(let t of this._arrDrawingLayer)t&&t._setObjectFit(e)}getObjectFit(){return this._arrDrawingLayer.length?this._arrDrawingLayer[0]._getObjectFit():null}setVisible(e){this._arrDrawingLayer.length&&(this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.display=e?"block":"none")}_switchPointerEvent(){if(this._arrDrawingLayer.length)for(let e of this._arrDrawingLayer)e.getMode()}}class b{constructor(e){this._controlTarget=null,this._arrUsers=[],this._mapAction_UserArgs=new Map,this._mapProperty_UserValue=new Map,this._mapAction_Callbacks=new Map,this._controlTarget=e}setControlTarget(e){this._controlTarget=e}getControlTarget(){return this._controlTarget}register(e){this._arrUsers.includes(e)||this._arrUsers.push(e)}logout(e){const t=this._arrUsers.indexOf(e);-1!==t&&(this.clearUserDisiredAction({user:e}),this.clearUserDisiredValue({user:e}),this._arrUsers.splice(t,1))}getRegisteredUsers(){return this._arrUsers}ifUserExisted(e){return this._arrUsers.includes(e)}setDisiredValue(e,t,i,s){if(!this._arrUsers.includes(e))throw new Error("Unregistered user.");s&&(this._controlTarget[t]=i),this._mapProperty_UserValue.get(t)?this._mapProperty_UserValue.get(t).set(e,i):this._mapProperty_UserValue.set(t,new Map([[e,i]]))}clearUserDisiredValue(e){if(e&&(e.user||e.property)){if(e.property&&e.user){const t=this._mapProperty_UserValue.get(e.property);if(!t)return;t.delete(e.user)}else if(e.property)this._mapProperty_UserValue.delete(e.property);else if(e.user)for(let t of this._mapProperty_UserValue.values())t.delete(e.user)}else this._mapProperty_UserValue=new Map}getValue(e){if(!this._controlTarget)throw new Error("Control target is not set.");return this._controlTarget[e]}getPropertyDisiredValue(e){if(this._mapProperty_UserValue.get(e)){const t=[],i=this._mapProperty_UserValue.get(e);for(let e of i.values())t.push(e);return t}return null}setDisiredAction(e,t,i,s){if(!this._arrUsers.includes(e))throw new Error("Unregistered user.");return i||(i=[]),s?this._controlTarget[t](...i):(this._mapAction_UserArgs.get(t)?this._mapAction_UserArgs.get(t).set(e,i):this._mapAction_UserArgs.set(t,new Map([[e,i]])),this._render(t))}clearUserDisiredAction(e){if(e&&(e.user||e.actionName)){if(e.actionName&&e.user){const t=this._mapAction_UserArgs.get(e.actionName);if(!t)return;t.delete(e.user)}else if(e.actionName)this._mapAction_UserArgs.delete(e.actionName);else if(e.user)for(let t of this._mapAction_UserArgs.values())t.delete(e.user);this.render()}else this._mapAction_UserArgs=new Map}addCallback(e,t){const i=this._mapAction_Callbacks.get(e);i?i.push(t):this._mapAction_Callbacks.set(e,[t])}removeCallback(e,t){const i=this._mapAction_Callbacks.get(e);if(!i)return;const s=i.indexOf(t);-1!==s&&i.splice(s,1)}clearCallback(e){e?this._mapAction_Callbacks.delete(e):this._mapAction_Callbacks.clear()}_fireCallback(e){const t=this._mapAction_Callbacks.get(e);if(t)for(let e of t){if(!e)return;setTimeout(e.bind(this._controlTarget),0)}}_render(e){const t=this._mapAction_UserArgs.get(e);if(!t)throw new Error("Unrecorded action.");if(t.size===this._arrUsers.length){let i=[];for(let e of t.values())e.length>0&&(i=e);if(this._controlTarget[e]){const t=this._controlTarget[e](...i);return this._mapAction_UserArgs.delete(e),this._fireCallback(e),t}}}render(e){if(e)return this._render(e);for(let e of this._mapAction_UserArgs.keys())this._render(e)}}class C{static multiply(e,t){const i=[];for(let s=0;s<3;s++){const r=t.slice(3*s,3*s+3);for(let t=0;t<3;t++){const s=[e[t],e[t+3],e[t+6]].reduce(((e,t,i)=>e+t*r[i]),0);i.push(s)}}return i}static identity(){return[1,0,0,0,1,0,0,0,1]}static translate(e,t,i){return C.multiply(e,[1,0,0,0,1,0,t,i,1])}static rotate(e,t){var i=Math.cos(t),s=Math.sin(t);return C.multiply(e,[i,-s,0,s,i,0,0,0,1])}static scale(e,t,i){return C.multiply(e,[t,0,0,0,i,0,0,0,1])}}var L;!function(e){e.GREY="grey",e.GREY32="grey32",e.RGBA="rgba",e.RBGA="rbga",e.GRBA="grba",e.GBRA="gbra",e.BRGA="brga",e.BGRA="bgra"}(L||(L={}));const I=(e,t,i,s)=>{let r=t+Math.round((e-t)/i)*i;return s&&(r=Math.min(r,s)),r};class x{constructor(){this._maxCvsSideLength=void 0,this._defaultMaxCvsSideLength=null,this._predefinedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],this._mapCameraResolutions=new Map,this._bWebGLSupported=!0,this.extraBindings=[],this._singleFrameMode=!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),this._cvsSingleFrameMode=null,this._cvsOriginalImage=null,this._imgWidth=0,this._imgHeight=0,this._singleFrameModeIpt=null,this._clickIptSingleFrameMode=()=>{if(this.singleFrameMode&&!this.getDrawingLayers().some((e=>"editor"==e.getMode()))){if(!this._singleFrameModeIpt){const e=document.createElement("input");this._singleFrameModeIpt=e,e.setAttribute("type","file"),e.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),e.setAttribute("capture",""),e.addEventListener("change",(async()=>{const t=e.files[0];e.value="";const i=await(async e=>{let t=null,i=null;if("undefined"!=typeof createImageBitmap)try{if(t=await createImageBitmap(e),t)return t}catch(e){}var s;return t||(i=await(s=e,new Promise(((e,t)=>{let i=URL.createObjectURL(s),r=new Image;r.dbrObjUrl=i,r.src=i,r.onload=()=>{e(r)},r.onerror=e=>{t(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}})))),i})(t),s=i instanceof HTMLImageElement?i.naturalWidth:i.width,r=i instanceof HTMLImageElement?i.naturalHeight:i.height;this._imgWidth=s,this._imgHeight=r;const a=e=>{const t=Date.now();if(0===s||0===r)return null;if(e instanceof HTMLImageElement&&!e.complete)throw new Error("The source is not loaded.");const i=this._scanRegion,a=this.getFrameSize(s,r,i,this.maxCvsSideLength);if(!a)return null;let o=!0;s===a.sWidth&&r===a.sHeight&&(o=!1);const n=this.mapPixelFormatString_Enum.get(this.framePixelFormat.toLowerCase()),h={data:null,region:i?JSON.parse(JSON.stringify(i)):null,sx:a.sx,sy:a.sy,width:a.dWidth,height:a.dHeight,colorMode:null,pixelFormat:null,timeSpent:null,timeStamp:null,isCropped:o,toCanvas:this._toCanvas,_sWidth:a.sWidth,_sHeight:a.sHeight,_bUseWebGL:null},l=this._getImageData(e,s,r,a,null,{pixelFormat:n});if(!l)return null;const d=Date.now();if(x._onLog&&x._onLog("DCE: _getVideoData(region?) END: "+d),h.data=l.data,h.pixelFormat=h.colorMode=l.pixelFormat,h._bUseWebGL=l._bUseWebGL,h.timeSpent=d-t,h.timeStamp=d,l.pixelFormat===L.GREY)h.stride=h.width;else h.stride=4*h.width;return h};(e=>{let t=this._cvsSingleFrameMode;if(!t){if(t=document.createElement("canvas"),!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(t),t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.left="0",t.style.top="0",t.style.objectFit="contain",t.style.pointerEvents="none",this._cvsSingleFrameMode=t}t.width==s&&t.height==r||(t.width=s,t.height=r);const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.drawImage(e,0,0)})(i),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);let o;this._updateDrawingLayersSize();try{o=a(i)}catch(e){throw e}const n=this.mapCameraEvents.get("singleframeacquired");for(let e of n)if(e)try{const t={data:new Uint8Array(o.data),region:JSON.parse(JSON.stringify(o.region)),sx:o.sx,sy:o.sy,width:o.width,height:o.height,stride:o.stride,colorMode:o.colorMode,pixelFormat:o.pixelFormat,timeSpent:o.timeSpent,timeStamp:o.timeStamp,isCropped:o.isCropped,toCanvas:o.toCanvas,_sWidth:o._sWidth,_sHeight:o._sHeight,_bUseWebGL:o._bUseWebGL};await e.apply(this,[t])}catch(e){console.error(e)}})),e.style.position="fixed",e.style.left="-1px",e.style.top="-1px",e.style.width="1px",e.style.height="1px",e.style.backgroundColor="transparent",e.style.color="transparent",document.body.appendChild(e)}this._singleFrameModeIpt.click()}},this.styleEls=[],this._framePixelFormat=void 0,this._defaultFramePixelFormat="rgba",this.mapPixelFormatString_Enum=new Map([["grey",L.GREY],["grey32",L.GREY32],["rgba",L.RGBA],["rbga",L.RBGA],["grba",L.GRBA],["gbra",L.GBRA],["brga",L.BRGA],["bgra",L.BGRA]]),this.shaderPixelFormat=L.RGBA,this.maxVideoCvsLength=3,this._reusedCvs=null,this._reusedWebGLCvs=null,this._tempDataContainer=null,this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._softwareScale=1,this._scaleCenter={x:0,y:0},this._focusParameters={maxTimeout:400,minTimeout:300,kTimeout:void 0,oldDistance:null,fds:null,isDoingFocus:0,taskBackToContinous:null,curFocusTaskId:0,focusCancelableTime:1500,defaultFocusAreaSizeRatio:6,focusBackToContinousTime:5e3,tapFocusMinDistance:null,tapFocusMaxDistance:null,_focusArea:null},this._tapFocusEnabled=!0,this._focusSupported=!0,this._tapDoFocus=async e=>{if(this._touchMoved)return void(this._touchMoved=!1);if(!this._tapFocusEnabled)return;if(!this._bOpen)return;if(this.singleFrameMode)return;if(!this._video||this._video.paused)return;if(!this._videoTrack)return;if(!this._focusSupported)return;if(this.getDrawingLayers().some((e=>"editor"==e.getMode())))return;if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))return void(this._focusSupported=!1);if(null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),1==this._focusParameters.isDoingFocus)return;let t,i,s,r;if(this._focusParameters.taskBackToContinous&&(clearTimeout(this._focusParameters.taskBackToContinous),this._focusParameters.taskBackToContinous=null),e instanceof MouseEvent)t=e.clientX,i=e.clientY;else{if(!(e instanceof TouchEvent))throw new Error("Unknown event type.");if(!e.changedTouches.length)return;t=e.changedTouches[0].clientX,i=e.changedTouches[0].clientY}const a=this.getVideoFit(),o=this._video.videoWidth,n=this._video.videoHeight,h=this._elContainer.getBoundingClientRect(),l=h.left,d=h.top,c=window.getComputedStyle(this._elContainer),g=parseFloat(c.width),u=parseFloat(c.height),_=g/u,f=o/n;let p=1;if("contain"===a)if(f>_){p=g/o,s=(t-l)/p;r=(i-d-(u-g/f)/2)/p}else{p=u/n,r=(i-d)/p;s=(t-l-(g-u*f)/2)/p}else{if("cover"!==a)throw new Error("Unsupported object-fit.");if(f>_){p=u/n,r=(i-d)/p;s=(t-l+(u*f-g)/2)/p}else{p=g/o,s=(t-l)/p;r=(i-d+(g/f-u)/2)/p}}const m={x:s+"px",y:r+"px"},w=2*Math.round(Math.min(o,n)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px",v=w;await this._setLocalFocus(m,w,v,this._focusParameters.tapFocusMinDistance,this._focusParameters.tapFocusMaxDistance),this._focusParameters.taskBackToContinous=setTimeout((()=>{this._videoTrack&&this._videoTrack.applyConstraints({advanced:[{focusMode:"continuous"}]}).catch((()=>{}))}),this._focusParameters.focusBackToContinousTime)},this._touchMoved=!1,this._touchMoveEvent=()=>{this._touchMoved=!0},this._recordedStates={},this.playCallbackInfo=null,this._toCanvas=function(){const e=document.createElement("canvas");let t;e.width=this.width,e.height=this.height;if("grey"===(this.pixelFormat||this.colorMode)){t=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<t.length;e+=4)t[e]=this.data[e/4],t[e+1]=this.data[e/4],t[e+2]=this.data[e/4],t[e+3]=255}else t=new Uint8ClampedArray(this.data.buffer);const i=new ImageData(t,this.width,this.height);return e.getContext("2d").putImageData(i,0,0),e},this._onCameraSelChange=async()=>{await this.selectCamera(this._selCam.value),this._bOpen||this.stop()},this._onResolutionSelChange=async()=>{let e,t;if(this._selRsl&&-1!=this._selRsl.selectedIndex){let i=this._selRsl.options[this._selRsl.selectedIndex];e=i.getAttribute("data-width"),t=i.getAttribute("data-height")}await this.setResolution(e,t),this._bOpen||this.stop()},this._onCloseBtnClick=()=>{this.close(!0)},this._bOpen=!1,this.isCameraEnhancer=!0,this.isDisposed=!1,this.disposed=!1,this.videoSrc=null,this.videoSettings={video:{width:{ideal:1280},height:{ideal:720},facingMode:{ideal:"environment"}}},this.iPlayRound=0,this.promisePlay=null,this._ifSaveLastUsedCamera=!1,this.ifSkipCameraInspection=!1,this._allCameras=[],this._currentCamera=null,this._videoTrack=null,this._lastDeviceId=void 0,this._vc_bPlayingVideoBeforeHide=!1,this._ev_documentHideEvent=()=>{if(!this.singleFrameMode)if("visible"===document.visibilityState){if(x._onLog&&x._onLog("DCE: document visible."),this._bOpen&&this._vc_bPlayingVideoBeforeHide)if(this.videoSrc)this._video.play();else if(this._video.srcObject){const e=this._video.srcObject.getTracks()[0];this._video.srcObject.active&&e&&!e.muted?this._video.play():this.play()}}else"hidden"===document.visibilityState&&(x._onLog&&x._onLog("DCE: document hidden."),["iPhone","iPad"].includes(o.OS)?(this._vc_bPlayingVideoBeforeHide=!0,this._video&&this._video.pause()):this._video&&!this._video.paused?(this._vc_bPlayingVideoBeforeHide=!0,this._video.pause()):this._vc_bPlayingVideoBeforeHide=!1)},this.containerClassName="dce-video-container",this._elContainer=null,this._videoContainer=null,this._video=null,this.videoFit="contain",this._cvsScanRegion=null,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=2,this._bShowScanRegionMask=!0,this._bShowScanRegionLaser=void 0,this._defaultBShowScanRegionLaser=!1,this._scanRegion=null,this._arrScanRegionOverlays=[],this._layerBaseCvs=null,this._drawingLayerOfTip=null,this._tipArgs={x:void 0,y:void 0,width:void 0,duration:void 0,autoShowSuggestedTip:void 0},this._hideTipTimeoutId=null,this.onTipSuggested=null,this._cvsViewDecorator=null,this._decoratorType=[],this._decoratorArea=null,this._viewDecoratorInfo={rectangle:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},focus:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},crossline:{lineWidth:2,strokeStyle:"rgb(254,142,20)"},crosshair:{lineWidth:4,strokeStyle:"rgb(254,142,20)"}},this._croppingRegions=void 0,this._defaultCroppingRegions=[null],this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0,this._loopInterval=void 0,this._defaultLoopInterval=0,this._maxNumberOfFramesInBuffer=void 0,this._defaultMaxNumberOfFramesInBuffer=1,this._frameQueue=[],this._bFetchingLoopStarted=!1,this._refreshInterval=void 0,this._defaultRefreshInterval=-1,this._updateLayersTimeout=500,this._updateLayers=()=>{this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none");for(let e of this._arrScanRegionOverlays)e&&(e.style.display="none");this._resizeTimeoutId&&clearTimeout(this._resizeTimeoutId),this._resizeTimeoutId=setTimeout((()=>{if(!this.isDisposed||!this.disposed){this.ifShowScanRegionMask&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this.showScanRegionLaser(),this._cvsViewDecorator&&this.showViewDecorator(),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&(e.style.display="",this._updateScanRegionOverlay(e));this._updateDrawingLayersSize(),this._updateVideoContainerStyle()}}),this._updateLayersTimeout)},this.mapCameraEvents=new Map([["cameraopen",[]],["cameraclose",[]],["camerachange",[]],["resolutionchange",[]],["played",[]],["singleframeacquired",[]],["frameaddedtobuffer",[]]]),this._controler=null}static getVersion(){return this._version}static async detectEnvironment(){return await(async()=>({wasm:n,worker:h,getUserMedia:l,camera:await d(),browser:o.browser,version:o.version,OS:o.OS}))()}static set engineResourcePath(e){if(this._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");x._engineResourcePath=(e=>{if(null==e&&(e="./"),!t){let t=document.createElement("a");t.href=e,e=t.href}return e.endsWith("/")||(e+="/"),e})(e)}static get engineResourcePath(){return this._engineResourcePath}static isStorageAvailable(e){let t;try{t=window[e];const i="__storage_test__";return t.setItem(i,i),t.removeItem(i),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}}static isDCEFrame(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&("data"in e&&("region"in e&&("sx"in e&&("sy"in e&&("width"in e&&("height"in e&&(("colorMode"in e||"pixelFormat"in e)&&("timeSpent"in e&&("timeStamp"in e&&("isCropped"in e&&("toCanvas"in e&&("_sWidth"in e&&("_sHeight"in e&&"_bUseWebGL"in e)))))))))))))}static async testCameraAccess(){try{if(!navigator||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return{ok:!1,message:"Insecure context."};(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()}))}catch(e){if("OverconstrainedError"===e.name||"NotFoundError"===e.name)return{ok:!1,message:"No camera detected."};if("NotAllowedError"===e.name)return{ok:!1,message:"No permission to access camera."};if("AbortError"===e.name)return{ok:!1,message:"Some problem occurred which prevented the device from being used."};if("NotReadableError"===e.name)return{ok:!1,message:"A hardware error occurred."};if("SecurityError"===e.name)return{ok:!1,message:"User media support is disabled."};throw e}return{ok:!0,message:"Successfully accessed the camera."}}set maxCvsSideLength(e){if(e<=0)throw new Error("Invalid value.");this._maxCvsSideLength=e}get maxCvsSideLength(){if(void 0!==this._maxCvsSideLength)return this._maxCvsSideLength;if(this._controler){const e=this._controler.getPropertyDisiredValue("maxCvsSideLength");if(e&&1===e.length)return e[0]}return this._defaultMaxCvsSideLength}static set defaultUIElementURL(e){x._defaultUIElementURL=e}static get defaultUIElementURL(){var e;return null===(e=x._defaultUIElementURL)||void 0===e?void 0:e.replace("@engineResourcePath/",x.engineResourcePath)}getUIElement(){return this.UIElement}async setUIElement(e){if(this._bOpen)throw new Error("It is not allowed to change the UIElement when the camera is open.");if("string"==typeof e||e instanceof String){if(!e.trim().startsWith("<")){let t=await fetch(e);if(!t.ok)throw Error("setUIElement(elementOrUrl): Network Error: "+t.statusText);e=await t.text()}if(!e.trim().startsWith("<"))throw Error("setUIElement(elementOrUrl): Can't get valid HTMLElement.");let t=document.createElement("div");t.innerHTML=e;for(let e=0;e<t.childElementCount;++e){let i=t.children[e];i instanceof HTMLStyleElement&&(this.styleEls.push(i),document.head.append(i))}(e=1==t.childElementCount?t.children[0]:t).remove()}this.UIElement=e,this._uiOriginalState={display:e&&e.style.display,inDom:document.body.contains(e)}}appendAndShowUI(){this.UIElement&&(this.UIElement.parentNode||(this.UIElement.style.position="fixed",this.UIElement.style.left="0",this.UIElement.style.top="0",document.body.append(this.UIElement)),"none"==this.UIElement.style.display&&(this.UIElement.style.display=""))}hideUI(){this.UIElement&&(this.UIElement.style.display="none")}get singleFrameMode(){return this._singleFrameMode}set singleFrameMode(e){if(this._bOpen)throw new Error("It is not allowed to change `singleFrameMode` when the camera is open.");this._singleFrameMode=e}set frameColorMode(e){this._framePixelFormat=e}get frameColorMode(){if(void 0!==this._framePixelFormat)return this._framePixelFormat;if(this._controler){const e=this._controler.getPropertyDisiredValue("framePixelFormat")||this._controler.getPropertyDisiredValue("frameColorMode");if(e&&1===e.length)return e[0]}return this._defaultFramePixelFormat}set framePixelFormat(e){this._framePixelFormat=e}get framePixelFormat(){if(void 0!==this._framePixelFormat)return this._framePixelFormat;if(this._controler){const e=this._controler.getPropertyDisiredValue("framePixelFormat")||this._controler.getPropertyDisiredValue("frameColorMode");if(e&&1===e.length)return e[0]}return this._defaultFramePixelFormat}set bOpen(e){if(this._bOpen=e,e){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateDrawingLayersSize(),this.ifShowScanRegionMask?this.showScanRegionMask():this.hideScanRegionMask(),this.ifShowScanRegionLaser?this.showScanRegionLaser():this.hideScanRegionLaser(),this.showViewDecorator(),this.showScanRegionOverlays(),this._drawingLayersManager.setVisible(!0)}else this._softwareScale=1}set ifSaveLastUsedCamera(e){e?x.isStorageAvailable("localStorage")?this._ifSaveLastUsedCamera=!0:(this._ifSaveLastUsedCamera=!1,console.warn("Local storage is unavailable")):this._ifSaveLastUsedCamera=!1}get ifSaveLastUsedCamera(){return this._ifSaveLastUsedCamera}get video(){return this._video}setVideoFit(e){if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`Unsupported value '${e}'.`);if(this.videoFit=e,this._video&&(this._video.style.objectFit=e,!this.singleFrameMode)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateVideoContainerStyle(),this._drawingLayersManager.setObjectFit(e)}}getVideoFit(){return this.videoFit}_showElClassName(){this._cvsScanRegion&&this._cvsScanRegion.classList.add("cvs-scan-region-mask"),this._cvsViewDecorator&&this._cvsViewDecorator.classList.add("cvs-view-decorator"),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.classList.add("div-scan-region-overlay-container"),this._layerBaseCvs&&this._layerBaseCvs.classList.add("cvs-drawing-layer-base"),this._layerBaseCvs&&this._layerBaseCvs.parentElement.classList.add("div-drawing-layer-container"),this._cvsOriginalImage&&this._cvsOriginalImage.classList.add("cvs-original-image"),this._cvsSingleFrameMode&&this._cvsSingleFrameMode.classList.add("cvs-single-frame")}_hideElClassName(){this._cvsScanRegion&&this._cvsScanRegion.classList.remove("cvs-scan-region-mask"),this._cvsViewDecorator&&this._cvsViewDecorator.classList.remove("cvs-view-decorator"),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.classList.remove("div-scan-region-overlay-container"),this._layerBaseCvs&&this._layerBaseCvs.classList.remove("cvs-drawing-layer-base"),this._layerBaseCvs&&this._layerBaseCvs.parentElement.classList.remove("div-drawing-layer-container"),this._cvsOriginalImage&&this._cvsOriginalImage.classList.remove("cvs-original-image"),this._cvsSingleFrameMode&&this._cvsSingleFrameMode.classList.remove("cvs-single-frame")}set ifShowScanRegionMask(e){this._bShowScanRegionMask=e,e?this.showScanRegionMask():this.hideScanRegionMask()}get ifShowScanRegionMask(){return this._bShowScanRegionMask}showScanRegionMask(){this._cvsScanRegion&&("none"==this._cvsScanRegion.style.display&&(this._cvsScanRegion.style.display=""),this._recordedStates.maskShow=!0)}hideScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display="none",this._recordedStates.maskShow=!1)}set ifShowScanRegionLaser(e){this._bShowScanRegionLaser=e,e?this.showScanRegionLaser():this.hideScanRegionLaser()}get ifShowScanRegionLaser(){if(void 0!==this._bShowScanRegionLaser)return this._bShowScanRegionLaser;if(this._controler){const e=this._controler.getPropertyDisiredValue("ifShowScanRegionLaser");if(e&&e.length){let t=0;for(let i of e)i||t++;return t!==this._controler.getRegisteredUsers().length}}return this._defaultBShowScanRegionLaser}showScanRegionLaser(){this._divScanLight&&("none"==this._divScanLight.style.display&&(this._divScanLight.style.display="block"),this._recordedStates.laserShow=!0)}hideScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display="none",this._recordedStates.laserShow=!1)}_checkValidRegion(e){return null===e||!!e&&(!!(e.hasOwnProperty("regionLeft")&&e.hasOwnProperty("regionTop")&&e.hasOwnProperty("regionRight")&&e.hasOwnProperty("regionBottom")&&e.hasOwnProperty("regionMeasuredByPercentage"))&&(!(e.regionLeft<0||e.regionTop<0||e.regionRight<0||e.regionBottom<0)&&(!e.regionMeasuredByPercentage||!(e.regionLeft>100||e.regionTop>100||e.regionRight>100||e.regionBottom>100))))}set scanRegion(e){if(!this._checkValidRegion(e))throw new Error("Invalid region.");this._scanRegion=JSON.parse(JSON.stringify(e)),this._updateScanRegionCanvas(),this._updateScanAreaDiv();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e)}setScanRegion(e){this.scanRegion=e}getScanRegion(){return JSON.parse(JSON.stringify(this._scanRegion))}_calculateCvsSize(){if(!this._bOpen)return null;let e,t,i;if(this.singleFrameMode)e=this._imgWidth,t=this._imgHeight,i="contain";else{if(!this._video)return null;e=this._video.videoWidth,t=this._video.videoHeight,i=this.getVideoFit()}return{width:e,height:t,objectFit:i}}addScanRegionOverlayCanvas(){this._assertOpen();const e=document.createElement("canvas");if(this._updateScanRegionOverlay(e),!this._scanRegionOverlayContainer){const e=document.createElement("div");if(this._scanRegionOverlayContainer=e,e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.overflow="hidden",e.style.pointerEvents="none",this._layerBaseCvs)this._layerBaseCvs.parentElement.after(e);else if(this._cvsScanRegion)this._cvsScanRegion.after(e);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(e);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(e);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(e)}this._recordedStates.overlayShow=!0}return this._scanRegionOverlayContainer.append(e),this._arrScanRegionOverlays.push(e),e}removeScanRegionOverlayCanvas(e){const t=this._arrScanRegionOverlays.indexOf(e);-1!==t&&(e.remove(),this._arrScanRegionOverlays.splice(t,1))}_updateScanRegionOverlay(e){if(!e)return;const t=this._calculateCvsSize();if(!t)return;const{width:i,height:s,objectFit:r}=t;if(i<=0||s<=0)return e.width=0,void(e.height=0);const a=this._getRegionInPixels(i,s,this._scanRegion),o=this.getFrameSize(i,s,this._scanRegion,this.maxCvsSideLength),n=o.dWidth,h=o.dHeight;e.width==n&&e.height==h||(e.width=n,e.height=h);const l=window.getComputedStyle(this._elContainer),d=parseFloat(l.width),c=parseFloat(l.height),g=d/c,u=i/s;let _,f,p,m,w=1;"contain"===r?(u>g?(w=d/i,_=0,f=(c-s*w)/2):(w=c/s,_=(d-i*w)/2,f=0),_+=a.regionLeft*w,f+=a.regionTop*w,p=(a.regionRight-a.regionLeft)*w,m=(a.regionBottom-a.regionTop)*w):"cover"===r?(u>g?(w=c/s,_=a.regionLeft*w-(i*w-d)/2,f=a.regionTop*w):(w=d/i,_=a.regionLeft*w,f=a.regionTop*w-(s*w-c)/2),p=(a.regionRight-a.regionLeft)*w,m=(a.regionBottom-a.regionTop)*w):(_=0,f=0,p=0,m=0),e.style.position="absolute",e.style.left=_+"px",e.style.top=f+"px",e.style.width=p+"px",e.style.height=m+"px"}showScanRegionOverlays(){this._scanRegionOverlayContainer&&("none"==this._scanRegionOverlayContainer.style.display&&(this._scanRegionOverlayContainer.style.display=""),this._recordedStates.overlayShow=!0)}hideScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none",this._recordedStates.overlayShow=!1)}setViewDecorator(e,t){if(!e)return void(this._cvsViewDecorator&&(this._cvsViewDecorator.remove(),this._cvsViewDecorator=null));if(!t)throw new Error("Invalid area.");this._assertOpen();let i=[];if("string"==typeof e?i.push(e):Array.isArray(e)&&(i=JSON.parse(JSON.stringify(e))),!this._cvsViewDecorator){if(this._cvsViewDecorator=document.createElement("canvas"),this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.after(this._cvsViewDecorator);else if(this._layerBaseCvs)this._layerBaseCvs.parentElement.after(this._cvsViewDecorator);else if(this._cvsScanRegion)this._cvsScanRegion.after(this._cvsViewDecorator);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(this._cvsViewDecorator);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsViewDecorator);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(this._cvsViewDecorator)}this._recordedStates.decoratorShow=!0}this._decoratorArea=JSON.parse(JSON.stringify(t)),this._decoratorType.length=0;const s=["rectangle","focus"],r=["crossline","crosshair"];let a=!1,o=!1;for(let e of i)e=e.toLowerCase(),s.includes(e)&&!a&&(a=!0,this._decoratorType.push(e)),r.includes(e)&&!o&&(o=!0,!this._decoratorType.includes(e)&&this._decoratorType.push(e));this._updateViewDecorator()}getViewDecorator(){return{type:JSON.parse(JSON.stringify(this._decoratorType)),area:JSON.parse(JSON.stringify(this._decoratorArea)),canvas:this._cvsViewDecorator}}showViewDecorator(){this._cvsViewDecorator&&("none"==this._cvsViewDecorator.style.display&&(this._cvsViewDecorator.style.display=""),this._recordedStates.decoratorShow=!0)}hideViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none",this._recordedStates.decoratorShow=!1)}setViewDecoratorLineWidth(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("lineWidth"))throw new Error(`It is not allowed to change the property 'lineWidth' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].lineWidth=t,this._updateViewDecorator()}setViewDecoratorStrokeStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("strokeStyle"))throw new Error(`It is not allowed to change the property 'strokeStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].strokeStyle=t,this._updateViewDecorator()}setViewDecoratorFillStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("fillStyle"))throw new Error(`It is not allowed to change the property 'fillStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].fillStyle=t,this._updateViewDecorator()}setViewDecoratorMaskFillStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("maskFillStyle"))throw new Error(`It is not allowed to change the property 'maskFillStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].maskFillStyle=t,this._updateViewDecorator()}_updateViewDecorator(){if(!this._bOpen)return;if(!this._cvsViewDecorator||!this._decoratorArea)return;let e;if(this.singleFrameMode)e="contain";else{if(!this._video)return;e=this.getVideoFit()}const t=this._cvsViewDecorator;t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.left="0",t.style.top="0",t.style.objectFit=e,t.style.pointerEvents="none";const i=this.getVisibleRegion(!0),s=i.regionRight-i.regionLeft,r=i.regionBottom-i.regionTop;if(t.width==s&&t.height==r||(t.width=s,t.height=r),s<=0||r<=0)return;const a=t.getContext("2d");a.clearRect(0,0,t.width,t.height);const o=this._decoratorArea.x/100*s,n=this._decoratorArea.y/100*r,h=this._decoratorArea.width/100*s,l=this._decoratorArea.height/100*r;for(let e of this._decoratorType){if("rectangle"===e){a.fillStyle=this._viewDecoratorInfo.rectangle.maskFillStyle,a.fillRect(0,0,t.width,t.height),a.clearRect(Math.round(o),Math.round(n),Math.round(h),Math.round(l)),a.fillStyle=this._viewDecoratorInfo.rectangle.fillStyle,a.fillRect(Math.round(o),Math.round(n),Math.round(h),Math.round(l)),a.lineWidth=this._viewDecoratorInfo.rectangle.lineWidth,a.strokeStyle=this._viewDecoratorInfo.rectangle.strokeStyle;const e=a.lineWidth/2;a.strokeRect(Math.round(o-e),Math.round(n-e),Math.round(h+a.lineWidth),Math.round(l+a.lineWidth))}if("focus"===e){a.fillStyle=this._viewDecoratorInfo.focus.maskFillStyle,a.fillRect(0,0,t.width,t.height),a.clearRect(Math.round(o),Math.round(n),Math.round(h),Math.round(l)),a.fillStyle=this._viewDecoratorInfo.focus.fillStyle,a.fillRect(Math.round(o),Math.round(n),Math.round(h),Math.round(l)),a.lineWidth=this._viewDecoratorInfo.focus.lineWidth,a.strokeStyle=this._viewDecoratorInfo.focus.strokeStyle;const e=a.lineWidth/2,i=[0,.25,.75,1],s=[0,.25,.75,1];a.beginPath();for(let e=0;e<i.length;e++)if(0==e||3==e)for(let t=0;t<s.length;t+=2)a.moveTo(Math.round(o+i[e]*h),Math.round(n+s[t]*l)),a.lineTo(Math.round(o+i[e]*h),Math.round(n+s[t+1]*l));for(let t=0;t<s.length;t++)if(0==t||3==t)for(let r=0;r<i.length;r+=2)a.moveTo(Math.round(o+i[r]*h-e),Math.round(n+s[t]*l)),a.lineTo(Math.round(o+i[r+1]*h+e),Math.round(n+s[t]*l));a.stroke()}if("crossline"===e&&(a.beginPath(),a.lineWidth=this._viewDecoratorInfo.crossline.lineWidth,a.strokeStyle=this._viewDecoratorInfo.crossline.strokeStyle,a.moveTo(Math.round(o),Math.round(n+l/2)),a.lineTo(Math.round(o+h),Math.round(n+l/2)),a.moveTo(Math.round(o+h/2),Math.round(n)),a.lineTo(Math.round(o+h/2),Math.round(n+l)),a.stroke()),"crosshair"===e){a.beginPath();const e=.05*Math.min(h,l);a.lineWidth=this._viewDecoratorInfo.crosshair.lineWidth,a.strokeStyle=this._viewDecoratorInfo.crosshair.strokeStyle,a.moveTo(Math.round(o+(h-e)/2),Math.round(n+l/2)),a.lineTo(Math.round(o+(h+e)/2),Math.round(n+l/2)),a.moveTo(Math.round(o+h/2),Math.round(n+(l-e)/2)),a.lineTo(Math.round(o+h/2),Math.round(n+(l+e)/2)),a.stroke()}}}getVisibleRegion(e){this._assertOpen();const t=this._calculateCvsSize();if(!t)return null;const{width:i,height:s,objectFit:r}=t;let a=(()=>{const e=parseFloat(window.getComputedStyle(this._elContainer).width),t=parseFloat(window.getComputedStyle(this._elContainer).height);let a,o={regionBottom:s,regionRight:i,regionLeft:0,regionTop:0,regionMeasuredByPercentage:!1};return"cover"===r?e/t<i/s?(a=t/s,o.regionLeft=Math.floor((i-e/a)/2),o.regionRight=Math.ceil(i-o.regionLeft),o.regionTop=0,o.regionBottom=s):(a=e/i,o.regionTop=Math.floor((s-t/a)/2),o.regionBottom=Math.ceil(s-o.regionTop),o.regionLeft=0,o.regionRight=i):"none"===r&&(e<i&&t<s?(o.regionLeft=Math.floor((i-e)/2),o.regionRight=Math.ceil(i-o.regionLeft),o.regionTop=Math.floor((s-t)/2),o.regionBottom=Math.ceil(s-o.regionTop)):e<i?(o.regionLeft=Math.floor((i-e)/2),o.regionRight=Math.ceil(i-o.regionLeft),o.regionTop=0,o.regionBottom=s):t<s&&(o.regionTop=Math.floor((s-t)/2),o.regionBottom=Math.ceil(s-o.regionTop),o.regionLeft=0,o.regionRight=i)),o})();return e?a.regionMeasuredByPercentage=!1:(a.regionBottom=Math.ceil(a.regionBottom/s*100),a.regionRight=Math.ceil(a.regionRight/i*100),a.regionLeft=Math.floor(a.regionLeft/i*100),a.regionTop=Math.floor(a.regionTop/s*100),a.regionMeasuredByPercentage=!0),a}setScanRegionMaskStyle(e){e&&(e.fillStyle&&(this.regionMaskFillStyle=e.fillStyle),e.strokeStyle&&(this.regionMaskStrokeStyle=e.strokeStyle),e.lineWidth&&(this.regionMaskLineWidth=e.lineWidth),this._updateScanRegionCanvas())}_getRegionInPixels(e,t,i){if(!(e<=0||t<=0)){if(!i)return{regionLeft:0,regionTop:0,regionRight:e,regionBottom:t,regionMeasuredByPercentage:!1};if(i.regionMeasuredByPercentage)return{regionLeft:Math.round(i.regionLeft/100*e),regionTop:Math.round(i.regionTop/100*t),regionRight:Math.round(i.regionRight/100*e),regionBottom:Math.round(i.regionBottom/100*t),regionMeasuredByPercentage:!1};return JSON.parse(JSON.stringify(i))}}_updateScanRegionCanvas(){if(!this._bOpen)return;const e=this._calculateCvsSize();if(!e)return;const{width:t,height:i,objectFit:s}=e;if(t<=0||i<=0)return void(this._cvsScanRegion&&(this._cvsScanRegion.width=0,this._cvsScanRegion.height=0));const r=this._getRegionInPixels(t,i,this._scanRegion);if(!this._cvsScanRegion){if(this._cvsScanRegion=document.createElement("canvas"),this._cvsOriginalImage)this._cvsOriginalImage.after(this._cvsScanRegion);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsScanRegion);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(this._cvsScanRegion)}this._recordedStates.maskShow=!0}const a=this._cvsScanRegion;a.style.position="absolute",a.style.width="100%",a.style.height="100%",a.style.left="0",a.style.top="0",a.style.objectFit=s,a.style.pointerEvents="none",a.width==t&&a.height==i||(a.width=t,a.height=i);const o=a.getContext("2d");if(o.clearRect(0,0,a.width,a.height),0!=r.regionLeft||r.regionRight!=t||0!=r.regionTop||r.regionBottom!=i){const e=r.regionLeft,t=r.regionTop,i=r.regionRight-r.regionLeft,s=r.regionBottom-r.regionTop;o.fillStyle=this.regionMaskFillStyle,o.fillRect(0,0,a.width,a.height),o.clearRect(Math.round(e),Math.round(t),Math.round(i),Math.round(s)),o.strokeStyle=this.regionMaskStrokeStyle,o.lineWidth=this.regionMaskLineWidth;const n=o.lineWidth/2;o.strokeRect(Math.round(e-n),Math.round(t-n),Math.round(i+o.lineWidth),Math.round(s+o.lineWidth))}}_updateScanAreaDiv(){if(!this._bOpen)return;const e=this._calculateCvsSize();if(!e)return;const{width:t,height:i,objectFit:s}=e;if(!this._divScanArea)return;if(t<=0||i<=0)return this._divScanArea.style.width="0",void(this._divScanArea.style.height="0");const r=this._getRegionInPixels(t,i,this._scanRegion),a=window.getComputedStyle(this._elContainer),o=parseFloat(a.width),n=parseFloat(a.height),h=o/n,l=t/i;let d,c,g,u,_=1;if("contain"===s)h<l?(_=o/t,d=0,c=(n-i*_)/2):(_=n/i,d=(o-t*_)/2,c=0),d+=r.regionLeft*_,c+=r.regionTop*_,g=(r.regionRight-r.regionLeft)*_,u=(r.regionBottom-r.regionTop)*_;else if("cover"===s)if(h<l){_=n/i,d=r.regionLeft*_-(t*_-o)/2,d=Math.max(d,0),d=Math.min(d,parseFloat(a.width)),c=r.regionTop*_;let e=r.regionRight*_-(t*_-o)/2;e=Math.max(e,0),e=Math.min(e,parseFloat(a.width)),g=e-d,u=(r.regionBottom-r.regionTop)*_}else{_=o/t,d=r.regionLeft*_,c=r.regionTop*_-(i*_-n)/2,c=Math.max(c,0),c=Math.min(c,parseFloat(a.height));let e=r.regionBottom*_-(i*_-n)/2;e=Math.max(e,0),e=Math.min(e,parseFloat(a.height)),g=(r.regionRight-r.regionLeft)*_,u=e-c}else d=0,c=0,g=0,u=0;this._divScanArea.style.left=d+"px",this._divScanArea.style.top=c+"px",this._divScanArea.style.width=g+"px",this._divScanArea.style.height=u+"px"}set croppingRegions(e){this._croppingRegions=e,this._bFetchingLoopStarted&&(this.bIncreaseRegionIndexAuto&&(this._croppingRegionIndex=0),this._fetchingLoop(!1))}get croppingRegions(){if(void 0!==this._croppingRegions)return this._croppingRegions;if(this._controler){const e=this._controler.getPropertyDisiredValue("croppingRegions");if(e&&1===e.length)return e[0]}return this._defaultCroppingRegions}set croppingRegionIndex(e){e<0?(this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0):(this.bIncreaseRegionIndexAuto=!1,this._croppingRegionIndex=e)}get croppingRegionIndex(){return this._croppingRegionIndex}set loopInterval(e){if(e<0)throw new Error("'Invalid value.");this._loopInterval=e,this._bFetchingLoopStarted&&this._fetchingLoop(!1)}get loopInterval(){if(void 0!==this._loopInterval)return this._loopInterval;if(this._controler){const e=this._controler.getPropertyDisiredValue("loopInterval");if(e&&1===e.length)return e[0]}return this._defaultLoopInterval}set maxNumberOfFramesInBuffer(e){if(e<=0)throw new Error("Invalid value.");for(this._maxNumberOfFramesInBuffer=e;this._frameQueue&&this._frameQueue.length>this.maxNumberOfFramesInBuffer;)this._frameQueue.shift()}get maxNumberOfFramesInBuffer(){if(void 0!==this._maxNumberOfFramesInBuffer)return this._maxNumberOfFramesInBuffer;if(this._controler){const e=this._controler.getPropertyDisiredValue("maxNumberOfFramesInBuffer");if(e&&1===e.length)return e[0]}return this._defaultMaxNumberOfFramesInBuffer}get numberOfFramesInBuffer(){return this._frameQueue.length}set refreshInterval(e){this._refreshInterval=e}get refreshInterval(){if(void 0!==this._refreshInterval)return this._refreshInterval;if(this._controler){const e=this._controler.getPropertyDisiredValue("refreshInterval");if(e&&1===e.length)return e[0]}return this._defaultRefreshInterval}static async createInstance(e){let t=new x;("string"==typeof e||e instanceof String)&&(e=JSON.parse(e));for(let i in e)t[i]=e[i];return this._hasEngineResourceLoaded=!0,x.onWarning&&(location&&"file:"===location.protocol?setTimeout((()=>{x.onWarning&&x.onWarning({id:1,message:"The page is opened over file:// and Dynamsoft Camera Enhancer may not work properly. Please open the page via https://."})}),0):!1!==window.isSecureContext&&navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||setTimeout((()=>{x.onWarning&&x.onWarning({id:2,message:"Dynamsoft Camera Enhancer may not work properly in a non-secure context. Please open the page via https://."})}),0)),t._drawingLayersManager=new S,t}static async playVideo(e,t,i){return new Promise(((s,r)=>{e||r(new Error("Invalid video element.")),t||r(new Error("Invalid source.")),e.onloadedmetadata=async()=>{e.onloadedmetadata=null,await e.play(),s(e)},"string"==typeof t||t instanceof String?e.src=t:e.srcObject=t,void 0!==i&&setTimeout((()=>r(new Error("Failed to play video. Timeout."))),i)}))}static findBestRearCamera(e){if(!e||!e.length)return null;const t=["rear","back","rck","arrire","trasera","trs","traseira","posteriore","","","","","","","","","","arka","achterzijde","","baksidan","bagside","sau","bak","tylny","takakamera","belakang","","","spate","hts","zadn","darrere","zadn","","stranja","belakang",""];for(let i of e){const e=i.label.toLowerCase();if(e&&t.some((t=>e.includes(t)))&&/\b0(\b)?/.test(e))return i.deviceId}return["Android","HarmonyOS"].includes(o.OS)?e[e.length-1].deviceId:null}async play(e,t,i,s){let r;if(this._video&&this.videoSrc){x._onLog&&(r=Date.now(),x._onLog("DCE: start loading static video: "+r));const e=await x.playVideo(this._video,this.videoSrc,4e3);if(x._onLog&&x._onLog("DCE: finish loading static video. Costs: "+(Date.now()-r)),!this._video)return e.pause(),this.playCallbackInfo={width:0,height:0,deviceId:null},{width:0,height:0,deviceId:null};const t={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.playCallbackInfo=JSON.parse(JSON.stringify(t));const i=this.mapCameraEvents.get("played");for(let e of i){if(!e)continue;const i=JSON.parse(JSON.stringify(t));setTimeout((()=>{this.isDisposed&&this.disposed||e.apply(this,[i])}),0)}return this._recordedStates.videoPlaying=!0,t}if(this.singleFrameMode)return s&&s.notTriggerSingleFrameClick||this._clickIptSingleFrameMode(),this.playCallbackInfo={width:0,height:0,deviceId:null},{width:0,height:0,deviceId:null};if(!this._video)throw new Error("'video' is null or undefined.");const a=++this.iPlayRound;if(this.promisePlay&&(await this.promisePlay,a<this.iPlayRound))return this.playCallbackInfo={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId},{width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.promisePlay=(async()=>{var s;try{this._video&&this._video.srcObject&&this.stop(),x._onLog&&x._onLog("DCE: ======before video========");const r=()=>{if(!this._video)throw h&&h.getTracks().forEach((e=>{e.stop()})),this._videoTrack=null,this._currentCamera=null,new Error("'video' is null or undefined.")},a=this.getVideoSettings();let n,h;if("boolean"==typeof a.video&&(a.video={}),e)delete a.video.facingMode,a.video.deviceId={exact:e};else if(a.video.deviceId);else if(this._lastDeviceId)delete a.video.facingMode,a.video.deviceId={exact:this._lastDeviceId};else if(this.ifSaveLastUsedCamera&&x.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete a.video.facingMode,a.video.deviceId={ideal:window.localStorage.getItem("dce_last_camera_id")};const e=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),t=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));e&&t&&(a.video.width=e,a.video.height=t)}else if(this.ifSkipCameraInspection);else if(a.video.facingMode){if(await this.getAllCameras(!1),!this._video)throw new Error("'video' is null or undefined.");let e=a.video.facingMode;if(e instanceof Array&&e.length&&(e=e[0]),e=e.exact||e.ideal||e,"environment"===e){n=!0;const e=x.findBestRearCamera(this._allCameras);e&&(delete a.video.facingMode,a.video.deviceId={ideal:e})}}t&&(a.video.width={ideal:t}),i&&(a.video.height={ideal:i}),x._onLog&&x._onLog("DCE: ======try getUserMedia========");let l=[0,500],d=null;const c=async e=>{for(let t of l){t&&await new Promise((e=>setTimeout(e,t))),r();try{x._onLog&&x._onLog("DCE: ask "+JSON.stringify(e)),h=await navigator.mediaDevices.getUserMedia(e);break}catch(e){d=e,x._onLog&&x._onLog("DCE: "+e.message||e)}}};let g;if(await c(a),!h){if(x._onLog&&x._onLog("DCE: ======try getUserMedia again========"),g=JSON.parse(JSON.stringify(a)),"object"==typeof g.video){["iPhone","iPad"].includes(o.OS)?(t>=1280||i>=1280?g.video.width=1280:t>=640||i>=640?g.video.width=640:(t<640||i<640)&&(g.video.width=320),delete g.video.height):n&&!a.video.deviceId?(delete g.video.facingMode,this._allCameras.length&&(g.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})):g.video=!0}x._onLog&&x._onLog("DCE: "+g),await c(g)}if(h||(l=[1e3,2e3],await c(a)),h||await c(g),!h)throw d;const u=()=>{const e=h.getVideoTracks();let t,i;if(e.length&&(t=this._videoTrack=e[0]),this._video&&t){const e=t.getSettings();if(e)for(let s of this._allCameras)if(e.deviceId===s.deviceId){s._checked=!0,s.label=t.label,i=s;break}}this._currentCamera=i};if(await this.getAllCameras(!1),r(),n){u();const e=x.findBestRearCamera(this._allCameras),t=null===(s=this._currentCamera)||void 0===s?void 0:s.deviceId;e&&e!=t&&(h.getTracks().forEach((e=>{e.stop()})),l=[0,500,1e3,2e3],await c(a))}x._onLog&&x._onLog("DCE: ======play video========"),r(),await x.playVideo(this._video,h,4e3),r(),x._onLog&&x._onLog("DCE: ======played video========"),this._bgLoading&&(this._bgLoading.style.animationPlayState="paused");const _=this._video.videoWidth+"x"+this._video.videoHeight;this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",this._video.videoWidth),this._optGotRsl.setAttribute("data-height",this._video.videoHeight),this._optGotRsl.innerText=_,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got")),x._onLog&&x._onLog("DCE: got "+_),u(),this._renderSelCameraInfo();const f={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};f.deviceId&&(this._lastDeviceId=f.deviceId,this.ifSaveLastUsedCamera&&x.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",this._lastDeviceId),a.video.width&&a.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(a.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(a.video.height)))));const p=this.mapCameraEvents.get("played");for(let e of p){if(!e)continue;const t=JSON.parse(JSON.stringify(f));setTimeout((()=>{this.isDisposed&&this.disposed||e.apply(this,[t])}),0)}return this.promisePlay=null,f}catch(e){throw this.promisePlay=null,this._bgLoading&&(this._bgLoading.style.display="none"),"NotFoundError"===e.name&&(DOMException?e=new DOMException("No camera available, please use a device with an accessible camera.",e.name):(e=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),e}})(),x._onLog&&(r=Date.now(),x._onLog("DCE: start opening camera: "+r));const n=await this.promisePlay;return x._onLog&&x._onLog("DCE: finish opening camera. Costs: "+(Date.now()-r)),this.playCallbackInfo=JSON.parse(JSON.stringify(n)),this._recordedStates.videoPlaying=!0,n}async resume(){this._assertOpen(),this._video&&(await this._video.play(),this._recordedStates.videoPlaying=!0),this.ifShowScanRegionLaser&&this.showScanRegionLaser()}pause(){this._assertOpen(),this._video&&(this._video.pause(),this._recordedStates.videoPlaying=!1),this.ifShowScanRegionLaser&&this.hideScanRegionLaser()}_bindUI(){if(!this.UIElement)throw new Error("Need to define `UIElement` before opening.");const e=[this.UIElement];for(let t=0;t<e.length;++t)for(let i of e[t].children)e.push(i);for(let t of e){if(!this._video&&t.classList.contains(this.containerClassName)){this._elContainer=t;const e=document.createElement("video");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.objectFit=this.getVideoFit(),e.setAttribute("playsinline","true"),e.setAttribute("muted","true"),this._video=e;const i=document.createElement("div");i.append(e),i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.width="100%",i.style.height="100%",i.style.overflow="hidden",this._videoContainer=i,t.prepend(i)}else!this._divScanArea&&t.classList.contains("dce-scanarea")?this._divScanArea=t:!this._divScanLight&&t.classList.contains("dce-scanlight")?this._divScanLight=t:!this._bgLoading&&t.classList.contains("dce-bg-loading")?this._bgLoading=t:!this._bgCamera&&t.classList.contains("dce-bg-camera")?this._bgCamera=t:!this._selCam&&t.classList.contains("dce-sel-camera")?this._selCam=t:!this._selRsl&&t.classList.contains("dce-sel-resolution")?(this._selRsl=t,this.videoSrc||this.singleFrameMode||this._selRsl.options.length||(this._selRsl.innerHTML=[this._optGotRsl?"":'<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="1920" data-height="1080">1920x1080</option>','<option data-width="1280" data-height="720">1280x720</option>','<option data-width="640" data-height="480">640x480</option>'].join(""),this._optGotRsl=this._optGotRsl||this._selRsl.options[0])):!this._optGotRsl&&t.classList.contains("dce-opt-gotResolution")?this._optGotRsl=t:!this._btnClose&&t.classList.contains("dce-btn-close")?this._btnClose=t:!this._selMinLtr&&t.classList.contains("dlr-sel-minletter")?(this._selMinLtr=t,this._selMinLtr.options.length||(this._selMinLtr.innerHTML=[this._optGotMinLtr?"":'<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="17">17+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._optGotMinLtr||this._selMinLtr.options[0])):!this._optGotMinLtr&&t.classList.contains("dlr-opt-gotMinLtr")&&(this._optGotMinLtr=t);if(this.extraBindings&&this.extraBindings.length)for(let e of this.extraBindings)try{e(t)}catch(e){}}if(!this._video)throw this._unbindUI(),Error(`Can not find the video container element with class '${this.containerClassName}'`);this.singleFrameMode||this.videoSrc?(this.singleFrameMode&&(this._elContainer&&(this._elContainer.addEventListener("click",this._clickIptSingleFrameMode),this._elContainer.setAttribute("title","Take a photo")),this._bgCamera&&(this._bgCamera.style.display="block")),this._selCam&&(this._selCam.style.display="none"),this._selRsl&&(this._selRsl.style.display="none"),this._selMinLtr&&(this._selMinLtr.style.display="none")):(this._elContainer&&(["Android","HarmonyOS"].includes(o.OS)?(this._elContainer.addEventListener("touchend",this._tapDoFocus),this._elContainer.addEventListener("touchmove",this._touchMoveEvent)):this._elContainer.addEventListener("click",this._tapDoFocus)),this._selCam&&(this._selCam.style.display="block",this._selCam.addEventListener("change",this._onCameraSelChange)),this._selRsl&&(this._selRsl.style.display="block",this._selRsl.addEventListener("change",this._onResolutionSelChange)),this._selMinLtr&&(this._selMinLtr.style.display="block"),this._bgLoading&&(this._bgLoading.style.display="block")),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),document.addEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver&&(this._resizeObserver||(this._resizeObserver=new ResizeObserver((e=>{for(let t of e)t.target===this._elContainer&&this._updateLayers()}))),this._elContainer&&this._resizeObserver.observe(this._elContainer)),window.addEventListener("resize",this._updateLayers)}_unbindUI(){this.singleFrameMode?(this._elContainer&&(this._elContainer.removeEventListener("click",this._clickIptSingleFrameMode),this._elContainer.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._bgLoading&&(this._bgLoading.style.display="none"),this._elContainer&&(this._elContainer.removeEventListener("click",this._tapDoFocus),this._elContainer.removeEventListener("touchend",this._tapDoFocus),this._elContainer.removeEventListener("touchmove",this._touchMoveEvent)),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this.hideScanRegionLaser(),this.hideViewDecorator(),this.hideScanRegionOverlays(),this._drawingLayersManager.setVisible(!1),this._hideOriginalImageCvs(),this._videoContainer&&this._videoContainer.remove(),this._video=null,this._videoContainer=null,this._elContainer=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this._divScanArea=null,this._divScanLight=null,this._cvsScanRegion&&(this._cvsScanRegion.remove(),this._cvsScanRegion=null),this._singleFrameModeIpt&&(this._singleFrameModeIpt.remove(),this._singleFrameModeIpt=null),this._cvsSingleFrameMode&&(this._cvsSingleFrameMode.remove(),this._cvsSingleFrameMode=null),document.removeEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver&&this._resizeObserver&&this._resizeObserver.disconnect(),window.removeEventListener("resize",this._updateLayers)}_assertOpen(){if(!this._bOpen)throw Error("The camera is not open.")}async open(e){this.UIElement||await this.setUIElement(x.defaultUIElementURL),this._bindUI(),e&&this.appendAndShowUI();let t=await this.play();this.bOpen=!0,this._focusParameters.fds=null,this._focusParameters.kTimeout=void 0,this._focusSupported=!0,this._tapFocusEnabled&&!this.singleFrameMode&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,this._focusParameters.fds||(this._focusSupported=!1,this._tapFocusEnabled=!1));const i=this.mapCameraEvents.get("cameraopen");for(let e of i){if(!e)continue;const i=JSON.parse(JSON.stringify(t));setTimeout((()=>{this.isDisposed&&this.disposed||e.apply(this,[i])}),0)}return t}close(e){if(!this._video)return;this.stop(),this._hideOriginalImage(!1),this.hideTip(),this._unbindUI(),e&&this.hideUI(),this.stopFetchingLoop(),this.bOpen=!1;const t=this.mapCameraEvents.get("cameraclose");for(let e of t){if(!e)continue;const t={width:0,height:0,deviceId:null};setTimeout((()=>{this.isDisposed&&this.disposed||e.apply(this,[t])}),0)}}stop(){this._video&&this._video.srcObject&&(x._onLog&&x._onLog("DCE: ======stop video========"),this._video.srcObject.getTracks().forEach((e=>{e.stop()})),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null),this._video&&this.videoSrc&&(x._onLog&&x._onLog("DCE: ======stop existing video========"),this._video.pause(),this._video.currentTime=0),this._bgLoading&&(this._bgLoading.style.animationPlayState=""),this._frameQueue.length=0,this._reusedCvs&&this._reusedCvs.ctx2d&&this._reusedCvs.ctx2d.clearRect(0,0,this._reusedCvs.width,this._reusedCvs.height),this.forceLoseContext()}async getAllCameras(e=!0){let t=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));if(e&&t&&t.length&&!t[0].deviceId){let e=await navigator.mediaDevices.getUserMedia({video:!0});t=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),e.getTracks().forEach((e=>{e.stop()}))}const i=[],s=[];if(this._allCameras)for(let e of this._allCameras)e._checked&&s.push(e);for(let e=0;e<t.length;e++){let r,a=t[e];for(let e of s)if(a.deviceId==e.deviceId){r=e;break}r||(r={deviceId:a.deviceId,label:a.label?a.label:"camera "+e,_checked:!1}),r.deviceId&&i.push(r)}return this._allCameras=i,x._onLog&&x._onLog("DCE: "+JSON.stringify(this._allCameras)),i}_renderSelCameraInfo(){if(!this._selCam)return;let e;this._selCam.textContent="";for(let t of this._allCameras){const i=document.createElement("option");i.value=t.deviceId,i.innerText=t.label,this._selCam.append(i),t.deviceId&&this._currentCamera&&this._currentCamera.deviceId==t.deviceId&&(e=i)}this._selCam.value=e?e.value:""}getSelectedCamera(){if(!this._bOpen){let e="";const t=this.videoSettings.video.deviceId;t&&(e=t.exact||t.ideal||t);for(let t of this._allCameras)if(t.deviceId===e)return JSON.parse(JSON.stringify(t));return{deviceId:e,label:"",_checked:!1}}return this._currentCamera}async selectCamera(e){let t="";if(e&&(t=e.deviceId||e),this.videoSettings.video.deviceId={exact:t},!this._bOpen||this._video.paused)return null;let i=null;this._currentCamera&&(i=this._currentCamera.deviceId);const s=this._video.videoWidth,r=this._video.videoHeight,a=await this.play(e.deviceId||e);if(this._focusParameters.fds=null,this._focusParameters.kTimeout=void 0,this._focusSupported=!0,this._tapFocusEnabled&&!this.singleFrameMode&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,this._focusParameters.fds||(this._focusSupported=!1,this._tapFocusEnabled=!1)),i!==a.deviceId){const e=this.mapCameraEvents.get("camerachange");for(let t of e){if(!t)continue;const e=JSON.parse(JSON.stringify(a));setTimeout((()=>{this.isDisposed&&this.disposed||t.apply(this,[e])}),0)}}if(s!==a.width||r!==a.height){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateDrawingLayersSize(),this._updateVideoContainerStyle();const e=this.mapCameraEvents.get("resolutionchange");for(let t of e){if(!t)continue;const e=JSON.parse(JSON.stringify(a));setTimeout((()=>{this.isDisposed&&this.disposed||t.apply(this,[e])}),0)}}return a}getResolution(){if(this._bOpen)return[this._video.videoWidth,this._video.videoHeight];{let e=0,t=0;const i=this.videoSettings.video.width,s=this.videoSettings.video.height;return i&&(e=i.exact||i.ideal||i),s&&(t=s.exact||s.ideal||s),[e,t]}}async setResolution(e,t){let i,s;if(e instanceof Array?(i=e[0],s=e[1]):(i=e,s=t),this.videoSettings.video.width={ideal:i},this.videoSettings.video.height={ideal:s},!this._bOpen||this._video.paused)return null;const r=this._video.videoWidth,a=this._video.videoHeight,o=await this.play(null,i,s);if(r!==o.width||a!==o.height){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateDrawingLayersSize(),this._updateVideoContainerStyle();const e=this.mapCameraEvents.get("resolutionchange");for(let t of e){if(!t)continue;const e=JSON.parse(JSON.stringify(o));setTimeout((()=>{this.isDisposed&&this.disposed||t.apply(this,[e])}),0)}}return o}async getResolutions(e){let t="";const i=(e,t)=>{const i=this._mapCameraResolutions.get(e);if(!i||!i.length)return!1;for(let e of i)if(e[0]===t.width&&e[1]===t.height)return!0;return!1},s=async(e,t,i)=>{const s={video:{deviceId:{exact:e},width:{ideal:t},height:{ideal:i}}};let r=null;try{r=await navigator.mediaDevices.getUserMedia(s)}catch(e){return null}if(!r)return null;const a=r.getVideoTracks();let o=null;try{const e=a[0].getSettings();o={width:e.width,height:e.height}}catch(e){const t=document.createElement("video");t.srcObject=r,o={width:t.videoWidth,height:t.videoHeight},t.srcObject=null}return a.forEach((e=>{e.stop()})),o};if(!this._bOpen){const r=this.videoSettings.video.deviceId;if(!r)return null;if(t=r.hasOwnProperty("exact")?this.videoSettings.video.deviceId.exact:r.hasOwnProperty("ideal")?this.videoSettings.video.deviceId.ideal:this.videoSettings.video.deviceId,!t)return null;let a=this._mapCameraResolutions.get(t);if(a&&!e)return this._mapCameraResolutions.get(t);this._mapCameraResolutions.set(t,[]),a=this._mapCameraResolutions.get(t);for(let e of this._predefinedResolutions){const r=await s(t,e.width,e.height);r&&!i(t,r)&&a.push([r.width,r.height])}return a}if(this._currentCamera){t=this._currentCamera.deviceId;let s=this._mapCameraResolutions.get(t);if(s&&!e)return this._mapCameraResolutions.get(t);this._mapCameraResolutions.set(t,[]),s=this._mapCameraResolutions.get(t);const r=this.getConstraints();for(let e of this._predefinedResolutions){await this._videoTrack.applyConstraints({width:{ideal:e.width},height:{ideal:e.height}});const r=this._videoTrack.getSettings(),a={width:r.width,height:r.height};i(t,a)||s.push([a.width,a.height])}return await this._videoTrack.applyConstraints(r),s}return null}on(e,t){if(!t)return;const i=this.mapCameraEvents.get(e.toLowerCase());if(!i)throw new Error(`Event '${e}' does not exist.`);i.includes(t)||i.push(t)}off(e,t){const i=this.mapCameraEvents.get(e.toLowerCase());if(!i)throw new Error(`Event '${e}' does not exist.`);const s=i.indexOf(t);-1!==s&&i.splice(s,1)}offAll(e){if(e){if("string"==typeof e){const t=this.mapCameraEvents.get(e);t&&(t.length=0)}}else for(let e of this.mapCameraEvents.values())e&&(e.length=0)}getVideoSettings(){return JSON.parse(JSON.stringify(this.videoSettings))}updateVideoSettings(e){if(this.videoSettings=JSON.parse(JSON.stringify(e)),this._lastDeviceId=null,this._bOpen)return this.play()}isOpen(){return this._bOpen}getCapabilities(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCapabilities()' is unavailable in singleFrameMode.");return this._videoTrack&&this._videoTrack.getCapabilities?this._videoTrack.getCapabilities():{}}getCameraSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCameraSettings()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings():null}getConstraints(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getConstraints()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getConstraints():null}async applyConstraints(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'applyConstraints()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');if(!this._videoTrack.applyConstraints)throw Error("Not supported.");return await this._videoTrack.applyConstraints(e)}async turnOnTorch(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOnTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return await this._videoTrack.applyConstraints({advanced:[{torch:!0}]});throw Error("Not supported.")}async turnOffTorch(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOffTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return await this._videoTrack.applyConstraints({advanced:[{torch:!1}]});throw Error("Not supported.")}async setColorTemperature(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setColorTemperature()' is unavailable in singleFrameMode.");let t=this.getCapabilities().colorTemperature;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),await this._videoTrack.applyConstraints({advanced:[{colorTemperature:e,whiteBalanceMode:"manual"}]})}getColorTemperature(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getColorTemperature()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().colorTemperature||0:null}async setExposureCompensation(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setExposureCompensation()' is unavailable in singleFrameMode.");let t=this.getCapabilities().exposureCompensation;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),await this._videoTrack.applyConstraints({advanced:[{exposureCompensation:e}]})}getExposureCompensation(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getExposureCompensation()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().exposureCompensation||0:null}async _setHardwareScale(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setHardwareScale()' is unavailable in singleFrameMode.");if(e<1)throw new RangeError("Invalid value.");if(!this._videoTrack)return;const t=this.getCapabilities().zoom;if(!t)throw new Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),e=I(e,t.min,t.step,t.max),await this._videoTrack.applyConstraints({advanced:[{zoom:e}]}),e}_getHardwareScale(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().zoom||1:null}_setSoftwareScale(e,t){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setSoftwareScale()' is unavailable in singleFrameMode.");if(e<1)throw new RangeError("Invalid value.");t&&this._setScaleCenter(t),this._softwareScale=e,this._scaleVideo(e,t)}_getSoftwareScale(){return this._softwareScale}_setScaleCenter(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setScaleCenter()' is unavailable in singleFrameMode.");if(!e||"string"!=typeof e.x||"string"!=typeof e.y)throw new Error("Invalid center.");const t=this._video.videoWidth,i=this._video.videoHeight;let s=0,r=0;if(e.x.endsWith("px"))s=parseFloat(e.x);else{if(!e.x.endsWith("%"))throw new Error("Invalid scale center.");s=parseFloat(e.x)/100*t}if(e.y.endsWith("px"))r=parseFloat(e.y);else{if(!e.y.endsWith("%"))throw new Error("Invalid scale center.");r=parseFloat(e.y)/100*i}if(NaN==s||NaN==r)throw new Error("Invalid scale center.");this._scaleCenter={x:s,y:r}}_resetScaleCenter(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_resetScaleCenter()' is unavailable in singleFrameMode.");const e=this._video.videoWidth,t=this._video.videoHeight;this._scaleCenter={x:e/2,y:t/2}}_isVideoCenter(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_isVideoCenter()' is unavailable in singleFrameMode.");return e&&e.x==this._video.videoWidth/2&&e.y==this._video.videoHeight/2}async _setZoom(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");if(e<1)throw new RangeError("Invalid value.");this._resetScaleCenter();try{if(this._isVideoCenter(this._scaleCenter)){const t=await this._setHardwareScale(e);let i=this._getHardwareScale();1==i&&1!=t&&(i=t),e>i?this._setSoftwareScale(e/i):this._setSoftwareScale(1)}else await this._setHardwareScale(1),this._setSoftwareScale(e)}catch(t){if("Not supported."!==(t.message||t))throw t;this._setSoftwareScale(e)}}async setZoom(e){if("number"!=typeof e&&"object"!=typeof e)throw new TypeError("Illegal type of argument.");if("number"==typeof e)return this._setZoom(e);if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");if(e){if("number"!=typeof e.factor)throw new TypeError("Illegal type of 'factor'.");if(e.factor<1)throw new RangeError("Invalid value.");e.centerPoint?this._setScaleCenter(e.centerPoint):this._resetScaleCenter();try{if(this._isVideoCenter(this._scaleCenter)){const t=await this._setHardwareScale(e.factor);let i=this._getHardwareScale();1==i&&1!=t&&(i=t),e.factor>i?this._setSoftwareScale(e.factor/i):this._setSoftwareScale(1)}else await this._setHardwareScale(1),this._setSoftwareScale(e.factor)}catch(t){if("Not supported."!==(t.message||t))throw t;this._setSoftwareScale(e.factor)}}}getZoom(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getZoom()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;return this._getHardwareScale()*this._softwareScale}getZoomSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getZoom()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;return{factor:this._getHardwareScale()*this._softwareScale}}async resetZoom(){await this.setZoom({factor:1})}async setFrameRate(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFrameRate()' is unavailable in singleFrameMode.");let t=this.getCapabilities().frameRate;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),await this._videoTrack.applyConstraints({width:{ideal:Math.max(this._video.videoWidth,this._video.videoHeight)},frameRate:e})}getFrameRate(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrameRate()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().frameRate:null}async _setFocus(e,t){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");if("string"!=typeof e)throw Error("Invalid focus mode.");e=e.toLowerCase();const i=this.getCapabilities().focusMode,s=this.getCapabilities().focusDistance;if(!i)throw Error("Not supported.");if(!i.includes(e))throw Error("Unsupported mode.");if(t>=0){if(!s)throw Error("Manual focus unsupported.");return t<s.min?t=s.min:t>s.max&&(t=s.max),t=I(t,s.min,s.step,s.max),await this._videoTrack.applyConstraints({advanced:[{focusMode:e,focusDistance:t}]})}return await this._videoTrack.applyConstraints({advanced:[{focusMode:e}]})}async setFocus(e,t){if("string"==typeof e)return this._setFocus(e,t);if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");if(!e)return;const i=this.getCapabilities(),s=i.focusMode,r=i.focusDistance;if(!s)throw Error("Not supported.");if("string"!=typeof e.mode)throw Error("Invalid focus mode.");const a=e.mode.toLowerCase();if(!s.includes(a))throw Error("Unsupported focus mode.");if("manual"!==a)return this._focusParameters._focusArea=null,await this._videoTrack.applyConstraints({advanced:[{focusMode:a}]});if(!r)throw Error("Manual focus unsupported.");if(e.hasOwnProperty("distance")){let t=e.distance;return t<r.min?t=r.min:t>r.max&&(t=r.max),t=I(t,r.min,r.step,r.max),this._focusParameters._focusArea=null,await this._videoTrack.applyConstraints({advanced:[{focusMode:a,focusDistance:t}]})}if(!e.area)throw new Error("'distance' or 'area' should be specified in 'manual' mode.");{const t=e.area.centerPoint;let i=e.area.width,s=e.area.height;if(!i||!s){const e=this._video.videoWidth,t=this._video.videoHeight;i||(i=2*Math.round(Math.min(e,t)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px"),s||(s=2*Math.round(Math.min(e,t)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px")}this._focusParameters._focusArea={centerPoint:{x:t.x,y:t.y},width:i,height:s},await this._setLocalFocus(t,i,s)}}getFocus(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;const e=this._videoTrack.getSettings().focusMode;return e?"continuous"===e?{mode:e}:{mode:e,distance:this._videoTrack.getSettings().focusDistance}:null}getFocusSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;const e=this._videoTrack.getSettings(),t=e.focusMode;return t?"manual"===t?this._focusParameters._focusArea?{mode:"manual",area:JSON.parse(JSON.stringify(this._focusParameters._focusArea))}:{mode:"manual",distance:e.focusDistance}:{mode:t}:null}async _setFocusAndGetContract(e,t){const i=e=>{if(!this._bOpen||!this._videoTrack||this.video.paused||e.focusTaskId!=this._focusParameters.curFocusTaskId){this._bOpen&&this._videoTrack&&!this.video.paused||(this._focusParameters.isDoingFocus=0);const t=new Error(`Focus task ${e.focusTaskId} canceled.`);throw t.name="DeprecatedTaskError",t}1===this._focusParameters.isDoingFocus&&Date.now()-e.timeStart>this._focusParameters.focusCancelableTime&&(this._focusParameters.isDoingFocus=-1)};let s;t=I(t,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:t}]}),i(e),s=null==this._focusParameters.oldDistance?this._focusParameters.kTimeout*Math.max(Math.abs(1/this._focusParameters.fds.min-1/t),Math.abs(1/this._focusParameters.fds.max-1/t))+this._focusParameters.minTimeout:this._focusParameters.kTimeout*Math.abs(1/this._focusParameters.oldDistance-1/t)+this._focusParameters.minTimeout,this._focusParameters.oldDistance=t,await new Promise((e=>{setTimeout(e,s)})),i(e);let r=e.focusL-e.focusW/2,a=e.focusT-e.focusH/2,o=e.focusW,n=e.focusH;if(r>=this.video.videoWidth||a>=this.video.videoHeight)throw new Error("Invalid area.");r+o>this.video.videoWidth&&(o=this.video.videoWidth-r),a+n>this.video.videoHeight&&(n=this.video.videoHeight-a);const h=this._getImageData(this.video,this.video.videoWidth,this.video.videoHeight,{sx:r,sy:a,sWidth:o,sHeight:n,dWidth:o,dHeight:n},null,{pixelFormat:L.RGBA});if(!h)return this._setFocusAndGetContract(e,t);const l=h.data;let d=0;for(let e=0,t=l.length-8;e<t;++e){let t=l[e]-l[e+8];++e;let i=l[e]-l[e+8];++e;let s=l[e]-l[e+8];++e,d+=t*t+i*i+s*s}return-d}async _doFocusDetail(e,t,i,s,r,a,o){let n;if(t=I(t,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),s=I(s,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),a?a=I(a,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max):(a=I(Math.sqrt((t||this._focusParameters.fds.step)*(s||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),o=await this._setFocusAndGetContract(e,a)),o<=i&&o<=r?n=3:i<r&&i<o?n=1:r<i&&r<o&&(n=2),(s-t)/2<=this._focusParameters.fds.step)return 3===n||(1===n?await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:t}]}):2===n&&await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:s}]})),!0;if(1===n)return await this._doFocusDetail(e,t,i,a,o);if(2===n)return await this._doFocusDetail(e,a,o,s,r);if(3!==n)return i=await this._setFocusAndGetContract(e,t),r=await this._setFocusAndGetContract(e,s),await this._doFocusDetail(e,t,i,s,r);let h=I(Math.sqrt((t||this._focusParameters.fds.step)*(a||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),l=I(Math.sqrt((s||this._focusParameters.fds.step)*(a||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max);if(Math.abs(1/this._focusParameters.oldDistance-1/h)<=Math.abs(1/this._focusParameters.oldDistance-1/l)){let n=await this._setFocusAndGetContract(e,h);if(n<o)return await this._doFocusDetail(e,t,i,a,o,h,n);if(n==o)return await this._doFocusDetail(e,h,n,a,o);let d=await this._setFocusAndGetContract(e,l);if(n>o&&o<d)return await this._doFocusDetail(e,h,n,l,d,a,o);if(o==d)return await this._doFocusDetail(e,a,o,l,d);if(o>d)return await this._doFocusDetail(e,a,o,s,r,l,d)}else{let n=await this._setFocusAndGetContract(e,l);if(o>n)return await this._doFocusDetail(e,a,o,s,r,l,n);if(o==n)return await this._doFocusDetail(e,a,o,l,n);let d=await this._setFocusAndGetContract(e,h);if(d>o&&o<n)return await this._doFocusDetail(e,h,d,l,n,a,o);if(d==o)return await this._doFocusDetail(e,h,d,a,o);if(d<o)return await this._doFocusDetail(e,t,i,a,o,h,d)}return!1}async _setLocalFocus(e,t,i,s,r){if(1==this._focusParameters.isDoingFocus)return!1;if(!e||"string"!=typeof e.x||"string"!=typeof e.y)throw new Error("Invalid centerPoint.");if(!t||"string"!=typeof t)throw new Error("Invalid width.");if(!i||"string"!=typeof i)throw new Error("Invalid height.");const a=this._video.videoWidth,o=this._video.videoHeight;let n=0,h=0;if(e.x.endsWith("px"))n=parseFloat(e.x);else{if(!e.x.endsWith("%"))throw new Error("Invalid centerPoint.");n=parseFloat(e.x)/100*a}if(e.y.endsWith("px"))h=parseFloat(e.y);else{if(!e.y.endsWith("%"))throw new Error("Invalid centerPoint.");h=parseFloat(e.y)/100*o}if(NaN==n||NaN==h)throw new Error("Invalid centerPoint.");let l=0;if(t.endsWith("px"))l=parseFloat(t);else{if(!t.endsWith("%"))throw new Error("Invalid width.");l=parseFloat(t)/100*a}if(NaN==l)throw new Error("Invalid width.");let d=0;if(i.endsWith("px"))d=parseFloat(i);else{if(!i.endsWith("%"))throw new Error("Invalid height.");d=parseFloat(i)/100*o}if(NaN==d)throw new Error("Invalid height.");if(1!==this._softwareScale){const e=this._softwareScale,t=this._scaleCenter;l/=e,d/=e,n=(1-1/e)*t.x+n/e,h=(1-1/e)*t.y+h/e}if(!this._focusSupported)throw new Error("Manual focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,new Error("Manual focus unsupported.");null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus=1;const c={focusL:n,focusT:h,focusW:l,focusH:d,focusTaskId:++this._focusParameters.curFocusTaskId,timeStart:Date.now()},g=async(e,t,i)=>{try{(null==t||t<this._focusParameters.fds.min)&&(t=this._focusParameters.fds.min),(null==i||i>this._focusParameters.fds.max)&&(i=this._focusParameters.fds.max),this._focusParameters.oldDistance=null;let s=I(Math.sqrt(i*(t||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),r=I(Math.sqrt((t||this._focusParameters.fds.step)*s),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),a=I(Math.sqrt(s*i),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),o=await this._setFocusAndGetContract(e,a),n=await this._setFocusAndGetContract(e,r),h=await this._setFocusAndGetContract(e,s);if(n>h&&h<o){const t=await this._doFocusDetail(e,r,n,a,o,s,h);return this._focusParameters.isDoingFocus=0,t}if(n<h&&n<o){let i=await this._setFocusAndGetContract(e,t);const a=await this._doFocusDetail(e,t,i,s,h,r,n);return this._focusParameters.isDoingFocus=0,a}if(h>o&&n>o){let t=await this._setFocusAndGetContract(e,i);const r=await this._doFocusDetail(e,s,h,i,t,a,o);return this._focusParameters.isDoingFocus=0,r}if(n==h&&h<o){const t=await this._doFocusDetail(e,r,n,s,h);return this._focusParameters.isDoingFocus=0,t}if(h==o&&n>h){const t=await this._doFocusDetail(e,s,h,a,o);return this._focusParameters.isDoingFocus=0,t}return g(e,t,i)}catch(e){if("DeprecatedTaskError"!==e.name)throw e}};return g(c,s,r)}async enableTapToFocus(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'enableTapToFocus()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error("Video is not playing.");if(!this._focusSupported)throw new Error("Tapping to focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,this._tapFocusEnabled=!1,new Error("Tapping to focus unsupported.");this._tapFocusEnabled=!0}disableTapToFocus(){this._tapFocusEnabled=!1}isTapToFocusEnabled(){return this._tapFocusEnabled}_updateVideoContainerStyle(){if(!this._video)return;if(this.singleFrameMode)return;const e=this._getSoftwareScale(),t=this._videoContainer;if("contain"===this.videoFit&&e>1){const e=this._video.videoWidth,i=this._video.videoHeight,s=window.getComputedStyle(this._elContainer),r=parseFloat(s.width),a=parseFloat(s.height),o=e/i;if(r/a<o){let e=r/o;t.style.left="0",t.style.top=(a-e)/2/a*100+"%",t.style.width="100%",t.style.height=e/a*100+"%"}else{let e=a*o;t.style.left=(r-e)/2/r*100+"%",t.style.top="0",t.style.width=e/r*100+"%",t.style.height="100%"}}else t.style.left="0",t.style.top="0",t.style.width="100%",t.style.height="100%"}_scaleVideo(e,t){if(this._video&&!this.singleFrameMode){if(e<1)throw new RangeError("Invalid scale value.");if(t&&this._setScaleCenter(t),1===e)this._video.style.transform="";else{const t=this.getVideoFit(),i=this._video.videoWidth,s=this._video.videoHeight,r=window.getComputedStyle(this._elContainer),a=parseFloat(r.width),o=parseFloat(r.height),n=a/o,h=i/s;let l=1;"contain"===t?l=n<h?a/(i/e):o/(s/e):"cover"===t&&(l=h>n?o/(i/e):a/(s/e));const d=l*(1-1/e)*(i/2-this._scaleCenter.x),c=l*(1-1/e)*(s/2-this._scaleCenter.y);this._video.style.transform=`translate(${d}px, ${c}px) scale(${e})`}this._updateVideoContainerStyle()}}getFrameSize(e,t,i,s){if(!e||!t)return null;let r,a,o,n,h=e,l=t;const d={regionLeft:0,regionTop:0,regionRight:h,regionBottom:l,regionMeasuredByPercentage:!1};i?(i.regionMeasuredByPercentage?(d.regionLeft=i.regionLeft*h/100,d.regionTop=i.regionTop*l/100,d.regionRight=i.regionRight*h/100,d.regionBottom=i.regionBottom*l/100):(d.regionLeft=i.regionLeft,d.regionTop=i.regionTop,d.regionRight=i.regionRight,d.regionBottom=i.regionBottom),r=Math.round(d.regionLeft),a=Math.round(d.regionTop),h=Math.round(d.regionRight-d.regionLeft),l=Math.round(d.regionBottom-d.regionTop)):(r=0,a=0,h=Math.round(h),l=Math.round(l));const c=Math.max(h,l);if(s&&s>0&&c>s){const e=s/c;h>l?(o=s,n=Math.round(l*e)):(o=Math.round(h*e),n=s)}else o=h,n=l;return o<=0||n<=0?null:{sx:r,sy:a,sWidth:h,sHeight:l,dWidth:o,dHeight:n}}getFrame(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrame()' is unavailable in singleFrameMode.");return this._getVideoData()}getImage(){return this.getFrame()}_drawImage(e,t,i,s,r,a,o){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!i||!s)return null;if(t instanceof HTMLVideoElement&&4!==t.readyState||t instanceof HTMLImageElement&&!t.complete)throw new Error("The source is not loaded.");let n;x._onLog&&(n=Date.now(),x._onLog("DCE: _drawImage(), START: "+n));let h=0,l=0,d=i,c=s,g=0,u=0,_=i,f=s;r&&(r.sx&&(h=Math.round(r.sx)),r.sy&&(l=Math.round(r.sy)),r.sWidth&&(d=Math.round(r.sWidth)),r.sHeight&&(c=Math.round(r.sHeight)),r.dx&&(g=Math.round(r.dx)),r.dy&&(u=Math.round(r.dy)),r.dWidth&&(_=Math.round(r.dWidth)),r.dHeight&&(f=Math.round(r.dHeight)));let p=L.RGBA;o&&o.pixelFormat&&(p=o.pixelFormat);const m=e;if(o&&o.bUseWebGL){x._onLog&&x._onLog("DCE: _drawImage() in WebGL."),(m.width<g+_||m.height<u+f)&&(m.width=g+_,m.height=u+f,m.ctxWebGL&&m.ctxWebGL.viewport(0,0,g+_,u+f));const e=m.ctxWebGL||m.getContext("webgl",{antialias:!1})||m.getContext("experimental-webgl",{antialias:!1});if(!e){x._onLog&&x._onLog("DCE: WebGL unavailable.");const e=new Error("WebGL error: unable to initialize WebGL. Your browser or machine may not support it.");throw e.name="WebGLError",e}if(!m.ctxWebGL||p!==this.shaderPixelFormat){m.ctxWebGL=e;const t=e=>{const t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t);e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW);const i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i);return e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW),{positions:t,texCoords:i}},i=e=>{const t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t},s=(e,t)=>{const i=e.createProgram();if(t.forEach((t=>e.attachShader(i,t))),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS)){const t=new Error(`An error occured linking the program: ${e.getProgramInfoLog(i)}.`);throw t.name="WebGLError",t}return e.useProgram(i),i},r=(e,t,i)=>{const s=e.createShader(t);if(e.shaderSource(s,i),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const t=new Error(`An error occured compiling the shader: ${e.getShaderInfoLog(s)}.`);throw t.name="WebGLError",t}return s},a="\n                    attribute vec2 a_position;\n                    attribute vec2 a_texCoord;\n\n                    uniform mat3 u_matrix;\n                    uniform mat3 u_textureMatrix;\n\n                    varying vec2 v_texCoord;\n                    void main(void) {\n                    gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1.0);\n                    v_texCoord = vec4((u_textureMatrix * vec3(a_texCoord, 1)).xy, 0, 1.0).xy;\n                    }\n                ";let o="rgb";["rgba","rbga","grba","gbra","brga","bgra"].includes(p)&&(o=p.slice(0,3));const n=`\n                    precision mediump float;\n                    varying vec2 v_texCoord;\n                    uniform sampler2D u_image;\n                    uniform float uColorFactor;\n\n                    void main() {\n                        vec4 sample = texture2D(u_image, v_texCoord);\n                        float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                        gl_FragColor = vec4(sample.${o} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                    }\n                `,h=s(e,[r(e,e.VERTEX_SHADER,a),r(e,e.FRAGMENT_SHADER,n)]);this._webGLProgramInfo={program:h,attribLocations:{vertexPosition:e.getAttribLocation(h,"a_position"),texPosition:e.getAttribLocation(h,"a_texCoord")},uniformLocations:{uSampler:e.getUniformLocation(h,"u_image"),uColorFactor:e.getUniformLocation(h,"uColorFactor"),uMatrix:e.getUniformLocation(h,"u_matrix"),uTextureMatrix:e.getUniformLocation(h,"u_textureMatrix")}},this._webGLBuffers=t(e),this._webGLTexture=i(e),this.shaderPixelFormat=p}const r=(e,t,i)=>{e.bindBuffer(e.ARRAY_BUFFER,t),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0)},o=(e,t,i)=>{const s=e.RGBA,r=e.RGBA,a=e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,s,r,a,i)},w=(e,t,a,o)=>{e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),r(e,a.positions,t.attribLocations.vertexPosition),r(e,a.texCoords,t.attribLocations.texPosition),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o),e.uniform1i(t.uniformLocations.uSampler,0),e.uniform1f(t.uniformLocations.uColorFactor,[L.GREY,L.GREY32].includes(p)?1:0);let n,m,w=C.translate(C.identity(),-1,-1);w=C.scale(w,2,2),w=C.scale(w,1/e.canvas.width,1/e.canvas.height),n=C.translate(w,g,u),n=C.scale(n,_,f),e.uniformMatrix3fv(t.uniformLocations.uMatrix,!1,n),m=C.translate(C.identity(),h/i,l/s),m=C.scale(m,d/i,c/s),e.uniformMatrix3fv(t.uniformLocations.uTextureMatrix,!1,m),e.drawArrays(e.TRIANGLES,0,6)};let v;if(o(e,this._webGLTexture,t),w(e,this._webGLProgramInfo,this._webGLBuffers,this._webGLTexture),a){if(a.length<_*f*4)throw new Error("Unexpected size of the 'bufferContainer'.");v=a}else v=new Uint8Array(_*f*4);if(e.readPixels(g,u,_,f,e.RGBA,e.UNSIGNED_BYTE,v),255!==v[3]){x._onLog&&x._onLog("DCE: WebGL drawing incorrect."),this._bWebGLSupported=!1;const e=new Error("WebGL error: incorrect WebGL drawing.");throw e.name="WebGLError",e}return x._onLog&&x._onLog("DCE: _drawImage() in WebGL end. Costs: "+(Date.now()-n)),{context:e,pixelFormat:p===L.GREY?L.GREY32:p,_bUseWebGL:!0}}{x._onLog&&x._onLog("DCE: _drawImage() in context2d."),m.ctx2d||(m.ctx2d=m.getContext("2d",{willReadFrequently:!0}));const e=m.ctx2d;if(!e)throw new Error("Unable to get 'CanvasRenderingContext2D' from canvas.");return(m.width<g+_||m.height<u+f)&&(m.width=g+_,m.height=u+f),e.drawImage(t,h,l,d,c,g,u,_,f),x._onLog&&x._onLog("DCE: _drawImage() in context2d end. Costs: "+(Date.now()-n)),{context:e,pixelFormat:L.RGBA,_bUseWebGL:!1}}}_readCvsData(e,t,i){let s,r=0,a=0,o=e.canvas.width,n=e.canvas.height;if(t&&(t.x&&(r=t.x),t.y&&(a=t.y),t.width&&(o=t.width),t.height&&(n=t.height)),e instanceof WebGLRenderingContext){const t=e;if(i){if(i.length<o*n*4)throw new Error("Unexpected size of the 'bufferContainer'.");t.readPixels(r,a,o,n,t.RGBA,t.UNSIGNED_BYTE,i),s=new Uint8Array(i.buffer,0,o*n*4)}else s=new Uint8Array(o*n*4),t.readPixels(r,a,o,n,t.RGBA,t.UNSIGNED_BYTE,s)}else if(e instanceof CanvasRenderingContext2D){let t;if(t=e.getImageData(r,a,o,n),s=new Uint8Array(t.data.buffer),i){if(i.length<s.length)throw new Error("Unexpected size of the 'bufferContainer'.");i.set(s)}}return s}_transformPixelFormat(e,t,i,s){let r,a;if(x._onLog&&(r=Date.now(),x._onLog("DCE: _transformPixelFormat(), START: "+r)),t===i)return x._onLog&&x._onLog("DCE: _transformPixelFormat() end. Costs: "+(Date.now()-r)),s?new Uint8Array(e):e;const o=[L.RGBA,L.RBGA,L.GRBA,L.GBRA,L.BRGA,L.BGRA];if(o.includes(t))if(i===L.GREY){a=new Uint8Array(e.length/4);for(let t=0;t<e.length;t+=4){const i=.21*e[t]+.71*e[t+1]+.07*e[t+2];a[t/4]=i}}else if(i===L.GREY32){a=s?new Uint8Array(e):e;for(let t=0;t<e.length;t+=4){const i=.21*e[t]+.71*e[t+1]+.07*e[t+2];a[t]=i,a[t+1]=i,a[t+2]=i}}else{if(!o.includes(i))throw new Error("Unable to transform.");if(s){a=new Uint8Array(e);const s=t.indexOf("r"),r=t.indexOf("g"),o=t.indexOf("b"),n=i.indexOf("r"),h=i.indexOf("g"),l=i.indexOf("b");for(let t=0;t<e.length;t+=4)a[t+n]=e[t+s],a[t+h]=e[t+r],a[t+l]=e[t+o]}else{a=e;const s=t.indexOf("r"),r=t.indexOf("g"),o=t.indexOf("b"),n=i.indexOf("r"),h=i.indexOf("g"),l=i.indexOf("b");for(let t=0;t<e.length;t+=4){let i=[e[t],e[t+1],e[t+2]];a[t+n]=i[s],a[t+h]=i[r],a[t+l]=i[o]}}}else if(t===L.GREY){if(i!==L.GREY32)throw new Error("Unable to transform.");a=new Uint8Array(4*e.length);for(let t=0;t<e.length;t++)a[4*t]=e[t],a[4*t+1]=e[t],a[4*t+2]=e[t],a[4*t+3]=255}else{if(t!==L.GREY32)throw new Error("Unable to transform.");if(i!==L.GREY)throw new Error("Unable to transform.");a=new Uint8Array(new Uint32Array(e.buffer))}return x._onLog&&x._onLog("DCE: _transformPixelFormat() end. Costs: "+(Date.now()-r)),a}_getImageData(e,t,i,s,r,a){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!t||!i)return null;if(s.sx>t||s.sy>i||s.sx+s.sWidth>t||s.sy+s.sHeight>i)throw new Error("Invalid position.");if(e instanceof HTMLVideoElement&&4!==e.readyState||e instanceof HTMLImageElement&&!e.complete)throw new Error("The source is not loaded.");let o;x._onLog&&(o=Date.now(),x._onLog("DCE: _getImageData(), START: "+o));const n=Math.round(s.sx),h=Math.round(s.sy),l=Math.round(s.sWidth),d=Math.round(s.sHeight),c=Math.round(s.dWidth),g=Math.round(s.dHeight);let u=L.RGBA;a&&a.pixelFormat&&(u=a.pixelFormat);let _,f,p,m=this._bWebGLSupported;a&&0==a.bUseWebGL&&(m=!1),m?(this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas")),_=this._reusedWebGLCvs):(this._reusedCvs||(this._reusedCvs=document.createElement("canvas")),_=this._reusedCvs);try{if(m)if(x._onLog&&x._onLog("DCE: _getImageData() in WebGL."),r)if(u===L.GREY){if(p=new Uint8Array(c*g*4),f=this._drawImage(_,e,t,i,{sx:n,sy:h,sWidth:l,sHeight:d,dWidth:c,dHeight:g},p,{pixelFormat:u,bUseWebGL:m}),p=this._transformPixelFormat(p,f.pixelFormat,u),r){if(r.length<p.length)throw new Error("Unexpected size of the 'bufferContainer'.");r.set(p)}}else f=this._drawImage(_,e,t,i,{sx:n,sy:h,sWidth:l,sHeight:d,dWidth:c,dHeight:g},r,{pixelFormat:u,bUseWebGL:m}),p=new Uint8Array(r.buffer,0,c*g*4),p=this._transformPixelFormat(p,f.pixelFormat,u);else u===L.GREY?((!this._tempDataContainer||this._tempDataContainer.length<c*g*4)&&(this._tempDataContainer=new Uint8Array(c*g*4)),p=new Uint8Array(this._tempDataContainer.buffer,0,c*g*4)):p=new Uint8Array(c*g*4),f=this._drawImage(_,e,t,i,{sx:n,sy:h,sWidth:l,sHeight:d,dWidth:c,dHeight:g},p,{pixelFormat:u,bUseWebGL:m}),p=this._transformPixelFormat(p,f.pixelFormat,u);else if(x._onLog&&x._onLog("DCE: _getImageData() in context2d."),f=this._drawImage(_,e,t,i,{sx:n,sy:h,sWidth:l,sHeight:d,dWidth:c,dHeight:g},null,{pixelFormat:L.RGBA,bUseWebGL:m}),p=this._readCvsData(f.context,null,null),p=this._transformPixelFormat(p,f.pixelFormat,u),r){if(r.length<p.length)throw new Error("Unexpected size of the 'bufferContainer'.");r.set(p)}}catch(s){if("WebGLError"===s.name)return x._onLog&&x._onLog("DCE: _getImageData() in WebGL failed, try again in context2d."),this.forceLoseContext(),this._bWebGLSupported=!1,this._getImageData(e,t,i,{sx:n,sy:h,sWidth:l,sHeight:d,dWidth:c,dHeight:g},r,a);throw s}return x._onLog&&x._onLog("DCE: _getImageData() end. Costs: "+(Date.now()-o)),{data:p,pixelFormat:u,_bUseWebGL:f._bUseWebGL}}forceLoseContext(){if(!this._reusedWebGLCvs)return;const e=this._reusedWebGLCvs.ctxWebGL;e&&!e.isContextLost()&&e.getExtension("WEBGL_lose_context")&&e.getExtension("WEBGL_lose_context").loseContext(),this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._reusedWebGLCvs=null}_getVideoData(e,t){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getVideoData()' is unavailable in singleFrameMode.");if(!this._video||4!==this._video.readyState)return null;const i=Date.now();x._onLog&&x._onLog("DCE: _getVideoData() START: "+i);let s=this._scanRegion;t&&t.hasOwnProperty("region")&&(s=t.region);let r=this.mapPixelFormatString_Enum.get(this.framePixelFormat.toLowerCase());t&&t.pixelFormat&&(r=this.mapPixelFormatString_Enum.get(t.pixelFormat.toLowerCase()));let a=this._softwareScale;t&&t.scale&&(a=t.scale);const o=this._video.videoWidth,n=this._video.videoHeight;let h=this._scaleCenter;if(t&&t.scaleCenter){if("string"!=typeof t.scaleCenter.x||"string"!=typeof t.scaleCenter.y)throw new Error("Invalid scale center.");let e=0,i=0;if(t.scaleCenter.x.endsWith("px"))e=parseFloat(t.scaleCenter.x);else{if(!t.scaleCenter.x.endsWith("%"))throw new Error("Invalid scale center.");e=parseFloat(t.scaleCenter.x)/100*o}if(t.scaleCenter.y.endsWith("px"))i=parseFloat(t.scaleCenter.y);else{if(!t.scaleCenter.y.endsWith("%"))throw new Error("Invalid scale center.");i=parseFloat(t.scaleCenter.y)/100*n}if(NaN==e||NaN==i)throw new Error("Invalid scale center.");h.x=Math.round(e),h.y=Math.round(i)}if(0===o||0===n)return null;const l=this.getFrameSize(o,n,s,this.maxCvsSideLength);if(!l)return null;let d=!0;o===l.sWidth&&n===l.sHeight&&(d=!1);const c={data:null,region:s?JSON.parse(JSON.stringify(s)):null,sx:l.sx,sy:l.sy,width:l.dWidth,height:l.dHeight,colorMode:null,pixelFormat:null,timeSpent:null,timeStamp:null,isCropped:d,toCanvas:this._toCanvas,_sWidth:l.sWidth,_sHeight:l.sHeight,_bUseWebGL:null};1!==a&&(l.sWidth=Math.round(l.sWidth/a),l.sHeight=Math.round(l.sHeight/a),l.sx=Math.round((1-1/a)*h.x+l.sx/a),l.sy=Math.round((1-1/a)*h.y+l.sy/a));const g=this._getImageData(this._video,o,n,l,e,{pixelFormat:r});if(!g)return null;const u=Date.now();if(x._onLog&&x._onLog("DCE: _getVideoData() END: "+u),c.data=g.data,c.pixelFormat=c.colorMode=g.pixelFormat,c._bUseWebGL=g._bUseWebGL,c.timeSpent=u-i,c.timeStamp=u,g.pixelFormat===L.GREY)c.stride=c.width;else c.stride=4*c.width;return c}getCurrentRegion(){let e=null;if(this._scanRegion)e=this._scanRegion;else if(this.croppingRegions){if(this._croppingRegionIndex>=this.croppingRegions.length||this._croppingRegionIndex<0)throw new Error("The 'croppingRegionIndex' is out of bounds.");e=this.croppingRegions[this._croppingRegionIndex],this.bIncreaseRegionIndexAuto&&++this._croppingRegionIndex>=this.croppingRegions.length&&(this._croppingRegionIndex=0)}return e}_fetchingLoop(e){if(this.isDisposed&&this.disposed)return;if(!this._bOpen||!this.isFetchingLoopStarted())return void this.stopFetchingLoop();const t=()=>{x._onLog&&x._onLog("DCE: start fetching a frame into buffer: "+Date.now());const e=this.getCurrentRegion();let t=this._getVideoData(null,{region:e});if(!t)return void(x._onLog&&x._onLog("DCE: get a invalid frame, abandon it: "+Date.now()));for(;this._frameQueue&&this._frameQueue.length>=this.maxNumberOfFramesInBuffer;)this._frameQueue.shift();this._frameQueue.push(t),x._onLog&&x._onLog("DCE: finish fetching a frame into buffer: "+Date.now());const i=this.mapCameraEvents.get("frameaddedtobuffer");for(let e of i)e&&setTimeout((()=>{this.isDisposed&&this.disposed||e.apply(this)}),0)},i=()=>{this.isDisposed&&this.disposed||(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this.refreshInterval<=0||(this._frameLoopTimeoutId2=setTimeout((()=>{this.isDisposed&&this.disposed||(this._bOpen&&this.isFetchingLoopStarted()?(x._onLog&&x._onLog("DCE: second timeout executes: "+Date.now()),t(),i()):this.stopFetchingLoop())}),this.refreshInterval)))};e&&(this._frameQueue.length<this.maxNumberOfFramesInBuffer?(t(),this.refreshInterval>0&&i()):this.refreshInterval>0?(t(),i()):0===this.refreshInterval?t():this.refreshInterval),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameLoopTimeoutId=setTimeout((()=>{this.isDisposed&&this.disposed||this._fetchingLoop(!0)}),this.loopInterval)}startFetchingLoop(){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw Error("'startFetchingLoop()' is unavailable in singleFrameMode.");this.isFetchingLoopStarted()||(this._bFetchingLoopStarted=!0,this._recordedStates.fetchingLoopStart=!0,x._onLog&&x._onLog("DCE: start fetching loop: "+Date.now()),this._fetchingLoop(!0))}isFetchingLoopStarted(){return this._bFetchingLoopStarted}stopFetchingLoop(){this._bFetchingLoopStarted&&(x._onLog&&x._onLog("DCE: stop fetching loop: "+Date.now()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameQueue.length=0,this._bFetchingLoopStarted=!1,this._recordedStates.fetchingLoopStart=!1)}getFrameFromBuffer(e){return this._frameQueue&&this._frameQueue.length?e?e<this._frameQueue.length?(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.splice(e,1)[0]):void 0:(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.pop()):null}clearFrameBuffer(){this._frameQueue&&(this._frameQueue.length=0)}_createDrawingLayerBaseCvs(){this._assertOpen();const e=this._calculateCvsSize();if(!e)throw new Error("Camera is not open.");const{width:t,height:i,objectFit:s}=e;if(t<=0||i<=0)throw new Error("Invalid dimension of video or image.");const r=document.createElement("canvas");if(r.width==t&&r.height==i||(r.width=t,r.height=i),r.style.objectFit=s,this._cvsScanRegion)this._cvsScanRegion.after(r);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(r);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(r);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(r)}return r}_updateDrawingLayersSize(e){let t;if(t=e&&e.width&&e.height&&e.objectFit?{width:e.width,height:e.height,objectFit:e.objectFit}:this._calculateCvsSize(),!t)return;const{width:i,height:s,objectFit:r}=t;this._drawingLayersManager.setDimensions({width:i,height:s},{backstoreOnly:!0}),this._drawingLayersManager.setObjectFit(r)}_createDrawingLayer(e){this._layerBaseCvs||(this._layerBaseCvs=this._createDrawingLayerBaseCvs());const t=this._layerBaseCvs;return this._drawingLayersManager.createDrawingLayer(t,e)}deleteDrawingLayer(e){this._drawingLayersManager.deleteDrawingLayer(e),this._drawingLayersManager.getDrawingLayers().length||this._layerBaseCvs&&(this._layerBaseCvs.remove(),this._layerBaseCvs=null)}createDrawingLayer(){return this._createDrawingLayer()}getDrawingLayer(e){const t=this._drawingLayersManager.getDrawingLayer(e);return t||([1,2,3].includes(e)?this._createDrawingLayer(e):null)}getDrawingLayers(){return this._drawingLayersManager.getDrawingLayers().filter((e=>e.getId()>=0))}getSelectedDrawingItems(){return this._drawingLayersManager.getSelectedDrawingItems()}createDrawingStyle(e){return this._drawingLayersManager.createDrawingStyle(e)}getDrawingStyle(e){return this._drawingLayersManager.getDrawingStyle(e)}getDrawingStyles(){return this._drawingLayersManager.getDrawingStyles()}updateDrawingStyle(e,t){return this._drawingLayersManager.updateDrawingStyle(e,t)}clearDrawingLayers(){const e=this.getDrawingLayers();for(let t of e)this.deleteDrawingLayer(t.getId())}showTip(e,t,i,s,r=3e3,a=!0){this._assertOpen(),this._tipArgs.x=e,this._tipArgs.y=t,this._tipArgs.width=i,this._tipArgs.autoShowSuggestedTip=!!a,this._drawingLayerOfTip||(this._drawingLayerOfTip=this._createDrawingLayer(-1)),this._tipStyleId||(this._tipStyleId=this.createDrawingStyle({fillStyle:"#FFFFFF",paintMode:"fill",fontFamily:"Open Sans",fontSize:40})),this._drawingLayerOfTip.clearDrawingItems();const o=new v(s||"",e,t,i,this._tipStyleId);o._fabricObject.paddingTop=15,o._fabricObject.calcTextHeight=function(){for(var e=0,t=0,i=this._textLines.length;t<i;t++)e+=this.getHeightOfLine(t);return e+=2*this.paddingTop},o._fabricObject._getTopOffset=function(){return-this.height/2+this.getHeightOfLine(0)*(1-1/this.lineHeight)/2+this.paddingTop},o.setAttribute("backgroundColor","rgba(50, 50, 52, .8)"),o.setAttribute("lineHeight",1.3),o.setAttribute("textAlign","center"),this._drawingLayerOfTip.addDrawingItem(o),this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId),this._tipArgs.duration=void 0===r?3e3:r,this._tipArgs.duration>0&&(this._hideTipTimeoutId=setTimeout((()=>{this.isDisposed&&this.disposed||this._hideTip()}),this._tipArgs.duration))}_hideTip(){this._drawingLayerOfTip&&(this.deleteDrawingLayer(this._drawingLayerOfTip.getId()),this._drawingLayerOfTip=null,this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId))}hideTip(){this._hideTip(),this._tipArgs.x=null,this._tipArgs.y=null,this._tipArgs.width=null,this._tipArgs.autoShowSuggestedTip=null}updateTipMessage(e){if(!this._drawingLayerOfTip)throw new Error("The Tip is not showing.");this._drawingLayerOfTip.getDrawingItems()[0].setAttribute("text",e),this._drawingLayerOfTip.renderAll(),this._tipArgs.duration>0&&(this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId),this._hideTipTimeoutId=setTimeout((()=>{this.isDisposed&&this.disposed||this._hideTip()}),this._tipArgs.duration))}suggestTip(e,t){this._tipArgs.autoShowSuggestedTip&&(this._drawingLayerOfTip?this.updateTipMessage(t):void 0!==this._tipArgs.x&&this.showTip(this._tipArgs.x,this._tipArgs.y,this._tipArgs.width,t,this._tipArgs.duration)),this.onTipSuggested&&setTimeout((()=>{this.isDisposed&&this.disposed||this.onTipSuggested.apply(this,[e,t])}),0)}_createControler(){if(this._controler||(this._controler=new b(this)),this._controler)return this._controler}_destroyControler(){this._controler=null}setOriginalImage(e,t,i){if(!e||!t||!i)throw new Error("Invalid arguments");this._originalImageData={imageData:e,width:t,height:i};let s=this._cvsOriginalImage;s||(s=document.createElement("canvas"),s.style.position="absolute",s.style.width="100%",s.style.height="100%",s.style.left="0",s.style.top="0",s.style.backgroundColor="white",s.style.objectFit="contain",this._cvsOriginalImage=s),s.width===t&&s.height===i||(s.width=t,s.height=i);const r=s.getContext("2d");r.clearRect(0,0,s.width,s.height),e instanceof Uint8Array||e instanceof Uint8ClampedArray?(e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),r.putImageData(new ImageData(e,t,i),0,0)):e instanceof HTMLCanvasElement&&r.drawImage(e,0,0),document.body.contains(s)&&""===s.style.display&&this._updateDrawingLayersSize({width:t,height:i,objectFit:"contain"})}getOriginalImage(){return this._originalImageData?Object.assign({},this._originalImageData):null}async deleteOriginalImage(){await this.hideOriginalImage(),this._cvsOriginalImage&&(this._cvsOriginalImage.remove(),this._cvsOriginalImage=null),this._originalImageData=null}_showOriginalImageCvs(){this._cvsOriginalImage&&"none"==this._cvsOriginalImage.style.display&&(this._cvsOriginalImage.style.display="")}_hideOriginalImageCvs(){this._cvsOriginalImage&&(this._cvsOriginalImage.style.display="none")}showOriginalImage(){if(!this._originalImageData)throw new Error("No original image is set.");const e=this._cvsOriginalImage;if(""===e.style.display&&document.body.contains(e))return;const{width:t,height:i}=this._originalImageData;if(this._updateDrawingLayersSize({width:t,height:i,objectFit:"contain"}),this._bOpen&&(this._video&&!this._video.paused&&this._video.pause(),this._bFetchingLoopStarted&&(this.stopFetchingLoop(),this._recordedStates.fetchingLoopStart=!0),this.ifShowScanRegionMask&&this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this.ifShowScanRegionLaser&&this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none"),this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none"),this._selCam&&(this._selCam.parentElement.style.display="none")),!document.body.contains(e))if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(e);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(e)}this._showOriginalImageCvs()}async _hideOriginalImage(e){this._originalImageData&&this._cvsOriginalImage&&"none"!==this._cvsOriginalImage.style.display&&(this._updateDrawingLayersSize(),this._bOpen&&e&&(this._video&&this._recordedStates.videoPlaying&&await this.play(null,null,null,{notTriggerSingleFrameClick:!0}),this._recordedStates.fetchingLoopStart&&!this.singleFrameMode&&this.startFetchingLoop(),this.ifShowScanRegionMask&&this._cvsScanRegion&&this._recordedStates.maskShow&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this._divScanLight&&this._recordedStates.laserShow&&this.showScanRegionLaser(),this._cvsViewDecorator&&this._recordedStates.decoratorShow&&this.showViewDecorator(),this._scanRegionOverlayContainer&&this._recordedStates.overlayShow&&this.showScanRegionOverlays()),this._selCam&&(this._selCam.parentElement.style.display=""),this._hideOriginalImageCvs())}async hideOriginalImage(){return this._hideOriginalImage(!0)}dispose(e){this.UIElement&&(this._uiOriginalState&&this._uiOriginalState.inDom?this.UIElement.style.display=this._uiOriginalState.display:this.UIElement.style.display="none"),this.clearDrawingLayers(),this.close(),this.forceLoseContext(),this.setViewDecorator(null,null),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.remove(),this._arrScanRegionOverlays.length=0,e&&this.UIElement&&this.UIElement.remove(),this.__proto__=null;for(let e in this)delete this[e];Object.defineProperty(this,"isCameraEnhancer",{value:!0}),Object.defineProperty(this,"isDisposed",{value:!0}),Object.defineProperty(this,"disposed",{value:!0})}}x._jsVersion="3.3.1",x._jsEditVersion="20230217",x._version="JS "+x._jsVersion+"."+x._jsEditVersion,x.browserInfo=o,x._hasEngineResourceLoaded=!1,x._engineResourcePath=c,x._defaultUIElementURL="@engineResourcePath/dce.ui.html";const E={DT_Arc:class extends g{constructor(t,i,s,r,a,o){super(new e.Circle({left:t,top:i,radius:s,startAngle:r,endAngle:a}),o),this._mediaType="arc"}},DT_Polygon:m,DT_Rect:class extends g{constructor(t,i,s,r,a){super(new e.Rect({left:t,top:i,width:s,height:r}),a)}},DT_Image:class extends g{constructor(t,i,s,r){super(new e.Image(t,{left:i,top:s}),r),this.image=t}_extendSet(e,t){if("image"===e){if(t instanceof HTMLImageElement)return this._fabricObject.setElement(t),this.image=t,!0;if(t instanceof HTMLCanvasElement){const e=new Image;return e.src=t.toDataURL(),this._fabricObject.setElement(e),this.image=t,!0}throw new Error("Unsupported value.")}}_extendGet(e){if("image"===e)return this.image}},DT_Text:v,DT_Line:class extends m{constructor(e,t,i){super([e,t],i),this._mediaType="line"}_extendSet(t,i){if("startPoint"===t||"endPoint"===t){i="startPoint"===t?[i,this.get("endPoint")]:[this.get("startPoint"),i];const s=this._fabricObject;if(s.group){const e=s.group;s.points=i.map((t=>({x:t.x-e.left-e.width/2,y:t.y-e.top-e.height/2}))),e.addWithUpdate()}else s.points=i;const r=s.points.length-1;return s.controls=s.points.reduce((function(t,i,s){return t["p"+s]=new e.Control({positionHandler:u,actionHandler:p(s>0?s-1:r,f),actionName:"modifyPolygon",pointIndex:s}),t}),{}),s._setPositionDimensions({}),!0}}_extendGet(t){if("startPoint"===t||"endPoint"===t){const i=[],s=this._fabricObject;if(s.selectable&&!s.group)for(let e in s.oCoords)i.push({x:s.oCoords[e].x,y:s.oCoords[e].y});else for(let t of s.points){let r=t.x-s.pathOffset.x,a=t.y-s.pathOffset.y;const o=e.util.transformPoint({x:r,y:a},s.calcTransformMatrix());i.push({x:o.x,y:o.y})}return"startPoint"===t?i[0]:i[1]}}},DT_Group:class extends g{constructor(t){super(new e.Group(t.map((e=>e._getFabricObject())))),this._fabricObject.on("selected",(()=>{this.styleSelector="selected";const e=this._fabricObject._objects;for(let t of e)setTimeout((()=>{t&&t.fire("selected")}),0);setTimeout((()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())}),0)})),this._fabricObject.on("deselected",(()=>{this.styleSelector="default";const e=this._fabricObject._objects;for(let t of e)setTimeout((()=>{t&&t.fire("deselected")}),0);setTimeout((()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())}),0)}))}getChildItems(){return this._fabricObject._objects.map((e=>e.getDrawingItem()))}addChildItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");this._drawingLayer?this._drawingLayer._updateGroupItem(this,e,"add"):this._fabricObject.addWithUpdate(e._getFabricObject())}removeChildItem(e){e&&e.isDrawingItem&&(this._drawingLayer?this._drawingLayer._updateGroupItem(this,e,"remove"):this._fabricObject.removeWithUpdate(e._getFabricObject()))}}};export{x as CameraEnhancer,E as DrawingItem};
