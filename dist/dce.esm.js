/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2022, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 3.1.0 (js 20221019)
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */
import{fabric as e}from"dm-fabric";function t(e,t,i,r){return new(i||(i=Promise))((function(s,n){function o(e){try{l(r.next(e))}catch(e){n(e)}}function a(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((r=r.apply(e,t||[])).next())}))}const i="undefined"==typeof self;let r,s,n,o,a;if("undefined"!=typeof navigator&&(r=navigator,s=r.userAgent,n=r.platform,o=r.mediaDevices),!i){const e={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:r.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},t={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:n,search:"Win"},Mac:{str:n},Linux:{str:n}};let i="unknownBrowser",o=0,l="unknownOS";for(let t in e){const r=e[t]||{};let n=r.str||s,a=r.search||t,l=r.verStr||s,h=r.verSearch||t;if(h instanceof Array||(h=[h]),-1!=n.indexOf(a)){i=t;for(let e of h){let t=l.indexOf(e);if(-1!=t){o=parseFloat(l.substring(t+e.length+1));break}}break}}for(let e in t){const i=t[e]||{};let r=i.str||s,n=i.search||e;if(-1!=r.indexOf(n)){l=e;break}}"Linux"==l&&-1!=s.indexOf("Windows NT")&&(l="HarmonyOS"),a={browser:i,version:o,OS:l}}i&&(a={browser:"ssr",version:0,OS:"ssr"});const l="undefined"!=typeof WebAssembly&&s&&!(/Safari/.test(s)&&!/Chrome/.test(s)&&/\(.+\s11_2_([2-6]).*\)/.test(s)),h=!("undefined"==typeof Worker),d=!(!o||!o.getUserMedia),c=async()=>{let e=!1;if(d)try{(await o.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()})),e=!0}catch(e){}return e};"Chrome"===a.browser&&a.version>66||"Safari"===a.browser&&a.version>13||"OPR"===a.browser&&a.version>43||"Edge"===a.browser&&a.version;const g=(()=>{if(!i&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})();class _{constructor(e,t){this._zIndex=null,this._drawingLayer=null,this._drawingLayerId=null,this._mapStyle=new Map,this.mapEvent_Callbacks=new Map([["selected",new Map],["deselected",new Map],["mousedown",new Map],["mouseup",new Map],["dblclick",new Map],["mouseover",new Map],["mouseout",new Map]]),this.mapNoteName_Content=new Map([]),this.isDrawingItem=!0,this._setFabricObject(e),this._mediaType=e.type,this.styleSelector="default",this.styleId=t}get mediaType(){return this._mediaType}get drawingLayerId(){return this._drawingLayerId}_setFabricObject(e){this._fabricObject=e,this._fabricObject.on("selected",(()=>{this.styleSelector="selected"})),this._fabricObject.on("deselected",(()=>{this._fabricObject.canvas&&this._fabricObject.canvas.getActiveObjects().includes(this._fabricObject)?this.styleSelector="selected":this.styleSelector="default","i-text"===this._fabricObject.type&&(this._fabricObject.isEditing&&this._fabricObject.exitEditing(),this._fabricObject.selected=!1)})),e.getDrawingItem=()=>this}_getFabricObject(){return this._fabricObject}on(e,t){if(!t)return;const i=this.mapEvent_Callbacks.get(e);if(!i)throw new Error(`Event '${e}' does not exist.`);let r=i.get(t);r||(r=e=>{const i=e.e;if(!i)return void(t&&t.apply(this,[{targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null}]));const r={targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null};if(this._drawingLayer){let e,t,s,n;const o=i.target.getBoundingClientRect();e=o.left,t=o.top,s=e+window.scrollX,n=t+window.scrollY;const a=this._drawingLayer.fabricCanvas.lowerCanvasEl.width,l=this._drawingLayer.fabricCanvas.lowerCanvasEl.height,h=parseFloat(window.getComputedStyle(this._drawingLayer.fabricCanvas.lowerCanvasEl).width),d=parseFloat(window.getComputedStyle(this._drawingLayer.fabricCanvas.lowerCanvasEl).height),c=h/d,g=a/l,_=this._drawingLayer._getObjectFit();let f,u,p,m,v=1;if("contain"===_)c<g?(v=h/a,f=e+this.get("x")*v,u=t+this.get("y")*v+(d-l*v)/2,p=s+this.get("x")*v,m=n+this.get("y")*v+(d-l*v)/2):(v=d/l,f=e+this.get("x")*v+(h-a*v)/2,u=t+this.get("y")*v,p=s+this.get("x")*v+(h-a*v)/2,m=n+this.get("y")*v);else if("cover"===_)if(c<g){v=d/l;let i=this.get("x")*v-(a*v-h)/2;i=Math.max(i,0),i=Math.min(i,h),f=e+i,u=t+this.get("y")*v,p=s+i,m=n+this.get("y")*v}else{v=h/a;let i=this.get("y")*v-(l*v-d)/2;i=Math.max(i,0),i=Math.min(i,d),f=e+this.get("x")*v,u=t+i,p=s+this.get("x")*v,m=n+i}r.itemClientX=Math.round(f),r.itemClientY=Math.round(u),r.itemPageX=Math.round(p),r.itemPageY=Math.round(m)}for(let e of Object.getOwnPropertyNames(r))Object.defineProperty(i,e,{value:r[e],writable:!0});t&&t.apply(this,[i])},i.set(t,r),this._fabricObject.on("dblclick"===e?"mousedblclick":e,r))}off(e,t){const i=this.mapEvent_Callbacks.get(e);if(!i)throw new Error(`Event '${e}' does not exist.`);let r=i.get(t);r&&(i.delete(t),this._fabricObject.off("dblclick"===e?"mousedblclick":e,r))}_setEditable(e){const t=this._fabricObject;e?(t.selectable=!0,t.hasControls=!0,t.hoverCursor=null):(t.selectable=!1,t.hasControls=!1,t.hoverCursor="default")}hasNote(e){return this.mapNoteName_Content.has(e)}addNote(e,t){if(this.hasNote(e.name)&&!t)throw new Error("A note with the same name already exists, please use a different name.");const i=e.content?JSON.parse(JSON.stringify(e.content)):e.content;this.mapNoteName_Content.set(e.name,[i])}getNote(e){const t=this.mapNoteName_Content.get(e);return t?1===t.length?{name:e,content:t[0]?JSON.parse(JSON.stringify(t[0])):t[0]}:{name:e,content:JSON.parse(JSON.stringify(t))}:null}getNotes(){const e=[];for(let t of this.mapNoteName_Content){let i=1===t[1].length?t[1][0]:t[1];i=i?JSON.parse(JSON.stringify(i)):i,e.push({name:t[0],content:i})}return e}updateNote(e,t,i){const r=this.mapNoteName_Content.get(e);if(!r)throw new Error("The note name does not exist.");i||(r.length=0),t=t?JSON.parse(JSON.stringify(t)):t,r.push(t)}deleteNote(e){this.mapNoteName_Content.delete(e)}clearNotes(){this.mapNoteName_Content.clear()}_extendSet(e,t){return!1}_extendGet(e){}set(e,t){if(!this._extendSet(e,t))if("x"===e){const e=this._fabricObject.group;e?(this._fabricObject.set("left",t-e.left-e.width/2),e.addWithUpdate()):this._fabricObject.set("left",t)}else if("y"===e){const e=this._fabricObject.group;e?(this._fabricObject.set("top",t-e.top-e.height/2),e.addWithUpdate()):this._fabricObject.set("top",t)}else"styleId"===e?this.styleId=t:this._fabricObject.set(e,t);["vertices","startPoint","endPoint","x","y","left","top","width","height","scaleX","scaleY","skewX","skewY","padding","angle","strokeWidth"].includes(e)&&this._fabricObject.setCoords()}get(e){let t=this._extendGet(e);if(void 0===t)if("x"===e){const e=this._fabricObject.group;t=e?this._fabricObject.get("left")+e.left+e.width/2:this._fabricObject.get("left")}else if("y"===e){const e=this._fabricObject.group;t=e?this._fabricObject.get("top")+e.top+e.height/2:this._fabricObject.get("top")}else t=["type","mediaType"].includes(e)?this.mediaType:"styleSelector"===e?this.styleSelector:"styleId"===e?this.styleId:"drawingLayerId"===e?this.drawingLayerId:this._fabricObject.get(e);return t}setAttribute(e,t){this.set(e,t)}getAttribute(e){return this.get(e)}}_.arrMediaTypes=["rect","arc","polygon","image","text","line","path"],_.arrStyleSelectors=["default","selected"];function f(t,i,r){let s=r.points[this.pointIndex].x-r.pathOffset.x,n=r.points[this.pointIndex].y-r.pathOffset.y;return e.util.transformPoint({x:s,y:n},r.calcTransformMatrix())}function u(t){let i=new e.Point(t.strokeUniform?1/t.scaleX:1,t.strokeUniform?1/t.scaleY:1).multiply(t.strokeWidth);return new e.Point(t.width+i.x,t.height+i.y)}function p(t,i,r,s){let n=i.target,o=n.controls[n.__corner],a=n.toLocalPoint(new e.Point(r,s),"center","center"),l=u(n),h=n._getTransformedDimensions(0,0),d={x:a.x*l.x/h.x+n.pathOffset.x,y:a.y*l.y/h.y+n.pathOffset.y};return n.points[o.pointIndex]=d,!0}function m(t,i){return function(r,s,n,o){let a=s.target,l=e.util.transformPoint({x:a.points[t].x-a.pathOffset.x,y:a.points[t].y-a.pathOffset.y},a.calcTransformMatrix()),h=i(r,s,n,o);a._setPositionDimensions({});let d=u(a),c=(a.points[t].x-a.pathOffset.x)/d.x,g=(a.points[t].y-a.pathOffset.y)/d.y;return a.setPositionByOrigin(l,c+.5,g+.5),h}}class v extends _{constructor(t,i){super(new e.Polygon(t,{objectCaching:!1}),i);const r=this._fabricObject;let s=r.points.length-1;r.controls=r.points.reduce((function(t,i,r){return t["p"+r]=new e.Control({positionHandler:f,actionHandler:m(r>0?r-1:s,p),actionName:"modifyPolygon",pointIndex:r}),t}),{})}_extendSet(t,i){if("vertices"===t){const t=this._fabricObject;if(t.group){const e=t.group;t.points=i.map((t=>({x:t.x-e.left-e.width/2,y:t.y-e.top-e.height/2}))),e.addWithUpdate()}else t.points=i;const r=t.points.length-1;return t.controls=t.points.reduce((function(t,i,s){return t["p"+s]=new e.Control({positionHandler:f,actionHandler:m(s>0?s-1:r,p),actionName:"modifyPolygon",pointIndex:s}),t}),{}),t._setPositionDimensions({}),!0}}_extendGet(t){if("vertices"===t){const t=[],i=this._fabricObject;if(i.selectable&&!i.group)for(let e in i.oCoords)t.push({x:i.oCoords[e].x,y:i.oCoords[e].y});else for(let r of i.points){let s=r.x-i.pathOffset.x,n=r.y-i.pathOffset.y;const o=e.util.transformPoint({x:s,y:n},i.calcTransformMatrix());t.push({x:o.x,y:o.y})}return t}}}const y=e=>{let t=(e=>e.split("\n").map((e=>e.split("\t"))))(e);return(e=>{for(let t=0;;t++){let i=-1;for(let r=0;r<e.length;r++){let s=e[r][t];void 0!==s&&(s.length>i&&(i=s.length))}if(-1===i)break;for(let r=0;r<e.length;r++){if(t>=e[r].length-1)continue;let s=" ".repeat(i+2-e[r][t].length);e[r][t]=e[r][t].concat(s)}}})(t),(e=>{let t="";for(let i=0;i<e.length;i++)t=t.concat(...e[i],i===e.length-1?"":"\n");return t})(t)};"undefined"!=typeof document&&"undefined"!=typeof window&&(e.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(e.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject((function(e){e.dispose&&e.dispose()})),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),e.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},e.Object.prototype.transparentCorners=!1,e.Object.prototype.cornerSize=20,e.Object.prototype.touchCornerSize=100,e.Object.prototype.cornerColor="rgb(254,142,20)",e.Object.prototype.cornerStyle="circle",e.Object.prototype.strokeUniform=!0,e.Object.prototype.hasBorders=!1,e.Canvas.prototype.containerClass="",e.Canvas.prototype.getPointer=function(t,i){if(this._absolutePointer&&!i)return this._absolutePointer;if(this._pointer&&i)return this._pointer;var r,s=this.upperCanvasEl,n=e.util.getPointer(t,s),o=s.getBoundingClientRect(),a=o.width||0,l=o.height||0;a&&l||("top"in o&&"bottom"in o&&(l=Math.abs(o.top-o.bottom)),"right"in o&&"left"in o&&(a=Math.abs(o.right-o.left))),this.calcOffset(),n.x=n.x-this._offset.left,n.y=n.y-this._offset.top,i||(n=this.restorePointerVpt(n));var h=this.getRetinaScaling();if(1!==h&&(n.x/=h,n.y/=h),0!==a&&0!==l){var d=window.getComputedStyle(s).objectFit,c=s.width,g=s.height,_=a,f=l;r={width:c/_,height:g/f};var u,p,m=c/g,v=_/f;return"contain"===d?m>v?(u=_,p=_/m,{x:n.x*r.width,y:(n.y-(f-p)/2)*r.width}):(u=f*m,p=f,{x:(n.x-(_-u)/2)*r.height,y:n.y*r.height}):"cover"===d?m>v?{x:(c-r.height*_)/2+n.x*r.height,y:n.y*r.height}:{x:n.x*r.width,y:(g-r.width*f)/2+n.y*r.width}:{x:n.x*r.width,y:n.y*r.height}}return r={width:1,height:1},{x:n.x*r.width,y:n.y*r.height}},e.Canvas.prototype._onTouchStart=function(t){var i=this.findTarget(t);!this.allowTouchScrolling&&t.preventDefault&&t.preventDefault(),i&&t.preventDefault&&t.preventDefault(),null===this.mainTouchId&&(this.mainTouchId=this.getPointerId(t)),this.__onMouseDown(t),this._resetTransformEventData();var r=this.upperCanvasEl,s=this._getEventPrefix();e.util.addListener(e.document,"touchend",this._onTouchEnd,{passive:!1}),e.util.addListener(e.document,"touchmove",this._onMouseMove,{passive:!1}),e.util.removeListener(r,s+"down",this._onMouseDown)});class w{constructor(t,i,r,s){let n,o;switch(this.mapMediaType_Style=new Map,this.mode="viewer",this.onSelectionChange=null,this._arrDrwaingItem=[],this._arrFabricObject=[],this._visible=!0,t.hasOwnProperty("getFabricCanvas")?this.fabricCanvas=t.getFabricCanvas():(this.fabricCanvas=new e.Canvas(t,Object.assign(s,{allowTouchScrolling:!0})),this.fabricCanvas.setDimensions({width:"100%",height:"100%"},{cssOnly:!0}),this.fabricCanvas.lowerCanvasEl.className="",this.fabricCanvas.upperCanvasEl.className="",this.fabricCanvas.on("selection:created",(function(e){const t=e.selected,i=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!i.includes(t)&&i.push(t)}for(let e of i){const i=[];for(let r of t){const t=r.getDrawingItem();t._drawingLayer===e&&i.push(t)}setTimeout((()=>{e.onSelectionChange&&e.onSelectionChange(i,[])}),0)}})),this.fabricCanvas.on("before:selection:cleared",(function(e){const t=this.getActiveObjects(),i=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!i.includes(t)&&i.push(t)}for(let e of i){const i=[];for(let r of t){const t=r.getDrawingItem();t._drawingLayer===e&&i.push(t)}setTimeout((()=>{const t=[];for(let r of i)e.hasDrawingItem(r)&&t.push(r);t.length>0&&e.onSelectionChange&&e.onSelectionChange([],t)}),0)}})),this.fabricCanvas.on("selection:updated",(function(e){const t=e.selected,i=e.deselected,r=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!r.includes(t)&&r.push(t)}for(let e of i){const t=e.getDrawingItem()._drawingLayer;t&&!r.includes(t)&&r.push(t)}for(let e of r){const r=[],s=[];for(let i of t){const t=i.getDrawingItem();t._drawingLayer===e&&r.push(t)}for(let t of i){const i=t.getDrawingItem();i._drawingLayer===e&&s.push(i)}setTimeout((()=>{e.onSelectionChange&&e.onSelectionChange(r,s)}),0)}})),this.fabricCanvas.wrapperEl.style.position="absolute",t.getFabricCanvas=()=>this.fabricCanvas),this.id=i,this._mapDrawingStyles=r,i){case 1:n=r.get(1),o=r.get(5);break;case 2:n=r.get(2),o=r.get(6);break;case 3:n=r.get(3),o=r.get(7);break;default:n=r.get(4),o=r.get(8)}for(let e of _.arrMediaTypes)this.mapMediaType_Style.set(e,{default:n,selected:o})}getId(){return this.id}_getDrawingStyle(e,t){if("number"!=typeof e)throw new Error("Invalid style id.");const i=this._mapDrawingStyles.get(e);return i?t?JSON.parse(JSON.stringify(i)):i:null}setVisible(e){if(e){for(let e of this._arrFabricObject)e.visible=!0;this._visible=!0}else{for(let e of this._arrFabricObject)e.visible=!1;this._visible=!1}this.fabricCanvas.renderAll()}isVisible(){return this._visible}_getItemCurrentStyleId(e){return e.styleId?e.styleId:this.mapMediaType_Style.get(e._mediaType)[e.styleSelector].styleId}_getItemCurrentStyle(e){if(e.styleId)return this._getDrawingStyle(e.styleId);const t=e._mapStyle.get(e.styleSelector);return t||null}_changeMediaTypeCurStyleInStyleSelector(e,t,i,r){let s;switch(e){case"rect":s=this.fabricCanvas.getObjects("rect");break;case"arc":s=this.fabricCanvas.getObjects("circle");break;case"polygon":s=this.fabricCanvas.getObjects("polygon");break;case"image":s=this.fabricCanvas.getObjects("image");break;case"text":s=this.fabricCanvas.getObjects("text");break;case"line":s=this.fabricCanvas.getObjects("line");break;case"path":s=this.fabricCanvas.getObjects("path")}for(let e of s){if(!this._arrFabricObject.includes(e))continue;const r=e.getDrawingItem();r.styleSelector===t&&this._changeItemStyle(r,i,!0)}r||this.fabricCanvas.renderAll()}_changeItemStyle(e,t,i){if(!e||!t)return;const r=e._getFabricObject();"number"==typeof e.styleId&&(t=this._getDrawingStyle(e.styleId)),r.strokeWidth=t.lineWidth,"fill"===t.paintMode?(r.fill=t.fillStyle,r.stroke=t.fillStyle):"stroke"===t.paintMode?(r.fill="transparent",r.stroke=t.strokeStyle):"strokeAndFill"===t.paintMode&&(r.fill=t.fillStyle,r.stroke=t.strokeStyle),r.fontFamily&&(r.fontFamily=t.fontFamily),r.fontSize&&(r.fontSize=t.fontSize),r.group||(r.dirty=!0),i||this.fabricCanvas.renderAll()}_updateGroupItem(e,t,i){if(!e||!t)return;const r=e.getChildItems();if("add"===i){if(r.includes(t))return;const i=t._getFabricObject();if(this.fabricCanvas.getObjects().includes(i)){if(!this._arrFabricObject.includes(i))throw new Error("Existed in other drawing layers.");t._zIndex=null}else{let i;if(t.styleId)i=this._getDrawingStyle(t.styleId);else{i=this.mapMediaType_Style.get(t._mediaType)[e.styleSelector];const r=()=>{this._changeItemStyle(t,this.mapMediaType_Style.get(t._mediaType).selected,!0)},s=()=>{this._changeItemStyle(t,this.mapMediaType_Style.get(t._mediaType).default,!0)};t.on("selected",r),t.on("deselected",s),t._funcChangeStyleToSelected=r,t._funcChangeStyleToDefault=s}t._drawingLayer=this,t._drawingLayerId=this.id,this._changeItemStyle(t,i,!0)}e._fabricObject.addWithUpdate(t._getFabricObject())}else{if("remove"!==i)return;if(!r.includes(t))return;t._zIndex=null,t._drawingLayer=null,t._drawingLayerId=null,t.off("selected",t._funcChangeStyleToSelected),t.off("deselected",t._funcChangeStyleToDefault),t._funcChangeStyleToSelected=null,t._funcChangeStyleToDefault=null,e._fabricObject.removeWithUpdate(t._getFabricObject())}this.fabricCanvas.renderAll()}_addDrawingItem(e,t){let i=e._getFabricObject();const r=this.fabricCanvas.getObjects();let s,n;if(r.includes(i)){if(this._arrFabricObject.includes(i))return;throw new Error("Existed in other drawing layers.")}if("group"===e._mediaType){s=e.getChildItems();for(let e of s)if(e._drawingLayer&&e._drawingLayer!==this)throw new Error("The childItems of DT_Group have existed in other drawing layers.")}if(t&&"object"==typeof t&&!Array.isArray(t))for(let e in t)i.set(e,t[e]);if(s){for(let e of s){const t=this.mapMediaType_Style.get(e._mediaType);for(let i of _.arrStyleSelectors)e._mapStyle.set(i,t[i]);if(e.styleId)n=this._getDrawingStyle(e.styleId);else{n=t.default;const i=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).selected,!0)},r=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).default,!0)};e.on("selected",i),e.on("deselected",r),e._funcChangeStyleToSelected=i,e._funcChangeStyleToDefault=r}e._drawingLayer=this,e._drawingLayerId=this.id,this._changeItemStyle(e,n,!0)}i.dirty=!0,this.fabricCanvas.renderAll()}else{const t=this.mapMediaType_Style.get(e._mediaType);for(let i of _.arrStyleSelectors)e._mapStyle.set(i,t[i]);if(e.styleId)n=this._getDrawingStyle(e.styleId);else{n=t.default;const i=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).selected)},r=()=>{this._changeItemStyle(e,this.mapMediaType_Style.get(e._mediaType).default)};e.on("selected",i),e.on("deselected",r),e._funcChangeStyleToSelected=i,e._funcChangeStyleToDefault=r}this._changeItemStyle(e,n)}e._zIndex=this.id,e._drawingLayer=this,e._drawingLayerId=this.id;const o=this._arrFabricObject.length;let a=r.length;if(o)a=r.indexOf(this._arrFabricObject[o-1])+1;else for(let t=0;t<r.length;t++)if(e._zIndex<r[t].getDrawingItem()._zIndex){a=t;break}this._arrDrwaingItem.push(e),this._arrFabricObject.push(i),this._visible?i.visible=!0:i.visible=!1,this.fabricCanvas.insertAt(i,a,!1)}addDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");if("viewer"===this.mode)e._setEditable(!1);else{if("editor"!==this.mode)throw new Error("Illegal 'mode'.");e._setEditable(!0)}this._addDrawingItem(e)}addDrawingItems(e){for(let t of e)this.addDrawingItem(t)}removeDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");if(!this.hasDrawingItem(e))return;if(e._zIndex=null,e._drawingLayer=null,e._drawingLayerId=null,"group"===e._mediaType){const t=e.getChildItems();for(let e of t)e._zIndex=null,e._drawingLayer=null,e._drawingLayerId=null,e.off("selected",e._funcChangeStyleToSelected),e.off("deselected",e._funcChangeStyleToDefault),e._funcChangeStyleToSelected=null,e._funcChangeStyleToDefault=null,e._mapStyle.clear()}else e.off("selected",e._funcChangeStyleToSelected),e.off("deselected",e._funcChangeStyleToDefault),e._funcChangeStyleToSelected=null,e._funcChangeStyleToDefault=null,e._mapStyle.clear();const t=e._getFabricObject();"selected"===e.styleSelector&&(t.group?t.group.removeWithUpdate(t):this.fabricCanvas._activeObject=null,e.styleSelector="default"),this.fabricCanvas.remove(t),this._arrDrwaingItem.splice(this._arrDrwaingItem.indexOf(e),1),this._arrFabricObject.splice(this._arrFabricObject.indexOf(t),1)}removeDrawingItems(e){for(let t of e)this.removeDrawingItem(t)}setDrawingItems(e){this.clearDrawingItems(),this.addDrawingItems(e)}getDrawingItems(e){return e&&"function"==typeof e?this._arrDrwaingItem.filter(e):Array.from(this._arrDrwaingItem)}getSelectedDrawingItems(){const e=this.fabricCanvas.getActiveObjects(),t=[];for(let i of e)this._arrFabricObject.includes(i)&&t.push(i.getDrawingItem());return t}hasDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");return this._arrDrwaingItem.includes(e)}clearDrawingItems(){this.removeDrawingItems(Array.from(this._arrDrwaingItem))}setDrawingStyle(e,t,i){t=t?t.toLocaleLowerCase():"all",i=i?i.toLocaleLowerCase():"all";let r,s=this._getDrawingStyle(e);if("all"===t){const e=this.mapMediaType_Style.keys();for(let t of e)if(r=this.mapMediaType_Style.get(t),"all"===i)for(let e of _.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(t,e,s,!0),r[e]=s;for(let t of this._arrDrwaingItem)t._mapStyle.set(e,s)}else{this._changeMediaTypeCurStyleInStyleSelector(t,i,s,!0),r[i]=s;for(let e of this._arrDrwaingItem)e._mapStyle.set(i,s)}this.fabricCanvas.renderAll()}else if(r=this.mapMediaType_Style.get(t),"all"===i)for(let e of _.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(t,e,s,!0),r[e]=s;for(let i of this._arrDrwaingItem)i._mediaType===t&&i._mapStyle.set(e,s)}else{this._changeMediaTypeCurStyleInStyleSelector(t,i,s,!0),r[i]=s;for(let e of this._arrDrwaingItem)e._mediaType===t&&e._mapStyle.set(i,s)}}setMode(e){if("viewer"===(e=e.toLocaleLowerCase())){for(let e of this._arrDrwaingItem)e._setEditable(!1);this.fabricCanvas.discardActiveObject(),this.fabricCanvas.renderAll(),this.mode="viewer"}else{if("editor"!==e)throw new RangeError("Invalid value.");for(let e of this._arrDrwaingItem)e._setEditable(!0);this.mode="editor"}this._manager._switchPointerEvent()}getMode(){return this.mode}_setDimensions(e,t){this.fabricCanvas.setDimensions(e,t)}_setObjectFit(e){if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`Unsupported value '${e}'.`);this.fabricCanvas.lowerCanvasEl.style.objectFit=e,this.fabricCanvas.upperCanvasEl.style.objectFit=e}_getObjectFit(){return this.fabricCanvas.lowerCanvasEl.style.objectFit}renderAll(){for(let e of this._arrDrwaingItem){const t=this._getItemCurrentStyle(e);this._changeItemStyle(e,t,!0)}this.fabricCanvas.renderAll()}dispose(){this.clearDrawingItems(),1===this._manager._arrDrawingLayer.length&&(this.fabricCanvas.wrapperEl.style.pointerEvents="none",this.fabricCanvas.dispose(),this._arrDrwaingItem.length=0,this._arrFabricObject.length=0)}}class b{constructor(){this._arrDrawingLayer=[],this._mapDrawingStyles=new Map([[1,{id:1,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[2,{id:2,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[3,{id:3,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[4,{id:4,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[5,{id:5,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[6,{id:6,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[7,{id:7,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[8,{id:8,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}]]),this._defaultStyleTemplate={lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}}createDrawingStyle(e){if(!e)throw new Error("Invalid style definition.");let t;if(e.hasOwnProperty("id")){if(this._mapDrawingStyles.has(e.id))throw new Error("Existing drawing style id.");t=e.id}else{let e=100;for(;this._mapDrawingStyles.has(e);)e++;t=e}const i=JSON.parse(JSON.stringify(e));i.id=t;for(let e in this._defaultStyleTemplate)i.hasOwnProperty(e)||(i[e]=this._defaultStyleTemplate[e]);return this._mapDrawingStyles.set(t,i),i.id}_getDrawingStyle(e,t){if("number"!=typeof e)throw new Error("Invalid style id.");const i=this._mapDrawingStyles.get(e);return i?t?JSON.parse(JSON.stringify(i)):i:null}getDrawingStyle(e){return this._getDrawingStyle(e,!0)}getDrawingStyles(){return JSON.parse(JSON.stringify(Array.from(this._mapDrawingStyles.values())))}_updateDrawingStyle(e,t){const i=this._mapDrawingStyles.get(e);if(i)for(let e in t)i.hasOwnProperty(e)&&(i[e]=t[e])}updateDrawingStyle(e,t){this._updateDrawingStyle(e,t);for(let e of this._arrDrawingLayer)e.renderAll()}createDrawingLayer(e,t){const i=e=>{for(let t of this._arrDrawingLayer)if(t.getId()===e)return!0;return!1};if(void 0===t){for(let e=100;;e++)if(!i(e)){t=e;break}}else if(i(t))throw new Error("Existed drawing layer id.");const r=new w(e,t,this._mapDrawingStyles,{enableRetinaScaling:!1});return r._manager=this,this._arrDrawingLayer.push(r),this._switchPointerEvent(),r}deleteDrwaingLayer(e){const t=this.getDrawingLayer(e);if(!t)return;const i=this._arrDrawingLayer;t.dispose(),i.splice(i.indexOf(t),1),this._switchPointerEvent()}clearDrawingLayers(){for(let e of this._arrDrawingLayer)e.dispose();this._arrDrawingLayer.length=0}getDrawingLayer(e){for(let t of this._arrDrawingLayer)if(t.getId()===e)return t;return null}getDrawingLayers(){return Array.from(this._arrDrawingLayer)}getSelectedDrawingItems(){if(!this._arrDrawingLayer.length)return;const e=this._arrDrawingLayer[0].fabricCanvas.getActiveObjects(),t=[];for(let i of e)t.push(i.getDrawingItem());return t}setDimensions(e,t){this._arrDrawingLayer.length&&this._arrDrawingLayer[0]._setDimensions(e,t)}setObjectFit(e){for(let t of this._arrDrawingLayer)t&&t._setObjectFit(e)}getObjectFit(){return this._arrDrawingLayer.length?this._arrDrawingLayer[0]._getObjectFit():null}setVisible(e){this._arrDrawingLayer.length&&(this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.display=e?"block":"none")}_switchPointerEvent(){if(this._arrDrawingLayer.length)for(let e of this._arrDrawingLayer)e.getMode()}}class S{constructor(e){this._controlTarget=null,this._arrUsers=[],this._mapAction_UserArgs=new Map,this._mapProperty_UserValue=new Map,this._mapAction_Callbacks=new Map,this._controlTarget=e}setControlTarget(e){this._controlTarget=e}getControlTarget(){return this._controlTarget}register(e){this._arrUsers.includes(e)||this._arrUsers.push(e)}logout(e){const t=this._arrUsers.indexOf(e);-1!==t&&(this.clearUserDisiredAction({user:e}),this.clearUserDisiredValue({user:e}),this._arrUsers.splice(t,1))}getRegisteredUsers(){return this._arrUsers}ifUserExisted(e){return this._arrUsers.includes(e)}setDisiredValue(e,t,i,r){if(!this._arrUsers.includes(e))throw new Error("Unregistered user.");r&&(this._controlTarget[t]=i),this._mapProperty_UserValue.get(t)?this._mapProperty_UserValue.get(t).set(e,i):this._mapProperty_UserValue.set(t,new Map([[e,i]]))}clearUserDisiredValue(e){if(e&&(e.user||e.property)){if(e.property&&e.user){const t=this._mapProperty_UserValue.get(e.property);if(!t)return;t.delete(e.user)}else if(e.property)this._mapProperty_UserValue.delete(e.property);else if(e.user)for(let t of this._mapProperty_UserValue.values())t.delete(e.user)}else this._mapProperty_UserValue=new Map}getValue(e){if(!this._controlTarget)throw new Error("Control target is not set.");return this._controlTarget[e]}getPropertyDisiredValue(e){if(this._mapProperty_UserValue.get(e)){const t=[],i=this._mapProperty_UserValue.get(e);for(let e of i.values())t.push(e);return t}return null}setDisiredAction(e,t,i,r){if(!this._arrUsers.includes(e))throw new Error("Unregistered user.");return i||(i=[]),r?this._controlTarget[t](...i):(this._mapAction_UserArgs.get(t)?this._mapAction_UserArgs.get(t).set(e,i):this._mapAction_UserArgs.set(t,new Map([[e,i]])),this._render(t))}clearUserDisiredAction(e){if(e&&(e.user||e.actionName)){if(e.actionName&&e.user){const t=this._mapAction_UserArgs.get(e.actionName);if(!t)return;t.delete(e.user)}else if(e.actionName)this._mapAction_UserArgs.delete(e.actionName);else if(e.user)for(let t of this._mapAction_UserArgs.values())t.delete(e.user);this.render()}else this._mapAction_UserArgs=new Map}addCallback(e,t){const i=this._mapAction_Callbacks.get(e);i?i.push(t):this._mapAction_Callbacks.set(e,[t])}removeCallback(e,t){const i=this._mapAction_Callbacks.get(e);if(!i)return;const r=i.indexOf(t);-1!==r&&i.splice(r,1)}clearCallback(e){e?this._mapAction_Callbacks.delete(e):this._mapAction_Callbacks.clear()}_fireCallback(e){const t=this._mapAction_Callbacks.get(e);if(t)for(let e of t){if(!e)return;setTimeout(e.bind(this._controlTarget),0)}}_render(e){const t=this._mapAction_UserArgs.get(e);if(!t)throw new Error("Unrecorded action.");if(t.size===this._arrUsers.length){let i=[];for(let e of t.values())e.length>0&&(i=e);if(this._controlTarget[e]){const t=this._controlTarget[e](...i);return this._mapAction_UserArgs.delete(e),this._fireCallback(e),t}}}render(e){if(e)return this._render(e);for(let e of this._mapAction_UserArgs.keys())this._render(e)}}class C{static multiply(e,t){const i=[];for(let r=0;r<3;r++){const s=t.slice(3*r,3*r+3);for(let t=0;t<3;t++){const r=[e[t],e[t+3],e[t+6]].reduce(((e,t,i)=>e+t*s[i]),0);i.push(r)}}return i}static identity(){return[1,0,0,0,1,0,0,0,1]}static translate(e,t,i){return C.multiply(e,[1,0,0,0,1,0,t,i,1])}static rotate(e,t){var i=Math.cos(t),r=Math.sin(t);return C.multiply(e,[i,-r,0,r,i,0,0,0,1])}static scale(e,t,i){return C.multiply(e,[t,0,0,0,i,0,0,0,1])}}var L;!function(e){e.GREY="grey",e.GREY32="grey32",e.RGBA="rgba",e.RBGA="rbga",e.GRBA="grba",e.GBRA="gbra",e.BRGA="brga",e.BGRA="bgra"}(L||(L={}));class I{constructor(){this._maxCvsSideLength=void 0,this._defaultMaxCvsSideLength=null,this._predefinedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],this._mapCameraResolutions=new Map,this._bWebGLSupported=!0,this.extraBindings=[],this._singleFrameMode=!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),this._cvsSingleFrameMode=null,this._cvsOriginalImage=null,this._imgWidth=0,this._imgHeight=0,this._singleFrameModeIpt=null,this._clickIptSingleFrameMode=()=>{if(this.singleFrameMode){if(!this._singleFrameModeIpt){const e=document.createElement("input");this._singleFrameModeIpt=e,e.setAttribute("type","file"),e.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),e.setAttribute("capture",""),e.addEventListener("change",(()=>t(this,void 0,void 0,(function*(){const i=e.files[0];e.value="";const r=yield(e=>t(this,void 0,void 0,(function*(){let t=null,i=null;if("undefined"!=typeof createImageBitmap)try{if(t=yield createImageBitmap(e),t)return t}catch(e){}var r;return t||(i=yield(r=e,new Promise(((e,t)=>{let i=URL.createObjectURL(r),s=new Image;s.dbrObjUrl=i,s.src=i,s.onload=()=>{e(s)},s.onerror=e=>{t(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}})))),i})))(i),s=r instanceof HTMLImageElement?r.naturalWidth:r.width,n=r instanceof HTMLImageElement?r.naturalHeight:r.height;this._imgWidth=s,this._imgHeight=n;const o=e=>{const t=Date.now();if(0===s||0===n)return null;if(e instanceof HTMLImageElement&&!e.complete)throw new Error("The source is not loaded.");const i=this._scanRegion,r=this.getFrameSize(s,n,i,this.maxCvsSideLength);if(!r)return null;let o=!0;s===r.sWidth&&n===r.sHeight&&(o=!1);const a=this.mapPixelFormatString_Enum.get(this.framePixelFormat.toLowerCase()),l={data:null,region:i?JSON.parse(JSON.stringify(i)):null,sx:r.sx,sy:r.sy,width:r.dWidth,height:r.dHeight,colorMode:null,pixelFormat:null,timeSpent:null,timeStamp:null,isCropped:o,toCanvas:this._toCanvas,_sWidth:r.sWidth,_sHeight:r.sHeight,_bUseWebGL:null},h=this._getImageData(e,s,n,r,null,{pixelFormat:a});if(!h)return null;const d=Date.now();if(I._onLog&&I._onLog("DCE: _getVideoData(region?) END: "+d),l.data=h.data,l.pixelFormat=l.colorMode=h.pixelFormat,l._bUseWebGL=h._bUseWebGL,l.timeSpent=d-t,l.timeStamp=d,h.pixelFormat===L.GREY)l.stride=l.width;else l.stride=4*l.width;return l};(e=>{let t=this._cvsSingleFrameMode;if(!t){if(t=document.createElement("canvas"),t.style.pointerEvents="none",!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(t),t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.left="0",t.style.top="0",t.style.objectFit="contain",this._cvsSingleFrameMode=t}t.width==s&&t.height==n||(t.width=s,t.height=n);const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.drawImage(e,0,0)})(r),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);let a;this._updateDrawingLayersSize();try{a=o(r)}catch(e){throw e}const l=this.mapCameraEvents.get("singleFrameAcquired");for(let e of l)if(e)try{const t={data:new Uint8Array(a.data),region:JSON.parse(JSON.stringify(a.region)),sx:a.sx,sy:a.sy,width:a.width,height:a.height,stride:a.stride,colorMode:a.colorMode,pixelFormat:a.pixelFormat,timeSpent:a.timeSpent,timeStamp:a.timeStamp,isCropped:a.isCropped,toCanvas:a.toCanvas,_sWidth:a._sWidth,_sHeight:a._sHeight,_bUseWebGL:a._bUseWebGL};yield e.apply(this,[t])}catch(e){console.error(e)}})))),e.style.position="fixed",e.style.left="-1px",e.style.top="-1px",e.style.width="1px",e.style.height="1px",e.style.backgroundColor="transparent",e.style.color="transparent",document.body.appendChild(e)}this._singleFrameModeIpt.click()}},this.styleEls=[],this._framePixelFormat=void 0,this._defaultFramePixelFormat="rgba",this.mapPixelFormatString_Enum=new Map([["grey",L.GREY],["grey32",L.GREY32],["rgba",L.RGBA],["rbga",L.RBGA],["grba",L.GRBA],["gbra",L.GBRA],["brga",L.BRGA],["bgra",L.BGRA]]),this.shaderPixelFormat=L.RGBA,this.maxVideoCvsLength=3,this._reusedCvs=null,this._reusedWebGLCvs=null,this._tempDataContainer=null,this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._softwareScale=1,this._recordedStates={},this.playCallbackInfo=null,this._toCanvas=function(){const e=document.createElement("canvas");let t;if(e.width=this.width,e.height=this.height,"grey"===this.pixelFormat){t=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<t.length;e+=4)t[e]=this.data[e/4],t[e+1]=this.data[e/4],t[e+2]=this.data[e/4],t[e+3]=255}else t=new Uint8ClampedArray(this.data.buffer);const i=new ImageData(t,this.width,this.height);return e.getContext("2d").putImageData(i,0,0),e},this._onCameraSelChange=()=>t(this,void 0,void 0,(function*(){yield this.selectCamera(this._selCam.value),this._bOpen||this.stop()})),this._onResolutionSelChange=()=>t(this,void 0,void 0,(function*(){let e,t;if(this._selRsl&&-1!=this._selRsl.selectedIndex){let i=this._selRsl.options[this._selRsl.selectedIndex];e=i.getAttribute("data-width"),t=i.getAttribute("data-height")}yield this.setResolution(e,t),this._bOpen||this.stop()})),this._onCloseBtnClick=()=>{this.close(!0)},this._bOpen=!1,this.isCameraEnhancer=!0,this.isDisposed=!1,this.disposed=!1,this.videoSrc=null,this.videoSettings={video:{width:{ideal:1280},height:{ideal:720},facingMode:{ideal:"environment"}}},this.iPlayRound=0,this.promisePlay=null,this._ifSaveLastUsedCamera=!1,this.ifSkipCameraInspection=!1,this._allCameras=[],this._currentCamera=null,this._videoTrack=null,this._lastDeviceId=void 0,this._vc_bPlayingVideoBeforeHide=!1,this._ev_documentHideEvent=()=>{"visible"===document.visibilityState?this._vc_bPlayingVideoBeforeHide&&("Firefox"==a.browser?this.play():this._video.play(),this._vc_bPlayingVideoBeforeHide=!1):this._video&&!this._video.paused&&(this._vc_bPlayingVideoBeforeHide=!0,this._video.pause())},this.containerClassName="dce-video-container",this._elContainer=null,this._videoContainer=null,this._video=null,this.videoFit="contain",this._cvsScanRegion=null,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=2,this._bShowScanRegionMask=!0,this._bShowScanRegionLaser=void 0,this._defaultBShowScanRegionLaser=!1,this._scanRegion=null,this._arrScanRegionOverlays=[],this._layerBaseCvs=null,this._cvsViewDecorator=null,this._decoratorType=[],this._decoratorArea=null,this._viewDecoratorInfo={rectangle:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},focus:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},crossline:{lineWidth:2,strokeStyle:"rgb(254,142,20)"},crosshair:{lineWidth:4,strokeStyle:"rgb(254,142,20)"}},this._croppingRegions=void 0,this._defaultCroppingRegions=[null],this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0,this._loopInterval=void 0,this._defaultLoopInterval=0,this._maxNumberOfFramesInBuffer=void 0,this._defaultMaxNumberOfFramesInBuffer=1,this._frameQueue=[],this._bFetchingLoopStarted=!1,this._refreshInterval=void 0,this._defaultRefreshInterval=-1,this._updateLayersTimeout=100,this._updateLayers=()=>{this._resizeTimeoutId&&clearTimeout(this._resizeTimeoutId),this._resizeTimeoutId=setTimeout((()=>{if(!this.isDisposed||!this.disposed){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateDrawingLayersSize(),this._updateVideoContainerStyle()}}),this._updateLayersTimeout)},this.mapCameraEvents=new Map([["cameraOpen",[]],["cameraClose",[]],["cameraChange",[]],["resolutionChange",[]],["played",[]],["singleFrameAcquired",[]],["frameAddedToBuffer",[]]]),this._controler=null}static getVersion(){return this._version}static detectEnvironment(){return t(this,void 0,void 0,(function*(){return yield(async()=>({wasm:l,worker:h,getUserMedia:d,camera:await c(),browser:a.browser,version:a.version,OS:a.OS}))()}))}static set engineResourcePath(e){if(this._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");I._engineResourcePath=(e=>{if(null==e&&(e="./"),!i){let t=document.createElement("a");t.href=e,e=t.href}return e.endsWith("/")||(e+="/"),e})(e)}static get engineResourcePath(){return this._engineResourcePath}static isStorageAvailable(e){let t;try{t=window[e];const i="__storage_test__";return t.setItem(i,i),t.removeItem(i),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}}static isDCEFrame(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&("data"in e&&("region"in e&&("sx"in e&&("sy"in e&&("width"in e&&("height"in e&&(("colorMode"in e||"pixelFormat"in e)&&("timeSpent"in e&&("timeStamp"in e&&("isCropped"in e&&("toCanvas"in e&&("_sWidth"in e&&("_sHeight"in e&&"_bUseWebGL"in e)))))))))))))}set maxCvsSideLength(e){if(e<=0)throw new Error("Invalid value.");this._maxCvsSideLength=e}get maxCvsSideLength(){if(void 0!==this._maxCvsSideLength)return this._maxCvsSideLength;if(this._controler){const e=this._controler.getPropertyDisiredValue("maxCvsSideLength");if(e&&1===e.length)return e[0]}return this._defaultMaxCvsSideLength}static set defaultUIElementURL(e){I._defaultUIElementURL=e}static get defaultUIElementURL(){var e;return null===(e=I._defaultUIElementURL)||void 0===e?void 0:e.replace("@engineResourcePath/",I.engineResourcePath)}getUIElement(){return this.UIElement}setUIElement(e){return t(this,void 0,void 0,(function*(){if(this._bOpen)throw new Error("It is not allowed to change the UIElement when the camera is open.");if("string"==typeof e||e instanceof String){if(!e.trim().startsWith("<")){let t=yield fetch(e);if(!t.ok)throw Error("setUIElement(elementOrUrl): Network Error: "+t.statusText);e=yield t.text()}if(!e.trim().startsWith("<"))throw Error("setUIElement(elementOrUrl): Can't get valid HTMLElement.");let t=document.createElement("div");t.innerHTML=e;for(let e=0;e<t.childElementCount;++e){let i=t.children[e];i instanceof HTMLStyleElement&&(this.styleEls.push(i),document.head.append(i))}(e=1==t.childElementCount?t.children[0]:t).remove()}this.UIElement=e,this._uiOriginalState={display:e&&e.style.display,inDom:document.body.contains(e)}}))}appendAndShowUI(){this.UIElement&&(this.UIElement.parentNode||(this.UIElement.style.position="fixed",this.UIElement.style.left="0",this.UIElement.style.top="0",document.body.append(this.UIElement)),"none"==this.UIElement.style.display&&(this.UIElement.style.display=""))}hideUI(){this.UIElement&&(this.UIElement.style.display="none")}get singleFrameMode(){return this._singleFrameMode}set singleFrameMode(e){if(this._bOpen)throw new Error("It is not allowed to change `singleFrameMode` when the camera is open.");this._singleFrameMode=e}set frameColorMode(e){this._framePixelFormat=e}get frameColorMode(){if(void 0!==this._framePixelFormat)return this._framePixelFormat;if(this._controler){const e=this._controler.getPropertyDisiredValue("framePixelFormat")||this._controler.getPropertyDisiredValue("frameColorMode");if(e&&1===e.length)return e[0]}return this._defaultFramePixelFormat}set framePixelFormat(e){this._framePixelFormat=e}get framePixelFormat(){if(void 0!==this._framePixelFormat)return this._framePixelFormat;if(this._controler){const e=this._controler.getPropertyDisiredValue("framePixelFormat")||this._controler.getPropertyDisiredValue("frameColorMode");if(e&&1===e.length)return e[0]}return this._defaultFramePixelFormat}set bOpen(e){if(this._bOpen=e,e){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateDrawingLayersSize(),this.ifShowScanRegionMask?this.showScanRegionMask():this.hideScanRegionMask(),this.ifShowScanRegionLaser?this.showScanRegionLaser():this.hideScanRegionLaser(),this.showViewDecorator(),this.showScanRegionOverlays(),this._drawingLayersManager.setVisible(!0)}else this._softwareScale=1}set ifSaveLastUsedCamera(e){e?I.isStorageAvailable("localStorage")?this._ifSaveLastUsedCamera=!0:(this._ifSaveLastUsedCamera=!1,console.warn("Local storage is unavailable")):this._ifSaveLastUsedCamera=!1}get ifSaveLastUsedCamera(){return this._ifSaveLastUsedCamera}get video(){return this._video}setVideoFit(e){if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`Unsupported value '${e}'.`);if(this.videoFit=e,this._video&&(this._video.style.objectFit=e,!this.singleFrameMode)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateVideoContainerStyle(),this._drawingLayersManager.setObjectFit(e)}}getVideoFit(){return this.videoFit}_showElClassName(){this._cvsScanRegion&&this._cvsScanRegion.classList.add("cvs-scan-region-mask"),this._cvsViewDecorator&&this._cvsViewDecorator.classList.add("cvs-view-decorator"),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.classList.add("div-scan-region-overlay-container"),this._layerBaseCvs&&this._layerBaseCvs.classList.add("cvs-drawing-layer-base"),this._layerBaseCvs&&this._layerBaseCvs.parentElement.classList.add("div-drawing-layer-container"),this._cvsOriginalImage&&this._cvsOriginalImage.classList.add("cvs-original-image"),this._cvsSingleFrameMode&&this._cvsSingleFrameMode.classList.add("cvs-single-frame")}_hideElClassName(){this._cvsScanRegion&&this._cvsScanRegion.classList.remove("cvs-scan-region-mask"),this._cvsViewDecorator&&this._cvsViewDecorator.classList.remove("cvs-view-decorator"),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.classList.remove("div-scan-region-overlay-container"),this._layerBaseCvs&&this._layerBaseCvs.classList.remove("cvs-drawing-layer-base"),this._layerBaseCvs&&this._layerBaseCvs.parentElement.classList.remove("div-drawing-layer-container"),this._cvsOriginalImage&&this._cvsOriginalImage.classList.remove("cvs-original-image"),this._cvsSingleFrameMode&&this._cvsSingleFrameMode.classList.remove("cvs-single-frame")}set ifShowScanRegionMask(e){this._bShowScanRegionMask=e,e?this.showScanRegionMask():this.hideScanRegionMask()}get ifShowScanRegionMask(){return this._bShowScanRegionMask}showScanRegionMask(){this._cvsScanRegion&&("none"==this._cvsScanRegion.style.display&&(this._cvsScanRegion.style.display=""),this._recordedStates.maskShow=!0)}hideScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display="none",this._recordedStates.maskShow=!1)}set ifShowScanRegionLaser(e){this._bShowScanRegionLaser=e,e?this.showScanRegionLaser():this.hideScanRegionLaser()}get ifShowScanRegionLaser(){if(void 0!==this._bShowScanRegionLaser)return this._bShowScanRegionLaser;if(this._controler){const e=this._controler.getPropertyDisiredValue("ifShowScanRegionLaser");if(e&&e.length){let t=0;for(let i of e)i||t++;return t!==this._controler.getRegisteredUsers().length}}return this._defaultBShowScanRegionLaser}showScanRegionLaser(){this._divScanLight&&("none"==this._divScanLight.style.display&&(this._divScanLight.style.display="block"),this._recordedStates.laserShow=!0)}hideScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display="none",this._recordedStates.laserShow=!1)}_checkValidRegion(e){return null===e||!!e&&(!!(e.hasOwnProperty("regionLeft")&&e.hasOwnProperty("regionTop")&&e.hasOwnProperty("regionRight")&&e.hasOwnProperty("regionBottom")&&e.hasOwnProperty("regionMeasuredByPercentage"))&&(!(e.regionLeft<0||e.regionTop<0||e.regionRight<0||e.regionBottom<0)&&(!e.regionMeasuredByPercentage||!(e.regionLeft>100||e.regionTop>100||e.regionRight>100||e.regionBottom>100))))}set scanRegion(e){if(!this._checkValidRegion(e))throw new Error("Invalid region.");this._scanRegion=JSON.parse(JSON.stringify(e)),this._updateScanRegionCanvas(),this._updateScanAreaDiv();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e)}setScanRegion(e){this.scanRegion=e}getScanRegion(){return JSON.parse(JSON.stringify(this._scanRegion))}_calculateCvsSize(){if(!this._bOpen)return null;let e,t,i;if(this.singleFrameMode)e=this._imgWidth,t=this._imgHeight,i="contain";else{if(!this._video)return null;e=this._video.videoWidth,t=this._video.videoHeight,i=this.getVideoFit()}return{width:e,height:t,objectFit:i}}addScanRegionOverlayCanvas(){this._assertOpen();const e=document.createElement("canvas");if(this._updateScanRegionOverlay(e),!this._scanRegionOverlayContainer){const e=document.createElement("div");if(this._scanRegionOverlayContainer=e,e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.overflow="hidden",e.style.pointerEvents="none",this._layerBaseCvs)this._layerBaseCvs.parentElement.after(e);else if(this._cvsScanRegion)this._cvsScanRegion.before(e);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(e);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(e)}this._recordedStates.overlayShow=!0}return this._scanRegionOverlayContainer.append(e),this._arrScanRegionOverlays.push(e),e}removeScanRegionOverlayCanvas(e){const t=this._arrScanRegionOverlays.indexOf(e);-1!==t&&(e.remove(),this._arrScanRegionOverlays.splice(t,1))}_updateScanRegionOverlay(e){if(!e)return;const t=this._calculateCvsSize();if(!t)return;const{width:i,height:r,objectFit:s}=t;if(i<=0||r<=0)return e.width=0,void(e.height=0);const n=this._getRegionInPixels(i,r,this._scanRegion),o=this.getFrameSize(i,r,this._scanRegion,this.maxCvsSideLength),a=o.dWidth,l=o.dHeight;e.width==a&&e.height==l||(e.width=a,e.height=l);const h=window.getComputedStyle(this._elContainer),d=parseFloat(h.width),c=parseFloat(h.height),g=d/c,_=i/r;let f,u,p,m,v=1;"contain"===s?(g<_?(v=d/i,f=0,u=(c-r*v)/2):(v=c/r,f=(d-i*v)/2,u=0),f+=n.regionLeft*v,u+=n.regionTop*v,p=(n.regionRight-n.regionLeft)*v,m=(n.regionBottom-n.regionTop)*v):"cover"===s?(_>g?(v=c/r,f=n.regionLeft*v-(i*v-d)/2,u=n.regionTop*v):(v=d/i,f=n.regionLeft*v,u=n.regionTop*v-(r*v-c)/2),p=(n.regionRight-n.regionLeft)*v,m=(n.regionBottom-n.regionTop)*v):(f=0,u=0,p=0,m=0),e.style.position="absolute",e.style.left=f+"px",e.style.top=u+"px",e.style.width=p+"px",e.style.height=m+"px"}showScanRegionOverlays(){this._scanRegionOverlayContainer&&("none"==this._scanRegionOverlayContainer.style.display&&(this._scanRegionOverlayContainer.style.display=""),this._recordedStates.overlayShow=!0)}hideScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none",this._recordedStates.overlayShow=!1)}setViewDecorator(e,t){if(!e)return void(this._cvsViewDecorator&&(this._cvsViewDecorator.remove(),this._cvsViewDecorator=null));if(!t)throw new Error("Invalid area.");this._assertOpen();let i=[];if("string"==typeof e?i.push(e):Array.isArray(e)&&(i=JSON.parse(JSON.stringify(e))),!this._cvsViewDecorator){if(this._cvsViewDecorator=document.createElement("canvas"),this._cvsViewDecorator.style.pointerEvents="none",this._cvsScanRegion)this._cvsScanRegion.after(this._cvsViewDecorator);else if(this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.after(this._cvsViewDecorator);else if(this._layerBaseCvs)this._layerBaseCvs.parentElement.after(this._cvsViewDecorator);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsViewDecorator);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(this._cvsViewDecorator)}this._recordedStates.decoratorShow=!0}this._decoratorArea=JSON.parse(JSON.stringify(t)),this._decoratorType.length=0;const r=["rectangle","focus"],s=["crossline","crosshair"];let n=!1,o=!1;for(let e of i)e=e.toLowerCase(),r.includes(e)&&!n&&(n=!0,this._decoratorType.push(e)),s.includes(e)&&!o&&(o=!0,!this._decoratorType.includes(e)&&this._decoratorType.push(e));this._updateViewDecorator()}getViewDecorator(){return{type:JSON.parse(JSON.stringify(this._decoratorType)),area:JSON.parse(JSON.stringify(this._decoratorArea)),canvas:this._cvsViewDecorator}}showViewDecorator(){this._cvsViewDecorator&&("none"==this._cvsViewDecorator.style.display&&(this._cvsViewDecorator.style.display=""),this._recordedStates.decoratorShow=!0)}hideViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none",this._recordedStates.decoratorShow=!1)}setViewDecoratorLineWidth(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("lineWidth"))throw new Error(`It is not allowed to change the property 'lineWidth' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].lineWidth=t,this._updateViewDecorator()}setViewDecoratorStrokeStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("strokeStyle"))throw new Error(`It is not allowed to change the property 'strokeStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].strokeStyle=t,this._updateViewDecorator()}setViewDecoratorFillStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("fillStyle"))throw new Error(`It is not allowed to change the property 'fillStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].fillStyle=t,this._updateViewDecorator()}setViewDecoratorMaskFillStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("maskFillStyle"))throw new Error(`It is not allowed to change the property 'maskFillStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].maskFillStyle=t,this._updateViewDecorator()}_updateViewDecorator(){if(!this._bOpen)return;if(!this._cvsViewDecorator||!this._decoratorArea)return;let e;if(this.singleFrameMode)e="contain";else{if(!this._video)return;e=this.getVideoFit()}const t=this._cvsViewDecorator;t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.left="0",t.style.top="0",t.style.objectFit=e;const i=this.getVisibleRegion(!0),r=i.regionRight-i.regionLeft,s=i.regionBottom-i.regionTop;if(t.width==r&&t.height==s||(t.width=r,t.height=s),r<=0||s<=0)return;const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);const o=this._decoratorArea.x/100*r,a=this._decoratorArea.y/100*s,l=this._decoratorArea.width/100*r,h=this._decoratorArea.height/100*s;for(let e of this._decoratorType){if("rectangle"===e){n.fillStyle=this._viewDecoratorInfo.rectangle.maskFillStyle,n.fillRect(0,0,t.width,t.height),n.clearRect(Math.round(o),Math.round(a),Math.round(l),Math.round(h)),n.fillStyle=this._viewDecoratorInfo.rectangle.fillStyle,n.fillRect(Math.round(o),Math.round(a),Math.round(l),Math.round(h)),n.lineWidth=this._viewDecoratorInfo.rectangle.lineWidth,n.strokeStyle=this._viewDecoratorInfo.rectangle.strokeStyle;const e=n.lineWidth/2;n.strokeRect(Math.round(o-e),Math.round(a-e),Math.round(l+n.lineWidth),Math.round(h+n.lineWidth))}if("focus"===e){n.fillStyle=this._viewDecoratorInfo.focus.maskFillStyle,n.fillRect(0,0,t.width,t.height),n.clearRect(Math.round(o),Math.round(a),Math.round(l),Math.round(h)),n.fillStyle=this._viewDecoratorInfo.focus.fillStyle,n.fillRect(Math.round(o),Math.round(a),Math.round(l),Math.round(h)),n.lineWidth=this._viewDecoratorInfo.focus.lineWidth,n.strokeStyle=this._viewDecoratorInfo.focus.strokeStyle;const e=n.lineWidth/2,i=[0,.25,.75,1],r=[0,.25,.75,1];n.beginPath();for(let e=0;e<i.length;e++)if(0==e||3==e)for(let t=0;t<r.length;t+=2)n.moveTo(Math.round(o+i[e]*l),Math.round(a+r[t]*h)),n.lineTo(Math.round(o+i[e]*l),Math.round(a+r[t+1]*h));for(let t=0;t<r.length;t++)if(0==t||3==t)for(let s=0;s<i.length;s+=2)n.moveTo(Math.round(o+i[s]*l-e),Math.round(a+r[t]*h)),n.lineTo(Math.round(o+i[s+1]*l+e),Math.round(a+r[t]*h));n.stroke()}if("crossline"===e&&(n.beginPath(),n.lineWidth=this._viewDecoratorInfo.crossline.lineWidth,n.strokeStyle=this._viewDecoratorInfo.crossline.strokeStyle,n.moveTo(Math.round(o),Math.round(a+h/2)),n.lineTo(Math.round(o+l),Math.round(a+h/2)),n.moveTo(Math.round(o+l/2),Math.round(a)),n.lineTo(Math.round(o+l/2),Math.round(a+h)),n.stroke()),"crosshair"===e){n.beginPath();const e=.05*Math.min(l,h);n.lineWidth=this._viewDecoratorInfo.crosshair.lineWidth,n.strokeStyle=this._viewDecoratorInfo.crosshair.strokeStyle,n.moveTo(Math.round(o+(l-e)/2),Math.round(a+h/2)),n.lineTo(Math.round(o+(l+e)/2),Math.round(a+h/2)),n.moveTo(Math.round(o+l/2),Math.round(a+(h-e)/2)),n.lineTo(Math.round(o+l/2),Math.round(a+(h+e)/2)),n.stroke()}}}getVisibleRegion(e){this._assertOpen();const t=this._calculateCvsSize();if(!t)return null;const{width:i,height:r,objectFit:s}=t;let n=(()=>{const e=parseFloat(window.getComputedStyle(this._elContainer).width),t=parseFloat(window.getComputedStyle(this._elContainer).height);let n,o={regionBottom:r,regionRight:i,regionLeft:0,regionTop:0,regionMeasuredByPercentage:!1};return"cover"===s?e/t<i/r?(n=t/r,o.regionLeft=Math.floor((i-e/n)/2),o.regionRight=Math.ceil(i-o.regionLeft),o.regionTop=0,o.regionBottom=r):(n=e/i,o.regionTop=Math.floor((r-t/n)/2),o.regionBottom=Math.ceil(r-o.regionTop),o.regionLeft=0,o.regionRight=i):"none"===s&&(e<i&&t<r?(o.regionLeft=Math.floor((i-e)/2),o.regionRight=Math.ceil(i-o.regionLeft),o.regionTop=Math.floor((r-t)/2),o.regionBottom=Math.ceil(r-o.regionTop)):e<i?(o.regionLeft=Math.floor((i-e)/2),o.regionRight=Math.ceil(i-o.regionLeft),o.regionTop=0,o.regionBottom=r):t<r&&(o.regionTop=Math.floor((r-t)/2),o.regionBottom=Math.ceil(r-o.regionTop),o.regionLeft=0,o.regionRight=i)),o})();return e?n.regionMeasuredByPercentage=!1:(n.regionBottom=Math.ceil(n.regionBottom/r*100),n.regionRight=Math.ceil(n.regionRight/i*100),n.regionLeft=Math.floor(n.regionLeft/i*100),n.regionTop=Math.floor(n.regionTop/r*100),n.regionMeasuredByPercentage=!0),n}setScanRegionMaskStyle(e){e&&(e.fillStyle&&(this.regionMaskFillStyle=e.fillStyle),e.strokeStyle&&(this.regionMaskStrokeStyle=e.strokeStyle),e.lineWidth&&(this.regionMaskLineWidth=e.lineWidth),this._updateScanRegionCanvas())}_getRegionInPixels(e,t,i){if(!(e<=0||t<=0)){if(!i)return{regionLeft:0,regionTop:0,regionRight:e,regionBottom:t,regionMeasuredByPercentage:!1};if(i.regionMeasuredByPercentage)return{regionLeft:Math.round(i.regionLeft/100*e),regionTop:Math.round(i.regionTop/100*t),regionRight:Math.round(i.regionRight/100*e),regionBottom:Math.round(i.regionBottom/100*t),regionMeasuredByPercentage:!1};return JSON.parse(JSON.stringify(i))}}_updateScanRegionCanvas(){if(!this._bOpen)return;const e=this._calculateCvsSize();if(!e)return;const{width:t,height:i,objectFit:r}=e;if(t<=0||i<=0)return void(this._cvsScanRegion&&(this._cvsScanRegion.width=0,this._cvsScanRegion.height=0));const s=this._getRegionInPixels(t,i,this._scanRegion);this._cvsScanRegion||(this._cvsScanRegion=document.createElement("canvas"),this._cvsScanRegion.style.pointerEvents="none",this._scanRegionOverlayContainer?this._scanRegionOverlayContainer.after(this._cvsScanRegion):this._layerBaseCvs?this._layerBaseCvs.parentElement.after(this._cvsScanRegion):this._cvsSingleFrameMode?this._cvsSingleFrameMode.after(this._cvsScanRegion):this._videoContainer.after(this._cvsScanRegion),this._recordedStates.maskShow=!0);const n=this._cvsScanRegion;n.style.position="absolute",n.style.width="100%",n.style.height="100%",n.style.left="0",n.style.top="0",n.style.objectFit=r,n.width==t&&n.height==i||(n.width=t,n.height=i);const o=n.getContext("2d");if(o.clearRect(0,0,n.width,n.height),0!=s.regionLeft||s.regionRight!=t||0!=s.regionTop||s.regionBottom!=i){const e=s.regionLeft,t=s.regionTop,i=s.regionRight-s.regionLeft,r=s.regionBottom-s.regionTop;o.fillStyle=this.regionMaskFillStyle,o.fillRect(0,0,n.width,n.height),o.clearRect(Math.round(e),Math.round(t),Math.round(i),Math.round(r)),o.strokeStyle=this.regionMaskStrokeStyle,o.lineWidth=this.regionMaskLineWidth;const a=o.lineWidth/2;o.strokeRect(Math.round(e-a),Math.round(t-a),Math.round(i+o.lineWidth),Math.round(r+o.lineWidth))}}_updateScanAreaDiv(){if(!this._bOpen)return;const e=this._calculateCvsSize();if(!e)return;const{width:t,height:i,objectFit:r}=e;if(!this._divScanArea)return;if(t<=0||i<=0)return this._divScanArea.style.width="0",void(this._divScanArea.style.height="0");const s=this._getRegionInPixels(t,i,this._scanRegion),n=window.getComputedStyle(this._elContainer),o=parseFloat(n.width),a=parseFloat(n.height),l=o/a,h=t/i;let d,c,g,_,f=1;if("contain"===r)l<h?(f=o/t,d=0,c=(a-i*f)/2):(f=a/i,d=(o-t*f)/2,c=0),d+=s.regionLeft*f,c+=s.regionTop*f,g=(s.regionRight-s.regionLeft)*f,_=(s.regionBottom-s.regionTop)*f;else if("cover"===r)if(l<h){f=a/i,d=s.regionLeft*f-(t*f-o)/2,d=Math.max(d,0),d=Math.min(d,parseFloat(n.width)),c=s.regionTop*f;let e=s.regionRight*f-(t*f-o)/2;e=Math.max(e,0),e=Math.min(e,parseFloat(n.width)),g=e-d,_=(s.regionBottom-s.regionTop)*f}else{f=o/t,d=s.regionLeft*f,c=s.regionTop*f-(i*f-a)/2,c=Math.max(c,0),c=Math.min(c,parseFloat(n.height));let e=s.regionBottom*f-(i*f-a)/2;e=Math.max(e,0),e=Math.min(e,parseFloat(n.height)),g=(s.regionRight-s.regionLeft)*f,_=e-c}else d=0,c=0,g=0,_=0;this._divScanArea.style.left=d+"px",this._divScanArea.style.top=c+"px",this._divScanArea.style.width=g+"px",this._divScanArea.style.height=_+"px"}set croppingRegions(e){this._croppingRegions=e,this._bFetchingLoopStarted&&(this.bIncreaseRegionIndexAuto&&(this._croppingRegionIndex=0),this._fetchingLoop(!1))}get croppingRegions(){if(void 0!==this._croppingRegions)return this._croppingRegions;if(this._controler){const e=this._controler.getPropertyDisiredValue("croppingRegions");if(e&&1===e.length)return e[0]}return this._defaultCroppingRegions}set croppingRegionIndex(e){e<0?(this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0):(this.bIncreaseRegionIndexAuto=!1,this._croppingRegionIndex=e)}get croppingRegionIndex(){return this._croppingRegionIndex}set loopInterval(e){if(e<0)throw new Error("'Invalid value.");this._loopInterval=e,this._bFetchingLoopStarted&&this._fetchingLoop(!1)}get loopInterval(){if(void 0!==this._loopInterval)return this._loopInterval;if(this._controler){const e=this._controler.getPropertyDisiredValue("loopInterval");if(e&&1===e.length)return e[0]}return this._defaultLoopInterval}set maxNumberOfFramesInBuffer(e){if(e<=0)throw new Error("Invalid value.");for(this._maxNumberOfFramesInBuffer=e;this._frameQueue&&this._frameQueue.length>this.maxNumberOfFramesInBuffer;)this._frameQueue.shift()}get maxNumberOfFramesInBuffer(){if(void 0!==this._maxNumberOfFramesInBuffer)return this._maxNumberOfFramesInBuffer;if(this._controler){const e=this._controler.getPropertyDisiredValue("maxNumberOfFramesInBuffer");if(e&&1===e.length)return e[0]}return this._defaultMaxNumberOfFramesInBuffer}get numberOfFramesInBuffer(){return this._frameQueue.length}set refreshInterval(e){this._refreshInterval=e}get refreshInterval(){if(void 0!==this._refreshInterval)return this._refreshInterval;if(this._controler){const e=this._controler.getPropertyDisiredValue("refreshInterval");if(e&&1===e.length)return e[0]}return this._defaultRefreshInterval}static createInstance(e){return t(this,void 0,void 0,(function*(){let t=new I;("string"==typeof e||e instanceof String)&&(e=JSON.parse(e));for(let i in e)t[i]=e[i];return this._hasEngineResourceLoaded=!0,I.onWarning&&(location&&"file:"===location.protocol?setTimeout((()=>{I.onWarning&&I.onWarning({id:1,message:"Not using HTTP protocol, the SDK may not work correctly."})}),0):location&&"https:"!==location.protocol&&setTimeout((()=>{I.onWarning&&I.onWarning({id:2,message:"Not connected via SSL (HTTPS), the SDK may not work correctly."})}),0)),t._drawingLayersManager=new b,t}))}static playVideo(e,i,r){return t(this,void 0,void 0,(function*(){return new Promise(((s,n)=>{e||n(new Error("Invalid video element.")),i||n(new Error("Invalid source.")),e.onloadedmetadata=()=>t(this,void 0,void 0,(function*(){e.onloadedmetadata=null,yield e.play(),s(e)})),"string"==typeof i||i instanceof String?e.src=i:e.srcObject=i,void 0!==r&&setTimeout((()=>n(new Error("Failed to play video. Timeout."))),r)}))}))}static findBestRearCamera(e){if(!e||!e.length)return null;const t=["rear","back","rück","arrière","trasera","trás","traseira","posteriore","后面","後面","背面","后置","後置","背置","задней","الخلفية","후","arka","achterzijde","หลัง","baksidan","bagside","sau","bak","tylny","takakamera","belakang","אחורית","πίσω","spate","hátsó","zadní","darrere","zadná","задня","stražnja","belakang","बैक"];for(let i of e){const e=i.label.toLowerCase();if(e&&t.some((t=>e.includes(t)))&&/\b0(\b)?/.test(e))return i.deviceId}return["Android","HarmonyOS"].includes(a.OS)?e[e.length-1].deviceId:null}play(e,i,r,s){return t(this,void 0,void 0,(function*(){let n;if(this._video&&this.videoSrc){I._onLog&&(n=Date.now(),I._onLog("DCE: start loading static video: "+n));const e=yield I.playVideo(this._video,this.videoSrc,4e3);if(I._onLog&&I._onLog("DCE: finish loading static video. Costs: "+(Date.now()-n)),!this._video)return e.pause(),this.playCallbackInfo={width:0,height:0,deviceId:null},{width:0,height:0,deviceId:null};const t={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.playCallbackInfo=JSON.parse(JSON.stringify(t));const i=this.mapCameraEvents.get("played");for(let e of i){if(!e)continue;const i=JSON.parse(JSON.stringify(t));setTimeout((()=>e.apply(this,[i])),0)}return this._recordedStates.videoPlaying=!0,t}if(this.singleFrameMode)return s&&s.notTriggerSingleFrameClick||this._clickIptSingleFrameMode(),this.playCallbackInfo={width:0,height:0,deviceId:null},{width:0,height:0,deviceId:null};if(!this._video)throw new Error("'video' is null or undefined.");const o=++this.iPlayRound;if(this.promisePlay&&(yield this.promisePlay,o<this.iPlayRound))return this.playCallbackInfo={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId},{width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.promisePlay=(()=>t(this,void 0,void 0,(function*(){var s;try{this._video&&this._video.srcObject&&this.stop(),I._onLog&&I._onLog("DCE: ======before video========");const n=()=>{if(!this._video)throw h&&h.getTracks().forEach((e=>{e.stop()})),this._videoTrack=null,this._currentCamera=null,new Error("'video' is null or undefined.")},o=this.getVideoSettings();let l,h;if("boolean"==typeof o.video&&(o.video={}),e)delete o.video.facingMode,o.video.deviceId={exact:e};else if(o.video.deviceId);else if(this._lastDeviceId)delete o.video.facingMode,o.video.deviceId={exact:this._lastDeviceId};else if(this.ifSaveLastUsedCamera&&I.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete o.video.facingMode,o.video.deviceId={ideal:window.localStorage.getItem("dce_last_camera_id")};const e=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),t=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));e&&t&&(o.video.width=e,o.video.height=t)}else if(this.ifSkipCameraInspection);else if(o.video.facingMode){if(yield this.getAllCameras(!1),!this._video)throw new Error("'video' is null or undefined.");let e=o.video.facingMode;if(e instanceof Array&&e.length&&(e=e[0]),e=e.exact||e.ideal||e,"environment"===e){l=!0;const e=I.findBestRearCamera(this._allCameras);e&&(delete o.video.facingMode,o.video.deviceId={ideal:e})}}i&&(o.video.width={ideal:i}),r&&(o.video.height={ideal:r}),I._onLog&&I._onLog("DCE: ======try getUserMedia========");let d,c=[0,500],g=null;function _(e){return t(this,void 0,void 0,(function*(){for(let t of c){t&&(yield new Promise((e=>setTimeout(e,t)))),n();try{I._onLog&&I._onLog("DCE: ask "+JSON.stringify(e)),h=yield navigator.mediaDevices.getUserMedia(e);break}catch(e){g=e,I._onLog&&I._onLog("DCE: "+e.message||e)}}}))}if(yield _(o),!h){if(I._onLog&&I._onLog("DCE: ======try getUserMedia again========"),d=JSON.parse(JSON.stringify(o)),"object"==typeof d.video){["iPhone","iPad"].includes(a.OS)?(i>=1280||r>=1280?d.video.width=1280:i>=640||r>=640?d.video.width=640:(i<640||r<640)&&(d.video.width=320),delete d.video.height):l&&!o.video.deviceId?(delete d.video.facingMode,this._allCameras.length&&(d.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})):d.video=!0}I._onLog&&I._onLog("DCE: "+d),yield _(d)}if(h||(c=[1e3,2e3],yield _(o)),h||(yield _(d)),!h)throw g;const f=()=>{const e=h.getVideoTracks();let t,i;if(e.length&&(t=this._videoTrack=e[0]),this._video&&t){const e=t.getSettings();if(e)for(let r of this._allCameras)if(e.deviceId===r.deviceId){r._checked=!0,r.label=t.label,i=r;break}}this._currentCamera=i};if(yield this.getAllCameras(!1),n(),l){f();const e=I.findBestRearCamera(this._allCameras),t=null===(s=this._currentCamera)||void 0===s?void 0:s.deviceId;e&&e!=t&&(h.getTracks().forEach((e=>{e.stop()})),c=[0,500,1e3,2e3],yield _(o))}I._onLog&&I._onLog("DCE: ======play video========"),n(),yield I.playVideo(this._video,h,4e3),n(),I._onLog&&I._onLog("DCE: ======played video========"),this._bgLoading&&(this._bgLoading.style.animationPlayState="paused");const u=this._video.videoWidth+"x"+this._video.videoHeight;this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",this._video.videoWidth),this._optGotRsl.setAttribute("data-height",this._video.videoHeight),this._optGotRsl.innerText=u,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got")),I._onLog&&I._onLog("DCE: got "+u),f(),this._renderSelCameraInfo();const p={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};p.deviceId&&(this._lastDeviceId=p.deviceId,this.ifSaveLastUsedCamera&&I.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",this._lastDeviceId),o.video.width&&o.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(o.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(o.video.height)))));const m=this.mapCameraEvents.get("played");for(let e of m){if(!e)continue;const t=JSON.parse(JSON.stringify(p));setTimeout((()=>e.apply(this,[t])),0)}return this.promisePlay=null,p}catch(e){throw this.promisePlay=null,this._bgLoading&&(this._bgLoading.style.display="none"),"NotFoundError"===e.name&&(DOMException?e=new DOMException("No camera available, please use a device with an accessible camera.",e.name):(e=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),e}})))(),I._onLog&&(n=Date.now(),I._onLog("DCE: start opening camera: "+n));const l=yield this.promisePlay;return I._onLog&&I._onLog("DCE: finish opening camera. Costs: "+(Date.now()-n)),this.playCallbackInfo=JSON.parse(JSON.stringify(l)),this._recordedStates.videoPlaying=!0,l}))}resume(){return t(this,void 0,void 0,(function*(){this._assertOpen(),yield this.play(),this.ifShowScanRegionLaser&&this.showScanRegionLaser()}))}pause(){this._assertOpen(),this._video&&(this._video.pause(),this._recordedStates.videoPlaying=!1),this.ifShowScanRegionLaser&&this.hideScanRegionLaser()}_bindUI(){if(!this.UIElement)throw new Error("Need to define `UIElement` before opening.");const e=[this.UIElement];for(let t=0;t<e.length;++t)for(let i of e[t].children)e.push(i);for(let t of e){if(!this._video&&t.classList.contains(this.containerClassName)){this._elContainer=t;const e=document.createElement("video");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.objectFit=this.getVideoFit(),e.setAttribute("playsinline","true"),e.setAttribute("muted","true"),this._video=e;const i=document.createElement("div");i.append(e),i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.width="100%",i.style.height="100%",i.style.overflow="hidden",this._videoContainer=i,t.prepend(i)}else!this._divScanArea&&t.classList.contains("dce-scanarea")?this._divScanArea=t:!this._divScanLight&&t.classList.contains("dce-scanlight")?this._divScanLight=t:!this._bgLoading&&t.classList.contains("dce-bg-loading")?this._bgLoading=t:!this._bgCamera&&t.classList.contains("dce-bg-camera")?this._bgCamera=t:!this._selCam&&t.classList.contains("dce-sel-camera")?this._selCam=t:!this._selRsl&&t.classList.contains("dce-sel-resolution")?(this._selRsl=t,this.videoSrc||this.singleFrameMode||this._selRsl.options.length||(this._selRsl.innerHTML=[this._optGotRsl?"":'<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="1920" data-height="1080">1920x1080</option>','<option data-width="1280" data-height="720">1280x720</option>','<option data-width="640" data-height="480">640x480</option>'].join(""),this._optGotRsl=this._optGotRsl||this._selRsl.options[0])):!this._optGotRsl&&t.classList.contains("dce-opt-gotResolution")?this._optGotRsl=t:!this._btnClose&&t.classList.contains("dce-btn-close")?this._btnClose=t:!this._selMinLtr&&t.classList.contains("dlr-sel-minletter")?(this._selMinLtr=t,this._selMinLtr.options.length||(this._selMinLtr.innerHTML=[this._optGotMinLtr?"":'<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="17">17+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._optGotMinLtr||this._selMinLtr.options[0])):!this._optGotMinLtr&&t.classList.contains("dlr-opt-gotMinLtr")&&(this._optGotMinLtr=t);if(this.extraBindings&&this.extraBindings.length)for(let e of this.extraBindings)try{e(t)}catch(e){}}if(!this._video)throw this._unbindUI(),Error(`Can not find the video container element with class '${this.containerClassName}'`);this.singleFrameMode||this.videoSrc?(this.singleFrameMode&&(this._video&&(this._video.addEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="pointer",this._video.setAttribute("title","Take a photo")),this._bgCamera&&(this._bgCamera.style.display="block")),this._selCam&&(this._selCam.style.display="none"),this._selRsl&&(this._selRsl.style.display="none"),this._selMinLtr&&(this._selMinLtr.style.display="none")):(this._selCam&&(this._selCam.style.display="block",this._selCam.addEventListener("change",this._onCameraSelChange)),this._selRsl&&(this._selRsl.style.display="block",this._selRsl.addEventListener("change",this._onResolutionSelChange)),this._selMinLtr&&(this._selMinLtr.style.display="block"),this._bgLoading&&(this._bgLoading.style.display="block")),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),document.addEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver?(this._resizeObserver||(this._resizeObserver=new ResizeObserver((e=>{for(let t of e)t.target===this._elContainer&&this._updateLayers()}))),this._elContainer&&this._resizeObserver.observe(this._elContainer)):window.addEventListener("resize",this._updateLayers)}_unbindUI(){this.singleFrameMode?(this._video&&(this._video.removeEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="",this._video.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._bgLoading&&(this._bgLoading.style.display="none"),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this.hideScanRegionLaser(),this.hideViewDecorator(),this.hideScanRegionOverlays(),this._drawingLayersManager.setVisible(!1),this._hideOriginalImageCvs(),this._videoContainer&&this._videoContainer.remove(),this._video=null,this._videoContainer=null,this._elContainer=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this._divScanArea=null,this._divScanLight=null,this._cvsScanRegion&&(this._cvsScanRegion.remove(),this._cvsScanRegion=null),this._singleFrameModeIpt&&(this._singleFrameModeIpt.remove(),this._singleFrameModeIpt=null),this._cvsSingleFrameMode&&(this._cvsSingleFrameMode.remove(),this._cvsSingleFrameMode=null),document.removeEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver?this._resizeObserver&&this._resizeObserver.disconnect():window.removeEventListener("resize",this._updateLayers)}_assertOpen(){if(!this._bOpen)throw Error("The camera is not open.")}open(e){return t(this,void 0,void 0,(function*(){this.UIElement||(yield this.setUIElement(I.defaultUIElementURL)),this._bindUI(),e&&this.appendAndShowUI();let t=yield this.play();this.bOpen=!0;const i=this.mapCameraEvents.get("cameraOpen");for(let e of i){if(!e)continue;const i=JSON.parse(JSON.stringify(t));setTimeout((()=>e.apply(this,[i])),0)}return t}))}close(e){if(!this._video)return;this.stop(),this._hideOriginalImage(!1),this._unbindUI(),e&&this.hideUI(),this.stopFetchingLoop(),this.bOpen=!1;const t=this.mapCameraEvents.get("cameraClose");for(let e of t){if(!e)continue;const t={width:0,height:0,deviceId:null};setTimeout((()=>e.apply(this,[t])),0)}}stop(){this._video&&this._video.srcObject&&(I._onLog&&I._onLog("DCE: ======stop video========"),this._video.srcObject.getTracks().forEach((e=>{e.stop()})),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null),this._video&&this.videoSrc&&(I._onLog&&I._onLog("DCE: ======stop existing video========"),this._video.pause(),this._video.currentTime=0),this._bgLoading&&(this._bgLoading.style.animationPlayState=""),this._frameQueue.length=0,this._reusedCvs&&this._reusedCvs.ctx2d&&this._reusedCvs.ctx2d.clearRect(0,0,this._reusedCvs.width,this._reusedCvs.height),this.forceLoseContext()}getAllCameras(e=!0){return t(this,void 0,void 0,(function*(){let t=(yield navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));if(e&&t&&t.length&&!t[0].deviceId){let e=yield navigator.mediaDevices.getUserMedia({video:!0});t=(yield navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),e.getTracks().forEach((e=>{e.stop()}))}const i=[],r=[];if(this._allCameras)for(let e of this._allCameras)e._checked&&r.push(e);for(let e=0;e<t.length;e++){let s,n=t[e];for(let e of r)if(n.deviceId==e.deviceId){s=e;break}s||(s={deviceId:n.deviceId,label:n.label?n.label:"camera "+e,_checked:!1}),s.deviceId&&i.push(s)}return this._allCameras=i,I._onLog&&I._onLog("DCE: "+JSON.stringify(this._allCameras)),i}))}_renderSelCameraInfo(){if(!this._selCam)return;let e;this._selCam.textContent="";for(let t of this._allCameras){const i=document.createElement("option");i.value=t.deviceId,i.innerText=t.label,this._selCam.append(i),t.deviceId&&this._currentCamera&&this._currentCamera.deviceId==t.deviceId&&(e=i)}this._selCam.value=e?e.value:""}getSelectedCamera(){if(!this._bOpen){let e="";const t=this.videoSettings.video.deviceId;t&&(e=t.exact||t.ideal||t);for(let t of this._allCameras)if(t.deviceId===e)return JSON.parse(JSON.stringify(t));return{deviceId:e,label:"",_checked:!1}}return this._currentCamera}selectCamera(e){return t(this,void 0,void 0,(function*(){let t="";if(e&&(t=e.deviceId||e),this.videoSettings.video.deviceId={exact:t},!this._bOpen||this._video.paused)return null;let i=null;this._currentCamera&&(i=this._currentCamera.deviceId);const r=this._video.videoWidth,s=this._video.videoHeight,n=yield this.play(e.deviceId||e);if(i!==n.deviceId){const e=this.mapCameraEvents.get("cameraChange");for(let t of e){if(!t)continue;const e=JSON.parse(JSON.stringify(n));setTimeout((()=>t.apply(this,[e])),0)}}if(r!==n.width||s!==n.height){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateDrawingLayersSize(),this._updateVideoContainerStyle();const e=this.mapCameraEvents.get("resolutionChange");for(let t of e){if(!t)continue;const e=JSON.parse(JSON.stringify(n));setTimeout((()=>t.apply(this,[e])),0)}}return n}))}getResolution(){if(this._bOpen)return[this._video.videoWidth,this._video.videoHeight];{let e=0,t=0;const i=this.videoSettings.video.width,r=this.videoSettings.video.height;return i&&(e=i.exact||i.ideal||i),r&&(t=r.exact||r.ideal||r),[e,t]}}setResolution(e,i){return t(this,void 0,void 0,(function*(){let t,r;if(e instanceof Array?(t=e[0],r=e[1]):(t=e,r=i),this.videoSettings.video.width={ideal:t},this.videoSettings.video.height={ideal:r},!this._bOpen||this._video.paused)return null;const s=this._video.videoWidth,n=this._video.videoHeight,o=yield this.play(null,t,r);if(s!==o.width||n!==o.height){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._updateDrawingLayersSize(),this._updateVideoContainerStyle();const e=this.mapCameraEvents.get("resolutionChange");for(let t of e){if(!t)continue;const e=JSON.parse(JSON.stringify(o));setTimeout((()=>t.apply(this,[e])),0)}}return o}))}getResolutions(e){return t(this,void 0,void 0,(function*(){let i="";const r=(e,t)=>{const i=this._mapCameraResolutions.get(e);if(!i||!i.length)return!1;for(let e of i)if(e[0]===t.width&&e[1]===t.height)return!0;return!1},s=(e,i,r)=>t(this,void 0,void 0,(function*(){const t={video:{deviceId:{exact:e},width:{ideal:i},height:{ideal:r}}};let s=null;try{s=yield navigator.mediaDevices.getUserMedia(t)}catch(e){return null}if(!s)return null;const n=s.getVideoTracks();let o=null;try{const e=n[0].getSettings();o={width:e.width,height:e.height}}catch(e){const t=document.createElement("video");t.srcObject=s,o={width:t.videoWidth,height:t.videoHeight},t.srcObject=null}return n.forEach((e=>{e.stop()})),o}));if(!this._bOpen){const t=this.videoSettings.video.deviceId;if(!t)return null;if(i=t.hasOwnProperty("exact")?this.videoSettings.video.deviceId.exact:t.hasOwnProperty("ideal")?this.videoSettings.video.deviceId.ideal:this.videoSettings.video.deviceId,!i)return null;let n=this._mapCameraResolutions.get(i);if(n&&!e)return this._mapCameraResolutions.get(i);this._mapCameraResolutions.set(i,[]),n=this._mapCameraResolutions.get(i);for(let e of this._predefinedResolutions){const t=yield s(i,e.width,e.height);t&&!r(i,t)&&n.push([t.width,t.height])}return n}if(this._currentCamera){i=this._currentCamera.deviceId;let t=this._mapCameraResolutions.get(i);if(t&&!e)return this._mapCameraResolutions.get(i);this._mapCameraResolutions.set(i,[]),t=this._mapCameraResolutions.get(i);const s=this.getConstraints();for(let e of this._predefinedResolutions){yield this._videoTrack.applyConstraints({width:{ideal:e.width},height:{ideal:e.height}});const s=this._videoTrack.getSettings(),n={width:s.width,height:s.height};r(i,n)||t.push([n.width,n.height])}return yield this._videoTrack.applyConstraints(s),t}return null}))}on(e,t){if(!this.mapCameraEvents.has(e))throw new Error(`Event '${e}' does not exist.`);const i=this.mapCameraEvents.get(e);i.includes(t)||i.push(t)}off(e,t){if(!this.mapCameraEvents.has(e))throw new Error(`Event '${e}' does not exist.`);const i=this.mapCameraEvents.get(e),r=i.indexOf(t);-1!==r&&i.splice(r,1)}offAll(e){if(e){if("string"==typeof e){const t=this.mapCameraEvents.get(e);t&&(t.length=0)}}else for(let e of this.mapCameraEvents.values())e&&(e.length=0)}getVideoSettings(){return JSON.parse(JSON.stringify(this.videoSettings))}updateVideoSettings(e){if(this.videoSettings=JSON.parse(JSON.stringify(e)),this._lastDeviceId=null,this._bOpen)return this.play()}isOpen(){return this._bOpen}getCapabilities(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCapabilities()' is unavailable in singleFrameMode.");return this._videoTrack&&this._videoTrack.getCapabilities?this._videoTrack.getCapabilities():{}}getCameraSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCameraSettings()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings():null}getConstraints(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getConstraints()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getConstraints():null}applyConstraints(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'applyConstraints()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');if(!this._videoTrack.applyConstraints)throw Error("Not supported.");return yield this._videoTrack.applyConstraints(e)}))}turnOnTorch(){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOnTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!0}]});throw Error("Not supported.")}))}turnOffTorch(){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOffTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!1}]});throw Error("Not supported.")}))}setColorTemperature(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setColorTemperature()' is unavailable in singleFrameMode.");let t=this.getCapabilities().colorTemperature;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({advanced:[{colorTemperature:e}]})}))}getColorTemperature(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getColorTemperature()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().colorTemperature||0:null}setExposureCompensation(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setExposureCompensation()' is unavailable in singleFrameMode.");let t=this.getCapabilities().exposureCompensation;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({advanced:[{exposureCompensation:e}]})}))}getExposureCompensation(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getExposureCompensation()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().exposureCompensation||0:null}setZoom(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");if(e<1)throw new RangeError("Invalid value.");try{yield this._setHardwareScale(e);const t=this._getHardwareScale();e!==t?this._setSoftwareScale(e/t):this._setSoftwareScale(1)}catch(t){if("Not supported."!==(t.message||t))throw t;this._setSoftwareScale(e)}}))}getZoom(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getZoom()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;return this._getHardwareScale()*this._softwareScale}setFrameRate(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFrameRate()' is unavailable in singleFrameMode.");let t=this.getCapabilities().frameRate;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({width:{ideal:Math.max(this._video.videoWidth,this._video.videoHeight)},frameRate:e})}))}getFrameRate(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrameRate()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().frameRate:null}setFocus(e,i){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");const t=this.getCapabilities().focusMode,r=this.getCapabilities().focusDistance;if(!t||!t.includes(e)||!r)throw Error("Not supported.");return i?(i<r.min?i=r.min:i>r.max&&(i=r.max),yield this._videoTrack.applyConstraints({advanced:[{focusMode:e,focusDistance:i}]})):yield this._videoTrack.applyConstraints({advanced:[{focusMode:e}]})}))}getFocus(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;const e=this._videoTrack.getSettings().focusMode;return e?"continuous"===e?{mode:e}:{mode:e,distance:this._videoTrack.getSettings().focusDistance}:null}_setHardwareScale(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setHardwareScale()' is unavailable in singleFrameMode.");if(e<1)throw new RangeError("Invalid value.");if(!this._videoTrack)return;if(!this.getCapabilities().zoom)throw new Error("Not supported.");yield this._videoTrack.applyConstraints({advanced:[{zoom:e}]})}))}_getHardwareScale(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().zoom||1:null}_setSoftwareScale(e){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setSoftwareScale()' is unavailable in singleFrameMode.");if(e<1)throw new RangeError("Invalid value.");this._softwareScale=e,this._scaleVideo(e)}_getSoftwareScale(){return this._softwareScale}_updateVideoContainerStyle(){if(!this._video)return;if(this.singleFrameMode)return;const e=this._getSoftwareScale(),t=this._videoContainer;if("contain"===this.videoFit&&e>1){const e=this._video.videoWidth,i=this._video.videoHeight,r=window.getComputedStyle(this._elContainer),s=parseFloat(r.width),n=parseFloat(r.height),o=e/i;if(s/n<o){let e=s/o;t.style.left="0",t.style.top=(n-e)/2+"px",t.style.width="100%",t.style.height=e+"px"}else{let e=n*o;t.style.left=(s-e)/2+"px",t.style.top="0",t.style.width=e+"px",t.style.height="100%"}}else t.style.left="0",t.style.top="0",t.style.width="100%",t.style.height="100%"}_scaleVideo(e){if(this._video&&!this.singleFrameMode){if(e<1)throw new RangeError("Invalid value.");this._video.style.transform=1===e?"":`scale(${e})`,this._updateVideoContainerStyle()}}getFrameSize(e,t,i,r){if(!e||!t)return null;let s,n,o,a,l=e,h=t;const d={regionLeft:0,regionTop:0,regionRight:l,regionBottom:h,regionMeasuredByPercentage:!1};i?(i.regionMeasuredByPercentage?(d.regionLeft=i.regionLeft*l/100,d.regionTop=i.regionTop*h/100,d.regionRight=i.regionRight*l/100,d.regionBottom=i.regionBottom*h/100):(d.regionLeft=i.regionLeft,d.regionTop=i.regionTop,d.regionRight=i.regionRight,d.regionBottom=i.regionBottom),s=d.regionLeft,n=d.regionTop,l=Math.round(d.regionRight-d.regionLeft),h=Math.round(d.regionBottom-d.regionTop)):(s=0,n=0);const c=Math.max(l,h);if(r&&r>0&&c>r){const e=r/c;l>h?(o=r,a=Math.round(h*e)):(o=Math.round(l*e),a=r)}else o=l,a=h;return o<=0||a<=0?null:{sx:s,sy:n,sWidth:l,sHeight:h,dWidth:o,dHeight:a}}getFrame(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrame()' is unavailable in singleFrameMode.");return this._getVideoData()}getImage(){return this.getFrame()}_drawImage(e,t,i,r,s,n,o){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!i||!r)return null;if(t instanceof HTMLVideoElement&&4!==t.readyState||t instanceof HTMLImageElement&&!t.complete)throw new Error("The source is not loaded.");let a;I._onLog&&(a=Date.now(),I._onLog("DCE: _drawImage(), START: "+a));let l=0,h=0,d=i,c=r,g=0,_=0,f=i,u=r;s&&(s.sx&&(l=s.sx),s.sy&&(h=s.sy),s.sWidth&&(d=s.sWidth),s.sHeight&&(c=s.sHeight),s.dx&&(g=s.dx),s.dy&&(_=s.dy),s.dWidth&&(f=s.dWidth),s.dHeight&&(u=s.dHeight));let p=L.RGBA;o&&o.pixelFormat&&(p=o.pixelFormat);const m=e;if(o&&o.bUseWebGL){I._onLog&&I._onLog("DCE: _drawImage() in WebGL."),(m.width<g+f||m.height<_+u)&&(m.width=g+f,m.height=_+u,m.ctxWebGL&&m.ctxWebGL.viewport(0,0,g+f,_+u));const e=m.ctxWebGL||m.getContext("webgl",{antialias:!1})||m.getContext("experimental-webgl",{antialias:!1});if(!e){I._onLog&&I._onLog("DCE: WebGL unavailable.");const e=new Error("WebGL error: unable to initialize WebGL. Your browser or machine may not support it.");throw e.name="WebGLError",e}if(!m.ctxWebGL||p!==this.shaderPixelFormat){m.ctxWebGL=e;const t=e=>{const t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t);e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW);const i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i);return e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW),{positions:t,texCoords:i}},i=e=>{const t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t},r=(e,t)=>{const i=e.createProgram();if(t.forEach((t=>e.attachShader(i,t))),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS)){const t=new Error(`An error occured linking the program: ${e.getProgramInfoLog(i)}.`);throw t.name="WebGLError",t}return e.useProgram(i),i},s=(e,t,i)=>{const r=e.createShader(t);if(e.shaderSource(r,i),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){const t=new Error(`An error occured compiling the shader: ${e.getShaderInfoLog(r)}.`);throw t.name="WebGLError",t}return r},n="\n                    attribute vec2 a_position;\n                    attribute vec2 a_texCoord;\n\n                    uniform mat3 u_matrix;\n                    uniform mat3 u_textureMatrix;\n\n                    varying vec2 v_texCoord;\n                    void main(void) {\n                    gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1.0);\n                    v_texCoord = vec4((u_textureMatrix * vec3(a_texCoord, 1)).xy, 0, 1.0).xy;\n                    }\n                ";let o="rgb";["rgba","rbga","grba","gbra","brga","bgra"].includes(p)&&(o=p.slice(0,3));const a=`\n                    precision mediump float;\n                    varying vec2 v_texCoord;\n                    uniform sampler2D u_image;\n                    uniform float uColorFactor;\n\n                    void main() {\n                        vec4 sample = texture2D(u_image, v_texCoord);\n                        float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                        gl_FragColor = vec4(sample.${o} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                    }\n                `,l=r(e,[s(e,e.VERTEX_SHADER,n),s(e,e.FRAGMENT_SHADER,a)]);this._webGLProgramInfo={program:l,attribLocations:{vertexPosition:e.getAttribLocation(l,"a_position"),texPosition:e.getAttribLocation(l,"a_texCoord")},uniformLocations:{uSampler:e.getUniformLocation(l,"u_image"),uColorFactor:e.getUniformLocation(l,"uColorFactor"),uMatrix:e.getUniformLocation(l,"u_matrix"),uTextureMatrix:e.getUniformLocation(l,"u_textureMatrix")}},this._webGLBuffers=t(e),this._webGLTexture=i(e),this.shaderPixelFormat=p}const s=(e,t,i)=>{e.bindBuffer(e.ARRAY_BUFFER,t),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0)},o=(e,t,i)=>{const r=e.RGBA,s=e.RGBA,n=e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,r,s,n,i)},v=(e,t,n,o)=>{e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),s(e,n.positions,t.attribLocations.vertexPosition),s(e,n.texCoords,t.attribLocations.texPosition),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o),e.uniform1i(t.uniformLocations.uSampler,0),e.uniform1f(t.uniformLocations.uColorFactor,[L.GREY,L.GREY32].includes(p)?1:0);let a,m,v=C.translate(C.identity(),-1,-1);v=C.scale(v,2,2),v=C.scale(v,1/e.canvas.width,1/e.canvas.height),a=C.translate(v,g,_),a=C.scale(a,f,u),e.uniformMatrix3fv(t.uniformLocations.uMatrix,!1,a),m=C.translate(C.identity(),l/i,h/r),m=C.scale(m,d/i,c/r),e.uniformMatrix3fv(t.uniformLocations.uTextureMatrix,!1,m),e.drawArrays(e.TRIANGLES,0,6)};let y;if(o(e,this._webGLTexture,t),v(e,this._webGLProgramInfo,this._webGLBuffers,this._webGLTexture),n){if(n.length<f*u*4)throw new Error("Unexpected size of the 'bufferContainer'.");y=n}else y=new Uint8Array(f*u*4);if(e.readPixels(g,_,f,u,e.RGBA,e.UNSIGNED_BYTE,y),255!==y[3]){I._onLog&&I._onLog("DCE: WebGL drawing incorrect."),this._bWebGLSupported=!1;const e=new Error("WebGL error: incorrect WebGL drawing.");throw e.name="WebGLError",e}return I._onLog&&I._onLog("DCE: _drawImage() in WebGL end. Costs: "+(Date.now()-a)),{context:e,pixelFormat:p===L.GREY?L.GREY32:p,_bUseWebGL:!0}}{I._onLog&&I._onLog("DCE: _drawImage() in canvas."),m.ctx2d||(m.ctx2d=m.getContext("2d",{willReadFrequently:!0}));const e=m.ctx2d;if(!e)throw new Error("Unable to get 'CanvasRenderingContext2D' from canvas.");return(m.width<g+f||m.height<_+u)&&(m.width=g+f,m.height=_+u),e.drawImage(t,l,h,d,c,g,_,f,u),I._onLog&&I._onLog("DCE: _drawImage() in canvas end. Costs: "+(Date.now()-a)),{context:e,pixelFormat:L.RGBA,_bUseWebGL:!1}}}_readCvsData(e,t,i){let r,s=0,n=0,o=e.canvas.width,a=e.canvas.height;if(t&&(t.x&&(s=t.x),t.y&&(n=t.y),t.width&&(o=t.width),t.height&&(a=t.height)),e instanceof WebGLRenderingContext){const t=e;if(i){if(i.length<o*a*4)throw new Error("Unexpected size of the 'bufferContainer'.");t.readPixels(s,n,o,a,t.RGBA,t.UNSIGNED_BYTE,i),r=new Uint8Array(i.buffer,0,o*a*4)}else r=new Uint8Array(o*a*4),t.readPixels(s,n,o,a,t.RGBA,t.UNSIGNED_BYTE,r)}else if(e instanceof CanvasRenderingContext2D){let t;if(t=e.getImageData(s,n,o,a),r=new Uint8Array(t.data.buffer),i){if(i.length<r.length)throw new Error("Unexpected size of the 'bufferContainer'.");i.set(r)}}return r}_transformPixelFormat(e,t,i,r){let s,n;if(I._onLog&&(s=Date.now(),I._onLog("DCE: _transformPixelFormat(), START: "+s)),t===i)return I._onLog&&I._onLog("DCE: _transformPixelFormat() end. Costs: "+(Date.now()-s)),r?new Uint8Array(e):e;const o=[L.RGBA,L.RBGA,L.GRBA,L.GBRA,L.BRGA,L.BGRA];if(o.includes(t))if(i===L.GREY){n=new Uint8Array(e.length/4);for(let t=0;t<e.length;t+=4){const i=.21*e[t]+.71*e[t+1]+.07*e[t+2];n[t/4]=i}}else if(i===L.GREY32){n=r?new Uint8Array(e):e;for(let t=0;t<e.length;t+=4){const i=.21*e[t]+.71*e[t+1]+.07*e[t+2];n[t]=i,n[t+1]=i,n[t+2]=i}}else{if(!o.includes(i))throw new Error("Unable to transform.");if(r){n=new Uint8Array(e);const r=t.indexOf("r"),s=t.indexOf("g"),o=t.indexOf("b"),a=i.indexOf("r"),l=i.indexOf("g"),h=i.indexOf("b");for(let t=0;t<e.length;t+=4)n[t+a]=e[t+r],n[t+l]=e[t+s],n[t+h]=e[t+o]}else{n=e;const r=t.indexOf("r"),s=t.indexOf("g"),o=t.indexOf("b"),a=i.indexOf("r"),l=i.indexOf("g"),h=i.indexOf("b");for(let t=0;t<e.length;t+=4){let i=[e[t],e[t+1],e[t+2]];n[t+a]=i[r],n[t+l]=i[s],n[t+h]=i[o]}}}else if(t===L.GREY){if(i!==L.GREY32)throw new Error("Unable to transform.");n=new Uint8Array(4*e.length);for(let t=0;t<e.length;t++)n[4*t]=e[t],n[4*t+1]=e[t],n[4*t+2]=e[t],n[4*t+3]=255}else{if(t!==L.GREY32)throw new Error("Unable to transform.");if(i!==L.GREY)throw new Error("Unable to transform.");n=new Uint8Array(new Uint32Array(e.buffer))}return I._onLog&&I._onLog("DCE: _transformPixelFormat() end. Costs: "+(Date.now()-s)),n}_getImageData(e,t,i,r,s,n){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!t||!i)return null;if(e instanceof HTMLVideoElement&&4!==e.readyState||e instanceof HTMLImageElement&&!e.complete)throw new Error("The source is not loaded.");let o;I._onLog&&(o=Date.now(),I._onLog("DCE: _getImageData(), START: "+o));const a=n&&n.pixelFormat,l=this._bWebGLSupported;let h,d,c;l?(this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas")),h=this._reusedWebGLCvs):(this._reusedCvs||(this._reusedCvs=document.createElement("canvas")),h=this._reusedCvs);try{if(l)if(I._onLog&&I._onLog("DCE: _getImageData() in WebGL."),s)if(a===L.GREY){if(c=new Uint8Array(r.dWidth*r.dHeight*4),d=this._drawImage(h,e,t,i,r,c,{pixelFormat:a,bUseWebGL:l}),c=this._transformPixelFormat(c,d.pixelFormat,a),s){if(s.length<c.length)throw new Error("Unexpected size of the 'bufferContainer'.");s.set(c)}}else d=this._drawImage(h,e,t,i,r,s,{pixelFormat:a,bUseWebGL:l}),c=new Uint8Array(s.buffer,0,r.dWidth*r.dHeight*4),c=this._transformPixelFormat(c,d.pixelFormat,a);else a===L.GREY?((!this._tempDataContainer||this._tempDataContainer.length<r.dWidth*r.dHeight*4)&&(this._tempDataContainer=new Uint8Array(r.dWidth*r.dHeight*4)),c=new Uint8Array(this._tempDataContainer.buffer,0,r.dWidth*r.dHeight*4)):c=new Uint8Array(r.dWidth*r.dHeight*4),d=this._drawImage(h,e,t,i,r,c,{pixelFormat:a,bUseWebGL:l}),c=this._transformPixelFormat(c,d.pixelFormat,a);else if(I._onLog&&I._onLog("DCE: _getImageData() in context2d."),d=this._drawImage(h,e,t,i,r,null,{pixelFormat:L.RGBA,bUseWebGL:l}),c=this._readCvsData(d.context,null,null),c=this._transformPixelFormat(c,d.pixelFormat,a),s){if(s.length<c.length)throw new Error("Unexpected size of the 'bufferContainer'.");s.set(c)}}catch(o){if("WebGLError"===o.name)return I._onLog&&I._onLog("DCE: _getImageData() in WebGL failed, try again in context2d."),this.forceLoseContext(),this._bWebGLSupported=!1,this._getImageData(e,t,i,r,s,n);throw o}return I._onLog&&I._onLog("DCE: _getImageData() end. Costs: "+(Date.now()-o)),{data:c,pixelFormat:a,_bUseWebGL:d._bUseWebGL}}_getVideoData(e,t){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getVideoData()' is unavailable in singleFrameMode.");if(!this._video||4!==this._video.readyState)return null;const i=Date.now();I._onLog&&I._onLog("DCE: _getVideoData() START: "+i);let r=this._scanRegion;t&&t.hasOwnProperty("region")&&(r=t.region);let s=this.mapPixelFormatString_Enum.get(this.framePixelFormat.toLowerCase());t&&t.pixelFormat&&(s=this.mapPixelFormatString_Enum.get(t.pixelFormat.toLowerCase()));let n=this._softwareScale;t&&t.scale&&(n=t.scale);const o=this._video.videoWidth,a=this._video.videoHeight;if(0===o||0===a)return null;const l=this.getFrameSize(o,a,r,this.maxCvsSideLength);if(!l)return null;let h=!0;o===l.sWidth&&a===l.sHeight&&(h=!1);const d={data:null,region:r?JSON.parse(JSON.stringify(r)):null,sx:l.sx,sy:l.sy,width:l.dWidth,height:l.dHeight,colorMode:null,pixelFormat:null,timeSpent:null,timeStamp:null,isCropped:h,toCanvas:this._toCanvas,_sWidth:l.sWidth,_sHeight:l.sHeight,_bUseWebGL:null};1!==n&&(l.sWidth=l.sWidth/n,l.sHeight=l.sHeight/n,l.sx=(1-1/n)*o/2+l.sx/n,l.sy=(1-1/n)*a/2+l.sy/n);const c=this._getImageData(this._video,o,a,l,e,{pixelFormat:s});if(!c)return null;const g=Date.now();if(I._onLog&&I._onLog("DCE: _getVideoData() END: "+g),d.data=c.data,d.pixelFormat=d.colorMode=c.pixelFormat,d._bUseWebGL=c._bUseWebGL,d.timeSpent=g-i,d.timeStamp=g,c.pixelFormat===L.GREY)d.stride=d.width;else d.stride=4*d.width;return d}getCurrentRegion(){let e=null;if(this._scanRegion)e=this._scanRegion;else if(this.croppingRegions){if(this._croppingRegionIndex>=this.croppingRegions.length||this._croppingRegionIndex<0)throw new Error("The 'croppingRegionIndex' is out of bounds.");e=this.croppingRegions[this._croppingRegionIndex],this.bIncreaseRegionIndexAuto&&++this._croppingRegionIndex>=this.croppingRegions.length&&(this._croppingRegionIndex=0)}return e}_fetchingLoop(e){if(this.isDisposed&&this.disposed)return;if(!this._bOpen||!this.isFetchingLoopStarted())return void this.stopFetchingLoop();const t=()=>{I._onLog&&I._onLog("DCE: start fetching a frame into buffer: "+Date.now());const e=this.getCurrentRegion();let t=this._getVideoData(null,{region:e});if(!t)return void(I._onLog&&I._onLog("DCE: get a invalid frame, abandon it: "+Date.now()));for(;this._frameQueue&&this._frameQueue.length>=this.maxNumberOfFramesInBuffer;)this._frameQueue.shift();this._frameQueue.push(t),I._onLog&&I._onLog("DCE: finish fetching a frame into buffer: "+Date.now());const i=this.mapCameraEvents.get("frameAddedToBuffer");for(let e of i)e&&setTimeout(e.bind(this),0)},i=()=>{this.isDisposed&&this.disposed||(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this.refreshInterval<=0||(this._frameLoopTimeoutId2=setTimeout((()=>{this.isDisposed&&this.disposed||(this._bOpen&&this.isFetchingLoopStarted()?(I._onLog&&I._onLog("DCE: second timeout executes: "+Date.now()),t(),i()):this.stopFetchingLoop())}),this.refreshInterval)))};e&&(this._frameQueue.length<this.maxNumberOfFramesInBuffer?(t(),this.refreshInterval>0&&i()):this.refreshInterval>0?(t(),i()):0===this.refreshInterval?t():this.refreshInterval),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameLoopTimeoutId=setTimeout((()=>{this.isDisposed&&this.disposed||this._fetchingLoop(!0)}),this.loopInterval)}startFetchingLoop(){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw Error("'startFetchingLoop()' is unavailable in singleFrameMode.");this.isFetchingLoopStarted()||(this._bFetchingLoopStarted=!0,this._recordedStates.fetchingLoopStart=!0,I._onLog&&I._onLog("DCE: start fetching loop: "+Date.now()),this._fetchingLoop(!0))}isFetchingLoopStarted(){return this._bFetchingLoopStarted}stopFetchingLoop(){this._bFetchingLoopStarted&&(I._onLog&&I._onLog("DCE: stop fetching loop: "+Date.now()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameQueue.length=0,this._bFetchingLoopStarted=!1,this._recordedStates.fetchingLoopStart=!1)}getFrameFromBuffer(e){return this._frameQueue&&this._frameQueue.length?e?e<this._frameQueue.length?(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.splice(e,1)[0]):void 0:(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.pop()):null}forceLoseContext(){if(!this._reusedWebGLCvs)return;const e=this._reusedWebGLCvs.ctxWebGL;e&&!e.isContextLost()&&e.getExtension("WEBGL_lose_context")&&e.getExtension("WEBGL_lose_context").loseContext(),this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._reusedWebGLCvs=null}_createDrawingLayerBaseCvs(){this._assertOpen();const e=this._calculateCvsSize();if(!e)throw new Error("Camera is not open.");const{width:t,height:i,objectFit:r}=e;if(t<=0||i<=0)throw new Error("Invalid dimension of video or image.");const s=document.createElement("canvas");if(s.width==t&&s.height==i||(s.width=t,s.height=i),s.style.objectFit=r,this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.before(s);else if(this._cvsScanRegion)this._cvsScanRegion.before(s);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(s);else{if(!this._videoContainer)throw new Error("'_video' is lost.");this._videoContainer.after(s)}return s}_updateDrawingLayersSize(e){let t;if(t=e&&e.width&&e.height&&e.objectFit?{width:e.width,height:e.height,objectFit:e.objectFit}:this._calculateCvsSize(),!t)return;const{width:i,height:r,objectFit:s}=t;this._drawingLayersManager.setDimensions({width:i,height:r},{backstoreOnly:!0}),this._drawingLayersManager.setObjectFit(s)}_createDrawingLayer(e){this._layerBaseCvs||(this._layerBaseCvs=this._createDrawingLayerBaseCvs());const t=this._layerBaseCvs;return this._drawingLayersManager.createDrawingLayer(t,e)}createDrawingLayer(){return this._createDrawingLayer()}getDrawingLayer(e){const t=this._drawingLayersManager.getDrawingLayer(e);return t||([1,2,3].includes(e)?this._createDrawingLayer(e):null)}getDrawingLayers(){return this._drawingLayersManager.getDrawingLayers()}getSelectedDrawingItems(){return this._drawingLayersManager.getSelectedDrawingItems()}createDrawingStyle(e){return this._drawingLayersManager.createDrawingStyle(e)}getDrawingStyle(e){return this._drawingLayersManager.getDrawingStyle(e)}getDrawingStyles(){return this._drawingLayersManager.getDrawingStyles()}updateDrawingStyle(e,t){return this._drawingLayersManager.updateDrawingStyle(e,t)}clearDrawingLayers(){this._drawingLayersManager.clearDrawingLayers(),this._layerBaseCvs&&(this._layerBaseCvs.remove(),this._layerBaseCvs=null)}_createControler(){if(this._controler||(this._controler=new S(this)),this._controler)return this._controler}_destroyControler(){this._controler=null}setOriginalImage(e,t,i){if(!e||!t||!i)throw new Error("Invalid arguments");this._originalImageData={imageData:e,width:t,height:i};let r=this._cvsOriginalImage;r||(r=document.createElement("canvas"),r.style.position="absolute",r.style.width="100%",r.style.height="100%",r.style.left="0",r.style.top="0",r.style.backgroundColor="white",r.style.objectFit="contain",this._cvsOriginalImage=r),r.width===t&&r.height===i||(r.width=t,r.height=i);const s=r.getContext("2d");s.clearRect(0,0,r.width,r.height),e instanceof Uint8Array||e instanceof Uint8ClampedArray?(e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),s.putImageData(new ImageData(e,t,i),0,0)):e instanceof HTMLCanvasElement&&s.drawImage(e,0,0),document.body.contains(r)&&""===r.style.display&&this._updateDrawingLayersSize({width:t,height:i,objectFit:"contain"})}getOriginalImage(){return this._originalImageData?Object.assign({},this._originalImageData):null}deleteOriginalImage(){return t(this,void 0,void 0,(function*(){yield this.hideOriginalImage(),this._cvsOriginalImage&&(this._cvsOriginalImage.remove(),this._cvsOriginalImage=null),this._originalImageData=null}))}_showOriginalImageCvs(){this._cvsOriginalImage&&"none"==this._cvsOriginalImage.style.display&&(this._cvsOriginalImage.style.display="")}_hideOriginalImageCvs(){this._cvsOriginalImage&&(this._cvsOriginalImage.style.display="none")}showOriginalImage(){if(!this._originalImageData)throw new Error("No original image is set.");const e=this._cvsOriginalImage;if(""===e.style.display&&document.body.contains(e))return;const{width:t,height:i}=this._originalImageData;if(this._updateDrawingLayersSize({width:t,height:i,objectFit:"contain"}),this._bOpen&&(this._video&&!this._video.paused&&this._video.pause(),this._bFetchingLoopStarted&&(this.stopFetchingLoop(),this._recordedStates.fetchingLoopStart=!0),this.ifShowScanRegionMask&&this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this.ifShowScanRegionLaser&&this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none"),this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none"),this._selCam&&(this._selCam.parentElement.style.display="none")),!document.body.contains(e))if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(e);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(e)}this._showOriginalImageCvs()}_hideOriginalImage(e){return t(this,void 0,void 0,(function*(){this._originalImageData&&this._cvsOriginalImage&&"none"!==this._cvsOriginalImage.style.display&&(this._updateDrawingLayersSize(),this._bOpen&&e&&(this._video&&this._recordedStates.videoPlaying&&(yield this.play(null,null,null,{notTriggerSingleFrameClick:!0})),this._recordedStates.fetchingLoopStart&&!this.singleFrameMode&&this.startFetchingLoop(),this.ifShowScanRegionMask&&this._cvsScanRegion&&this._recordedStates.maskShow&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this._divScanLight&&this._recordedStates.laserShow&&this.showScanRegionLaser(),this._cvsViewDecorator&&this._recordedStates.decoratorShow&&this.showViewDecorator(),this._scanRegionOverlayContainer&&this._recordedStates.overlayShow&&this.showScanRegionOverlays()),this._selCam&&(this._selCam.parentElement.style.display=""),this._hideOriginalImageCvs())}))}hideOriginalImage(){return t(this,void 0,void 0,(function*(){return this._hideOriginalImage(!0)}))}dispose(e){this.UIElement&&(this._uiOriginalState&&this._uiOriginalState.inDom?this.UIElement.style.display=this._uiOriginalState.display:this.UIElement.style.display="none"),this.clearDrawingLayers(),this.close(),this.forceLoseContext(),this.setViewDecorator(null,null),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.remove(),this._arrScanRegionOverlays.length=0,e&&this.UIElement&&this.UIElement.remove(),this.__proto__=null;for(let e in this)delete this[e];Object.defineProperty(this,"isCameraEnhancer",{value:!0}),Object.defineProperty(this,"isDisposed",{value:!0}),Object.defineProperty(this,"disposed",{value:!0})}}I._jsVersion="3.1.0",I._jsEditVersion="20221019",I._version="JS "+I._jsVersion+"."+I._jsEditVersion,I.browserInfo=a,I._hasEngineResourceLoaded=!1,I._engineResourcePath=g,I._defaultUIElementURL="@engineResourcePath/dce.ui.html";const E={DT_Arc:class extends _{constructor(t,i,r,s,n,o){super(new e.Circle({left:t,top:i,radius:r,startAngle:s,endAngle:n}),o),this._mediaType="arc"}},DT_Polygon:v,DT_Rect:class extends _{constructor(t,i,r,s,n){super(new e.Rect({left:t,top:i,width:r,height:s}),n)}},DT_Image:class extends _{constructor(t,i,r,s){super(new e.Image(t,{left:i,top:r}),s),this.image=t}_extendSet(e,t){if("image"===e){if(t instanceof HTMLImageElement)return this._fabricObject.setElement(t),this.image=t,!0;if(t instanceof HTMLCanvasElement){const e=new Image;return e.src=t.toDataURL(),this._fabricObject.setElement(e),this.image=t,!0}throw new Error("Unsupported value.")}}_extendGet(e){if("image"===e)return this.image}},DT_Text:class extends _{constructor(t,i,r,s,n){if("number"!=typeof s||s<=0)throw new RangeError("Invalid width.");super(new e.Textbox(y(t),{left:i,top:r,width:s,splitByGrapheme:!0}),n),this._mediaType="text",this._text=t}_extendSet(e,t){if("text"===e)return this._text=t,this._fabricObject.set("text",y(t)),!0}_extendGet(e){if("text"===e)return this._text}},DT_Line:class extends v{constructor(e,t,i){super([e,t],i),this._mediaType="line"}_extendSet(t,i){if("startPoint"===t||"endPoint"===t){i="startPoint"===t?[i,this.get("endPoint")]:[this.get("startPoint"),i];const r=this._fabricObject;if(r.group){const e=r.group;r.points=i.map((t=>({x:t.x-e.left-e.width/2,y:t.y-e.top-e.height/2}))),e.addWithUpdate()}else r.points=i;const s=r.points.length-1;return r.controls=r.points.reduce((function(t,i,r){return t["p"+r]=new e.Control({positionHandler:f,actionHandler:m(r>0?r-1:s,p),actionName:"modifyPolygon",pointIndex:r}),t}),{}),r._setPositionDimensions({}),!0}}_extendGet(t){if("startPoint"===t||"endPoint"===t){const i=[],r=this._fabricObject;if(r.selectable&&!r.group)for(let e in r.oCoords)i.push({x:r.oCoords[e].x,y:r.oCoords[e].y});else for(let t of r.points){let s=t.x-r.pathOffset.x,n=t.y-r.pathOffset.y;const o=e.util.transformPoint({x:s,y:n},r.calcTransformMatrix());i.push({x:o.x,y:o.y})}return"startPoint"===t?i[0]:i[1]}}},DT_Group:class extends _{constructor(t){super(new e.Group(t.map((e=>e._getFabricObject())))),this._fabricObject.on("selected",(()=>{this.styleSelector="selected";const e=this._fabricObject._objects;for(let t of e)setTimeout((()=>{t&&t.fire("selected")}),0);setTimeout((()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())}),0)})),this._fabricObject.on("deselected",(()=>{this.styleSelector="default";const e=this._fabricObject._objects;for(let t of e)setTimeout((()=>{t&&t.fire("deselected")}),0);setTimeout((()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())}),0)}))}getChildItems(){return this._fabricObject._objects.map((e=>e.getDrawingItem()))}addChildItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");this._drawingLayer?this._drawingLayer._updateGroupItem(this,e,"add"):this._fabricObject.addWithUpdate(e._getFabricObject())}removeChildItem(e){e&&e.isDrawingItem&&(this._drawingLayer?this._drawingLayer._updateGroupItem(this,e,"remove"):this._fabricObject.removeWithUpdate(e._getFabricObject()))}}};export{I as CameraEnhancer,E as DrawingItem};
