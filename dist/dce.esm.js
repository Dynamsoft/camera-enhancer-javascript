/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2023, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 4.0.0
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */
import{_isDSImageData as e,_isDSRect as t,_isRect as i,_isLineSegment as s,_isPolygon as r,_isQuad as n,_isPoint as a,EnumImagePixelFormat as o,EnumCapturedResultItemType as h,ImageSourceAdapter as l,EnumImageTagType as d,IntermediateResultReceiver as c,EnumIntermediateResultUnitType as f,EnumBufferOverflowProtectionMode as g}from"dynamsoft-core";import{fabric as u}from"dm-fabric";import{CaptureVisionRouter as m}from"dynamsoft-capture-vision-router";import{Howl as w}from"dm-howler";class p{static getVersion(){return"4.0.0"}}function _(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)}function y(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i}"function"==typeof SuppressedError&&SuppressedError;const v="undefined"==typeof self,I=(()=>{if(!v&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})();var E,b,S,C;!function(e){e[e.DIMT_RECTANGLE=1]="DIMT_RECTANGLE",e[e.DIMT_QUADRILATERAL=2]="DIMT_QUADRILATERAL",e[e.DIMT_TEXT=4]="DIMT_TEXT",e[e.DIMT_ARC=8]="DIMT_ARC",e[e.DIMT_IMAGE=16]="DIMT_IMAGE",e[e.DIMT_POLYGON=32]="DIMT_POLYGON",e[e.DIMT_LINE=64]="DIMT_LINE",e[e.DIMT_GROUP=128]="DIMT_GROUP"}(E||(E={})),function(e){e[e.DIS_DEFAULT=1]="DIS_DEFAULT",e[e.DIS_SELECTED=2]="DIS_SELECTED"}(b||(b={})),function(e){e[e.EF_ENHANCED_FOCUS=4]="EF_ENHANCED_FOCUS",e[e.EF_AUTO_ZOOM=16]="EF_AUTO_ZOOM",e[e.EF_TAP_TO_FOCUS=64]="EF_TAP_TO_FOCUS"}(S||(S={})),function(e){e.GREY="grey",e.GREY32="grey32",e.RGBA="rgba",e.RBGA="rbga",e.GRBA="grba",e.GBRA="gbra",e.BRGA="brga",e.BGRA="bgra"}(C||(C={}));const A=e=>"number"==typeof e&&!Number.isNaN(e),T=e=>"string"==typeof e;var x,L,F,D,M,R;!function(e){e.ARC="arc",e.IMAGE="image",e.LINE="line",e.POLYGON="polygon",e.QUAD="quad",e.RECT="rect",e.TEXT="text",e.GROUP="group"}(M||(M={})),function(e){e.DEFAULT="default",e.SELECTED="selected"}(R||(R={}));class O{get mediaType(){return new Map([["rect",E.DIMT_RECTANGLE],["quad",E.DIMT_QUADRILATERAL],["text",E.DIMT_TEXT],["arc",E.DIMT_ARC],["image",E.DIMT_IMAGE],["polygon",E.DIMT_POLYGON],["line",E.DIMT_LINE],["group",E.DIMT_GROUP]]).get(this._mediaType)}get styleSelector(){switch(_(this,L,"f")){case b.DIS_DEFAULT:return"default";case b.DIS_SELECTED:return"selected"}}set drawingStyleId(e){this.styleId=e}get drawingStyleId(){return this.styleId}set coordinateBase(e){if(!["view","image"].includes(e))throw new Error("Invalid 'coordinateBase'.");this._drawingLayer&&("image"===_(this,F,"f")&&"view"===e?this.updateCoordinateBaseFromImageToView():"view"===_(this,F,"f")&&"image"===e&&this.updateCoordinateBaseFromViewToImage()),y(this,F,e,"f")}get coordinateBase(){return _(this,F,"f")}get drawingLayerId(){return this._drawingLayerId}constructor(e,t){if(x.add(this),L.set(this,void 0),F.set(this,"image"),this._zIndex=null,this._drawingLayer=null,this._drawingLayerId=null,this._mapStyle=new Map,this._mapState_StyleId=new Map,this.mapEvent_Callbacks=new Map([["selected",new Map],["deselected",new Map],["mousedown",new Map],["mouseup",new Map],["dblclick",new Map],["mouseover",new Map],["mouseout",new Map]]),this.mapNoteName_Content=new Map([]),this.isDrawingItem=!0,null!=t&&!A(t))throw new TypeError("Invalid 'drawingStyleId'.");e&&this._setFabricObject(e),this.setState(b.DIS_DEFAULT),this.styleId=t}_setFabricObject(e){this._fabricObject=e,this._fabricObject.on("selected",(()=>{this.setState(b.DIS_SELECTED)})),this._fabricObject.on("deselected",(()=>{this._fabricObject.canvas&&this._fabricObject.canvas.getActiveObjects().includes(this._fabricObject)?this.setState(b.DIS_SELECTED):this.setState(b.DIS_DEFAULT),"textbox"===this._fabricObject.type&&(this._fabricObject.isEditing&&this._fabricObject.exitEditing(),this._fabricObject.selected=!1)})),e.getDrawingItem=()=>this}_getFabricObject(){return this._fabricObject}setState(e){y(this,L,e,"f")}getState(){return _(this,L,"f")}_on(e,t){if(!t)return;const i=e.toLowerCase(),s=this.mapEvent_Callbacks.get(i);if(!s)throw new Error(`Event '${e}' does not exist.`);let r=s.get(t);r||(r=e=>{const i=e.e;if(!i)return void(t&&t.apply(this,[{targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null}]));const s={targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null};if(this._drawingLayer){let e,t,r,n;const a=i.target.getBoundingClientRect();e=a.left,t=a.top,r=e+window.scrollX,n=t+window.scrollY;const{width:o,height:h}=this._drawingLayer.fabricCanvas.lowerCanvasEl.getBoundingClientRect(),l=this._drawingLayer.width,d=this._drawingLayer.height,c=o/h,f=l/d,g=this._drawingLayer._getObjectFit();let u,m,w,p,_=1;if("contain"===g)c<f?(_=o/l,u=e+this.get("x")*_,m=t+this.get("y")*_+(h-d*_)/2,w=r+this.get("x")*_,p=n+this.get("y")*_+(h-d*_)/2):(_=h/d,u=e+this.get("x")*_+(o-l*_)/2,m=t+this.get("y")*_,w=r+this.get("x")*_+(o-l*_)/2,p=n+this.get("y")*_);else if("cover"===g)if(c<f){_=h/d;let i=this.get("x")*_-(l*_-o)/2;i=Math.max(i,0),i=Math.min(i,o),u=e+i,m=t+this.get("y")*_,w=r+i,p=n+this.get("y")*_}else{_=o/l;let i=this.get("y")*_-(d*_-h)/2;i=Math.max(i,0),i=Math.min(i,h),u=e+this.get("x")*_,m=t+i,w=r+this.get("x")*_,p=n+i}s.itemClientX=Math.round(u),s.itemClientY=Math.round(m),s.itemPageX=Math.round(w),s.itemPageY=Math.round(p)}for(let e of Object.getOwnPropertyNames(s))Object.defineProperty(i,e,{value:s[e],writable:!0});t&&t.apply(this,[i])},s.set(t,r),this._fabricObject.on("dblclick"===i?"mousedblclick":i,r))}on(e,t){this._on(e,t)}_off(e,t){const i=e.toLowerCase(),s=this.mapEvent_Callbacks.get(i);if(!s)throw new Error(`Event '${e}' does not exist.`);let r=s.get(t);r&&(s.delete(t),this._fabricObject.off("dblclick"===i?"mousedblclick":i,r))}off(e,t){this._off(e,t)}_setEditable(e){const t=this._fabricObject;e?(t.selectable=!0,t.hasControls=!0,t.hoverCursor=null):(t.selectable=!1,t.hasControls=!1,t.hoverCursor="default")}hasNote(e){return this.mapNoteName_Content.has(e)}addNote(e,t){if(this.hasNote(e.name)&&!t)throw new Error("A note with the same name already exists, please use a different name.");const i=e.content?JSON.parse(JSON.stringify(e.content)):e.content;this.mapNoteName_Content.set(e.name,[i])}getNote(e){const t=this.mapNoteName_Content.get(e);return t?1===t.length?{name:e,content:t[0]?JSON.parse(JSON.stringify(t[0])):t[0]}:{name:e,content:JSON.parse(JSON.stringify(t))}:null}getNotes(){const e=[];for(let t of this.mapNoteName_Content){let i=1===t[1].length?t[1][0]:t[1];i=i?JSON.parse(JSON.stringify(i)):i,e.push({name:t[0],content:i})}return e}updateNote(e,t,i){const s=this.mapNoteName_Content.get(e);if(!s)throw new Error("The note name does not exist.");i||(s.length=0),t=t?JSON.parse(JSON.stringify(t)):t,s.push(t)}deleteNote(e){this.mapNoteName_Content.delete(e)}clearNotes(){this.mapNoteName_Content.clear()}set(e,t){if(!this.extendSet(e,t))if("x"===e){const e=this._fabricObject.group;e?(this._fabricObject.set("left",t-e.left-e.width/2),e.addWithUpdate()):this._fabricObject.set("left",t)}else if("y"===e){const e=this._fabricObject.group;e?(this._fabricObject.set("top",t-e.top-e.height/2),e.addWithUpdate()):this._fabricObject.set("top",t)}else"styleId"===e?this.styleId=t:this._fabricObject.set(e,t);["vertices","startPoint","endPoint","x","y","left","top","width","height","scaleX","scaleY","skewX","skewY","padding","angle","strokeWidth"].includes(e)&&this._fabricObject.setCoords()}get(e){let t=this.extendGet(e);if(void 0===t)if("x"===e){const e=this._fabricObject.group;t=e?this._fabricObject.get("left")+e.left+e.width/2:this._fabricObject.get("left")}else if("y"===e){const e=this._fabricObject.group;t=e?this._fabricObject.get("top")+e.top+e.height/2:this._fabricObject.get("top")}else t="scaledWidth"===e?this._fabricObject.getScaledWidth():"scaledHeight"===e?this._fabricObject.getScaledHeight():["type","mediaType"].includes(e)?this.mediaType:"state"===e?this.getState():"styleId"===e?this.styleId:"drawingLayerId"===e?this.drawingLayerId:this._fabricObject.get(e);return t}remove(){this._drawingLayer&&this._drawingLayer.removeDrawingItem(this)}convertPropFromImageToView(e){if("number"!=typeof e)throw new TypeError("Invalid value.");return e*_(this,x,"m",D).call(this)}convertPropFromViewToImage(e){if("number"!=typeof e)throw new TypeError("Invalid value.");return e/_(this,x,"m",D).call(this)}_setLineWidth(e){if(this._drawingLayer)if("view"===this.coordinateBase)this.set("strokeWidth",this.convertPropFromViewToImage(e));else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("strokeWidth",e)}}_getLineWidth(){if(this._drawingLayer){if("view"===this.coordinateBase)return this.convertPropFromImageToView(this.get("strokeWidth"));if("image"===this.coordinateBase)return this.get("strokeWidth");throw new Error("Invalid 'coordinateBase'.")}}_setFontSize(e){if(this._drawingLayer)if("view"===this.coordinateBase)this.set("fontSize",this.convertPropFromViewToImage(e));else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("fontSize",e)}}_getFontSize(){if(this._drawingLayer){if("view"===this.coordinateBase)return this.convertPropFromImageToView(this.get("fontSize"));if("image"===this.coordinateBase)return this.get("fontSize");throw new Error("Invalid 'coordinateBase'.")}}}L=new WeakMap,F=new WeakMap,x=new WeakSet,D=function(){const e=this._drawingLayer;if(!e)return 1;const t=e.width,i=e.height,{width:s,height:r}=e.fabricCanvas.wrapperEl.getBoundingClientRect();if(s<=0||r<=0)throw new Error("Unable to get drawing layer dimensions. Layer may not be rendered on the page.");const n=s/t,a=r/i,o=e._getObjectFit();let h=1;if("contain"===o)if(n<a){h=s/t}else{h=r/i}else if("cover"===o)if(n<a){h=r/i}else{h=s/t}return h},O.arrMediaTypes=["rect","arc","polygon","image","text","line","quad"],O.mapItemType=new Map([[M.ARC,"arc"],[M.IMAGE,"image"],[M.LINE,"line"],[M.POLYGON,"polygon"],[M.QUAD,"quad"],[M.RECT,"rect"],[M.TEXT,"text"],[M.GROUP,"group"]]),O.arrStyleSelectors=["default","selected"],O.mapItemState=new Map([[R.DEFAULT,"default"],[R.SELECTED,"selected"]]);const P=e=>null!==e&&"object"==typeof e&&!Array.isArray(e),k=e=>!!T(e)&&""!==e,B=e,W=t,V=s,N=r,U=a,G=n,j=i,H=e=>!!P(e)&&(!("id"in e&&!A(e.id))&&(!("lineWidth"in e&&!A(e.lineWidth))&&(!("fillStyle"in e&&!k(e.fillStyle))&&(!("strokeStyle"in e&&!k(e.strokeStyle))&&(!("paintMode"in e&&!["fill","stroke","strokeAndFill"].includes(e.paintMode))&&(!("fontFamily"in e&&!k(e.fontFamily))&&!("fontSize"in e&&!A(e.fontSize))))))));class Z{static convert(e,t,i){const s={x:0,y:0,width:t,height:i};if(!e)return s;if(j(e))e.isMeasuredInPercentage?(s.x=e.x/100*t,s.y=e.y/100*i,s.width=e.width/100*t,s.height=e.height/100*i):(s.x=e.x,s.y=e.y,s.width=e.width,s.height=e.height);else{if(!W(e))throw TypeError("Invalid region.");e.isMeasuredInPercentage?(s.x=e.left/100*t,s.y=e.top/100*i,s.width=(e.right-e.left)/100*t,s.height=(e.bottom-e.top)/100*i):(s.x=e.left,s.y=e.top,s.width=e.right-e.left,s.height=e.bottom-e.top)}return s.x=Math.round(s.x),s.y=Math.round(s.y),s.width=Math.round(s.width),s.height=Math.round(s.height),s}}var Y,z;class J{constructor(){Y.set(this,new Map),z.set(this,!1)}get disposed(){return _(this,z,"f")}on(e,t){e=e.toLowerCase();const i=_(this,Y,"f").get(e);if(i){if(i.includes(t))return;i.push(t)}else _(this,Y,"f").set(e,[t])}off(e,t){e=e.toLowerCase();const i=_(this,Y,"f").get(e);if(!i)return;const s=i.indexOf(t);-1!==s&&i.splice(s,1)}offAll(e){e=e.toLowerCase();const t=_(this,Y,"f").get(e);t&&(t.length=0)}async fire(e,t=[],i={async:!1}){e=e.toLowerCase();const s=_(this,Y,"f").get(e);if(s)for(let e of s){if(!e)continue;let s;if(i.async)setTimeout((()=>{this.disposed||e.apply(i.target,t)}),0);else try{s=await e.apply(i.target,t)}catch(e){}if(!0===s)break}}dispose(){y(this,z,!0,"f")}}function X(e,t,i){return(i.x-e.x)*(t.y-e.y)==(t.x-e.x)*(i.y-e.y)&&Math.min(e.x,t.x)<=i.x&&i.x<=Math.max(e.x,t.x)&&Math.min(e.y,t.y)<=i.y&&i.y<=Math.max(e.y,t.y)}function q(e){return Math.abs(e)<1e-6?0:e<0?-1:1}function Q(e,t,i,s){let r=e[0]*(i[1]-t[1])+t[0]*(e[1]-i[1])+i[0]*(t[1]-e[1]),n=e[0]*(s[1]-t[1])+t[0]*(e[1]-s[1])+s[0]*(t[1]-e[1]);return!((r^n)>=0&&0!==r&&0!==n)&&(r=i[0]*(e[1]-s[1])+s[0]*(i[1]-e[1])+e[0]*(s[1]-i[1]),n=i[0]*(t[1]-s[1])+s[0]*(i[1]-t[1])+t[0]*(s[1]-i[1]),!((r^n)>=0&&0!==r&&0!==n))}Y=new WeakMap,z=new WeakMap;const K=async e=>{if("string"!=typeof e)throw new TypeError("Invalid url.");const t=await fetch(e);if(!t.ok)throw Error("Network Error: "+t.statusText);const i=await t.text();if(!i.trim().startsWith("<"))throw Error("Unable to get valid HTMLElement.");const s=document.createElement("div");s.insertAdjacentHTML("beforeend",i);for(let e=0;e<s.childElementCount;++e){let t=s.children[e];t instanceof HTMLStyleElement&&document.head.append(t)}return 1==s.childElementCount?s.children[0]:s};var $,ee,te,ie,se;class re extends O{constructor(e,t){if(super(null,t),$.set(this,void 0),!j(e))throw new TypeError("Invalid 'rect'.");this._setFabricObject(new u.Rect({left:e.x,top:e.y,width:e.width,height:e.height})),y(this,$,JSON.parse(JSON.stringify(e)),"f"),this._mediaType="rect"}extendSet(e,t){return!1}extendGet(e){}updateCoordinateBaseFromImageToView(){this.set("left",this.convertPropFromViewToImage(this.get("left"))),this.set("top",this.convertPropFromViewToImage(this.get("top"))),this.set("width",this.convertPropFromViewToImage(this.get("scaledWidth"))),this.set("height",this.convertPropFromViewToImage(this.get("scaledHeight")))}updateCoordinateBaseFromViewToImage(){this.set("left",this.convertPropFromImageToView(this.get("left"))),this.set("top",this.convertPropFromImageToView(this.get("top"))),this.set("width",this.convertPropFromImageToView(this.get("scaledWidth"))),this.set("height",this.convertPropFromImageToView(this.get("scaledHeight")))}setPosition(e){this.setRect(e)}getPosition(){return this.getRect()}updatePosition(){_(this,$,"f")&&this.setRect(_(this,$,"f"))}setRect(e){if(!j(e))throw new TypeError("Invalid 'rect'.");if(this._drawingLayer){if("view"===this.coordinateBase)this.set("left",this.convertPropFromViewToImage(e.x)),this.set("top",this.convertPropFromViewToImage(e.y)),this.set("width",this.convertPropFromViewToImage(e.width)),this.set("height",this.convertPropFromViewToImage(e.height));else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("left",e.x),this.set("top",e.y),this.set("width",e.width),this.set("height",e.height)}this._drawingLayer.renderAll()}else y(this,$,JSON.parse(JSON.stringify(e)),"f")}getRect(){if(this._drawingLayer){if("view"===this.coordinateBase)return{x:this.convertPropFromImageToView(this.get("left")),y:this.convertPropFromImageToView(this.get("top")),width:this.convertPropFromImageToView(this.get("scaledWidth")),height:this.convertPropFromImageToView(this.get("scaledHeight"))};if("image"===this.coordinateBase)return{x:this.get("left"),y:this.get("top"),width:this.get("scaledWidth"),height:this.get("scaledHeight")};throw new Error("Invalid 'coordinateBase'.")}return _(this,$,"f")?JSON.parse(JSON.stringify(_(this,$,"f"))):null}}function ne(e,t,i){let s=i.points[this.pointIndex].x-i.pathOffset.x,r=i.points[this.pointIndex].y-i.pathOffset.y;return u.util.transformPoint({x:s,y:r},i.calcTransformMatrix())}function ae(e){let t=new u.Point(e.strokeUniform?1/e.scaleX:1,e.strokeUniform?1/e.scaleY:1).multiply(e.strokeWidth);return new u.Point(e.width+t.x,e.height+t.y)}function oe(e,t,i,s){let r=t.target,n=r.controls[r.__corner],a=r.toLocalPoint(new u.Point(i,s),"center","center"),o=ae(r),h=r._getTransformedDimensions(0,0),l={x:a.x*o.x/h.x+r.pathOffset.x,y:a.y*o.y/h.y+r.pathOffset.y};return r.points[n.pointIndex]=l,!0}function he(e,t){return function(i,s,r,n){let a=s.target,o=u.util.transformPoint({x:a.points[e].x-a.pathOffset.x,y:a.points[e].y-a.pathOffset.y},a.calcTransformMatrix()),h=t(i,s,r,n);a._setPositionDimensions({});let l=ae(a),d=(a.points[e].x-a.pathOffset.x)/l.x,c=(a.points[e].y-a.pathOffset.y)/l.y;return a.setPositionByOrigin(o,d+.5,c+.5),h}}$=new WeakMap;class le extends O{constructor(e,t){if(super(null,t),ee.set(this,void 0),!N(e))throw new TypeError("Invalid 'polygon'.");this._setFabricObject(new u.Polygon(e.points,{objectCaching:!1}));const i=this._fabricObject;let s=i.points.length-1;i.controls=i.points.reduce((function(e,t,i){return e["p"+i]=new u.Control({positionHandler:ne,actionHandler:he(i>0?i-1:s,oe),actionName:"modifyPolygon",pointIndex:i}),e}),{}),y(this,ee,JSON.parse(JSON.stringify(e)),"f"),this._mediaType="polygon"}extendSet(e,t){if("vertices"===e){const e=this._fabricObject;if(e.group){const i=e.group;e.points=t.map((e=>({x:e.x-i.left-i.width/2,y:e.y-i.top-i.height/2}))),i.addWithUpdate()}else e.points=t;const i=e.points.length-1;return e.controls=e.points.reduce((function(e,t,s){return e["p"+s]=new u.Control({positionHandler:ne,actionHandler:he(s>0?s-1:i,oe),actionName:"modifyPolygon",pointIndex:s}),e}),{}),e._setPositionDimensions({}),!0}}extendGet(e){if("vertices"===e){const e=[],t=this._fabricObject;if(t.selectable&&!t.group)for(let i in t.oCoords)e.push({x:t.oCoords[i].x,y:t.oCoords[i].y});else for(let i of t.points){let s=i.x-t.pathOffset.x,r=i.y-t.pathOffset.y;const n=u.util.transformPoint({x:s,y:r},t.calcTransformMatrix());e.push({x:n.x,y:n.y})}return e}}updateCoordinateBaseFromImageToView(){const e=this.get("vertices").map((e=>({x:this.convertPropFromViewToImage(e.x),y:this.convertPropFromViewToImage(e.y)})));this.set("vertices",e)}updateCoordinateBaseFromViewToImage(){const e=this.get("vertices").map((e=>({x:this.convertPropFromImageToView(e.x),y:this.convertPropFromImageToView(e.y)})));this.set("vertices",e)}setPosition(e){this.setPolygon(e)}getPosition(){return this.getPolygon()}updatePosition(){_(this,ee,"f")&&this.setPolygon(_(this,ee,"f"))}setPolygon(e){if(!N(e))throw new TypeError("Invalid 'polygon'.");if(this._drawingLayer){if("view"===this.coordinateBase){const t=e.points.map((e=>({x:this.convertPropFromViewToImage(e.x),y:this.convertPropFromViewToImage(e.y)})));this.set("vertices",t)}else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("vertices",e.points)}this._drawingLayer.renderAll()}else y(this,ee,JSON.parse(JSON.stringify(e)),"f")}getPolygon(){if(this._drawingLayer){if("view"===this.coordinateBase){return{points:this.get("vertices").map((e=>({x:this.convertPropFromImageToView(e.x),y:this.convertPropFromImageToView(e.y)})))}}if("image"===this.coordinateBase)return{points:this.get("vertices")};throw new Error("Invalid 'coordinateBase'.")}return _(this,ee,"f")?JSON.parse(JSON.stringify(_(this,ee,"f"))):null}}ee=new WeakMap;te=new WeakMap,ie=new WeakMap;const de=e=>{let t=(e=>e.split("\n").map((e=>e.split("\t"))))(e);return(e=>{for(let t=0;;t++){let i=-1;for(let s=0;s<e.length;s++){let r=e[s][t];void 0!==r&&(r.length>i&&(i=r.length))}if(-1===i)break;for(let s=0;s<e.length;s++){if(t>=e[s].length-1)continue;let r=" ".repeat(i+2-e[s][t].length);e[s][t]=e[s][t].concat(r)}}})(t),(e=>{let t="";for(let i=0;i<e.length;i++)t=t.concat(...e[i],i===e.length-1?"":"\n");return t})(t)};class ce extends O{constructor(e,t,i){if(super(null,i),se.set(this,void 0),!T(e))throw new TypeError("Invalid 'text'.");if(!j(t))throw new TypeError("Invalid 'rect'.");this._setFabricObject(new u.Textbox(de(e),{left:t.x,top:t.y,width:t.width})),this._text=e,y(this,se,JSON.parse(JSON.stringify(t)),"f"),this._mediaType="text"}extendSet(e,t){if("text"===e)return this._text=t,this._fabricObject.set("text",de(t)),!0}extendGet(e){if("text"===e)return this._text}updateCoordinateBaseFromImageToView(){this.set("left",this.convertPropFromViewToImage(this.get("left"))),this.set("top",this.convertPropFromViewToImage(this.get("top"))),this.set("width",this.convertPropFromViewToImage(this.get("scaledWidth")))}updateCoordinateBaseFromViewToImage(){this.set("left",this.convertPropFromImageToView(this.get("left"))),this.set("top",this.convertPropFromImageToView(this.get("top"))),this.set("width",this.convertPropFromImageToView(this.get("scaledWidth")))}setPosition(e){this.setTextRect(e)}getPosition(){return this.getTextRect()}updatePosition(){_(this,se,"f")&&this.setTextRect(_(this,se,"f"))}setText(e){if(!T(e))throw new TypeError("Invalid 'text'.");this.set("text",e)}getText(){return this.get("text")}setTextRect(e){if(!j(e))throw new TypeError("Invalid 'rect'.");if(this._drawingLayer){if("view"===this.coordinateBase)this.set("left",this.convertPropFromViewToImage(e.x)),this.set("top",this.convertPropFromViewToImage(e.y)),this.set("width",this.convertPropFromViewToImage(e.width));else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("left",e.x),this.set("top",e.y),this.set("width",e.width)}this._drawingLayer.renderAll()}else y(this,se,JSON.parse(JSON.stringify(e)),"f")}getTextRect(){if(this._drawingLayer){if("view"===this.coordinateBase)return{x:this.convertPropFromImageToView(this.get("left")),y:this.convertPropFromImageToView(this.get("top")),width:this.convertPropFromImageToView(this.get("scaledWidth")),height:this.convertPropFromImageToView(this.get("scaledHeight"))};if("image"===this.coordinateBase)return{x:this.get("left"),y:this.get("top"),width:this.get("scaledWidth"),height:this.get("scaledHeight")};throw new Error("Invalid 'coordinateBase'.")}return _(this,se,"f")?JSON.parse(JSON.stringify(_(this,se,"f"))):null}}var fe,ge,ue,me,we,pe,_e,ye,ve,Ie,Ee,be,Se,Ce,Ae,Te,xe,Le,Fe,De,Me,Re,Oe,Pe,ke,Be,We,Ve,Ne,Ue,Ge,je,He,Ze,Ye,ze,Je,Xe,qe,Qe;se=new WeakMap;fe=new WeakMap;class Ke extends le{constructor(e,t){if(super({points:null==e?void 0:e.points},t),ge.set(this,void 0),!G(e))throw new TypeError("Invalid 'quad'.");y(this,ge,JSON.parse(JSON.stringify(e)),"f"),this._mediaType="quad"}setPosition(e){this.setQuad(e)}getPosition(){return this.getQuad()}updatePosition(){_(this,ge,"f")&&this.setQuad(_(this,ge,"f"))}setPolygon(){}getPolygon(){return null}setQuad(e){if(!G(e))throw new TypeError("Invalid 'quad'.");if(this._drawingLayer){if("view"===this.coordinateBase){const t=e.points.map((e=>({x:this.convertPropFromViewToImage(e.x),y:this.convertPropFromViewToImage(e.y)})));this.set("vertices",t)}else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("vertices",e.points)}this._drawingLayer.renderAll()}else y(this,ge,JSON.parse(JSON.stringify(e)),"f")}getQuad(){if(this._drawingLayer){if("view"===this.coordinateBase){return{points:this.get("vertices").map((e=>({x:this.convertPropFromImageToView(e.x),y:this.convertPropFromImageToView(e.y)})))}}if("image"===this.coordinateBase)return{points:this.get("vertices")};throw new Error("Invalid 'coordinateBase'.")}return _(this,ge,"f")?JSON.parse(JSON.stringify(_(this,ge,"f"))):null}}ge=new WeakMap;class $e extends O{constructor(e){super(new u.Group(e.map((e=>e._getFabricObject())))),this._fabricObject.on("selected",(()=>{this.setState(b.DIS_SELECTED);const e=this._fabricObject._objects;for(let t of e)setTimeout((()=>{t&&t.fire("selected")}),0);setTimeout((()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())}),0)})),this._fabricObject.on("deselected",(()=>{this.setState(b.DIS_DEFAULT);const e=this._fabricObject._objects;for(let t of e)setTimeout((()=>{t&&t.fire("deselected")}),0);setTimeout((()=>{this._fabricObject&&this._fabricObject.canvas&&(this._fabricObject.dirty=!0,this._fabricObject.canvas.renderAll())}),0)})),this._mediaType="group"}extendSet(e,t){return!1}extendGet(e){}updateCoordinateBaseFromImageToView(){}updateCoordinateBaseFromViewToImage(){}setPosition(){}getPosition(){}updatePosition(){}getChildDrawingItems(){return this._fabricObject._objects.map((e=>e.getDrawingItem()))}setChildDrawingItems(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");this._drawingLayer?this._drawingLayer._updateGroupItem(this,e,"add"):this._fabricObject.addWithUpdate(e._getFabricObject())}removeChildItem(e){e&&e.isDrawingItem&&(this._drawingLayer?this._drawingLayer._updateGroupItem(this,e,"remove"):this._fabricObject.removeWithUpdate(e._getFabricObject()))}}class et{static createDrawingStyle(e){if(!H(e))throw new Error("Invalid style definition.");let t,i=_(et,ue,"f",me);for(;_(et,ue,"f",we).has(i);)i++;t=i;const s=JSON.parse(JSON.stringify(e));s.id=t;for(let e in _(et,ue,"f",pe))s.hasOwnProperty(e)||(s[e]=_(et,ue,"f",pe)[e]);return _(et,ue,"f",we).set(t,s),s.id}static _getDrawingStyle(e,t){if("number"!=typeof e)throw new Error("Invalid style id.");const i=_(et,ue,"f",we).get(e);return i?t?JSON.parse(JSON.stringify(i)):i:null}static getDrawingStyle(e){return this._getDrawingStyle(e,!0)}static getDrawingStyles(){return JSON.parse(JSON.stringify(Array.from(_(et,ue,"f",we).values())))}static _updateDrawingStyle(e,t){if(!H(t))throw new Error("Invalid style definition.");const i=_(et,ue,"f",we).get(e);if(i)for(let e in t)i.hasOwnProperty(e)&&(i[e]=t[e])}static updateDrawingStyle(e,t){this._updateDrawingStyle(e,t)}}ue=et,me={value:1024},we={value:new Map([[1,{id:1,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[2,{id:2,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[3,{id:3,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[4,{id:4,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[5,{id:5,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[6,{id:6,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[7,{id:7,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[8,{id:8,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}]])},pe={value:{lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}},"undefined"!=typeof document&&"undefined"!=typeof window&&(u.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(u.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject((function(e){e.dispose&&e.dispose()})),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),u.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},u.Object.prototype.transparentCorners=!1,u.Object.prototype.cornerSize=20,u.Object.prototype.touchCornerSize=100,u.Object.prototype.cornerColor="rgb(254,142,20)",u.Object.prototype.cornerStyle="circle",u.Object.prototype.strokeUniform=!0,u.Object.prototype.hasBorders=!1,u.Canvas.prototype.containerClass="",u.Canvas.prototype.getPointer=function(e,t){if(this._absolutePointer&&!t)return this._absolutePointer;if(this._pointer&&t)return this._pointer;var i,s=this.upperCanvasEl,r=u.util.getPointer(e,s),n=s.getBoundingClientRect(),a=n.width||0,o=n.height||0;a&&o||("top"in n&&"bottom"in n&&(o=Math.abs(n.top-n.bottom)),"right"in n&&"left"in n&&(a=Math.abs(n.right-n.left))),this.calcOffset(),r.x=r.x-this._offset.left,r.y=r.y-this._offset.top,t||(r=this.restorePointerVpt(r));var h=this.getRetinaScaling();if(1!==h&&(r.x/=h,r.y/=h),0!==a&&0!==o){var l=window.getComputedStyle(s).objectFit,d=s.width,c=s.height,f=a,g=o;i={width:d/f,height:c/g};var m,w,p=d/c,_=f/g;return"contain"===l?p>_?(m=f,w=f/p,{x:r.x*i.width,y:(r.y-(g-w)/2)*i.width}):(m=g*p,w=g,{x:(r.x-(f-m)/2)*i.height,y:r.y*i.height}):"cover"===l?p>_?{x:(d-i.height*f)/2+r.x*i.height,y:r.y*i.height}:{x:r.x*i.width,y:(c-i.width*g)/2+r.y*i.width}:{x:r.x*i.width,y:r.y*i.height}}return i={width:1,height:1},{x:r.x*i.width,y:r.y*i.height}},u.Canvas.prototype._onTouchStart=function(e){var t=this.findTarget(e);!this.allowTouchScrolling&&e.cancelable&&e.preventDefault&&e.preventDefault(),t&&e.cancelable&&e.preventDefault&&e.preventDefault(),null===this.mainTouchId&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),this._resetTransformEventData();var i=this.upperCanvasEl,s=this._getEventPrefix();u.util.addListener(u.document,"touchend",this._onTouchEnd,{passive:!1}),u.util.addListener(u.document,"touchmove",this._onMouseMove,{passive:!1}),u.util.removeListener(i,s+"down",this._onMouseDown)},u.Textbox.prototype._wrapLine=function(e,t,i,s){const r=e.match(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g),n=!(!r||!r.length);var a=0,o=this.splitByGrapheme||n,h=[],l=[],d=o?u.util.string.graphemeSplit(e):e.split(this._wordJoiners),c="",f=0,g=o?"":" ",m=0,w=0,p=0,_=!0,y=this._getWidthOfCharSpacing();s=s||0;0===d.length&&d.push([]),i-=s;for(var v=0;v<d.length;v++)c=o?d[v]:u.util.string.graphemeSplit(d[v]),m=this._measureWord(c,t,f),f+=c.length,(a+=w+m-y)>i&&!_?(h.push(l),l=[],a=m,_=!0):a+=y,_||o||l.push(g),l=l.concat(c),w=o?0:this._measureWord([g],t,f),f++,_=!1,m>p&&(p=m);return v&&h.push(l),p+s>this.dynamicMinWidth&&(this.dynamicMinWidth=p-y+s),h});class tt{get width(){return this.fabricCanvas.width}get height(){return this.fabricCanvas.height}set _allowMultiSelect(e){this.fabricCanvas.selection=e,this.fabricCanvas.renderAll()}get _allowMultiSelect(){return this.fabricCanvas.selection}constructor(e,t,i){let s,r;switch(this.mapMediaType_Style=new Map,this.mapType_StateAndStyleId=new Map,this.mode="viewer",this.onSelectionChanged=null,this._arrDrwaingItem=[],this._arrFabricObject=[],this._visible=!0,e.hasOwnProperty("getFabricCanvas")?this.fabricCanvas=e.getFabricCanvas():(this.fabricCanvas=new u.Canvas(e,Object.assign(i,{allowTouchScrolling:!0,selection:!1})),this.fabricCanvas.setDimensions({width:"100%",height:"100%"},{cssOnly:!0}),this.fabricCanvas.lowerCanvasEl.className="",this.fabricCanvas.upperCanvasEl.className="",this.fabricCanvas.on("selection:created",(function(e){const t=e.selected,i=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!i.includes(t)&&i.push(t)}for(let e of i){const i=[];for(let s of t){const t=s.getDrawingItem();t._drawingLayer===e&&i.push(t)}setTimeout((()=>{e.onSelectionChanged&&e.onSelectionChanged(i,[])}),0)}})),this.fabricCanvas.on("before:selection:cleared",(function(e){const t=this.getActiveObjects(),i=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!i.includes(t)&&i.push(t)}for(let e of i){const i=[];for(let s of t){const t=s.getDrawingItem();t._drawingLayer===e&&i.push(t)}setTimeout((()=>{const t=[];for(let s of i)e.hasDrawingItem(s)&&t.push(s);t.length>0&&e.onSelectionChanged&&e.onSelectionChanged([],t)}),0)}})),this.fabricCanvas.on("selection:updated",(function(e){const t=e.selected,i=e.deselected,s=[];for(let e of t){const t=e.getDrawingItem()._drawingLayer;t&&!s.includes(t)&&s.push(t)}for(let e of i){const t=e.getDrawingItem()._drawingLayer;t&&!s.includes(t)&&s.push(t)}for(let e of s){const s=[],r=[];for(let i of t){const t=i.getDrawingItem();t._drawingLayer===e&&s.push(t)}for(let t of i){const i=t.getDrawingItem();i._drawingLayer===e&&r.push(i)}setTimeout((()=>{e.onSelectionChanged&&e.onSelectionChanged(s,r)}),0)}})),this.fabricCanvas.wrapperEl.style.position="absolute",e.getFabricCanvas=()=>this.fabricCanvas),this.id=t,t){case 1:s=et.getDrawingStyle(1),r=et.getDrawingStyle(5);break;case 2:s=et.getDrawingStyle(2),r=et.getDrawingStyle(6);break;case 3:s=et.getDrawingStyle(3),r=et.getDrawingStyle(7);break;default:s=et.getDrawingStyle(4),r=et.getDrawingStyle(8)}for(let e of O.arrMediaTypes)this.mapType_StateAndStyleId.set(e,{default:s.id,selected:r.id})}getId(){return this.id}setVisible(e){if(e){for(let e of this._arrFabricObject)e.visible=!0,e.hasControls=!0;this._visible=!0}else{for(let e of this._arrFabricObject)e.visible=!1,e.hasControls=!1;this._visible=!1}this.fabricCanvas.renderAll()}isVisible(){return this._visible}_getItemCurrentStyleId(e){return e.styleId?e.styleId:this.mapType_StateAndStyleId.get(e._mediaType)[e.styleSelector]}_getItemCurrentStyle(e){if(e.styleId)return et.getDrawingStyle(e.styleId);const t=et.getDrawingStyle(e._mapState_StyleId.get(e.styleSelector));return t||null}_changeMediaTypeCurStyleInStyleSelector(e,t,i,s){const r=this.getDrawingItems((t=>t._mediaType===e));for(let e of r)e.styleSelector===t&&this._changeItemStyle(e,i,!0);s||this.fabricCanvas.renderAll()}_changeItemStyle(e,t,i){if(!e||!t)return;const s=e._getFabricObject();"number"==typeof e.styleId&&(t=et.getDrawingStyle(e.styleId)),s.strokeWidth=t.lineWidth,"fill"===t.paintMode?(s.fill=t.fillStyle,s.stroke=t.fillStyle):"stroke"===t.paintMode?(s.fill="transparent",s.stroke=t.strokeStyle):"strokeAndFill"===t.paintMode&&(s.fill=t.fillStyle,s.stroke=t.strokeStyle),s.fontFamily&&(s.fontFamily=t.fontFamily),s.fontSize&&(s.fontSize=t.fontSize),s.group||(s.dirty=!0),i||this.fabricCanvas.renderAll()}_updateGroupItem(e,t,i){if(!e||!t)return;const s=e.getChildDrawingItems();if("add"===i){if(s.includes(t))return;const i=t._getFabricObject();if(this.fabricCanvas.getObjects().includes(i)){if(!this._arrFabricObject.includes(i))throw new Error("Existed in other drawing layers.");t._zIndex=null}else{let i;if(t.styleId)i=et.getDrawingStyle(t.styleId);else{const s=this.mapType_StateAndStyleId.get(t._mediaType);i=et.getDrawingStyle(s[e.styleSelector]);const r=()=>{this._changeItemStyle(t,et.getDrawingStyle(this.mapType_StateAndStyleId.get(t._mediaType).selected),!0)},n=()=>{this._changeItemStyle(t,et.getDrawingStyle(this.mapType_StateAndStyleId.get(t._mediaType).default),!0)};t._on("selected",r),t._on("deselected",n),t._funcChangeStyleToSelected=r,t._funcChangeStyleToDefault=n}t._drawingLayer=this,t._drawingLayerId=this.id,this._changeItemStyle(t,i,!0)}e._fabricObject.addWithUpdate(t._getFabricObject())}else{if("remove"!==i)return;if(!s.includes(t))return;t._zIndex=null,t._drawingLayer=null,t._drawingLayerId=null,t._off("selected",t._funcChangeStyleToSelected),t._off("deselected",t._funcChangeStyleToDefault),t._funcChangeStyleToSelected=null,t._funcChangeStyleToDefault=null,e._fabricObject.removeWithUpdate(t._getFabricObject())}this.fabricCanvas.renderAll()}_addDrawingItem(e,t){if(!(e instanceof O))throw new TypeError("Invalid 'drawingItem'.");if(e._drawingLayer){if(e._drawingLayer==this)return;throw new Error("This drawing item has existed in other layer.")}let i=e._getFabricObject();const s=this.fabricCanvas.getObjects();let r,n;if(s.includes(i)){if(this._arrFabricObject.includes(i))return;throw new Error("Existed in other drawing layers.")}if("group"===e._mediaType){r=e.getChildDrawingItems();for(let e of r)if(e._drawingLayer&&e._drawingLayer!==this)throw new Error("The childItems of DT_Group have existed in other drawing layers.")}if(t&&"object"==typeof t&&!Array.isArray(t))for(let e in t)i.set(e,t[e]);if(r){for(let e of r){const t=this.mapType_StateAndStyleId.get(e._mediaType);for(let i of O.arrStyleSelectors)e._mapState_StyleId.set(i,t[i]);if(e.styleId)n=et.getDrawingStyle(e.styleId);else{n=et.getDrawingStyle(t.default);const i=()=>{this._changeItemStyle(e,et.getDrawingStyle(this.mapType_StateAndStyleId.get(e._mediaType).selected),!0)},s=()=>{this._changeItemStyle(e,et.getDrawingStyle(this.mapType_StateAndStyleId.get(e._mediaType).default),!0)};e._on("selected",i),e._on("deselected",s),e._funcChangeStyleToSelected=i,e._funcChangeStyleToDefault=s}e._drawingLayer=this,e._drawingLayerId=this.id,this._changeItemStyle(e,n,!0)}i.dirty=!0,this.fabricCanvas.renderAll()}else{const t=this.mapType_StateAndStyleId.get(e._mediaType);for(let i of O.arrStyleSelectors)e._mapState_StyleId.set(i,t[i]);if(e.styleId)n=et.getDrawingStyle(e.styleId);else{n=et.getDrawingStyle(t.default);const i=()=>{this._changeItemStyle(e,et.getDrawingStyle(this.mapType_StateAndStyleId.get(e._mediaType).selected))},s=()=>{this._changeItemStyle(e,et.getDrawingStyle(this.mapType_StateAndStyleId.get(e._mediaType).default))};e._on("selected",i),e._on("deselected",s),e._funcChangeStyleToSelected=i,e._funcChangeStyleToDefault=s}this._changeItemStyle(e,n)}e._zIndex=this.id,e._drawingLayer=this,e._drawingLayerId=this.id;const a=this._arrFabricObject.length;let o=s.length;if(a)o=s.indexOf(this._arrFabricObject[a-1])+1;else for(let t=0;t<s.length;t++)if(e._zIndex<s[t].getDrawingItem()._zIndex){o=t;break}this._arrDrwaingItem.push(e),this._arrFabricObject.push(i),this._visible?i.visible=!0:i.visible=!1,this.fabricCanvas.insertAt(i,o,!1)}addDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");if("viewer"===this.mode)e._setEditable(!1);else{if("editor"!==this.mode)throw new Error("Illegal 'mode'.");e._setEditable(!0)}this._addDrawingItem(e),e.updatePosition()}addDrawingItems(e){for(let t of e)this.addDrawingItem(t)}removeDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");if(!this.hasDrawingItem(e))return;if(e._zIndex=null,e._drawingLayer=null,e._drawingLayerId=null,"group"===e._mediaType){const t=e.getChildDrawingItems();for(let e of t)e._zIndex=null,e._drawingLayer=null,e._drawingLayerId=null,e._off("selected",e._funcChangeStyleToSelected),e._off("deselected",e._funcChangeStyleToDefault),e._funcChangeStyleToSelected=null,e._funcChangeStyleToDefault=null,e._mapState_StyleId.clear()}else e._off("selected",e._funcChangeStyleToSelected),e._off("deselected",e._funcChangeStyleToDefault),e._funcChangeStyleToSelected=null,e._funcChangeStyleToDefault=null,e._mapState_StyleId.clear();const t=e._getFabricObject();"selected"===e.styleSelector&&(t.group?t.group.removeWithUpdate(t):this.fabricCanvas._activeObject=null,e.setState(b.DIS_DEFAULT)),this.fabricCanvas.remove(t),this._arrDrwaingItem.splice(this._arrDrwaingItem.indexOf(e),1),this._arrFabricObject.splice(this._arrFabricObject.indexOf(t),1)}removeDrawingItems(e){for(let t of e)this.removeDrawingItem(t)}setDrawingItems(e){this.clearDrawingItems(),this.addDrawingItems(e)}getDrawingItems(e){return e&&"function"==typeof e?this._arrDrwaingItem.filter(e):Array.from(this._arrDrwaingItem)}getSelectedDrawingItems(){const e=this.fabricCanvas.getActiveObjects(),t=[];for(let i of e)this._arrFabricObject.includes(i)&&t.push(i.getDrawingItem());return t}hasDrawingItem(e){if(!e||!e.isDrawingItem)throw TypeError("Illegal drawing item.");return this._arrDrwaingItem.includes(e)}clearDrawingItems(){this.removeDrawingItems(Array.from(this._arrDrwaingItem))}_setDefaultStyle(e,t,i){t?t.forEach((e=>e.toLowerCase())):t=O.arrMediaTypes,i?i.forEach((e=>e.toLowerCase())):i=O.arrStyleSelectors;const s=et.getDrawingStyle(e);if(!s)throw new Error(`The 'drawingStyle' with id '${e}' doesn't exist.`);let r;for(let n of t)if(r=this.mapType_StateAndStyleId.get(n),r)for(let t of i){this._changeMediaTypeCurStyleInStyleSelector(n,t,s,!0),r[t]=e;for(let i of this._arrDrwaingItem)i._mediaType===n&&i._mapState_StyleId.set(t,e)}this.fabricCanvas.renderAll()}setDefaultStyle(e,t,i){const s=[];i&E.DIMT_RECTANGLE&&s.push("rect"),i&E.DIMT_QUADRILATERAL&&s.push("quad"),i&E.DIMT_TEXT&&s.push("text"),i&E.DIMT_ARC&&s.push("arc"),i&E.DIMT_IMAGE&&s.push("image"),i&E.DIMT_POLYGON&&s.push("polygon"),i&E.DIMT_LINE&&s.push("line");const r=[];t&b.DIS_DEFAULT&&r.push("default"),t&b.DIS_SELECTED&&r.push("selected"),this._setDefaultStyle(e,s.length?s:null,r.length?r:null)}setMode(e){if("viewer"===(e=e.toLowerCase())){for(let e of this._arrDrwaingItem)e._setEditable(!1);this.fabricCanvas.discardActiveObject(),this.fabricCanvas.renderAll(),this.mode="viewer"}else{if("editor"!==e)throw new RangeError("Invalid value.");for(let e of this._arrDrwaingItem)e._setEditable(!0);this.mode="editor"}this._manager._switchPointerEvent()}getMode(){return this.mode}_setDimensions(e,t){this.fabricCanvas.setDimensions(e,t)}_setObjectFit(e){if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`Unsupported value '${e}'.`);this.fabricCanvas.lowerCanvasEl.style.objectFit=e,this.fabricCanvas.upperCanvasEl.style.objectFit=e}_getObjectFit(){return this.fabricCanvas.lowerCanvasEl.style.objectFit}renderAll(){for(let e of this._arrDrwaingItem){const t=this._getItemCurrentStyle(e);this._changeItemStyle(e,t,!0)}this.fabricCanvas.renderAll()}dispose(){this.clearDrawingItems(),1===this._manager._arrDrawingLayer.length&&(this.fabricCanvas.wrapperEl.style.pointerEvents="none",this.fabricCanvas.dispose(),this._arrDrwaingItem.length=0,this._arrFabricObject.length=0)}}tt.DDN_LAYER_ID=1,tt.DBR_LAYER_ID=2,tt.DLR_LAYER_ID=3,tt.USER_DEFINED_LAYER_BASE_ID=100;class it{constructor(){this._arrDrawingLayer=[]}createDrawingLayer(e,t){const i=e=>{for(let t of this._arrDrawingLayer)if(t.getId()===e)return!0;return!1};if(void 0===t){for(let e=it.USER_DEFINED_LAYER_BASE_ID;;e++)if(!i(e)){t=e;break}}else if(i(t))throw new Error("Existed drawing layer id.");const s=new tt(e,t,{enableRetinaScaling:!1});return s._manager=this,this._arrDrawingLayer.push(s),this._switchPointerEvent(),s}deleteDrawingLayer(e){const t=this.getDrawingLayer(e);if(!t)return;const i=this._arrDrawingLayer;t.dispose(),i.splice(i.indexOf(t),1),this._switchPointerEvent()}clearDrawingLayers(){for(let e of this._arrDrawingLayer)e.dispose();this._arrDrawingLayer.length=0}getDrawingLayer(e){for(let t of this._arrDrawingLayer)if(t.getId()===e)return t;return null}getAllDrawingLayers(){return Array.from(this._arrDrawingLayer)}getSelectedDrawingItems(){if(!this._arrDrawingLayer.length)return;const e=this._arrDrawingLayer[0].fabricCanvas.getActiveObjects(),t=[];for(let i of e)t.push(i.getDrawingItem());return t}setDimensions(e,t){this._arrDrawingLayer.length&&this._arrDrawingLayer[0]._setDimensions(e,t)}setObjectFit(e){for(let t of this._arrDrawingLayer)t&&t._setObjectFit(e)}getObjectFit(){return this._arrDrawingLayer.length?this._arrDrawingLayer[0]._getObjectFit():null}setVisible(e){this._arrDrawingLayer.length&&(this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.display=e?"block":"none")}_switchPointerEvent(){if(this._arrDrawingLayer.length)for(let e of this._arrDrawingLayer)e.getMode()}}it.DDN_LAYER_ID=1,it.DBR_LAYER_ID=2,it.DLR_LAYER_ID=3,it.USER_DEFINED_LAYER_BASE_ID=100;class st extends ce{constructor(e,t,i,s,r){super(e,{x:t,y:i,width:s,height:0},r),_e.set(this,void 0),ye.set(this,void 0),this._fabricObject.paddingTop=15,this._fabricObject.calcTextHeight=function(){for(var e=0,t=0,i=this._textLines.length;t<i;t++)e+=this.getHeightOfLine(t);return e+=2*this.paddingTop},this._fabricObject._getTopOffset=function(){return-this.height/2+this.getHeightOfLine(0)*(1-1/this.lineHeight)/2+this.paddingTop},this.set("backgroundColor","rgba(50, 50, 52, .8)"),this.set("lineHeight",1.3),this.set("textAlign","center")}setDuration(e){y(this,_e,e,"f"),_(this,ye,"f")&&clearTimeout(_(this,ye,"f")),_(this,_e,"f")>=0&&y(this,ye,setTimeout((()=>{this.set("visible",!1),this._drawingLayer&&this._drawingLayer.renderAll()}),_(this,_e,"f")),"f")}getDuration(){return _(this,_e,"f")}}_e=new WeakMap,ye=new WeakMap;class rt{constructor(){ve.add(this),Ie.set(this,void 0),Ee.set(this,void 0),be.set(this,void 0),Se.set(this,!0),this._drawingLayersManager=new it}createDrawingLayerBaseCvs(e,t,i="contain"){if("number"!=typeof e||e<=1)throw new Error("Invalid 'width'.");if("number"!=typeof t||t<=1)throw new Error("Invalid 'height'.");if(!["contain","cover"].includes(i))throw new Error("Unsupported 'objectFit'.");const s=document.createElement("canvas");return s.width==e&&s.height==t||(s.width=e,s.height=t),s.style.objectFit=i,this._innerComponent.appendChild(s),s}_createDrawingLayer(e,t,i,s){if(!this._layerBaseCvs){let s;try{s=this.getContentDimensions()}catch(e){if("Invalid content dimensions."!==(e.message||e))throw e}e||(e=(null==s?void 0:s.width)||1280),t||(t=(null==s?void 0:s.height)||720),i||(i=(null==s?void 0:s.objectFit)||"contain"),this._layerBaseCvs=this.createDrawingLayerBaseCvs(e,t,i)}const r=this._layerBaseCvs,n=this._drawingLayersManager.createDrawingLayer(r,s);return r.parentElement.setAttribute("slot","drawing-layer"),n}createDrawingLayer(){let e=this._createDrawingLayer();return 999==e.getId()&&(e=this._createDrawingLayer()),e}deleteDrawingLayer(e){this._drawingLayersManager.deleteDrawingLayer(e),this._drawingLayersManager.getAllDrawingLayers().length||this._layerBaseCvs&&(this._layerBaseCvs.remove(),this._layerBaseCvs=null)}deleteUserDefinedDrawingLayer(e){if("number"!=typeof e)throw new TypeError("Invalid id.");if(e<it.USER_DEFINED_LAYER_BASE_ID)throw new Error(`The drawing layer with id ${e} is not defined by users.`);this.deleteDrawingLayer(e)}_clearDrawingLayers(){const e=this.getAllDrawingLayers();for(let t of e)this.deleteDrawingLayer(t.getId())}clearUserDefinedDrawingLayers(){const e=this.getAllDrawingLayers();for(let t of e){const e=t.getId();e<it.USER_DEFINED_LAYER_BASE_ID||this.deleteUserDefinedDrawingLayer(e)}}getDrawingLayer(e){if(999==e)return null;const t=this._drawingLayersManager.getDrawingLayer(e);return t||([it.DDN_LAYER_ID,it.DBR_LAYER_ID,it.DLR_LAYER_ID].includes(e)?this._createDrawingLayer(null,null,null,e):null)}getAllDrawingLayers(){return this._drawingLayersManager.getAllDrawingLayers().filter((e=>e.getId()>=0&&999!==e.getId()))}updateDrawingLayers(e){((e,t,i)=>{if(!(e<=1||t<=1)){if(!["contain","cover"].includes(i))throw new Error("Unsupported 'objectFit'.");this._drawingLayersManager.setDimensions({width:e,height:t},{backstoreOnly:!0}),this._drawingLayersManager.setObjectFit(i)}})(e.width,e.height,e.objectFit)}getSelectedDrawingItems(){return this._drawingLayersManager.getSelectedDrawingItems()}setTipConfig(e){if(!(P(t=e)&&U(t.topLeftPoint)&&A(t.width))||t.width<=0||!A(t.duration)||"coordinateBase"in t&&!["view","image"].includes(t.coordinateBase))throw new Error("Invalid tip config.");var t;y(this,Ie,JSON.parse(JSON.stringify(e)),"f"),_(this,Ie,"f").coordinateBase||(_(this,Ie,"f").coordinateBase="view"),y(this,be,e.duration,"f"),_(this,ve,"m",xe).call(this)}getTipConfig(){return _(this,Ie,"f")?_(this,Ie,"f"):null}setTipVisible(e){if("boolean"!=typeof e)throw new TypeError("Invalid value.");this._tip&&(this._tip.set("visible",e),this._drawingLayerOfTip&&this._drawingLayerOfTip.renderAll()),y(this,Se,e,"f")}isTipVisible(){return _(this,Se,"f")}updateTipMessage(e){if(!_(this,Ie,"f"))throw new Error("Tip config is not set.");this._tipStyleId||(this._tipStyleId=et.createDrawingStyle({fillStyle:"#FFFFFF",paintMode:"fill",fontFamily:"Open Sans",fontSize:40})),this._drawingLayerOfTip||(this._drawingLayerOfTip=this._createDrawingLayer(null,null,null,999)),this._tip?this._tip.set("text",e):this._tip=_(this,ve,"m",Ce).call(this,e,_(this,Ie,"f").topLeftPoint.x,_(this,Ie,"f").topLeftPoint.y,_(this,Ie,"f").width,_(this,Ie,"f").coordinateBase,this._tipStyleId),_(this,ve,"m",Ae).call(this,this._tip,this._drawingLayerOfTip),this._tip.set("visible",_(this,Se,"f")),this._drawingLayerOfTip&&this._drawingLayerOfTip.renderAll(),_(this,Ee,"f")&&clearTimeout(_(this,Ee,"f")),_(this,be,"f")>=0&&y(this,Ee,setTimeout((()=>{_(this,ve,"m",Te).call(this)}),_(this,be,"f")),"f")}}Ie=new WeakMap,Ee=new WeakMap,be=new WeakMap,Se=new WeakMap,ve=new WeakSet,Ce=function(e,t,i,s,r,n){const a=new st(e,t,i,s,n);return a.coordinateBase=r,a},Ae=function(e,t){t.hasDrawingItem(e)||t.addDrawingItems([e])},Te=function(){this._tip&&this._drawingLayerOfTip.removeDrawingItems([this._tip])},xe=function(){if(!this._tip)return;const e=_(this,Ie,"f");this._tip.coordinateBase=e.coordinateBase,this._tip.setTextRect({x:e.topLeftPoint.x,y:e.topLeftPoint.y,width:e.width,height:0}),this._tip.set("width",this._tip.get("width")),this._tip._drawingLayer&&this._tip._drawingLayer.renderAll()};class nt extends HTMLElement{constructor(){super(),Le.set(this,void 0);const e=document.createElement("template").content,t=document.createElement("div");t.setAttribute("class","wrapper"),e.appendChild(t),y(this,Le,t,"f");const i=document.createElement("slot");i.setAttribute("name","content"),t.append(i);const s=document.createElement("slot");s.setAttribute("name","drawing-layer"),t.append(s);const r=document.createElement("style");r.textContent="\n      .wrapper {\n        position: relative;\n        width: 100%;\n        height: 100%;\n      }\n      ::slotted(*) {\n        position: absolute;\n        left: 0;\n        top: 0;\n        width: 100%;\n        height: 100%;\n      }\n    ",e.appendChild(r),this.attachShadow({mode:"open"}).appendChild(e.cloneNode(!0))}getWrapper(){return _(this,Le,"f")}setContent(e){this.removeContent(),e.setAttribute("slot","content"),this.appendChild(e)}getContent(){return this.querySelector('[slot="content"]')}removeContent(){var e;null===(e=this.querySelectorAll('[slot="content"]'))||void 0===e||e.forEach((e=>e.remove()))}}Le=new WeakMap,customElements.get("dce-component")||customElements.define("dce-component",nt);class at extends HTMLElement{constructor(){super();const e=window._dce_default_template.content;this.attachShadow({mode:"open"}).appendChild(e.cloneNode(!0))}showScanLaser(){const e=this.shadowRoot.querySelector(".dce-scanlight");e&&(e.style.display="")}hideScanLaser(){const e=this.shadowRoot.querySelector(".dce-scanlight");e&&(e.style.display="none")}getElement(e){return this.shadowRoot.querySelector(e)}getVideoContainer(){return this.shadowRoot.querySelector(".dce-video-container")}getScanAreaEl(){return this.shadowRoot.querySelector(".dce-scanarea")}getScanLightEl(){return this.shadowRoot.querySelector(".dce-scanlight")}getLoadingBackgroundEl(){return this.shadowRoot.querySelector(".dce-bg-loading")}getCameraBackgroundEl(){return this.shadowRoot.querySelector(".dce-bg-camera")}getCameraSelectEl(){return this.shadowRoot.querySelector(".dce-sel-camera")}getResolutionSelectEl(){return this.shadowRoot.querySelector(".dce-sel-resolution")}getResolutionOptionEl(){return this.shadowRoot.querySelector(".dce-opt-gotResolution")}getCloseBtnEl(){return this.shadowRoot.querySelector(".dce-btn-close")}getDLRSelectEl(){return this.shadowRoot.querySelector(".dlr-sel-minletter")}getDLROptionEl(){return this.shadowRoot.querySelector(".dlr-opt-gotMinLtr")}}class ot extends rt{static set engineResourcePath(e){if(ot._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");ot._engineResourcePath=(e=>{if(null==e&&(e="./"),v);else{let t=document.createElement("a");t.href=e,e=t.href}return e.endsWith("/")||(e+="/"),e})(e)}static get engineResourcePath(){return ot._engineResourcePath}static set defaultUIElementURL(e){ot._defaultUIElementURL=e}static get defaultUIElementURL(){var e;return null===(e=ot._defaultUIElementURL)||void 0===e?void 0:e.replace("@engineResourcePath/",ot.engineResourcePath)}static async createInstance(e){customElements.get(ot.uiComponentName)||customElements.define(ot.uiComponentName,at),ot._hasEngineResourceLoaded=!0;const t=new ot;return await t.setUIElement(e||ot.defaultUIElementURL),t}static _transformCoordinates(e,t,i,s,r,n,a){const o=n/s,h=a/r;e.x=Math.round(e.x/o+t),e.y=Math.round(e.y/h+i)}set _singleFrameMode(e){if("boolean"!=typeof e)throw new TypeError("Invalid value.");e!==_(this,Ve,"f")&&(this._unbindUI(),y(this,Ve,e,"f"),this._bindUI())}get _singleFrameMode(){return _(this,Ve,"f")}get disposed(){return _(this,Ue,"f")}constructor(){super(),Fe.add(this),De.set(this,void 0),Me.set(this,void 0),Re.set(this,void 0),this.containerClassName="dce-video-container",Oe.set(this,void 0),this.videoFit="contain",this._hideDefaultSelection=!1,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,Pe.set(this,null),this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=6,ke.set(this,!1),Be.set(this,!1),We.set(this,{width:0,height:0}),this._updateLayersTimeout=500,this._videoResizeListener=()=>{_(this,Fe,"m",Ye).call(this),this._updateLayersTimeoutId&&clearTimeout(this._updateLayersTimeoutId),this._updateLayersTimeoutId=setTimeout((()=>{this.disposed||(this.eventHandler.fire("videoEl:resized",null,{async:!1}),this.eventHandler.fire("content:updated",null,{async:!1}),this.isScanLaserVisible()&&_(this,Fe,"m",Ze).call(this))}),this._updateLayersTimeout)},this._windowResizeListener=()=>{ot._onLog&&ot._onLog("window resize event triggered."),_(this,We,"f").width===document.documentElement.clientWidth&&_(this,We,"f").height===document.documentElement.clientHeight||(_(this,We,"f").width=document.documentElement.clientWidth,_(this,We,"f").height=document.documentElement.clientHeight,this._videoResizeListener())},Ve.set(this,!1),this._singleFrameModeIpt=null,this._clickIptSingleFrameMode=()=>{if(this._singleFrameMode){if(!this._singleFrameModeIpt){const e=document.createElement("input");this._singleFrameModeIpt=e,e.setAttribute("type","file"),e.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),e.setAttribute("capture",""),e.addEventListener("change",(async()=>{const t=e.files[0];e.value="";{const e=async e=>{let t=null,i=null;if("undefined"!=typeof createImageBitmap)try{if(t=await createImageBitmap(e),t)return t}catch(e){}var s;return t||(i=await(s=e,new Promise(((e,t)=>{let i=URL.createObjectURL(s),r=new Image;r.src=i,r.onload=()=>{e(r)},r.onerror=e=>{t(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}})))),i},i=(e,t,i,s)=>{e.width==i&&e.height==s||(e.width=i,e.height=s);const r=e.getContext("2d");r.clearRect(0,0,e.width,e.height),r.drawImage(t,0,0)},s=await e(t),r=s instanceof HTMLImageElement?s.naturalWidth:s.width,n=s instanceof HTMLImageElement?s.naturalHeight:s.height;let a=this._cvsSingleFrameMode;const o=null==a?void 0:a.width,h=null==a?void 0:a.height;a||(a=document.createElement("canvas"),a.style.objectFit="contain",a.style.pointerEvents="none",this._cvsSingleFrameMode=a),i(a,s,r,n),this._innerComponent.setContent(a),o===a.width&&h===a.height||this.eventHandler.fire("content:updated",null,{async:!1})}this._onSingleFrameAcquired&&setTimeout((()=>{this._onSingleFrameAcquired(this._cvsSingleFrameMode)}),0)})),e.style.position="fixed",e.style.left="-1px",e.style.top="-1px",e.style.width="1px",e.style.height="1px",e.style.backgroundColor="transparent",e.style.color="transparent",document.body.appendChild(e)}this._singleFrameModeIpt.click()}},this.extraBindings=[],this._ddnUnverifiedResultsStyle={fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"transparent",paintMode:"strokeAndFill"},this._styleIdsOfUnverifiedResults={ddn:void 0},Ne.set(this,[]),this._capturedResultReceiver={onCapturedResultReceived:(e,t)=>{var i,s,r,n;if(this._clearInnerDrawingItems(),!e)return;const a=e.originalImageTag;if(!a)return;const o=e.items;if(!(null==o?void 0:o.length))return;const l=(null===(i=a.cropRegion)||void 0===i?void 0:i.left)||0,d=(null===(s=a.cropRegion)||void 0===s?void 0:s.top)||0,c=(null===(r=a.cropRegion)||void 0===r?void 0:r.right)?a.cropRegion.right-l:a.originalWidth,f=(null===(n=a.cropRegion)||void 0===n?void 0:n.bottom)?a.cropRegion.bottom-d:a.originalHeight,g=a.currentWidth,u=a.currentHeight,m=(e,t,i,s,r,n,a,o,h=[],l)=>{t.forEach((e=>ot._transformCoordinates(e,i,s,r,n,a,o)));const d=new Ke({points:[{x:t[0].x,y:t[0].y},{x:t[1].x,y:t[1].y},{x:t[2].x,y:t[2].y},{x:t[3].x,y:t[3].y}]},l);for(let e of h)d.addNote(e);e.addDrawingItems([d]),_(this,Ne,"f").push(d)};let w,p;for(let e of o)switch(e.type){case h.CRIT_ORIGINAL_IMAGE:break;case h.CRIT_BARCODE:w=this.getDrawingLayer(it.DBR_LAYER_ID),p=[{name:"format",content:e.formatString},{name:"text",content:e.text}],m(w,e.location.points,l,d,c,f,g,u,p);break;case h.CRIT_TEXT_LINE:w=this.getDrawingLayer(it.DLR_LAYER_ID),p=[{name:"text",content:e.text}],m(w,e.location.points,l,d,c,f,g,u,p);break;case h.CRIT_DETECTED_QUAD:w=this.getDrawingLayer(it.DDN_LAYER_ID),(null==t?void 0:t.isDetectVerifyOpen)?e.verify?m(w,e.location.points,l,d,c,f,g,u,[]):(void 0===this._styleIdsOfUnverifiedResults.ddn&&(this._styleIdsOfUnverifiedResults.ddn=et.createDrawingStyle(this._ddnUnverifiedResultsStyle)),m(w,e.location.points,l,d,c,f,g,u,[],this._styleIdsOfUnverifiedResults.ddn)):m(w,e.location.points,l,d,c,f,g,u,[]);break;case h.CRIT_NORMALIZED_IMAGE:w=this.getDrawingLayer(it.DDN_LAYER_ID),(null==t?void 0:t.isNormalizeVerifyOpen)?e.verify?m(w,e.location.points,l,d,c,f,g,u,[]):(void 0===this._styleIdsOfUnverifiedResults.ddn&&(this._styleIdsOfUnverifiedResults.ddn=et.createDrawingStyle(this._ddnUnverifiedResultsStyle)),m(w,e.location.points,l,d,c,f,g,u,[],this._styleIdsOfUnverifiedResults.ddn)):m(w,e.location.points,l,d,c,f,g,u,[]);break;case h.CRIT_PARSED_RESULT:break;default:throw new Error("Illegal item type.")}}},Ue.set(this,!1),this.eventHandler=new J,this.eventHandler.on("content:updated",(()=>{_(this,De,"f")&&clearTimeout(_(this,De,"f")),y(this,De,setTimeout((()=>{let e;this._updateVideoContainer();try{e=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}this.updateDrawingLayers(e),this.updateConvertedRegion(e)}),0),"f")})),this.eventHandler.on("videoEl:resized",(()=>{_(this,Me,"f")&&clearTimeout(_(this,Me,"f")),y(this,Me,setTimeout((()=>{this._updateVideoContainer()}),0),"f")}))}_setUIElement(e){e instanceof HTMLTemplateElement?(window._dce_default_template=e,this.UIElement=new at):this.UIElement=e,this._unbindUI(),this._bindUI()}async setUIElement(e){let t;if(t="string"==typeof e?await K(e):e,t instanceof HTMLDivElement&&0==t.childElementCount){const e=await K(ot.defaultUIElementURL);e instanceof HTMLTemplateElement?(window._dce_default_template=e,t.append(new at)):t.append(e),this._setUIElement(t)}else this._setUIElement(t)}getUIElement(){return this.UIElement}_bindUI(){var e;if(!this.UIElement)throw new Error("Need to set 'UIElement'.");if(this._innerComponent)return;let t,i=this.UIElement;if(i instanceof at?t=i.getElement(`.${this.containerClassName}`):i instanceof HTMLDivElement&&1===i.childElementCount&&i.firstElementChild instanceof at?(t=i.firstElementChild.getElement(`.${this.containerClassName}`),i=i.firstElementChild):t=i.classList.contains(this.containerClassName)?i:i.querySelector(`.${this.containerClassName}`),!t)throw Error(`Can not find the element with class '${this.containerClassName}'.`);if(this._innerComponent=new nt,t.appendChild(this._innerComponent),this._singleFrameMode);else{const e=document.createElement("video");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.objectFit=this.getVideoFit(),e.setAttribute("playsinline","true"),e.setAttribute("muted","true"),y(this,Oe,e,"f");const t=document.createElement("div");t.append(e),t.style.overflow="hidden",this._videoContainer=t,this._innerComponent.setContent(t)}if(i instanceof at?(this._selRsl=i.getElement(".dce-sel-resolution"),this._selMinLtr=i.getElement(".dlr-sel-minletter"),this._divScanArea=i.getElement(".dce-scanarea"),this._divScanLight=i.getElement(".dce-scanlight"),this._bgLoading=i.getElement(".dce-bg-loading"),this._bgCamera=i.getElement(".dce-bg-camera"),this._selCam=i.getElement(".dce-sel-camera"),this._optGotRsl=i.getElement(".dce-opt-gotResolution"),this._btnClose=i.getElement(".dce-btn-close"),this._optGotMinLtr=i.getElement(".dlr-opt-gotMinLtr")):(this._selRsl=i.querySelector(".dce-sel-resolution"),this._selMinLtr=i.querySelector(".dlr-sel-minletter"),this._divScanArea=i.querySelector(".dce-scanarea"),this._divScanLight=i.querySelector(".dce-scanlight"),this._bgLoading=i.querySelector(".dce-bg-loading"),this._bgCamera=i.querySelector(".dce-bg-camera"),this._selCam=i.querySelector(".dce-sel-camera"),this._optGotRsl=i.querySelector(".dce-opt-gotResolution"),this._btnClose=i.querySelector(".dce-btn-close"),this._optGotMinLtr=i.querySelector(".dlr-opt-gotMinLtr")),this._selRsl&&(this._hideDefaultSelection||this._singleFrameMode||this._selRsl.options.length||(this._selRsl.innerHTML=['<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="1920" data-height="1080">1920x1080</option>','<option data-width="1280" data-height="720">1280x720</option>','<option data-width="640" data-height="480">640x480</option>'].join(""),this._optGotRsl=this._selRsl.options[0])),this._selMinLtr&&(this._hideDefaultSelection||this._singleFrameMode||this._selMinLtr.options.length||(this._selMinLtr.innerHTML=['<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="17">17+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._selMinLtr.options[0])),this.isScanLaserVisible()||_(this,Fe,"m",Ye).call(this),this._singleFrameMode||this._hideDefaultSelection?(this._singleFrameMode&&(this._innerComponent&&(this._innerComponent.addEventListener("click",this._clickIptSingleFrameMode),this._innerComponent.setAttribute("title","Take a photo")),this._bgCamera&&(this._bgCamera.style.display="block")),this._selCam&&(this._selCam.style.display="none"),this._selRsl&&(this._selRsl.style.display="none"),this._selMinLtr&&(this._selMinLtr.style.display="none")):(this._selCam&&(this._selCam.style.display="block"),this._selRsl&&(this._selRsl.style.display="block"),this._selMinLtr&&(this._selMinLtr.style.display="block"),this._stopLoading()),window.ResizeObserver){this._resizeObserver||(this._resizeObserver=new ResizeObserver((e=>{var t;ot._onLog&&ot._onLog("resize observer triggered.");for(let i of e)i.target===(null===(t=this._innerComponent)||void 0===t?void 0:t.getWrapper())&&this._videoResizeListener()})));const t=null===(e=this._innerComponent)||void 0===e?void 0:e.getWrapper();t&&this._resizeObserver.observe(t)}_(this,We,"f").width=document.documentElement.clientWidth,_(this,We,"f").height=document.documentElement.clientHeight,window.addEventListener("resize",this._windowResizeListener)}_unbindUI(){var e,t,i;this._singleFrameMode?(this._innerComponent&&(this._innerComponent.removeEventListener("click",this._clickIptSingleFrameMode),this._innerComponent.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._stopLoading(),_(this,Fe,"m",Ye).call(this),null===(e=this._drawingLayersManager)||void 0===e||e.clearDrawingLayers(),this._layerBaseCvs=null,this._drawingLayerOfMask=null,this._drawingLayerOfTip=null,null===(t=this._innerComponent)||void 0===t||t.remove(),this._innerComponent=null,y(this,Oe,null,"f"),null===(i=this._videoContainer)||void 0===i||i.remove(),this._videoContainer=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this._divScanArea=null,this._divScanLight=null,this._singleFrameModeIpt&&(this._singleFrameModeIpt.remove(),this._singleFrameModeIpt=null),window.ResizeObserver&&this._resizeObserver&&this._resizeObserver.disconnect(),window.removeEventListener("resize",this._windowResizeListener)}_startLoading(){this._bgLoading&&(this._bgLoading.style.display="",this._bgLoading.style.animationPlayState="")}_stopLoading(){this._bgLoading&&(this._bgLoading.style.display="none",this._bgLoading.style.animationPlayState="paused")}_renderCamerasInfo(e,t){if(!this._selCam)return;let i;this._selCam.textContent="";for(let s of t){const t=document.createElement("option");t.value=s.deviceId,t.innerText=s.label,this._selCam.append(t),s.deviceId&&e&&e.deviceId==s.deviceId&&(i=t)}this._selCam.value=i?i.value:""}_renderResolutionInfo(e){this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",e.width),this._optGotRsl.setAttribute("data-height",e.height),this._optGotRsl.innerText=e.width+"x"+e.height,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got"))}getVideoElement(){return _(this,Oe,"f")}isVideoLoaded(){return!!_(this,Oe,"f")&&4==_(this,Oe,"f").readyState}setVideoFit(e){if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`Unsupported value '${e}'.`);if(this.videoFit=e,!_(this,Oe,"f"))return;if(_(this,Oe,"f").style.objectFit=e,this._singleFrameMode)return;let t;this._updateVideoContainer();try{t=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}_(this,Fe,"m",ze).call(this,t,this.getConvertedRegion()),this.updateDrawingLayers(t)}getVideoFit(){return this.videoFit}getContentDimensions(){var e,t,i,s;let r,n,a;if(this._singleFrameMode?(r=null===(i=this._cvsSingleFrameMode)||void 0===i?void 0:i.width,n=null===(s=this._cvsSingleFrameMode)||void 0===s?void 0:s.height,a="contain"):(r=null===(e=_(this,Oe,"f"))||void 0===e?void 0:e.videoWidth,n=null===(t=_(this,Oe,"f"))||void 0===t?void 0:t.videoHeight,a=this.getVideoFit()),!r||!n)throw new Error("Invalid content dimensions.");return{width:r,height:n,objectFit:a}}updateConvertedRegion(e){const t=Z.convert(this.scanRegion,e.width,e.height);y(this,Pe,t,"f"),_(this,Re,"f")&&clearTimeout(_(this,Re,"f")),y(this,Re,setTimeout((()=>{let e;try{e=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}_(this,Fe,"m",Ge).call(this,e,t),_(this,Fe,"m",ze).call(this,e,t)}),0),"f")}getConvertedRegion(){return _(this,Pe,"f")}setScanRegion(e){if(null!=e&&!W(e)&&!j(e))throw TypeError("Invalid 'region'.");let t;this.scanRegion=e?JSON.parse(JSON.stringify(e)):null;try{t=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}this.updateConvertedRegion(t)}getScanRegion(){return JSON.parse(JSON.stringify(this.scanRegion))}getVisibleRegionOfVideo(e){if(!this.isVideoLoaded())throw new Error("The video is not loaded.");const t=_(this,Oe,"f").videoWidth,i=_(this,Oe,"f").videoHeight,s=this.getVideoFit(),{width:r,height:n}=this._innerComponent.getBoundingClientRect();if(r<=0||n<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");let a;const o={x:0,y:0,width:t,height:i,isMeasuredInPercentage:!1};if("cover"===s&&(r/n<t/i?(a=n/i,o.x=Math.floor((t-r/a)/2),o.y=0,o.width=Math.ceil(r/a),o.height=i):(a=r/t,o.x=0,o.y=Math.floor((i-n/a)/2),o.width=t,o.height=Math.ceil(n/a))),null==e?void 0:e.inPixels)return o;const h=o;return h.x=Math.ceil(h.x/i*100),h.y=Math.ceil(h.y/t*100),h.width=Math.floor(h.width/t*100),h.height=Math.floor(h.height/i*100),h.isMeasuredInPercentage=!0,o}setScanRegionMask(e,t,i,s){this._drawingLayerOfMask||(this._drawingLayerOfMask=this._createDrawingLayer(null,null,null,-2),this.isScanRegionMaskVisible()||_(this,Fe,"m",He).call(this)),this.clearScanRegionMask(),this._maskBackRectStyleId||(this._maskBackRectStyleId=et.createDrawingStyle({paintMode:"fill",fillStyle:this.regionMaskFillStyle,lineWidth:0})),this._maskCenterRectStyleId||(this._maskCenterRectStyleId=et.createDrawingStyle({paintMode:"stroke",strokeStyle:this.regionMaskStrokeStyle,lineWidth:this.regionMaskLineWidth}));const r=this._drawingLayerOfMask.width,n=this._drawingLayerOfMask.height,a=new re({x:0,y:0,width:r,height:n},this._maskBackRectStyleId),o=new re({x:-r/2,y:-n/2+t,width:e,height:s}),h=new re({x:-r/2+e+i,y:-n/2+t,width:r-e-i<0?0:r-e-i,height:s}),l=new re({x:-r/2,y:-n/2,width:r,height:t}),d=new re({x:-r/2,y:-n/2+t+s,width:r,height:n-t-s<0?0:n-t-s});o.set("strokeWidth",0),h.set("strokeWidth",0),l.set("strokeWidth",0),d.set("strokeWidth",0);const c=new $e([o,h,l,d])._getFabricObject();a.set("clipPath",c);const f=new re({x:e,y:t,width:i,height:s},this._maskCenterRectStyleId);this._drawingLayerOfMask.addDrawingItems([a,f])}clearScanRegionMask(){this._drawingLayerOfMask&&this._drawingLayerOfMask.clearDrawingItems()}deleteScanRegionMask(){this._drawingLayerOfMask&&this.deleteDrawingLayer(this._drawingLayerOfMask.getId())}_setScanRegionMaskVisible(e){y(this,ke,e,"f"),e?_(this,Fe,"m",je).call(this):_(this,Fe,"m",He).call(this)}setScanRegionMaskVisible(e){this._setScanRegionMaskVisible(e),this._userSetMaskVisible=e}isScanRegionMaskVisible(){return _(this,ke,"f")}setScanRegionMaskStyle(e){if(!e)return;let t;e.fillStyle&&(this.regionMaskFillStyle=e.fillStyle),e.strokeStyle&&(this.regionMaskStrokeStyle=e.strokeStyle),e.lineWidth&&(this.regionMaskLineWidth=e.lineWidth),this._maskBackRectStyleId&&et.updateDrawingStyle(this._maskBackRectStyleId,{fillStyle:this.regionMaskFillStyle}),this._maskCenterRectStyleId&&et.updateDrawingStyle(this._maskCenterRectStyleId,{strokeStyle:this.regionMaskStrokeStyle,lineWidth:this.regionMaskLineWidth});try{t=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}_(this,Fe,"m",Ge).call(this,t,this.getConvertedRegion())}getScanRegionMaskStyle(){return{fillStyle:this.regionMaskFillStyle,strokeStyle:this.regionMaskStrokeStyle,lineWidth:this.regionMaskLineWidth}}_setScanLaserVisible(e){y(this,Be,e,"f"),e?_(this,Fe,"m",Ze).call(this):_(this,Fe,"m",Ye).call(this)}setScanLaserVisible(e){this._setScanLaserVisible(e),this._userSetLaserVisible=e}isScanLaserVisible(){return _(this,Be,"f")}_updateVideoContainer(){if(!_(this,Oe,"f"))return;if(this._singleFrameMode)return;let e=1;const t=_(this,Oe,"f").style.transform.match(/scale\((.+)\)/);t&&(e=parseFloat(t[1]));const i=this._videoContainer;if("contain"===this.videoFit&&e>1){const e=_(this,Oe,"f").videoWidth,t=_(this,Oe,"f").videoHeight,{width:s,height:r}=this._innerComponent.getBoundingClientRect(),n=e/t;if(s/r<n){let e=s/n;i.style.left="0",i.style.top=(r-e)/2/r*100+"%",i.style.width="100%",i.style.height=e/r*100+"%"}else{let e=r*n;i.style.left=(s-e)/2/s*100+"%",i.style.top="0",i.style.width=e/s*100+"%",i.style.height="100%"}}else i.style.left="0",i.style.top="0",i.style.width="100%",i.style.height="100%"}updateLayers(){let e;this._updateVideoContainer();try{e=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}const t=this.getConvertedRegion();_(this,Fe,"m",ze).call(this,e,t),this.updateDrawingLayers(e),_(this,Fe,"m",Ge).call(this,e,t)}_clearInnerDrawingItems(){_(this,Ne,"f").forEach((e=>e.remove())),_(this,Ne,"f").length=0}dispose(){this._unbindUI(),delete window._dce_default_template,this.__proto__=null;for(let e in this)delete this[e];Object.defineProperty(this,"disposed",{value:!0})}}De=new WeakMap,Me=new WeakMap,Re=new WeakMap,Oe=new WeakMap,Pe=new WeakMap,ke=new WeakMap,Be=new WeakMap,We=new WeakMap,Ve=new WeakMap,Ne=new WeakMap,Ue=new WeakMap,Fe=new WeakSet,Ge=function(e,t){t&&(0!==t.x||0!==t.y||t.width!==e.width||t.height!==e.height)?this.setScanRegionMask(t.x,t.y,t.width,t.height):this.clearScanRegionMask()},je=function(){this._drawingLayerOfMask&&this._drawingLayerOfMask.setVisible(!0)},He=function(){this._drawingLayerOfMask&&this._drawingLayerOfMask.setVisible(!1)},Ze=function(){this._divScanLight&&"none"==this._divScanLight.style.display&&(this._divScanLight.style.display="block")},Ye=function(){this._divScanLight&&(this._divScanLight.style.display="none")},ze=function(e,t){if(!this._divScanArea)return;if(!this._innerComponent.getContent())return;const{width:i,height:s,objectFit:r}=e;t||(t={x:0,y:0,width:i,height:s});const{width:n,height:a}=this._innerComponent.getBoundingClientRect();if(n<=0||a<=0)throw new Error("Unable to get content dimensions. Camera view may not be rendered on the page.");const o=n/a,h=i/s;let l,d,c,f,g=1;if("contain"===r)o<h?(g=n/i,l=0,d=(a-s*g)/2):(g=a/s,l=(n-i*g)/2,d=0),l+=t.x*g,d+=t.y*g,c=t.width*g,f=t.height*g;else if("cover"===r)if(o<h){g=a/s,l=t.x*g-(i*g-n)/2,l=Math.max(l,0),l=Math.min(l,n),d=t.y*g;let e=(t.x+t.width)*g-(i*g-n)/2;e=Math.max(e,0),e=Math.min(e,n),c=e-l,f=t.height*g}else{g=n/i,l=t.x*g,d=t.y*g-(s*g-a)/2,d=Math.max(d,0),d=Math.min(d,a);let e=(t.y+t.height)*g-(s*g-a)/2;e=Math.max(e,0),e=Math.min(e,a),c=t.width*g,f=e-d}else l=0,d=0,c=0,f=0;this._divScanArea.style.left=l+"px",this._divScanArea.style.top=d+"px",this._divScanArea.style.width=c+"px",this._divScanArea.style.height=f+"px"},ot.uiComponentName="default-camera-view",ot._hasEngineResourceLoaded=!1,ot._engineResourcePath=I,ot._defaultUIElementURL="@engineResourcePath/dce.ui.html";class ht extends rt{static async createInstance(e){const t=new ht;return await t.setUIElement(e||_(t,Je,"m",Qe).call(t)),t}get disposed(){return _(this,qe,"f")}constructor(){super(),Je.add(this),this.containerClassName="dce-image-container",Xe.set(this,void 0),qe.set(this,!1)}_setUIElement(e){this.UIElement=e,this._unbindUI(),this._bindUI()}async setUIElement(e){let t;if(t="string"==typeof e?await K(e):e,t instanceof HTMLDivElement&&0==t.childElementCount){const e=_(this,Je,"m",Qe).call(this);this._setUIElement(e),t.append(this.getUIElement()),this.UIElement=t}else this._setUIElement(t)}getUIElement(){return this.UIElement}_bindUI(){if(!this.UIElement)throw new Error("Need to set 'UIElement'.");if(this._innerComponent)return;const e=this.UIElement;let t=e.classList.contains(this.containerClassName)?e:e.querySelector(`.${this.containerClassName}`);t||(t=document.createElement("div"),t.style.width="100%",t.style.height="100%",t.className=this.containerClassName,e.append(t)),this._innerComponent=new nt,t.appendChild(this._innerComponent)}_unbindUI(){var e,t;null===(e=this._drawingLayersManager)||void 0===e||e.clearDrawingLayers(),this._layerBaseCvs=null,null===(t=this._innerComponent)||void 0===t||t.remove(),this._innerComponent=null}setImage(e,t,i){if(!this._innerComponent)throw new Error("Need to set 'UIElement'.");let s=this._innerComponent.getContent();s||(s=document.createElement("canvas"),s.style.objectFit="contain",this._innerComponent.setContent(s)),s.width===t&&s.height===i||(s.width=t,s.height=i);const r=s.getContext("2d");r.clearRect(0,0,s.width,s.height),e instanceof Uint8Array||e instanceof Uint8ClampedArray?(e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),r.putImageData(new ImageData(e,t,i),0,0)):(e instanceof HTMLCanvasElement||e instanceof HTMLImageElement)&&r.drawImage(e,0,0)}getImage(){return this._innerComponent.getContent()}clearImage(){if(!this._innerComponent)return;let e=this._innerComponent.getContent();e&&e.getContext("2d").clearRect(0,0,e.width,e.height)}removeImage(){this._innerComponent&&this._innerComponent.removeContent()}setOriginalImage(e){if(B(e)){y(this,Xe,e,"f");const{width:t,height:i,bytes:s,format:r}=Object.assign({},e);let n;if(r===o.IPF_GRAYSCALED){n=new Uint8ClampedArray(t*i*4);for(let e=0;e<n.length;e+=4)n[e]=s[e/4],n[e+1]=s[e/4],n[e+2]=s[e/4],n[e+3]=255}else n=new Uint8ClampedArray(s.buffer);this.setImage(n,t,i)}else if(e instanceof HTMLCanvasElement)y(this,Xe,e,"f"),this.setImage(e,e.width,e.height);else{if(!(e instanceof HTMLImageElement))throw new TypeError("Invalid img.");y(this,Xe,e,"f"),this.setImage(e,e.naturalWidth,e.naturalHeight)}let t;try{t=this.getContentDimensions()}catch(e){if("Invalid content dimensions."===(e.message||e))return;throw e}this.updateDrawingLayers(t)}getOriginalImage(){return _(this,Xe,"f")}getContentDimensions(){let e,t,i;if(this._innerComponent){const s=this._innerComponent.getContent();e=null==s?void 0:s.width,t=null==s?void 0:s.height,i="contain"}if(!e||!t)throw new Error("Invalid content dimensions.");return{width:e,height:t,objectFit:i}}_createDrawingLayer(e,t,i,s){if(!this._layerBaseCvs){let s;try{s=this.getContentDimensions()}catch(e){if("Invalid content dimensions."!==(e.message||e))throw e}e||(e=(null==s?void 0:s.width)||300),t||(t=(null==s?void 0:s.height)||150),i||(i=(null==s?void 0:s.objectFit)||"contain"),this._layerBaseCvs=this.createDrawingLayerBaseCvs(e,t,i)}const r=this._layerBaseCvs,n=this._drawingLayersManager.createDrawingLayer(r,s);return r.parentElement.setAttribute("slot","drawing-layer"),999!=s&&n.setMode("editor"),n}dispose(){this._unbindUI(),this.__proto__=null;for(let e in this)delete this[e];Object.defineProperty(this,"disposed",{value:!0})}}function lt(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)}function dt(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i}Xe=new WeakMap,qe=new WeakMap,Je=new WeakSet,Qe=function(){const e=document.createElement("div");return e.className=this.containerClassName,e.style.width="100%",e.style.height="100%",e},"function"==typeof SuppressedError&&SuppressedError;const ct="undefined"==typeof self;let ft,gt,ut,mt,wt;"undefined"!=typeof navigator&&(ft=navigator,gt=ft.userAgent,ut=ft.platform,mt=ft.mediaDevices),function(){if(!ct){const e={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:ft.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},t={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:ut,search:"Win"},Mac:{str:ut},Linux:{str:ut}};let i="unknownBrowser",s=0,r="unknownOS";for(let t in e){const r=e[t]||{};let n=r.str||gt,a=r.search||t,o=r.verStr||gt,h=r.verSearch||t;if(h instanceof Array||(h=[h]),-1!=n.indexOf(a)){i=t;for(let e of h){let t=o.indexOf(e);if(-1!=t){s=parseFloat(o.substring(t+e.length+1));break}}break}}for(let e in t){const i=t[e]||{};let s=i.str||gt,n=i.search||e;if(-1!=s.indexOf(n)){r=e;break}}"Linux"==r&&-1!=gt.indexOf("Windows NT")&&(r="HarmonyOS"),wt={browser:i,version:s,OS:r}}ct&&(wt={browser:"ssr",version:0,OS:"ssr"})}(),"undefined"!=typeof WebAssembly&&gt&&(!/Safari/.test(gt)||/Chrome/.test(gt)||/\(.+\s11_2_([2-6]).*\)/.test(gt)),mt&&mt.getUserMedia,"Chrome"===wt.browser&&wt.version>66||"Safari"===wt.browser&&wt.version>13||"OPR"===wt.browser&&wt.version>43||"Edge"===wt.browser&&wt.version;const pt=e=>e&&"object"==typeof e&&"function"==typeof e.then;class _t extends Promise{constructor(e){let t,i;super(((e,s)=>{t=e,i=s})),this._s="pending",this.resolve=e=>{this.isPending&&(pt(e)?this.task=e:(this._s="fulfilled",t(e)))},this.reject=e=>{this.isPending&&(this._s="rejected",i(e))},this.task=e}get status(){return this._s}get isPending(){return"pending"===this._s}get isFulfilled(){return"fulfilled"===this._s}get isRejected(){return"rejected"===this._s}get task(){return this._task}set task(e){let t;this._task=e,pt(e)?t=e:"function"==typeof e&&(t=new Promise(e)),t&&(async()=>{try{const i=await t;e===this._task&&this.resolve(i)}catch(t){e===this._task&&this.reject(t)}})()}get isEmpty(){return null==this._task}}function yt(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)}function vt(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i}"function"==typeof SuppressedError&&SuppressedError;class It{static multiply(e,t){const i=[];for(let s=0;s<3;s++){const r=t.slice(3*s,3*s+3);for(let t=0;t<3;t++){const s=[e[t],e[t+3],e[t+6]].reduce(((e,t,i)=>e+t*r[i]),0);i.push(s)}}return i}static identity(){return[1,0,0,0,1,0,0,0,1]}static translate(e,t,i){return It.multiply(e,[1,0,0,0,1,0,t,i,1])}static rotate(e,t){var i=Math.cos(t),s=Math.sin(t);return It.multiply(e,[i,-s,0,s,i,0,0,0,1])}static scale(e,t,i){return It.multiply(e,[t,0,0,0,i,0,0,0,1])}}var Et,bt,St,Ct,At,Tt,xt;!function(e){e.GREY="grey",e.GREY32="grey32",e.RGBA="rgba",e.RBGA="rbga",e.GRBA="grba",e.GBRA="gbra",e.BRGA="brga",e.BGRA="bgra"}(Et||(Et={}));class Lt{static get version(){return"1.0.1"}get disposed(){return yt(this,xt,"f")}constructor(){bt.set(this,Et.RGBA),St.set(this,null),Ct.set(this,null),At.set(this,null),this._bWebGLSupported=!0,this._reusedCvs=null,this._reusedWebGLCvs=null,Tt.set(this,null),xt.set(this,!1)}drawImage(e,t,i,s,r,n){if(this.disposed)throw Error("The 'ImageDataGetter' instance has been disposed.");if(!i||!s)throw new Error("Invalid 'sourceWidth' or 'sourceHeight'.");if(t instanceof HTMLVideoElement&&4!==t.readyState||t instanceof HTMLImageElement&&!t.complete)throw new Error("The source is not loaded.");let a;Lt._onLog&&(a=Date.now(),Lt._onLog("drawImage(), START: "+a));let o=0,h=0,l=i,d=s,c=0,f=0,g=i,u=s;r&&(r.sx&&(o=Math.round(r.sx)),r.sy&&(h=Math.round(r.sy)),r.sWidth&&(l=Math.round(r.sWidth)),r.sHeight&&(d=Math.round(r.sHeight)),r.dx&&(c=Math.round(r.dx)),r.dy&&(f=Math.round(r.dy)),r.dWidth&&(g=Math.round(r.dWidth)),r.dHeight&&(u=Math.round(r.dHeight)));let m,w=Et.RGBA;if((null==n?void 0:n.pixelFormat)&&(w=n.pixelFormat),(null==n?void 0:n.bufferContainer)&&(m=n.bufferContainer,m.length<4*g*u))throw new Error("Unexpected size of the 'bufferContainer'.");const p=e;if(null==n?void 0:n.bUseWebGL){Lt._onLog&&Lt._onLog("drawImage() in WebGL."),(p.width<c+g||p.height<f+u)&&(p.width=c+g,p.height=f+u,p.ctxWebGL&&p.ctxWebGL.viewport(0,0,c+g,f+u));const e=p.ctxWebGL||p.getContext("webgl",{antialias:!1})||p.getContext("experimental-webgl",{antialias:!1});if(!e){Lt._onLog&&Lt._onLog("WebGL unavailable.");const e=new Error("WebGL error: unable to initialize WebGL. Your browser or machine may not support it.");throw e.name="WebGLError",e}if(!p.ctxWebGL||w!==yt(this,bt,"f")){p.ctxWebGL=e;const t=e=>{const t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW);const i=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW),{positions:t,texCoords:i}},i=e=>{const t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t},s=(e,t)=>{const i=e.createProgram();if(t.forEach((t=>e.attachShader(i,t))),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS)){const t=new Error(`An error occured linking the program: ${e.getProgramInfoLog(i)}.`);throw t.name="WebGLError",t}return e.useProgram(i),i},r=(e,t,i)=>{const s=e.createShader(t);if(e.shaderSource(s,i),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const t=new Error(`An error occured compiling the shader: ${e.getShaderInfoLog(s)}.`);throw t.name="WebGLError",t}return s},n="\n                attribute vec2 a_position;\n                attribute vec2 a_texCoord;\n\n                uniform mat3 u_matrix;\n                uniform mat3 u_textureMatrix;\n\n                varying vec2 v_texCoord;\n                void main(void) {\n                gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1.0);\n                v_texCoord = vec4((u_textureMatrix * vec3(a_texCoord, 1)).xy, 0, 1.0).xy;\n                }\n            ";let a="rgb";["rgba","rbga","grba","gbra","brga","bgra"].includes(w)&&(a=w.slice(0,3));const o=`\n                precision mediump float;\n                varying vec2 v_texCoord;\n                uniform sampler2D u_image;\n                uniform float uColorFactor;\n\n                void main() {\n                    vec4 sample = texture2D(u_image, v_texCoord);\n                    float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                    gl_FragColor = vec4(sample.${a} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                }\n            `,h=s(e,[r(e,e.VERTEX_SHADER,n),r(e,e.FRAGMENT_SHADER,o)]);vt(this,Ct,{program:h,attribLocations:{vertexPosition:e.getAttribLocation(h,"a_position"),texPosition:e.getAttribLocation(h,"a_texCoord")},uniformLocations:{uSampler:e.getUniformLocation(h,"u_image"),uColorFactor:e.getUniformLocation(h,"uColorFactor"),uMatrix:e.getUniformLocation(h,"u_matrix"),uTextureMatrix:e.getUniformLocation(h,"u_textureMatrix")}},"f"),vt(this,At,t(e),"f"),vt(this,St,i(e),"f"),vt(this,bt,w,"f")}const r=(e,t,i)=>{e.bindBuffer(e.ARRAY_BUFFER,t),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0)},n=(e,t,i)=>{const s=e.RGBA,r=e.RGBA,n=e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,s,r,n,i)},_=(e,t,n,a)=>{e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),r(e,n.positions,t.attribLocations.vertexPosition),r(e,n.texCoords,t.attribLocations.texPosition),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,a),e.uniform1i(t.uniformLocations.uSampler,0),e.uniform1f(t.uniformLocations.uColorFactor,[Et.GREY,Et.GREY32].includes(w)?1:0);let m,p,_=It.translate(It.identity(),-1,-1);_=It.scale(_,2,2),_=It.scale(_,1/e.canvas.width,1/e.canvas.height),m=It.translate(_,c,f),m=It.scale(m,g,u),e.uniformMatrix3fv(t.uniformLocations.uMatrix,!1,m),p=It.translate(It.identity(),o/i,h/s),p=It.scale(p,l/i,d/s),e.uniformMatrix3fv(t.uniformLocations.uTextureMatrix,!1,p),e.drawArrays(e.TRIANGLES,0,6)};n(e,yt(this,St,"f"),t),_(e,yt(this,Ct,"f"),yt(this,At,"f"),yt(this,St,"f"));const y=m||new Uint8Array(4*g*u);if(e.readPixels(c,f,g,u,e.RGBA,e.UNSIGNED_BYTE,y),255!==y[3]){Lt._onLog&&Lt._onLog("WebGL drawing incorrect."),this._bWebGLSupported=!1;const e=new Error("WebGL error: incorrect WebGL drawing.");throw e.name="WebGLError",e}return Lt._onLog&&Lt._onLog("drawImage() in WebGL end. Costs: "+(Date.now()-a)),{context:e,pixelFormat:w===Et.GREY?Et.GREY32:w,bUseWebGL:!0}}{Lt._onLog&&Lt._onLog("drawImage() in context2d."),p.ctx2d||(p.ctx2d=p.getContext("2d",{willReadFrequently:!0}));const e=p.ctx2d;if(!e)throw new Error("Unable to get 'CanvasRenderingContext2D' from canvas.");return(p.width<c+g||p.height<f+u)&&(p.width=c+g,p.height=f+u),e.drawImage(t,o,h,l,d,c,f,g,u),Lt._onLog&&Lt._onLog("drawImage() in context2d end. Costs: "+(Date.now()-a)),{context:e,pixelFormat:Et.RGBA,bUseWebGL:!1}}}readCvsData(e,t,i){if(!(e instanceof CanvasRenderingContext2D||e instanceof WebGLRenderingContext))throw new Error("Invalid 'context'.");let s,r=0,n=0,a=e.canvas.width,o=e.canvas.height;if(t&&(t.x&&(r=t.x),t.y&&(n=t.y),t.width&&(a=t.width),t.height&&(o=t.height)),(null==i?void 0:i.length)<4*a*o)throw new Error("Unexpected size of the 'bufferContainer'.");if(e instanceof WebGLRenderingContext){const t=e;i?(t.readPixels(r,n,a,o,t.RGBA,t.UNSIGNED_BYTE,i),s=new Uint8Array(i.buffer,0,4*a*o)):(s=new Uint8Array(4*a*o),t.readPixels(r,n,a,o,t.RGBA,t.UNSIGNED_BYTE,s))}else if(e instanceof CanvasRenderingContext2D){let t;t=e.getImageData(r,n,a,o),s=new Uint8Array(t.data.buffer),null==i||i.set(s)}return s}transformPixelFormat(e,t,i,s){let r,n;if(Lt._onLog&&(r=Date.now(),Lt._onLog("transformPixelFormat(), START: "+r)),t===i)return Lt._onLog&&Lt._onLog("transformPixelFormat() end. Costs: "+(Date.now()-r)),s?new Uint8Array(e):e;const a=[Et.RGBA,Et.RBGA,Et.GRBA,Et.GBRA,Et.BRGA,Et.BGRA];if(a.includes(t))if(i===Et.GREY){n=new Uint8Array(e.length/4);for(let t=0;t<e.length;t+=4){const i=.21*e[t]+.71*e[t+1]+.07*e[t+2];n[t/4]=i}}else if(i===Et.GREY32){n=s?new Uint8Array(e):e;for(let t=0;t<e.length;t+=4){const i=.21*e[t]+.71*e[t+1]+.07*e[t+2];n[t]=i,n[t+1]=i,n[t+2]=i}}else{if(!a.includes(i))throw new Error("Unable to transform.");if(s){n=new Uint8Array(e);const s=t.indexOf("r"),r=t.indexOf("g"),a=t.indexOf("b"),o=i.indexOf("r"),h=i.indexOf("g"),l=i.indexOf("b");for(let t=0;t<e.length;t+=4)n[t+o]=e[t+s],n[t+h]=e[t+r],n[t+l]=e[t+a]}else{n=e;const s=t.indexOf("r"),r=t.indexOf("g"),a=t.indexOf("b"),o=i.indexOf("r"),h=i.indexOf("g"),l=i.indexOf("b");for(let t=0;t<e.length;t+=4){let i=[e[t],e[t+1],e[t+2]];n[t+o]=i[s],n[t+h]=i[r],n[t+l]=i[a]}}}else if(t===Et.GREY){if(i!==Et.GREY32)throw new Error("Unable to transform.");n=new Uint8Array(4*e.length);for(let t=0;t<e.length;t++)n[4*t]=e[t],n[4*t+1]=e[t],n[4*t+2]=e[t],n[4*t+3]=255}else{if(t!==Et.GREY32)throw new Error("Unable to transform.");if(i!==Et.GREY)throw new Error("Unable to transform.");n=new Uint8Array(new Uint32Array(e.buffer))}return Lt._onLog&&Lt._onLog("transformPixelFormat() end. Costs: "+(Date.now()-r)),n}getImageData(e,t,i,s,r){if(this.disposed)throw Error("The 'ImageDataGetter' instance has been disposed.");if(!t||!i)throw new Error("Invalid 'sourceWidth' or 'sourceHeight'.");if(s.sx>t||s.sy>i||s.sx+s.sWidth>t||s.sy+s.sHeight>i)throw new Error("Invalid position.");if(e instanceof HTMLVideoElement&&4!==e.readyState||e instanceof HTMLImageElement&&!e.complete)throw new Error("The source is not loaded.");let n;Lt._onLog&&(n=Date.now(),Lt._onLog("getImageData(), START: "+n));const a=Math.round(s.sx),o=Math.round(s.sy),h=Math.round(s.sWidth),l=Math.round(s.sHeight),d=Math.round(s.dWidth),c=Math.round(s.dHeight);let f=Et.RGBA;(null==r?void 0:r.pixelFormat)&&(f=r.pixelFormat);let g=this._bWebGLSupported;0==(null==r?void 0:r.bUseWebGL)&&(g=!1);let u,m,w,p=null;(null==r?void 0:r.bufferContainer)&&(p=r.bufferContainer),g?(this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas")),u=this._reusedWebGLCvs):(this._reusedCvs||(this._reusedCvs=document.createElement("canvas")),u=this._reusedCvs);try{if(g)if(Lt._onLog&&Lt._onLog("getImageData() in WebGL."),p)if(f===Et.GREY){if(w=new Uint8Array(4*d*c),m=this.drawImage(u,e,t,i,{sx:a,sy:o,sWidth:h,sHeight:l,dWidth:d,dHeight:c},{pixelFormat:f,bUseWebGL:g,bufferContainer:w}),w=this.transformPixelFormat(w,m.pixelFormat,f),p){if(p.length<w.length)throw new Error("Unexpected size of the 'bufferContainer'.");p.set(w)}}else m=this.drawImage(u,e,t,i,{sx:a,sy:o,sWidth:h,sHeight:l,dWidth:d,dHeight:c},{pixelFormat:f,bUseWebGL:g,bufferContainer:p}),w=new Uint8Array(p.buffer,0,4*d*c),w=this.transformPixelFormat(w,m.pixelFormat,f);else f===Et.GREY?((!yt(this,Tt,"f")||yt(this,Tt,"f").length<4*d*c)&&vt(this,Tt,new Uint8Array(4*d*c),"f"),w=new Uint8Array(yt(this,Tt,"f").buffer,0,4*d*c)):w=new Uint8Array(4*d*c),m=this.drawImage(u,e,t,i,{sx:a,sy:o,sWidth:h,sHeight:l,dWidth:d,dHeight:c},{pixelFormat:f,bUseWebGL:g,bufferContainer:w}),w=this.transformPixelFormat(w,m.pixelFormat,f);else if(Lt._onLog&&Lt._onLog("getImageData() in context2d."),m=this.drawImage(u,e,t,i,{sx:a,sy:o,sWidth:h,sHeight:l,dWidth:d,dHeight:c},{pixelFormat:Et.RGBA,bUseWebGL:g}),w=this.readCvsData(m.context,{width:d,height:c},null),w=this.transformPixelFormat(w,m.pixelFormat,f),p){if(p.length<w.length)throw new Error("Unexpected size of the 'bufferContainer'.");p.set(w)}}catch(s){if("WebGLError"===s.name)return Lt._onLog&&Lt._onLog("getImageData() in WebGL failed, try again in context2d."),this.forceLoseContext(),this._bWebGLSupported=!1,this.getImageData(e,t,i,{sx:a,sy:o,sWidth:h,sHeight:l,dWidth:d,dHeight:c},r);throw s}return Lt._onLog&&Lt._onLog("getImageData() end. Costs: "+(Date.now()-n)),{data:w,pixelFormat:f,width:d,height:c,bUseWebGL:m.bUseWebGL}}convertDataToCvs(e,t,i,s){if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new TypeError("Invalid 'data'.");if("number"!=typeof t||t<=0)throw new Error("Invalid 'width'.");if("number"!=typeof i||i<=0)throw new Error("Invalid 'height'.");const r=document.createElement("canvas");let n;if(r.width=t,r.height=i,s===Et.GREY){n=new Uint8ClampedArray(4*t*i);for(let t=0;t<n.length;t+=4)n[t]=e[t/4],n[t+1]=e[t/4],n[t+2]=e[t/4],n[t+3]=255}else n=new Uint8ClampedArray(e.buffer);const a=new ImageData(n,t,i);return r.getContext("2d").putImageData(a,0,0),r}forceLoseContext(){if(!this._reusedWebGLCvs)return;const e=this._reusedWebGLCvs.ctxWebGL;e&&!e.isContextLost()&&e.getExtension("WEBGL_lose_context")&&e.getExtension("WEBGL_lose_context").loseContext(),vt(this,St,null,"f"),vt(this,Ct,null,"f"),vt(this,At,null,"f"),this._reusedWebGLCvs=null}dispose(){this.forceLoseContext(),vt(this,xt,!0,"f")}}bt=new WeakMap,St=new WeakMap,Ct=new WeakMap,At=new WeakMap,Tt=new WeakMap,xt=new WeakMap;var Ft,Dt,Mt,Rt,Ot,Pt,kt,Bt,Wt,Vt,Nt,Ut,Gt,jt,Ht,Zt,Yt,zt,Jt,Xt,qt,Qt,Kt,$t,ei,ti,ii,si,ri,ni,ai,oi,hi,li,di,ci,fi,gi,ui,mi;class wi{constructor(){Ft.set(this,new Map),Dt.set(this,!1)}get disposed(){return lt(this,Dt,"f")}on(e,t){e=e.toLowerCase();const i=lt(this,Ft,"f").get(e);if(i){if(i.includes(t))return;i.push(t)}else lt(this,Ft,"f").set(e,[t])}off(e,t){e=e.toLowerCase();const i=lt(this,Ft,"f").get(e);if(!i)return;const s=i.indexOf(t);-1!==s&&i.splice(s,1)}offAll(e){e=e.toLowerCase();const t=lt(this,Ft,"f").get(e);t&&(t.length=0)}async fire(e,t=[],i={async:!1}){e=e.toLowerCase();const s=lt(this,Ft,"f").get(e);if(s)for(let e of s){if(!e)continue;let s;if(i.async)setTimeout((()=>{this.disposed||e.apply(i.target,t)}),0);else try{s=await e.apply(i.target,t)}catch(e){}if(!0===s)break}}dispose(){dt(this,Dt,!0,"f")}}Ft=new WeakMap,Dt=new WeakMap;const pi=(e,t,i,s)=>{let r=t+Math.round((e-t)/i)*i;return s&&(r=Math.min(r,s)),r};class _i{static get version(){return"1.1.2"}static isStorageAvailable(e){let t;try{t=window[e];const i="__storage_test__";return t.setItem(i,i),t.removeItem(i),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}}static async playVideo(e,t,i){return new Promise(((s,r)=>{e||r(new Error("Invalid 'videoEl'.")),t||r(new Error("Invalid 'source'.")),"string"==typeof t||t instanceof String?e.src=t:e.srcObject=t,e.load(),e.play().then((()=>s(e))).catch((e=>r(e))),void 0!==i&&setTimeout((()=>r(new Error("Failed to play video. Timeout."))),i)}))}static async testCameraAccess(){var e,t;try{if(!(null===(t=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===t?void 0:t.getUserMedia))return{ok:!1,message:"Insecure context."};(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()}))}catch(e){if("OverconstrainedError"===e.name||"NotFoundError"===e.name)return{ok:!1,message:"No camera detected."};if("NotAllowedError"===e.name)return{ok:!1,message:"No permission to access camera."};if("AbortError"===e.name)return{ok:!1,message:"Some problem occurred which prevented the device from being used."};if("NotReadableError"===e.name)return{ok:!1,message:"A hardware error occurred."};if("SecurityError"===e.name)return{ok:!1,message:"User media support is disabled."};throw e}return{ok:!0,message:"Successfully accessed the camera."}}get state(){if(!lt(this,jt,"f"))return"closed";if(lt(this,jt,"f").isPending)return"opening";if(lt(this,jt,"f").isFulfilled)return"opened";throw new Error("Unknown state.")}set ifSaveLastUsedCamera(e){e?_i.isStorageAvailable("localStorage")?dt(this,Gt,!0,"f"):(dt(this,Gt,!1,"f"),console.warn("Local storage is unavailable")):dt(this,Gt,!1,"f")}get ifSaveLastUsedCamera(){return lt(this,Gt,"f")}get isVideoPlaying(){return!(!lt(this,Bt,"f")||lt(this,Bt,"f").paused)&&"opened"===this.state}set tapFocusEventBoundEl(e){var t,i,s;if(!(e instanceof HTMLElement)&&null!=e)throw new TypeError("Invalid 'element'.");null===(t=lt(this,Xt,"f"))||void 0===t||t.removeEventListener("click",lt(this,Jt,"f")),null===(i=lt(this,Xt,"f"))||void 0===i||i.removeEventListener("touchend",lt(this,Jt,"f")),null===(s=lt(this,Xt,"f"))||void 0===s||s.removeEventListener("touchmove",lt(this,zt,"f")),dt(this,Xt,e,"f"),e&&(window.TouchEvent&&["Android","HarmonyOS","iPhone","iPad"].includes(wt.OS)?(e.addEventListener("touchend",lt(this,Jt,"f")),e.addEventListener("touchmove",lt(this,zt,"f"))):e.addEventListener("click",lt(this,Jt,"f")))}get tapFocusEventBoundEl(){return lt(this,Xt,"f")}get disposed(){return lt(this,ri,"f")}constructor(e){var t,i;Rt.add(this),Bt.set(this,null),Wt.set(this,void 0),this.defaultConstraints={video:{facingMode:{ideal:"environment"}}},Vt.set(this,void 0),Nt.set(this,void 0),this._arrCameras=[],Ut.set(this,void 0),Gt.set(this,!1),this.ifSkipCameraInspection=!1,jt.set(this,void 0),Ht.set(this,!1),this._focusParameters={maxTimeout:400,minTimeout:300,kTimeout:void 0,oldDistance:null,fds:null,isDoingFocus:0,taskBackToContinous:null,curFocusTaskId:0,focusCancelableTime:1500,defaultFocusAreaSizeRatio:6,focusBackToContinousTime:5e3,tapFocusMinDistance:null,tapFocusMaxDistance:null,focusArea:null,tempBufferContainer:null,defaultTempBufferContainerLenRatio:1/4},Zt.set(this,!1),this._focusSupported=!0,this.calculateCoordInVideo=(e,t)=>{let i,s;const r=window.getComputedStyle(lt(this,Bt,"f")).objectFit,n=this.getResolution(),a=lt(this,Bt,"f").getBoundingClientRect(),o=a.left,h=a.top,{width:l,height:d}=lt(this,Bt,"f").getBoundingClientRect();if(l<=0||d<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");const c=l/d,f=n.width/n.height;let g=1;if("contain"===r)f>c?(g=l/n.width,i=(e-o)/g,s=(t-h-(d-l/f)/2)/g):(g=d/n.height,s=(t-h)/g,i=(e-o-(l-d*f)/2)/g);else{if("cover"!==r)throw new Error("Unsupported object-fit.");f>c?(g=d/n.height,s=(t-h)/g,i=(e-o+(d*f-l)/2)/g):(g=l/n.width,i=(e-o)/g,s=(t-h+(l/f-d)/2)/g)}return{x:i,y:s}},Yt.set(this,!1),zt.set(this,(()=>{dt(this,Yt,!0,"f")})),Jt.set(this,(async e=>{var t;if(lt(this,Yt,"f"))return void dt(this,Yt,!1,"f");if(!lt(this,Zt,"f"))return;if(!this.isVideoPlaying)return;if(!lt(this,Wt,"f"))return;if(!this._focusSupported)return;if(!this._focusParameters.fds&&(this._focusParameters.fds=null===(t=await this.getCameraCapabilities())||void 0===t?void 0:t.focusDistance,!this._focusParameters.fds))return void(this._focusSupported=!1);if(null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),1==this._focusParameters.isDoingFocus)return;let i,s;if(this._focusParameters.taskBackToContinous&&(clearTimeout(this._focusParameters.taskBackToContinous),this._focusParameters.taskBackToContinous=null),e instanceof MouseEvent)i=e.clientX,s=e.clientY;else{if(!(e instanceof TouchEvent))throw new Error("Unknown event type.");if(!e.changedTouches.length)return;i=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY}const r=this.getResolution(),n=2*Math.round(Math.min(r.width,r.height)/this._focusParameters.defaultFocusAreaSizeRatio/2);let a;try{a=this.calculateCoordInVideo(i,s)}catch(e){}if(a.x<0||a.x>r.width||a.y<0||a.y>r.height)return;const o={x:a.x+"px",y:a.y+"px"},h=n+"px",l=h;let d;_i._onLog&&(d=Date.now());try{await lt(this,Rt,"m",gi).call(this,o,h,l,this._focusParameters.tapFocusMinDistance,this._focusParameters.tapFocusMaxDistance)}catch(e){if(_i._onLog)throw _i._onLog(e),e}_i._onLog&&_i._onLog(`Tap focus costs: ${Date.now()-d} ms`),this._focusParameters.taskBackToContinous=setTimeout((()=>{var e;_i._onLog&&_i._onLog("Back to continuous focus."),null===(e=lt(this,Wt,"f"))||void 0===e||e.applyConstraints({advanced:[{focusMode:"continuous"}]}).catch((()=>{}))}),this._focusParameters.focusBackToContinousTime),lt(this,$t,"f").fire("tapfocus",null,{target:this,async:!0})})),Xt.set(this,null),qt.set(this,1),Qt.set(this,{x:0,y:0}),this.updateVideoElWhenSoftwareScaled=()=>{if(!lt(this,Bt,"f"))return;const e=lt(this,qt,"f");if(e<1)throw new RangeError("Invalid scale value.");if(1===e)lt(this,Bt,"f").style.transform="";else{const t=window.getComputedStyle(lt(this,Bt,"f")).objectFit,i=lt(this,Bt,"f").videoWidth,s=lt(this,Bt,"f").videoHeight,{width:r,height:n}=lt(this,Bt,"f").getBoundingClientRect();if(r<=0||n<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");const a=r/n,o=i/s;let h=1;"contain"===t?h=a<o?r/(i/e):n/(s/e):"cover"===t&&(h=o>a?n/(i/e):r/(s/e));const l=h*(1-1/e)*(i/2-lt(this,Qt,"f").x),d=h*(1-1/e)*(s/2-lt(this,Qt,"f").y);lt(this,Bt,"f").style.transform=`translate(${l}px, ${d}px) scale(${e})`}},Kt.set(this,(function(){if(!(this.data instanceof Uint8Array||this.data instanceof Uint8ClampedArray))throw new TypeError("Invalid data.");if("number"!=typeof this.width||this.width<=0)throw new Error("Invalid width.");if("number"!=typeof this.height||this.height<=0)throw new Error("Invalid height.");const e=document.createElement("canvas");let t;if(e.width=this.width,e.height=this.height,this.pixelFormat===Et.GREY){t=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<t.length;e+=4)t[e]=this.data[e/4],t[e+1]=this.data[e/4],t[e+2]=this.data[e/4],t[e+3]=255}else t=new Uint8ClampedArray(this.data.buffer);const i=new ImageData(t,this.width,this.height);return e.getContext("2d").putImageData(i,0,0),e})),$t.set(this,void 0),ei.set(this,["before:open","opened","before:close","closed","before:camera:change","camera:changed","before:resolution:change","resolution:changed","played","paused","resumed","tapfocus"]),this.detectedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],ti.set(this,new Map),ii.set(this,!1),si.set(this,(async()=>{if("visible"===document.visibilityState){if(_i._onLog&&_i._onLog("document visible."),lt(this,ii,"f")&&lt(this,Bt,"f")&&this.videoSrc&&"opened"===this.state)return void this.resume().catch((()=>{}));if(!this._mediaStream)return;if(this._mediaStream.active&&lt(this,Wt,"f")&&!lt(this,Wt,"f").muted)lt(this,ii,"f")&&this.resume().catch((()=>{}));else{lt(this,Rt,"m",hi).call(this),dt(this,Nt,null,"f");try{this._mediaStream=await lt(this,Rt,"m",oi).call(this),lt(this,Bt,"f")&&(lt(this,Bt,"f").srcObject=this._mediaStream),lt(this,Rt,"m",ai).call(this),lt(this,Bt,"f")&&lt(this,ii,"f")&&(await _i.playVideo(lt(this,Bt,"f"),this._mediaStream),lt(this,Rt,"m",ai).call(this),lt(this,$t,"f").fire("resumed",null,{target:this,async:!0}))}catch(e){lt(this,Rt,"m",di).call(this)}}}else"hidden"===document.visibilityState&&(_i._onLog&&_i._onLog("document hidden."),["iPhone","iPad","Mac"].includes(wt.OS)?dt(this,ii,!0,"f"):dt(this,ii,this.isVideoPlaying,"f"),this.isVideoLoaded()&&"opened"==this.state&&this.pause())})),ri.set(this,!1),(null===(i=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===i?void 0:i.getUserMedia)||_i.onWarning&&_i.onWarning("Browser version is too low, or it is in a insecure context."),this.resetMediaStreamConstraints(),e instanceof HTMLVideoElement&&this.setVideoEl(e),dt(this,$t,new wi,"f"),this.imageDataGetter=new Lt,document.addEventListener("visibilitychange",lt(this,si,"f"))}setVideoEl(e){if(!(e&&e instanceof HTMLVideoElement))throw new Error("Invalid 'videoEl'.");dt(this,Bt,e,"f")}getVideoEl(){return lt(this,Bt,"f")}releaseVideoEl(){dt(this,Bt,null,"f")}isVideoLoaded(){return!!lt(this,Bt,"f")&&4==lt(this,Bt,"f").readyState}async open(){if(lt(this,jt,"f")){if(lt(this,jt,"f").isPending)return lt(this,jt,"f");if(lt(this,jt,"f").isFulfilled)return}lt(this,$t,"f").fire("before:open",null,{target:this}),dt(this,jt,new _t,"f");try{if(this.videoSrc){if(!lt(this,Bt,"f"))throw new Error("'videoEl' should be set.");await _i.playVideo(lt(this,Bt,"f"),this.videoSrc,4e3)}else await lt(this,Rt,"m",li).call(this)}catch(e){throw lt(this,Rt,"m",di).call(this),e}lt(this,jt,"f").resolve(),lt(this,$t,"f").fire("opened",null,{target:this,async:!0}),lt(this,$t,"f").fire("played",null,{target:this,async:!0})}close(){"closed"!==this.state&&(lt(this,$t,"f").fire("before:close",null,{target:this}),lt(this,Rt,"m",di).call(this),lt(this,$t,"f").fire("closed",null,{target:this,async:!0}))}pause(){if(!this.isVideoLoaded())throw new Error("Video is not loaded.");if("opened"!==this.state)throw new Error("Camera or video is not open.");lt(this,Bt,"f").paused||(lt(this,Bt,"f").pause(),lt(this,$t,"f").fire("paused",null,{target:this,async:!0}))}async resume(){if(!this.isVideoLoaded())throw new Error("Video is not loaded.");if("opened"!==this.state)throw new Error("Camera or video is not open.");lt(this,Bt,"f").paused&&(await lt(this,Bt,"f").play(),lt(this,$t,"f").fire("resumed",null,{target:this,async:!0}))}async setCamera(e){if("string"!=typeof e)throw new TypeError("Invalid 'deviceId'.");if(lt(this,Vt,"f").video.deviceId={exact:e},"closed"!==this.state&&!this.videoSrc){lt(this,$t,"f").fire("before:camera:change",[],{target:this,async:!1});const e=lt(this,Nt,"f").deviceId,t=this.getResolution();lt(this,Rt,"m",hi).call(this),dt(this,Nt,null,"f");try{await lt(this,Rt,"m",li).call(this)}catch(e){throw lt(this,Rt,"m",di).call(this),e}try{this.resetSoftwareScale()}catch(e){}const i=this.getResolution();e!==lt(this,Nt,"f").deviceId&&lt(this,$t,"f").fire("camera:changed",[lt(this,Nt,"f").deviceId,e],{target:this,async:!0}),t.width==i.width&&t.height==i.height||lt(this,$t,"f").fire("resolution:changed",[{width:i.width,height:i.height},{width:t.width,height:t.height}],{target:this,async:!0}),lt(this,$t,"f").fire("played",null,{target:this,async:!0})}}getCamera(){if(lt(this,Nt,"f"))return lt(this,Nt,"f");{let e=lt(this,Vt,"f").video.deviceId||"";if(e){e=e.exact||e.ideal||e;for(let t of this._arrCameras)if(t.deviceId===e)return JSON.parse(JSON.stringify(t))}return{deviceId:"",label:"",_checked:!1}}}async _getCameras(e){var t,i;if(!(null===(i=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Browser version is too low, or it is in a insecure context.");let s;if(e){let e=await navigator.mediaDevices.getUserMedia({video:!0});s=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),e.getTracks().forEach((e=>{e.stop()}))}else s=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));const r=[],n=[];if(this._arrCameras)for(let e of this._arrCameras)e._checked&&n.push(e);for(let e=0;e<s.length;e++){let t,i=s[e];for(let e of n)if(i.deviceId==e.deviceId){t=e;break}t||(t={deviceId:i.deviceId,label:i.label?i.label:"camera "+e,_checked:!1}),t.deviceId&&r.push(t)}return this._arrCameras=r,_i._onLog&&_i._onLog(JSON.stringify(this._arrCameras)),r}async getCameras(){var e,t;if(!(null===(t=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===t?void 0:t.enumerateDevices))throw new Error("Browser version is too low, or it is in a insecure context.");const i=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));return i&&i.length&&!i[0].deviceId?this._getCameras(!0):this._getCameras(!1)}async getAllCameras(){return this.getCameras()}async setResolution(e,t,i){if("number"!=typeof e||e<=0)throw new TypeError("Invalid 'width'.");if("number"!=typeof t||t<=0)throw new TypeError("Invalid 'height'.");if(i?(lt(this,Vt,"f").video.width={exact:e},lt(this,Vt,"f").video.height={exact:t}):(lt(this,Vt,"f").video.width={ideal:e},lt(this,Vt,"f").video.height={ideal:t}),"closed"===this.state||this.videoSrc)return null;{lt(this,$t,"f").fire("before:resolution:change",[],{target:this,async:!1});const e=this.getResolution();lt(this,Rt,"m",hi).call(this),dt(this,Nt,null,"f");try{await lt(this,Rt,"m",li).call(this)}catch(e){throw lt(this,Rt,"m",di).call(this),e}try{this.resetSoftwareScale()}catch(e){}const t=this.getResolution();return e.width==t.width&&e.height==t.height||lt(this,$t,"f").fire("resolution:changed",[{width:t.width,height:t.height},{width:e.width,height:e.height}],{target:this,async:!0}),lt(this,$t,"f").fire("played",null,{target:this,async:!0}),{width:t.width,height:t.height}}}getResolution(){if("opened"===this.state&&this.videoSrc&&lt(this,Bt,"f"))return{width:lt(this,Bt,"f").videoWidth,height:lt(this,Bt,"f").videoHeight};if(lt(this,Wt,"f")){const e=lt(this,Wt,"f").getSettings();return{width:e.width,height:e.height}}if(this.isVideoLoaded())return{width:lt(this,Bt,"f").videoWidth,height:lt(this,Bt,"f").videoHeight};{const e={width:0,height:0};let t=lt(this,Vt,"f").video.width||0,i=lt(this,Vt,"f").video.height||0;return t&&(e.width=t.exact||t.ideal||t),i&&(e.height=i.exact||i.ideal||i),e}}async getResolutions(e){var t,i,s,r,n,a,o,h,l,d,c;if(!(null===(i=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Browser version is too low, or it is in a insecure context.");let f="";const g=(e,t)=>{const i=lt(this,ti,"f").get(e);if(!i||!i.length)return!1;for(let e of i)if(e.width===t.width&&e.height===t.height)return!0;return!1};if(this._mediaStream){f=null===(c=lt(this,Nt,"f"))||void 0===c?void 0:c.deviceId;let t=lt(this,ti,"f").get(f);if(t&&!e)return JSON.parse(JSON.stringify(t));t=[],lt(this,ti,"f").set(f,t),dt(this,Ht,!0,"f");try{for(let e of this.detectedResolutions){await lt(this,Wt,"f").applyConstraints({width:{ideal:e.width},height:{ideal:e.height}}),lt(this,Rt,"m",ai).call(this);const i=lt(this,Wt,"f").getSettings(),s={width:i.width,height:i.height};g(f,s)||t.push({width:s.width,height:s.height})}}catch(e){if(lt(this,Rt,"m",di).call(this),"AbortError"===e.name)return this.getResolutions();throw dt(this,Ht,!1,"f"),e}lt(this,Rt,"m",hi).call(this),dt(this,Nt,null,"f");try{await lt(this,Rt,"m",li).call(this)}catch(e){if(lt(this,Rt,"m",di).call(this),dt(this,Ht,!1,"f"),"AbortError"===e.name)return t;throw e}return dt(this,Ht,!1,"f"),t}{const t=async(e,t,i)=>{const s={video:{deviceId:{exact:e},width:{ideal:t},height:{ideal:i}}};let r=null;try{r=await navigator.mediaDevices.getUserMedia(s)}catch(e){return null}if(!r)return null;const n=r.getVideoTracks();let a=null;try{const e=n[0].getSettings();a={width:e.width,height:e.height}}catch(e){const t=document.createElement("video");t.srcObject=r,a={width:t.videoWidth,height:t.videoHeight},t.srcObject=null}return n.forEach((e=>{e.stop()})),a};let i=(null===(n=null===(r=null===(s=lt(this,Vt,"f"))||void 0===s?void 0:s.video)||void 0===r?void 0:r.deviceId)||void 0===n?void 0:n.exact)||(null===(h=null===(o=null===(a=lt(this,Vt,"f"))||void 0===a?void 0:a.video)||void 0===o?void 0:o.deviceId)||void 0===h?void 0:h.ideal)||(null===(d=null===(l=lt(this,Vt,"f"))||void 0===l?void 0:l.video)||void 0===d?void 0:d.deviceId);if(!i)return[];let c=lt(this,ti,"f").get(i);if(c&&!e)return JSON.parse(JSON.stringify(c));c=[],lt(this,ti,"f").set(i,c);for(let e of this.detectedResolutions){const s=await t(i,e.width,e.height);s&&!g(i,s)&&c.push({width:s.width,height:s.height})}return c}}async setMediaStreamConstraints(e,t){if(!(e=>{return null!==e&&"[object Object]"===(t=e,Object.prototype.toString.call(t));var t})(e))throw new TypeError("Invalid 'mediaStreamConstraints'.");if(dt(this,Vt,JSON.parse(JSON.stringify(e)),"f"),dt(this,Ut,null,"f"),["opening","opened"].includes(this.state)&&t){lt(this,Rt,"m",hi).call(this),dt(this,Nt,null,"f");try{await lt(this,Rt,"m",li).call(this)}catch(e){throw lt(this,Rt,"m",di).call(this),e}}}getMediaStreamConstraints(){return JSON.parse(JSON.stringify(lt(this,Vt,"f")))}resetMediaStreamConstraints(){dt(this,Vt,this.defaultConstraints?JSON.parse(JSON.stringify(this.defaultConstraints)):null,"f")}getCameraCapabilities(){if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");return lt(this,Wt,"f").getCapabilities?lt(this,Wt,"f").getCapabilities():{}}getCameraSettings(){if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");return lt(this,Wt,"f").getSettings()}async turnOnTorch(){if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");const e=this.getCameraCapabilities();if(!(null==e?void 0:e.torch))throw Error("Not supported.");await lt(this,Wt,"f").applyConstraints({advanced:[{torch:!0}]})}async turnOffTorch(){if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");const e=this.getCameraCapabilities();if(!(null==e?void 0:e.torch))throw Error("Not supported.");await lt(this,Wt,"f").applyConstraints({advanced:[{torch:!1}]})}async setColorTemperature(e,t){var i;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");const s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.colorTemperature;if(!s)throw Error("Not supported.");return t&&(e<s.min?e=s.min:e>s.max&&(e=s.max),e=pi(e,s.min,s.step,s.max)),await lt(this,Wt,"f").applyConstraints({advanced:[{colorTemperature:e,whiteBalanceMode:"manual"}]}),e}getColorTemperature(){return this.getCameraSettings().colorTemperature||0}async setExposureCompensation(e,t){var i;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");const s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.exposureCompensation;if(!s)throw Error("Not supported.");return t&&(e<s.min?e=s.min:e>s.max&&(e=s.max),e=pi(e,s.min,s.step,s.max)),await lt(this,Wt,"f").applyConstraints({advanced:[{exposureCompensation:e}]}),e}getExposureCompensation(){return this.getCameraSettings().exposureCompensation||0}async setFrameRate(e,t){var i;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");let s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.frameRate;if(!s)throw Error("Not supported.");t&&(e<s.min?e=s.min:e>s.max&&(e=s.max));const r=this.getResolution();return await lt(this,Wt,"f").applyConstraints({width:{ideal:Math.max(r.width,r.height)},frameRate:e}),e}getFrameRate(){return this.getCameraSettings().frameRate}async setFocus(e,t){if("object"!=typeof e||Array.isArray(e)||null==e)throw new TypeError("Invalid 'settings'.");if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");const i=this.getCameraCapabilities(),s=null==i?void 0:i.focusMode,r=null==i?void 0:i.focusDistance;if(!s)throw Error("Not supported.");if("string"!=typeof e.mode)throw TypeError("Invalid 'mode'.");const n=e.mode.toLowerCase();if(!s.includes(n))throw Error("Unsupported focus mode.");if("manual"===n){if(!r)throw Error("Manual focus unsupported.");if(e.hasOwnProperty("distance")){let i=e.distance;t&&(i<r.min?i=r.min:i>r.max&&(i=r.max),i=pi(i,r.min,r.step,r.max)),this._focusParameters.focusArea=null,await lt(this,Wt,"f").applyConstraints({advanced:[{focusMode:n,focusDistance:i}]})}else{if(!e.area)throw new Error("'distance' or 'area' should be specified in 'manual' mode.");{const t=e.area.centerPoint;let i=e.area.width,s=e.area.height;if(!i||!s){const e=this.getResolution();i||(i=2*Math.round(Math.min(e.width,e.height)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px"),s||(s=2*Math.round(Math.min(e.width,e.height)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px")}this._focusParameters.focusArea={centerPoint:{x:t.x,y:t.y},width:i,height:s},await lt(this,Rt,"m",gi).call(this,t,i,s)}}}else this._focusParameters.focusArea=null,await lt(this,Wt,"f").applyConstraints({advanced:[{focusMode:n}]})}getFocus(){const e=this.getCameraSettings(),t=e.focusMode;return t?"manual"===t?this._focusParameters.focusArea?{mode:"manual",area:JSON.parse(JSON.stringify(this._focusParameters.focusArea))}:{mode:"manual",distance:e.focusDistance}:{mode:t}:null}async enableTapToFocus(){dt(this,Zt,!0,"f")}disableTapToFocus(){dt(this,Zt,!1,"f")}isTapToFocusEnabled(){return lt(this,Zt,"f")}async setZoom(e){if("object"!=typeof e||Array.isArray(e)||null==e)throw new TypeError("Invalid 'settings'.");if("number"!=typeof e.factor)throw new TypeError("Illegal type of 'factor'.");if(e.factor<1)throw new RangeError("Invalid 'factor'.");if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");e.centerPoint?lt(this,Rt,"m",ui).call(this,e.centerPoint):this.resetScaleCenter();try{if(lt(this,Rt,"m",mi).call(this,lt(this,Qt,"f"))){const t=await this.setHardwareScale(e.factor,!0);let i=this.getHardwareScale();1==i&&1!=t&&(i=t),e.factor>i?this.setSoftwareScale(e.factor/i):this.setSoftwareScale(1)}else await this.setHardwareScale(1),this.setSoftwareScale(e.factor)}catch(t){if("Not supported."!==(t.message||t))throw t;this.setSoftwareScale(e.factor)}}getZoom(){if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");return{factor:this.getHardwareScale()*lt(this,qt,"f")}}async resetZoom(){await this.setZoom({factor:1})}async setHardwareScale(e,t){var i;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(e<1)throw new RangeError("Invalid 'value'.");if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");const s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.zoom;if(!s)throw Error("Not supported.");return t&&(e<s.min?e=s.min:e>s.max&&(e=s.max),e=pi(e,s.min,s.step,s.max)),await lt(this,Wt,"f").applyConstraints({advanced:[{zoom:e}]}),e}getHardwareScale(){return this.getCameraSettings().zoom||1}setSoftwareScale(e,t){if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(e<1)throw new RangeError("Invalid 'value'.");if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");t&&lt(this,Rt,"m",ui).call(this,t),dt(this,qt,e,"f"),this.updateVideoElWhenSoftwareScaled()}getSoftwareScale(){return lt(this,qt,"f")}resetScaleCenter(){if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");const e=this.getResolution();dt(this,Qt,{x:e.width/2,y:e.height/2},"f")}resetSoftwareScale(){this.setSoftwareScale(1),this.resetScaleCenter()}getFrameData(e){if(this.disposed)throw Error("The 'Camera' instance has been disposed.");if(!this.isVideoLoaded())return null;if(lt(this,Ht,"f"))return null;const t=Date.now();_i._onLog&&_i._onLog("getFrameData() START: "+t);const i=lt(this,Bt,"f").videoWidth,s=lt(this,Bt,"f").videoHeight;let r={sx:0,sy:0,sWidth:i,sHeight:s,dWidth:i,dHeight:s};(null==e?void 0:e.position)&&(r=JSON.parse(JSON.stringify(e.position)));let n=Et.RGBA;(null==e?void 0:e.pixelFormat)&&(n=e.pixelFormat);let a=lt(this,qt,"f");(null==e?void 0:e.scale)&&(a=e.scale);let o=lt(this,Qt,"f");if(null==e?void 0:e.scaleCenter){if("string"!=typeof e.scaleCenter.x||"string"!=typeof e.scaleCenter.y)throw new Error("Invalid scale center.");let t=0,r=0;if(e.scaleCenter.x.endsWith("px"))t=parseFloat(e.scaleCenter.x);else{if(!e.scaleCenter.x.endsWith("%"))throw new Error("Invalid scale center.");t=parseFloat(e.scaleCenter.x)/100*i}if(e.scaleCenter.y.endsWith("px"))r=parseFloat(e.scaleCenter.y);else{if(!e.scaleCenter.y.endsWith("%"))throw new Error("Invalid scale center.");r=parseFloat(e.scaleCenter.y)/100*s}if(isNaN(t)||isNaN(r))throw new Error("Invalid scale center.");o.x=Math.round(t),o.y=Math.round(r)}let h=null;if((null==e?void 0:e.bufferContainer)&&(h=e.bufferContainer),0==i||0==s)return null;1!==a&&(r.sWidth=Math.round(r.sWidth/a),r.sHeight=Math.round(r.sHeight/a),r.sx=Math.round((1-1/a)*o.x+r.sx/a),r.sy=Math.round((1-1/a)*o.y+r.sy/a));const l=this.imageDataGetter.getImageData(lt(this,Bt,"f"),i,s,r,{pixelFormat:n,bufferContainer:h});if(!l)return null;const d=Date.now();return _i._onLog&&_i._onLog("getFrameData() END: "+d),{data:l.data,width:l.width,height:l.height,pixelFormat:l.pixelFormat,timeSpent:d-t,timeStamp:d,toCanvas:lt(this,Kt,"f")}}on(e,t){if(!lt(this,ei,"f").includes(e.toLowerCase()))throw new Error(`Event '${e}' does not exist.`);lt(this,$t,"f").on(e,t)}off(e,t){lt(this,$t,"f").off(e,t)}dispose(){this.tapFocusEventBoundEl=null,this.close(),this.releaseVideoEl(),lt(this,$t,"f").dispose(),this.imageDataGetter.forceLoseContext(),document.removeEventListener("visibilitychange",lt(this,si,"f")),dt(this,ri,!0,"f")}}let yi,vi,Ii,Ei,bi;Ot=_i,Bt=new WeakMap,Wt=new WeakMap,Vt=new WeakMap,Nt=new WeakMap,Ut=new WeakMap,Gt=new WeakMap,jt=new WeakMap,Ht=new WeakMap,Zt=new WeakMap,Yt=new WeakMap,zt=new WeakMap,Jt=new WeakMap,Xt=new WeakMap,qt=new WeakMap,Qt=new WeakMap,Kt=new WeakMap,$t=new WeakMap,ei=new WeakMap,ti=new WeakMap,ii=new WeakMap,si=new WeakMap,ri=new WeakMap,Rt=new WeakSet,Pt=function(e){if(!e||!e.length)return null;const t=["back","baksidan","bakre","bak","","","","","","posteriore","posterior","zadn","bagside","rck","","trasera","taka","arrire","","","stranja","hts","belakang","a","","achterzijde","tylny","traseira","spate","","","zadn","","arka","sau"],i=["triple","","","","","","trojn","","kolmois","","","trostruka","tiga","tripla","","","trippelt","trippel","trjobiektywowy","tripl","","trojit","","l","","ba camera"],s=["dual wide","dual-weitwinkel","dual con gran angular","dual","doble","double","","",""," "," ","duln irokohl"," ","laajakulmainen kaksois"," "," ","dvostruka iroka","ketts, szles ltszg","ganda","doppia con grandangolo","  "," ","dwikamera","dobbelt vidvinkelkamera","dwuobiektywowy","dupla grande-angular","grande angular dupla","dubl"," ","dulna irokouhl","dubbel vidvinkel","","ift geni"," ","kp rng mt sau"],r=e.filter((e=>{const i=e.label.toLowerCase();return t.some((e=>i.includes(e)))}));if(!r.length)return null;const n=r.find((e=>{const t=e.label.toLowerCase();return i.some((e=>t.includes(e)))}));if(n)return n.deviceId;const a=r.find((e=>{const t=e.label.toLowerCase();return s.some((e=>t.includes(e)))}));return a?a.deviceId:r[0].deviceId},kt=function(e){if(!e||!e.length)return null;if(["iPhone","iPad","Mac"].includes(wt.OS))return lt(_i,Ot,"m",Pt).call(_i,e);const t=["rear","back","rck","arrire","trasera","trs","traseira","posteriore","posterior","","","","","","","","","","arka","achterzijde","","baksidan","bagside","sau","bak","tylny","taka","","","spate","hts","zadn","darrere","zadn","","stranja","belakang","","","a","","bakre",""];for(let i of e){const e=i.label.toLowerCase();if(e&&t.some((t=>e.includes(t)))&&/\b0(\b)?/.test(e))return i.deviceId}return["Android","HarmonyOS"].includes(wt.OS)?e[e.length-1].deviceId:null},ni=async function(){const e=this.getMediaStreamConstraints();let t;if("boolean"==typeof e.video&&(e.video={}),e.video.deviceId);else if(lt(this,Ut,"f"))delete e.video.facingMode,e.video.deviceId={exact:lt(this,Ut,"f")};else if(this.ifSaveLastUsedCamera&&_i.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete e.video.facingMode,e.video.deviceId={ideal:window.localStorage.getItem("dce_last_camera_id")};const t=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),i=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));t&&i&&(e.video.width=t,e.video.height=i)}else if(this.ifSkipCameraInspection);else if(e.video.facingMode){await this._getCameras(!1);let i=e.video.facingMode;if(i instanceof Array&&i.length&&(i=i[0]),i=i.exact||i.ideal||i,"environment"===i){t=!0;const i=lt(_i,Ot,"m",kt).call(_i,this._arrCameras);i&&(delete e.video.facingMode,e.video.deviceId={exact:i})}}return{constraints:e,bFmEnvironment:t}},ai=function(){if(!lt(this,jt,"f")){lt(this,Rt,"m",hi).call(this),dt(this,Nt,null,"f");const e=new Error("The operation was interrupted.");throw e.name="AbortError",e}},oi=async function(){var e,t,i,s,r,n,a;if(!(null===(t=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===t?void 0:t.getUserMedia))throw new Error("Browser version is too low, or it is in a insecure context.");let o;try{lt(this,Rt,"m",hi).call(this);let{constraints:e,bFmEnvironment:t}=await lt(this,Rt,"m",ni).call(this),h=(null===(i=e.video.width)||void 0===i?void 0:i.exact)||(null===(s=e.video.width)||void 0===s?void 0:s.ideal)||e.video.width,l=(null===(r=e.video.height)||void 0===r?void 0:r.exact)||(null===(n=e.video.height)||void 0===n?void 0:n.ideal)||e.video.height;_i._onLog&&_i._onLog("======try getUserMedia========");let d=[0,500],c=null;const f=async e=>{for(let t of d){t&&await new Promise((e=>setTimeout(e,t))),lt(this,Rt,"m",ai).call(this);try{_i._onLog&&_i._onLog("ask "+JSON.stringify(e)),o=await navigator.mediaDevices.getUserMedia(e);break}catch(e){if(lt(this,Rt,"m",ai).call(this),"NotFoundError"===e.name||"NotAllowedError"===e.name)throw e;c=e,_i._onLog&&_i._onLog(e.message||e)}}lt(this,Rt,"m",ai).call(this)};let g;if(await f(e),o||(_i._onLog&&_i._onLog("======try getUserMedia again========"),g=JSON.parse(JSON.stringify(e)),"object"==typeof g.video&&(["iPhone","iPad"].includes(wt.OS)?(h>=1280||l>=1280?g.video.width=1280:h>=640||l>=640?g.video.width=640:(h<640||l<640)&&(g.video.width=320),delete g.video.height):t&&!e.video.deviceId?(delete g.video.facingMode,this._arrCameras.length&&(g.video.deviceId={ideal:this._arrCameras[this._arrCameras.length-1].deviceId})):g.video=!0),_i._onLog&&_i._onLog(g),await f(g)),o||(d=[1e3,2e3],await f(e)),o||await f(g),!o)throw c;const u=()=>{const e=o.getVideoTracks();let t,i;if(e.length&&(t=dt(this,Wt,e[0],"f")),t){const e=t.getSettings();if(e)for(let s of this._arrCameras)if(e.deviceId===s.deviceId){s._checked=!0,s.label=t.label,i=s;break}}dt(this,Nt,i,"f")};if(await this._getCameras(!1),lt(this,Rt,"m",ai).call(this),t&&!this.ifSkipCameraInspection){u();const t=lt(_i,Ot,"m",kt).call(_i,this._arrCameras),i=null===(a=lt(this,Nt,"f"))||void 0===a?void 0:a.deviceId;t&&t!=i&&(o.getTracks().forEach((e=>{e.stop()})),d=[0,500,1e3,2e3],e.video.deviceId={exact:t},await f(e))}return u(),lt(this,Nt,"f")&&lt(this,Nt,"f").deviceId&&(dt(this,Ut,lt(this,Nt,"f")&&lt(this,Nt,"f").deviceId,"f"),this.ifSaveLastUsedCamera&&_i.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",lt(this,Ut,"f")),e.video.width&&e.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(e.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(e.video.height))))),o}catch(e){throw null==o||o.getTracks().forEach((e=>{e.stop()})),dt(this,Wt,null,"f"),dt(this,Nt,null,"f"),"NotFoundError"===e.name&&(DOMException?e=new DOMException("No camera available, please use a device with an accessible camera.",e.name):(e=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),e}},hi=function(){this._mediaStream&&(this._mediaStream.getTracks().forEach((e=>{e.stop()})),this._mediaStream=null),dt(this,Wt,null,"f")},li=async function(){if(this._mediaStream=await lt(this,Rt,"m",oi).call(this),lt(this,Rt,"m",ai).call(this),lt(this,Bt,"f")){try{await _i.playVideo(lt(this,Bt,"f"),this._mediaStream,4e3)}catch(e){throw lt(this,Rt,"m",hi).call(this),dt(this,Nt,null,"f"),e}lt(this,Rt,"m",ai).call(this)}},di=function(){lt(this,Rt,"m",hi).call(this),dt(this,Nt,null,"f"),lt(this,Bt,"f")&&(lt(this,Bt,"f").srcObject=null,this.videoSrc&&(lt(this,Bt,"f").pause(),lt(this,Bt,"f").currentTime=0)),dt(this,jt,null,"f");try{this.resetSoftwareScale()}catch(e){}},ci=async function e(t,i){const s=e=>{if(!lt(this,Wt,"f")||!this.isVideoPlaying||e.focusTaskId!=this._focusParameters.curFocusTaskId){lt(this,Wt,"f")&&this.isVideoPlaying||(this._focusParameters.isDoingFocus=0);const t=new Error(`Focus task ${e.focusTaskId} canceled.`);throw t.name="DeprecatedTaskError",t}1===this._focusParameters.isDoingFocus&&Date.now()-e.timeStart>this._focusParameters.focusCancelableTime&&(this._focusParameters.isDoingFocus=-1)};let r;i=pi(i,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),await lt(this,Wt,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:i}]}),s(t),r=null==this._focusParameters.oldDistance?this._focusParameters.kTimeout*Math.max(Math.abs(1/this._focusParameters.fds.min-1/i),Math.abs(1/this._focusParameters.fds.max-1/i))+this._focusParameters.minTimeout:this._focusParameters.kTimeout*Math.abs(1/this._focusParameters.oldDistance-1/i)+this._focusParameters.minTimeout,this._focusParameters.oldDistance=i,await new Promise((e=>{setTimeout(e,r)})),s(t);let n=t.focusL-t.focusW/2,a=t.focusT-t.focusH/2,o=t.focusW,h=t.focusH;const l=this.getResolution();if(n>=l.width||a>=l.height)throw new Error("Invalid area.");n+o>l.width&&(o=l.width-n),a+h>l.height&&(h=l.height-a),n=Math.round(n),a=Math.round(a),o=Math.round(o),h=Math.round(h);const d=4*l.width*l.height*this._focusParameters.defaultTempBufferContainerLenRatio,c=4*o*h;let f=this._focusParameters.tempBufferContainer;if(f){const e=f.length;d>e&&d>=c?f=new Uint8Array(d):c>e&&c>=d&&(f=new Uint8Array(c))}else f=this._focusParameters.tempBufferContainer=new Uint8Array(Math.max(d,c));if(!this.imageDataGetter.getImageData(lt(this,Bt,"f"),l.width,l.height,{sx:n,sy:a,sWidth:o,sHeight:h,dWidth:o,dHeight:h},{pixelFormat:Et.RGBA,bufferContainer:f}))return lt(this,Rt,"m",e).call(this,t,i);const g=f;let u=0;for(let e=0,t=c-8;e<t;++e){let t=g[e]-g[e+8];++e;let i=g[e]-g[e+8];++e;let s=g[e]-g[e+8];++e,u+=t*t+i*i+s*s}return-u},fi=async function e(t,i,s,r,n,a,o){let h;if(i=pi(i,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),r=pi(r,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),a?a=pi(a,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max):(a=pi(Math.sqrt((i||this._focusParameters.fds.step)*(r||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),o=await lt(this,Rt,"m",ci).call(this,t,a)),o<=s&&o<=n?h=3:s<n&&s<o?h=1:n<s&&n<o&&(h=2),(r-i)/2<=this._focusParameters.fds.step)return 3===h||(1===h?await lt(this,Wt,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:i}]}):2===h&&await lt(this,Wt,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:r}]})),!0;if(1===h)return await lt(this,Rt,"m",e).call(this,t,i,s,a,o);if(2===h)return await lt(this,Rt,"m",e).call(this,t,a,o,r,n);if(3!==h)return s=await lt(this,Rt,"m",ci).call(this,t,i),n=await lt(this,Rt,"m",ci).call(this,t,r),await lt(this,Rt,"m",e).call(this,t,i,s,r,n);let l=pi(Math.sqrt((i||this._focusParameters.fds.step)*(a||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),d=pi(Math.sqrt((r||this._focusParameters.fds.step)*(a||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max);if(Math.abs(1/this._focusParameters.oldDistance-1/l)<=Math.abs(1/this._focusParameters.oldDistance-1/d)){let h=await lt(this,Rt,"m",ci).call(this,t,l);if(h<o)return await lt(this,Rt,"m",e).call(this,t,i,s,a,o,l,h);if(h==o)return await lt(this,Rt,"m",e).call(this,t,l,h,a,o);let c=await lt(this,Rt,"m",ci).call(this,t,d);if(h>o&&o<c)return await lt(this,Rt,"m",e).call(this,t,l,h,d,c,a,o);if(o==c)return await lt(this,Rt,"m",e).call(this,t,a,o,d,c);if(o>c)return await lt(this,Rt,"m",e).call(this,t,a,o,r,n,d,c)}else{let h=await lt(this,Rt,"m",ci).call(this,t,d);if(o>h)return await lt(this,Rt,"m",e).call(this,t,a,o,r,n,d,h);if(o==h)return await lt(this,Rt,"m",e).call(this,t,a,o,d,h);let c=await lt(this,Rt,"m",ci).call(this,t,l);if(c>o&&o<h)return await lt(this,Rt,"m",e).call(this,t,l,c,d,h,a,o);if(c==o)return await lt(this,Rt,"m",e).call(this,t,l,c,a,o);if(c<o)return await lt(this,Rt,"m",e).call(this,t,i,s,a,o,l,c)}return!1},gi=async function(e,t,i,s,r){var n;if(1==this._focusParameters.isDoingFocus)return!1;if(!e||"string"!=typeof e.x||"string"!=typeof e.y)throw new Error("Invalid 'centerPoint'.");if(!t||"string"!=typeof t)throw new Error("Invalid 'width'.");if(!i||"string"!=typeof i)throw new Error("Invalid 'height'.");const a=this.getResolution();let o=0,h=0;if(e.x.endsWith("px"))o=parseFloat(e.x);else{if(!e.x.endsWith("%"))throw new Error("Invalid 'centerPoint'.");o=parseFloat(e.x)/100*a.width}if(e.y.endsWith("px"))h=parseFloat(e.y);else{if(!e.y.endsWith("%"))throw new Error("Invalid 'centerPoint'.");h=parseFloat(e.y)/100*a.height}if(isNaN(o)||isNaN(h)||o<0||o>a.width||h<0||h>a.height)throw new Error("Invalid 'centerPoint'.");let l=0;if(t.endsWith("px"))l=parseFloat(t);else{if(!t.endsWith("%"))throw new Error("Invalid 'width'.");l=parseFloat(t)/100*a.width}if(isNaN(l)||l<0)throw new Error("Invalid 'width'.");let d=0;if(i.endsWith("px"))d=parseFloat(i);else{if(!i.endsWith("%"))throw new Error("Invalid 'height'.");d=parseFloat(i)/100*a.height}if(isNaN(d)||d<0)throw new Error("Invalid 'height'.");if(1!==lt(this,qt,"f")){const e=lt(this,qt,"f"),t=lt(this,Qt,"f");l/=e,d/=e,o=(1-1/e)*t.x+o/e,h=(1-1/e)*t.y+h/e}if(!this._focusSupported)throw new Error("Manual focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=null===(n=await this.getCameraCapabilities())||void 0===n?void 0:n.focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,new Error("Manual focus unsupported.");null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus=1;const c={focusL:o,focusT:h,focusW:l,focusH:d,focusTaskId:++this._focusParameters.curFocusTaskId,timeStart:Date.now()},f=async(e,t,i)=>{try{(null==t||t<this._focusParameters.fds.min)&&(t=this._focusParameters.fds.min),(null==i||i>this._focusParameters.fds.max)&&(i=this._focusParameters.fds.max),this._focusParameters.oldDistance=null;let s=pi(Math.sqrt(i*(t||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),r=pi(Math.sqrt((t||this._focusParameters.fds.step)*s),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),n=pi(Math.sqrt(s*i),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),a=await lt(this,Rt,"m",ci).call(this,e,n),o=await lt(this,Rt,"m",ci).call(this,e,r),h=await lt(this,Rt,"m",ci).call(this,e,s);if(o>h&&h<a){const t=await lt(this,Rt,"m",fi).call(this,e,r,o,n,a,s,h);return this._focusParameters.isDoingFocus=0,t}if(o<h&&o<a){let i=await lt(this,Rt,"m",ci).call(this,e,t);const n=await lt(this,Rt,"m",fi).call(this,e,t,i,s,h,r,o);return this._focusParameters.isDoingFocus=0,n}if(h>a&&o>a){let t=await lt(this,Rt,"m",ci).call(this,e,i);const r=await lt(this,Rt,"m",fi).call(this,e,s,h,i,t,n,a);return this._focusParameters.isDoingFocus=0,r}if(o==h&&h<a){const t=await lt(this,Rt,"m",fi).call(this,e,r,o,s,h);return this._focusParameters.isDoingFocus=0,t}if(h==a&&o>h){const t=await lt(this,Rt,"m",fi).call(this,e,s,h,n,a);return this._focusParameters.isDoingFocus=0,t}return f(e,t,i)}catch(e){if("DeprecatedTaskError"!==e.name)throw e}};return f(c,s,r)},ui=function(e){if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");if(!e||"string"!=typeof e.x||"string"!=typeof e.y)throw new Error("Invalid 'center'.");const t=this.getResolution();let i=0,s=0;if(e.x.endsWith("px"))i=parseFloat(e.x);else{if(!e.x.endsWith("%"))throw new Error("Invalid scale center.");i=parseFloat(e.x)/100*t.width}if(e.y.endsWith("px"))s=parseFloat(e.y);else{if(!e.y.endsWith("%"))throw new Error("Invalid scale center.");s=parseFloat(e.y)/100*t.height}if(isNaN(i)||isNaN(s))throw new Error("Invalid scale center.");dt(this,Qt,{x:i,y:s},"f")},mi=function(e){if(!lt(this,Wt,"f"))throw new Error("Camera is not open.");const t=this.getResolution();return e&&e.x==t.width/2&&e.y==t.height/2},_i.browserInfo=wt,_i.onWarning=null===(Mt=null===window||void 0===window?void 0:window.console)||void 0===Mt?void 0:Mt.warn,"undefined"!=typeof navigator&&(yi=navigator,vi=yi.userAgent,Ii=yi.platform,Ei=yi.mediaDevices),function(){if(!v){const e={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:yi.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},t={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:Ii,search:"Win"},Mac:{str:Ii},Linux:{str:Ii}};let i="unknownBrowser",s=0,r="unknownOS";for(let t in e){const r=e[t]||{};let n=r.str||vi,a=r.search||t,o=r.verStr||vi,h=r.verSearch||t;if(h instanceof Array||(h=[h]),-1!=n.indexOf(a)){i=t;for(let e of h){let t=o.indexOf(e);if(-1!=t){s=parseFloat(o.substring(t+e.length+1));break}}break}}for(let e in t){const i=t[e]||{};let s=i.str||vi,n=i.search||e;if(-1!=s.indexOf(n)){r=e;break}}"Linux"==r&&-1!=vi.indexOf("Windows NT")&&(r="HarmonyOS"),bi={browser:i,version:s,OS:r}}v&&(bi={browser:"ssr",version:0,OS:"ssr"})}();const Si="undefined"!=typeof WebAssembly&&vi&&!(/Safari/.test(vi)&&!/Chrome/.test(vi)&&/\(.+\s11_2_([2-6]).*\)/.test(vi)),Ci=!("undefined"==typeof Worker),Ai=!(!Ei||!Ei.getUserMedia),Ti=async()=>{let e=!1;if(Ai)try{(await Ei.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()})),e=!0}catch(e){}return e};var xi,Li,Fi,Di,Mi,Ri,Oi,Pi,ki,Bi,Wi,Vi,Ni,Ui,Gi,ji,Hi,Zi,Yi,zi,Ji,Xi,qi,Qi,Ki,$i,es,ts,is,ss,rs;"Chrome"===bi.browser&&bi.version>66||"Safari"===bi.browser&&bi.version>13||"OPR"===bi.browser&&bi.version>43||"Edge"===bi.browser&&bi.version;class ns{constructor(e){xi.add(this),Li.set(this,void 0),Fi.set(this,0),Di.set(this,void 0),Mi.set(this,0),Ri.set(this,!1),y(this,Li,e,"f")}startCharging(){_(this,Ri,"f")||(ns._onLog&&ns._onLog("start charging."),_(this,xi,"m",Pi).call(this),y(this,Ri,!0,"f"))}stopCharging(){_(this,Di,"f")&&clearTimeout(_(this,Di,"f")),_(this,Ri,"f")&&(ns._onLog&&ns._onLog("stop charging."),y(this,Fi,Date.now()-_(this,Mi,"f"),"f"),y(this,Ri,!1,"f"))}}Li=new WeakMap,Fi=new WeakMap,Di=new WeakMap,Mi=new WeakMap,Ri=new WeakMap,xi=new WeakSet,Oi=function(){m.consumeForDce(1),ns._onLog&&ns._onLog("charge 1.")},Pi=function e(){0==_(this,Fi,"f")&&_(this,xi,"m",Oi).call(this),y(this,Mi,Date.now(),"f"),_(this,Di,"f")&&clearTimeout(_(this,Di,"f")),y(this,Di,setTimeout((()=>{y(this,Fi,0,"f"),_(this,xi,"m",e).call(this)}),_(this,Li,"f")-_(this,Fi,"f")),"f")};const as=new Map([[o.IPF_GRAYSCALED,Et.GREY],[o.IPF_ABGR_8888,Et.RGBA],[o.IPF_ARGB_8888,Et.BGRA]]),os=new Map([[Et.GREY,o.IPF_GRAYSCALED],[Et.RGBA,o.IPF_ABGR_8888],[Et.BGRA,o.IPF_ARGB_8888]]);var hs,ls,ds;!function(e){e[e.BF_NULL=0]="BF_NULL",e[e.BF_ALL=0x10000000000000000]="BF_ALL",e[e.BF_DEFAULT=4265607167]="BF_DEFAULT",e[e.BF_ONED=3147775]="BF_ONED",e[e.BF_GS1_DATABAR=260096]="BF_GS1_DATABAR",e[e.BF_CODE_39=1]="BF_CODE_39",e[e.BF_CODE_128=2]="BF_CODE_128",e[e.BF_CODE_93=4]="BF_CODE_93",e[e.BF_CODABAR=8]="BF_CODABAR",e[e.BF_ITF=16]="BF_ITF",e[e.BF_EAN_13=32]="BF_EAN_13",e[e.BF_EAN_8=64]="BF_EAN_8",e[e.BF_UPC_A=128]="BF_UPC_A",e[e.BF_UPC_E=256]="BF_UPC_E",e[e.BF_INDUSTRIAL_25=512]="BF_INDUSTRIAL_25",e[e.BF_CODE_39_EXTENDED=1024]="BF_CODE_39_EXTENDED",e[e.BF_GS1_DATABAR_OMNIDIRECTIONAL=2048]="BF_GS1_DATABAR_OMNIDIRECTIONAL",e[e.BF_GS1_DATABAR_TRUNCATED=4096]="BF_GS1_DATABAR_TRUNCATED",e[e.BF_GS1_DATABAR_STACKED=8192]="BF_GS1_DATABAR_STACKED",e[e.BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL=16384]="BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL",e[e.BF_GS1_DATABAR_EXPANDED=32768]="BF_GS1_DATABAR_EXPANDED",e[e.BF_GS1_DATABAR_EXPANDED_STACKED=65536]="BF_GS1_DATABAR_EXPANDED_STACKED",e[e.BF_GS1_DATABAR_LIMITED=131072]="BF_GS1_DATABAR_LIMITED",e[e.BF_PATCHCODE=262144]="BF_PATCHCODE",e[e.BF_CODE_32=16777216]="BF_CODE_32",e[e.BF_PDF417=33554432]="BF_PDF417",e[e.BF_QR_CODE=67108864]="BF_QR_CODE",e[e.BF_DATAMATRIX=134217728]="BF_DATAMATRIX",e[e.BF_AZTEC=268435456]="BF_AZTEC",e[e.BF_MAXICODE=536870912]="BF_MAXICODE",e[e.BF_MICRO_QR=1073741824]="BF_MICRO_QR",e[e.BF_MICRO_PDF417=524288]="BF_MICRO_PDF417",e[e.BF_GS1_COMPOSITE=2147483648]="BF_GS1_COMPOSITE",e[e.BF_MSI_CODE=1048576]="BF_MSI_CODE",e[e.BF_CODE_11=2097152]="BF_CODE_11",e[e.BF_TWO_DIGIT_ADD_ON=4194304]="BF_TWO_DIGIT_ADD_ON",e[e.BF_FIVE_DIGIT_ADD_ON=8388608]="BF_FIVE_DIGIT_ADD_ON",e[e.BF_MATRIX_25=68719476736]="BF_MATRIX_25",e[e.BF_POSTALCODE=0x3f0000000000000]="BF_POSTALCODE",e[e.BF_NONSTANDARD_BARCODE=4294967296]="BF_NONSTANDARD_BARCODE",e[e.BF_USPSINTELLIGENTMAIL=4503599627370496]="BF_USPSINTELLIGENTMAIL",e[e.BF_POSTNET=9007199254740992]="BF_POSTNET",e[e.BF_PLANET=0x40000000000000]="BF_PLANET",e[e.BF_AUSTRALIANPOST=0x80000000000000]="BF_AUSTRALIANPOST",e[e.BF_RM4SCC=72057594037927940]="BF_RM4SCC",e[e.BF_KIX=0x200000000000000]="BF_KIX",e[e.BF_DOTCODE=8589934592]="BF_DOTCODE",e[e.BF_PHARMACODE_ONE_TRACK=17179869184]="BF_PHARMACODE_ONE_TRACK",e[e.BF_PHARMACODE_TWO_TRACK=34359738368]="BF_PHARMACODE_TWO_TRACK",e[e.BF_PHARMACODE=51539607552]="BF_PHARMACODE"}(hs||(hs={}));class cs extends l{static set _onLog(e){y(cs,Bi,e,"f",Wi),_i._onLog=e,ns._onLog=e}static get _onLog(){return _(cs,Bi,"f",Wi)}static async detectEnvironment(){return await(async()=>({wasm:Si,worker:Ci,getUserMedia:Ai,camera:await Ti(),browser:bi.browser,version:bi.version,OS:bi.OS}))()}static async testCameraAccess(){return _i.testCameraAccess()}static async createInstance(e){if(e&&!(e instanceof ot))throw new TypeError("Invalid view.");const t=new cs(e);return cs.onWarning&&(location&&"file:"===location.protocol?setTimeout((()=>{cs.onWarning&&cs.onWarning({id:1,message:"The page is opened over file:// and Dynamsoft Camera Enhancer may not work properly. Please open the page via https://."})}),0):!1!==window.isSecureContext&&navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||setTimeout((()=>{cs.onWarning&&cs.onWarning({id:2,message:"Dynamsoft Camera Enhancer may not work properly in a non-secure context. Please open the page via https://."})}),0)),t}get video(){return _(this,Vi,"f").getVideoEl()}set videoSrc(e){if(!_(this,Vi,"f"))throw new Error("Camera manager is null.");_(this,Ni,"f")&&(_(this,Ni,"f")._hideDefaultSelection=!0),_(this,Vi,"f").videoSrc=e}get videoSrc(){var e;return null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.videoSrc}set ifSaveLastUsedCamera(e){if(!_(this,Vi,"f"))throw new Error("Camera manager is null.");_(this,Vi,"f").ifSaveLastUsedCamera=e}get ifSaveLastUsedCamera(){var e;return null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.ifSaveLastUsedCamera}set ifSkipCameraInspection(e){if(!_(this,Vi,"f"))throw new Error("Camera manager is null.");_(this,Vi,"f").ifSkipCameraInspection=e}get ifSkipCameraInspection(){var e;return null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.ifSkipCameraInspection}set singleFrameMode(e){if(this.isOpen())throw new Error("It is not allowed to change `singleFrameMode` when the camera is open.");y(this,Hi,e,"f")}get singleFrameMode(){return _(this,Hi,"f")}get _isFetchingStarted(){return _(this,Xi,"f")}get disposed(){return _(this,es,"f")}constructor(e){if(super(),ki.add(this),Vi.set(this,void 0),Ni.set(this,void 0),Ui.set(this,"closed"),Gi.set(this,void 0),ji.set(this,!1),Hi.set(this,void 0),this._onCameraSelChange=async()=>{this.isOpen()&&_(this,Ni,"f")&&await this.selectCamera(_(this,Ni,"f")._selCam.value)},this._onResolutionSelChange=async()=>{if(!this.isOpen())return;if(!_(this,Ni,"f"))return;let e,t;if(_(this,Ni,"f")._selRsl&&-1!=_(this,Ni,"f")._selRsl.selectedIndex){let i=_(this,Ni,"f")._selRsl.options[_(this,Ni,"f")._selRsl.selectedIndex];e=parseInt(i.getAttribute("data-width")),t=parseInt(i.getAttribute("data-height"))}await this.setResolution({width:e,height:t})},this._onCloseBtnClick=async()=>{this.isOpen()&&_(this,Ni,"f")&&this.close()},Zi.set(this,((e,t,i,s)=>{const r=Date.now(),n={sx:s.x,sy:s.y,sWidth:s.width,sHeight:s.height,dWidth:s.width,dHeight:s.height},a=Math.max(n.dWidth,n.dHeight);if(this.canvasSizeLimit&&a>this.canvasSizeLimit){const e=this.canvasSizeLimit/a;n.dWidth>n.dHeight?(n.dWidth=this.canvasSizeLimit,n.dHeight=Math.round(n.dHeight*e)):(n.dWidth=Math.round(n.dWidth*e),n.dHeight=this.canvasSizeLimit)}const o=_(this,Vi,"f").imageDataGetter.getImageData(e,t,i,n,{pixelFormat:as.get(this.getPixelFormat())});let h=null;if(o){const e=Date.now();let a;if(o.pixelFormat===Et.GREY)a=o.width;else a=4*o.width;let l=!0;0===n.sx&&0===n.sy&&n.sWidth===t&&n.sHeight===i&&(l=!1),h={bytes:o.data,width:o.width,height:o.height,stride:a,format:os.get(o.pixelFormat),tag:{imageId:this._imageId==Number.MAX_VALUE?this._imageId=0:++this._imageId,type:d.ITT_FILE_IMAGE,isCropped:l,cropRegion:{left:s.x,top:s.y,right:s.x+s.width,bottom:s.y+s.height,isMeasuredInPercentage:!1},originalWidth:t,originalHeight:i,currentWidth:o.width,currentHeight:o.height,timeSpent:e-r,timeStamp:e},toCanvas:_(this,Yi,"f"),isDCEFrame:!0}}return h})),this._onSingleFrameAcquired=e=>{let t;t=_(this,Ni,"f")?_(this,Ni,"f").getConvertedRegion():Z.convert(_(this,zi,"f"),e.width,e.height),t||(t={x:0,y:0,width:e.width,height:e.height});const i=_(this,Zi,"f").call(this,e,e.width,e.height,t);_(this,Gi,"f").fire("singleFrameAcquired",[i],{async:!1})},Yi.set(this,(function(){if(!(this.bytes instanceof Uint8Array||this.bytes instanceof Uint8ClampedArray))throw new TypeError("Invalid bytes.");if("number"!=typeof this.width||this.width<=0)throw new Error("Invalid width.");if("number"!=typeof this.height||this.height<=0)throw new Error("Invalid height.");const e=document.createElement("canvas");let t;e.width=this.width,e.height=this.height;if(this.format===o.IPF_GRAYSCALED){t=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<t.length;e+=4)t[e]=this.bytes[e/4],t[e+1]=this.bytes[e/4],t[e+2]=this.bytes[e/4],t[e+3]=255}else t=new Uint8ClampedArray(this.bytes.buffer);return e.getContext("2d").putImageData(new ImageData(t,this.width,this.height),0,0),e})),zi.set(this,void 0),Ji.set(this,o.IPF_ABGR_8888),Xi.set(this,!1),this._imageId=-1,qi.set(this,void 0),this.fetchInterval=0,Qi.set(this,{enhancedFocus:!1,autoZoom:!1,tapToFocus:!1}),Ki.set(this,{minValue:1,maxValue:999,autoFocusFrameArray:[],autoFocusFrameLimit:[5,3],autoZoomDetectionArea:.5,autoZoomTargetBorder:.9,autoZoomIdealArea:[0,.05],autoZoomInFrameArray:[],autoZoomInFrameLimit:[5,3],autoZoomInMaxTimes:5,autoZoomInMinStep:Math.pow(10,.2),autoZoomInIdealModuleSize:6,autoZoomOutFrameCount:0,autoZoomOutFrameLimit:3,autoZoomOutStepRate:1/3,autoZoomOutStepRate_2:.05,autoZoomOutMinStep:2,frameArrayInIdealZoom:[],frameLimitInIdealZoom:[5,3],nextActionInIdealZoom:"focus",noIntermediateResultsCount:[],enableZoomOutInIdealZoom:!1}),$i.set(this,void 0),es.set(this,!1),this.isCameraEnhancer=!0,e&&!(e instanceof ot))throw new TypeError("Invalid view.");y(this,Gi,new J,"f"),y(this,Vi,new _i,"f"),this._imageDataGetter=_(this,Vi,"f").imageDataGetter;_(this,Vi,"f").updateVideoElWhenSoftwareScaled=()=>{if(!this.video)return;const e=_(this,Vi,"f").getSoftwareScale();if(e<1)throw new RangeError("Invalid scale value.");_(this,Ni,"f")?(this.video.style.transform=1===e?"":`scale(${e})`,_(this,Ni,"f")._updateVideoContainer()):this.video.style.transform=1===e?"":`scale(${e})`},["iPhone","iPad","Android","HarmonyOS"].includes(bi.OS)?_(this,Vi,"f").setResolution(1280,720):_(this,Vi,"f").setResolution(1920,1080),this.singleFrameMode=!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),e&&this.setCameraView(e),this._on("before:camera:change",(()=>{_(this,$i,"f").stopCharging();const e=_(this,Ni,"f");e&&(e._startLoading(),e._clearInnerDrawingItems())})),this._on("camera:changed",(()=>{this.clearBuffer()})),this._on("before:resolution:change",(()=>{const e=_(this,Ni,"f");e&&(e._startLoading(),e._clearInnerDrawingItems())})),this._on("resolution:changed",(()=>{this.clearBuffer(),e.eventHandler.fire("content:updated",null,{async:!1})})),this._on("paused",(()=>{_(this,$i,"f").stopCharging();_(this,Ni,"f")})),this._on("resumed",(()=>{_(this,Ni,"f")})),this._on("tapfocus",(()=>{_(this,$i,"f").startCharging()})),this._intermediateResultReceiver=new c,this._intermediateResultReceiver.onTaskResultsReceived=async(e,t)=>{var i,s,r,n;if(this.singleFrameMode||!this.isOpen()||this.isPaused())return;const a=e.intermediateResultUnits;let o=!1,h=!1;for(let e of a){if(e.unitType===f.IRUT_DECODED_BARCODES&&e.decodedBarcodes.length){o=!0;break}e.unitType===f.IRUT_LOCALIZED_BARCODES&&e.localizedBarcodes.length&&(h=!0)}if(_(this,Qi,"f").autoZoom||_(this,Qi,"f").enhancedFocus)if(o)_(this,Ki,"f").autoZoomInFrameArray.length=0,_(this,Ki,"f").autoZoomOutFrameCount=0,_(this,Ki,"f").frameArrayInIdealZoom.length=0,_(this,Qi,"f").autoZoom&&_(this,Qi,"f").enhancedFocus&&(_(this,Ki,"f").nextActionInIdealZoom="focus"),_(this,Ki,"f").autoFocusFrameArray.length=0,_(this,Ki,"f").noIntermediateResultsCount=0;else if(_(this,$i,"f").startCharging(),h){const e=a[0].originalImageTag,t=(null===(i=e.cropRegion)||void 0===i?void 0:i.left)||0,o=(null===(s=e.cropRegion)||void 0===s?void 0:s.top)||0,h=(null===(r=e.cropRegion)||void 0===r?void 0:r.right)?e.cropRegion.right-t:e.originalWidth,l=(null===(n=e.cropRegion)||void 0===n?void 0:n.bottom)?e.cropRegion.bottom-o:e.originalHeight,d=e.currentWidth,c=e.currentHeight;let g;{let e,i,s,r,n;{const e=this.video.videoWidth*(1-_(this,Ki,"f").autoZoomDetectionArea)/2,t=this.video.videoWidth*(1+_(this,Ki,"f").autoZoomDetectionArea)/2,i=t,s=e,r=this.video.videoHeight*(1-_(this,Ki,"f").autoZoomDetectionArea)/2,a=r,o=this.video.videoHeight*(1+_(this,Ki,"f").autoZoomDetectionArea)/2;n=[{x:e,y:r},{x:t,y:a},{x:i,y:o},{x:s,y:o}]}const u=[];{const e=(e,t)=>{const i=(e,t)=>{if(!e&&!t)throw new Error("Invalid arguments.");return function(e,t,i){let s=!1;const r=e.length;if(r<=2)return!1;for(let n=0;n<r;n++){const a=e[n],o=e[(n+1)%r];if(X(a,o,{x:t,y:i}))return!0;q(a.y-i)>0!=q(o.y-i)>0&&q(t-(i-a.y)*(a.x-o.x)/(a.y-o.y)-a.x)<0&&(s=!s)}return s}(t,e.x,e.y)},s=(e,t)=>!!(Q([e[0],e[1]],[e[2],e[3]],[t[0].x,t[0].y],[t[1].x,t[1].y])||Q([e[0],e[1]],[e[2],e[3]],[t[1].x,t[1].y],[t[2].x,t[2].y])||Q([e[0],e[1]],[e[2],e[3]],[t[2].x,t[2].y],[t[3].x,t[3].y])||Q([e[0],e[1]],[e[2],e[3]],[t[3].x,t[3].y],[t[0].x,t[0].y]));return!!(i({x:e[0].x,y:e[0].y},t)||i({x:e[1].x,y:e[1].y},t)||i({x:e[2].x,y:e[2].y},t)||i({x:e[3].x,y:e[3].y},t))||(!!(i({x:t[0].x,y:t[0].y},e)||i({x:t[1].x,y:t[1].y},e)||i({x:t[2].x,y:t[2].y},e)||i({x:t[3].x,y:t[3].y},e))||!!(s([t[0].x,t[0].y,t[1].x,t[1].y],e)||s([t[1].x,t[1].y,t[2].x,t[2].y],e)||s([t[2].x,t[2].y,t[3].x,t[3].y],e)||s([t[3].x,t[3].y,t[0].x,t[0].y],e)))};for(let i of a)if(i.unitType===f.IRUT_LOCALIZED_BARCODES)for(let s of i.localizedBarcodes){if(!s)continue;const i=s.location.points;i.forEach((e=>{ot._transformCoordinates(e,t,o,h,l,d,c)})),e(n,i)&&u.push(s)}if(cs._debug&&_(this,Ni,"f")){const e=this.__layer||(this.__layer=_(this,Ni,"f")._createDrawingLayer(null,null,null,99));e.clearDrawingItems();const t=this.__styleId2||(this.__styleId2=et.createDrawingStyle({strokeStyle:"red"}));for(let i of a)if(i.unitType===f.IRUT_LOCALIZED_BARCODES)for(let s of i.localizedBarcodes){if(!s)continue;const i=s.location.points,r=new le({points:i},t);e.addDrawingItems([r])}}}let m;if(u.length){let e=u.filter((e=>e.possibleFormats==hs.BF_QR_CODE||e.possibleFormats==hs.BF_DATAMATRIX));if(e.length||(e=u.filter((e=>e.possibleFormats==hs.BF_ONED)),e.length||(e=u)),e.length){const t=e=>{const t=e.location.points,i=(t[0].x+t[1].x+t[2].x+t[3].x)/4,s=(t[0].y+t[1].y+t[2].y+t[3].y)/4;return(i-d/2)*(i-d/2)+(s-c/2)*(s-c/2)};m=e[0];let i=t(m);if(1!=e.length)for(let s=1;s<e.length;s++){const r=t(e[s]);e[s].confidence>1.1*m.confidence?(m=e[s],i=r):e[s].confidence>.9*m.confidence&&r<i&&(m=e[s],i=r)}}}if(m){const t=m.location.points;e=Math.min(t[0].x,t[1].x,t[2].x,t[3].x),i=Math.max(t[0].x,t[1].x,t[2].x,t[3].x),s=Math.min(t[0].y,t[1].y,t[2].y,t[3].y),r=Math.max(t[0].y,t[1].y,t[2].y,t[3].y),g={points:[{x:e,y:s},{x:i,y:s},{x:i,y:r},{x:e,y:r}],result:m}}}if(cs._debug&&_(this,Ni,"f")&&(null==g?void 0:g.points)){const e=this.__layer||(this.__layer=_(this,Ni,"f")._createDrawingLayer(null,null,null,99)),t=this.__styleId1||(this.__styleId1=et.createDrawingStyle({strokeStyle:"blue"})),i=new le({points:g.points},t);e.addDrawingItems([i])}if(_(this,Ki,"f").autoZoomOutFrameCount=0,_(this,Ki,"f").noIntermediateResultsCount=0,_(this,Qi,"f").autoZoom){const e=_(this,Ki,"f").autoZoomIdealArea[1];let t=(1-_(this,Ki,"f").autoZoomTargetBorder)/2;const i=g.points[0].x/h,s=(h-g.points[2].x)/h,r=g.points[0].y/l,n=(l-g.points[2].y)/l;if(i>e&&s>e&&r>e&&n>e&&g.result.moduleSize<_(this,Ki,"f").autoZoomInIdealModuleSize){if(_(this,Ki,"f").autoZoomInFrameArray.push(!0),_(this,Ki,"f").autoZoomInFrameArray.splice(0,_(this,Ki,"f").autoZoomInFrameArray.length-_(this,Ki,"f").autoZoomInFrameLimit[0]),_(this,Ki,"f").frameArrayInIdealZoom.length=0,_(this,Qi,"f").enhancedFocus&&(_(this,Ki,"f").nextActionInIdealZoom="focus",this.setFocus({mode:"continuous"}).catch((()=>{}))),_(this,Ki,"f").autoZoomInFrameArray.filter((e=>!0===e)).length>=_(this,Ki,"f").autoZoomInFrameLimit[1]){_(this,Ki,"f").autoZoomInFrameArray.length=0;const e=[(.5-t)/(.5-i),(.5-t)/(.5-s),(.5-t)/(.5-r),(.5-t)/(.5-n)].filter((e=>e>0)),a=Math.min(...e,_(this,Ki,"f").autoZoomInIdealModuleSize/g.result.moduleSize),o=this.getZoomSettings().factor;let h=Math.max(Math.pow(o*a,1/_(this,Ki,"f").autoZoomInMaxTimes),_(this,Ki,"f").autoZoomInMinStep);h=Math.min(h,a);let l=o*h;l=Math.max(_(this,Ki,"f").minValue,l),l=Math.min(_(this,Ki,"f").maxValue,l),await this.setZoom({factor:l}),this.clearBuffer()}}else if(_(this,Ki,"f").autoZoomInFrameArray.length=0,_(this,Ki,"f").frameArrayInIdealZoom.push(!0),_(this,Ki,"f").frameArrayInIdealZoom.splice(0,_(this,Ki,"f").frameArrayInIdealZoom.length-_(this,Ki,"f").frameLimitInIdealZoom[0]),_(this,Ki,"f").frameArrayInIdealZoom.filter((e=>!0===e)).length>=_(this,Ki,"f").frameLimitInIdealZoom[1])if(_(this,Ki,"f").frameArrayInIdealZoom.length=0,"focus"===_(this,Ki,"f").nextActionInIdealZoom&&_(this,Qi,"f").enhancedFocus){const e=g.points;try{await this.setFocus({mode:"manual",area:{centerPoint:{x:(e[0].x+e[2].x)/2+"px",y:(e[0].y+e[2].y)/2+"px"},width:e[2].x-e[0].x+"px",height:e[2].y-e[0].y+"px"}})}catch(e){}this.clearBuffer(),_(this,Ki,"f").nextActionInIdealZoom="zoomOut"}else{if("zoomOut"!==_(this,Ki,"f").nextActionInIdealZoom&&_(this,Qi,"f").enhancedFocus)throw new Error("Invalid action.");if(_(this,Ki,"f").enableZoomOutInIdealZoom){t=_(this,Ki,"f").autoZoomIdealArea[1]+_(this,Ki,"f").autoZoomOutStepRate_2;const e=[(.5-t)/(.5-i),(.5-t)/(.5-s),(.5-t)/(.5-r),(.5-t)/(.5-n)].filter((e=>e>0));let a=Math.min(...e)*this.getZoomSettings().factor;a=Math.max(_(this,Ki,"f").minValue,a),a=Math.min(_(this,Ki,"f").maxValue,a),await this.setZoom({factor:a}),this.clearBuffer(),_(this,Qi,"f").enhancedFocus&&(_(this,Ki,"f").nextActionInIdealZoom="focus",this.setFocus({mode:"continuous"}).catch((()=>{})))}}}else if(_(this,Qi,"f").enhancedFocus&&(_(this,Ki,"f").autoFocusFrameArray.push(!0),_(this,Ki,"f").autoFocusFrameArray.splice(0,_(this,Ki,"f").autoFocusFrameArray.length-_(this,Ki,"f").autoFocusFrameLimit[0]),_(this,Ki,"f").autoFocusFrameArray.filter((e=>!0===e)).length>=_(this,Ki,"f").autoFocusFrameLimit[1])){_(this,Ki,"f").autoFocusFrameArray.length=0;try{const e=g.points;await this.setFocus({mode:"manual",area:{centerPoint:{x:(e[0].x+e[2].x)/2+"px",y:(e[0].y+e[2].y)/2+"px"},width:e[2].x-e[0].x+"px",height:e[2].y-e[0].y+"px"}})}catch(e){}this.clearBuffer()}}else if(_(this,Ki,"f").noIntermediateResultsCount++,_(this,Qi,"f").autoZoom){if(_(this,Ki,"f").autoZoomInFrameArray.push(!1),_(this,Ki,"f").autoZoomInFrameArray.splice(0,_(this,Ki,"f").autoZoomInFrameArray.length-_(this,Ki,"f").autoZoomInFrameLimit[0]),_(this,Ki,"f").autoZoomOutFrameCount++,_(this,Ki,"f").frameArrayInIdealZoom.push(!1),_(this,Ki,"f").frameArrayInIdealZoom.splice(0,_(this,Ki,"f").frameArrayInIdealZoom.length-_(this,Ki,"f").frameLimitInIdealZoom[0]),_(this,Ki,"f").autoZoomOutFrameCount>=_(this,Ki,"f").autoZoomOutFrameLimit){_(this,Ki,"f").autoZoomOutFrameCount=0;const e=this.getZoomSettings().factor;let t=e-Math.max((e-1)*_(this,Ki,"f").autoZoomOutStepRate,_(this,Ki,"f").autoZoomOutMinStep);t=Math.max(_(this,Ki,"f").minValue,t),t=Math.min(_(this,Ki,"f").maxValue,t),await this.setZoom({factor:t}),this.clearBuffer()}_(this,Qi,"f").enhancedFocus&&(_(this,Ki,"f").nextActionInIdealZoom="focus",this.setFocus({mode:"continuous"}).catch((()=>{})))}else _(this,Qi,"f").enhancedFocus&&(_(this,Ki,"f").autoFocusFrameArray.length=0,this.setFocus({mode:"continuous"}).catch((()=>{})))},y(this,$i,new ns(1e4),"f")}setCameraView(e){if(!(e instanceof ot))throw new TypeError("Invalid view.");if(e.disposed)throw new Error("The camera view has been disposed.");if(this.isOpen())throw new Error("It is not allowed to change camera view when the camera is open.");this.releaseCameraView(),e._singleFrameMode=this.singleFrameMode,e._onSingleFrameAcquired=this._onSingleFrameAcquired,this.videoSrc&&(_(this,Ni,"f")._hideDefaultSelection=!0),this.singleFrameMode||_(this,Vi,"f").setVideoEl(e.getVideoElement()),y(this,Ni,e,"f"),this.addListenerToView()}getCameraView(){return _(this,Ni,"f")}releaseCameraView(){_(this,Ni,"f")&&(this.removeListenerFromView(),_(this,Ni,"f")._singleFrameMode=!1,_(this,Ni,"f")._onSingleFrameAcquired=null,_(this,Ni,"f")._hideDefaultSelection=!1,_(this,Vi,"f").releaseVideoEl(),y(this,Ni,null,"f"))}addListenerToView(){if(!_(this,Ni,"f"))return;const e=_(this,Ni,"f");this.singleFrameMode||this.videoSrc||(e._innerComponent&&(_(this,Vi,"f").tapFocusEventBoundEl=e._innerComponent),e._selCam&&e._selCam.addEventListener("change",this._onCameraSelChange),e._selRsl&&e._selRsl.addEventListener("change",this._onResolutionSelChange)),e._btnClose&&e._btnClose.addEventListener("click",this._onCloseBtnClick)}removeListenerFromView(){if(!_(this,Ni,"f"))return;const e=_(this,Ni,"f");_(this,Vi,"f").tapFocusEventBoundEl=null,e._selCam&&e._selCam.removeEventListener("change",this._onCameraSelChange),e._selRsl&&e._selRsl.removeEventListener("change",this._onResolutionSelChange),e._btnClose&&e._btnClose.removeEventListener("click",this._onCloseBtnClick)}getCameraState(){return this.singleFrameMode?_(this,Ui,"f"):new Map([["closed","closed"],["opening","opening"],["opened","open"]]).get(_(this,Vi,"f").state)}isOpen(){return"open"===this.getCameraState()}getVideoEl(){return this.video}async open(){const e=_(this,Ni,"f");e&&(e._singleFrameMode=this.singleFrameMode,this.singleFrameMode?e._clickIptSingleFrameMode():(_(this,Vi,"f").setVideoEl(e.getVideoElement()),e._startLoading()));let t={width:0,height:0,deviceId:""};if(this.singleFrameMode);else{try{await _(this,Vi,"f").open()}catch(t){throw e&&e._stopLoading(),t}_(this,ji,"f")&&this.turnOnTorch().catch((()=>{}));const i=this.getResolution();t.width=i.width,t.height=i.height,t.deviceId=this.getSelectedCamera().deviceId}return y(this,Ui,"open","f"),e&&(e._innerComponent.style.display="",this.singleFrameMode||(e._stopLoading(),e._renderCamerasInfo(this.getSelectedCamera(),_(this,Vi,"f")._arrCameras),e._renderResolutionInfo({width:t.width,height:t.height}),e.eventHandler.fire("content:updated",null,{async:!0}),e.eventHandler.fire("videoEl:resized",null,{async:!0}))),_(this,Gi,"f").fire("opened",null,{target:this,async:!0}),t}close(){const e=_(this,Ni,"f");this.stopFetching(),this.clearBuffer(),this.singleFrameMode||_(this,Vi,"f").close(),y(this,Ui,"closed","f"),_(this,$i,"f").stopCharging(),e&&(e._innerComponent.style.display="none",this.singleFrameMode&&e._innerComponent.removeContent(),e._stopLoading()),_(this,Gi,"f").fire("closed",null,{target:this,async:!0})}pause(){if(this.singleFrameMode)throw new Error("'pause()' is invalid in 'singleFrameMode'.");_(this,Vi,"f").pause()}isPaused(){var e;return!this.singleFrameMode&&!0===(null===(e=this.video)||void 0===e?void 0:e.paused)}async resume(){if(this.singleFrameMode)throw new Error("'resume()' is invalid in 'singleFrameMode'.");await _(this,Vi,"f").resume()}async selectCamera(e){if(!e)throw new Error("Invalid value.");let t;t="string"==typeof e?e:e.deviceId,await _(this,Vi,"f").setCamera(t),y(this,ji,!1,"f");const i=this.getResolution(),s=_(this,Ni,"f");return s&&(s._stopLoading(),s._renderCamerasInfo(this.getSelectedCamera(),_(this,Vi,"f")._arrCameras),s._renderResolutionInfo({width:i.width,height:i.height})),{width:i.width,height:i.height,deviceId:this.getSelectedCamera().deviceId}}getSelectedCamera(){return _(this,Vi,"f").getCamera()}async getAllCameras(){return _(this,Vi,"f").getCameras()}async setResolution(e){await _(this,Vi,"f").setResolution(e.width,e.height),_(this,ji,"f")&&this.turnOnTorch().catch((()=>{}));const t=this.getResolution(),i=_(this,Ni,"f");return i&&(i._stopLoading(),i._renderResolutionInfo({width:t.width,height:t.height})),{width:t.width,height:t.height,deviceId:this.getSelectedCamera().deviceId}}getResolution(){return _(this,Vi,"f").getResolution()}getAvailableResolutions(){var e;return null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.getResolutions()}_on(e,t){["opened","closed","singleframeacquired","frameaddedtobuffer"].includes(e.toLowerCase())?_(this,Gi,"f").on(e,t):_(this,Vi,"f").on(e,t)}_off(e,t){["opened","closed","singleframeacquired","frameaddedtobuffer"].includes(e.toLowerCase())?_(this,Gi,"f").off(e,t):_(this,Vi,"f").off(e,t)}on(e,t){const i=e.toLowerCase(),s=new Map([["cameraopen","opened"],["cameraclose","closed"],["camerachange","camera:changed"],["resolutionchange","resolution:changed"],["played","played"],["singleframeacquired","singleFrameAcquired"],["frameaddedtobuffer","frameAddedToBuffer"]]).get(i);if(!s)throw new Error("Invalid event.");this._on(s,t)}off(e,t){const i=e.toLowerCase(),s=new Map([["cameraopen","opened"],["cameraclose","closed"],["camerachange","camera:changed"],["resolutionchange","resolution:changed"],["played","played"],["singleframeacquired","singleFrameAcquired"],["frameaddedtobuffer","frameAddedToBuffer"]]).get(i);if(!s)throw new Error("Invalid event.");this._off(s,t)}getVideoSettings(){var e;return null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.getMediaStreamConstraints()}async updateVideoSettings(e){var t;await(null===(t=_(this,Vi,"f"))||void 0===t?void 0:t.setMediaStreamConstraints(e,!0))}getCapabilities(){var e;return null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.getCameraCapabilities()}getCameraSettings(){return _(this,Vi,"f").getCameraSettings()}async turnOnTorch(){var e;if(this.singleFrameMode)throw new Error("'turnOnTorch()' is invalid in 'singleFrameMode'.");await(null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.turnOnTorch()),y(this,ji,!0,"f")}async turnOffTorch(){var e;if(this.singleFrameMode)throw new Error("'turnOffTorch()' is invalid in 'singleFrameMode'.");await(null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.turnOffTorch()),y(this,ji,!1,"f")}async setColorTemperature(e){if(this.singleFrameMode)throw new Error("'setColorTemperature()' is invalid in 'singleFrameMode'.");await _(this,Vi,"f").setColorTemperature(e,!0)}getColorTemperature(){return _(this,Vi,"f").getColorTemperature()}async setExposureCompensation(e){var t;if(this.singleFrameMode)throw new Error("'setExposureCompensation()' is invalid in 'singleFrameMode'.");await(null===(t=_(this,Vi,"f"))||void 0===t?void 0:t.setExposureCompensation(e,!0))}getExposureCompensation(){var e;return null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.getExposureCompensation()}async _setZoom(e){var t;if(this.singleFrameMode)throw new Error("'setZoom()' is invalid in 'singleFrameMode'.");await(null===(t=_(this,Vi,"f"))||void 0===t?void 0:t.setZoom(e))}async setZoom(e){await this._setZoom(e)}getZoomSettings(){var e;return null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.getZoom()}async resetZoom(){var e;if(this.singleFrameMode)throw new Error("'resetZoom()' is invalid in 'singleFrameMode'.");await(null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.resetZoom())}async setFrameRate(e){var t;if(this.singleFrameMode)throw new Error("'setFrameRate()' is invalid in 'singleFrameMode'.");await(null===(t=_(this,Vi,"f"))||void 0===t?void 0:t.setFrameRate(e,!0))}getFrameRate(){var e;return null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.getFrameRate()}async setFocus(e){var t;if(this.singleFrameMode)throw new Error("'setFocus()' is invalid in 'singleFrameMode'.");await(null===(t=_(this,Vi,"f"))||void 0===t?void 0:t.setFocus(e,!0))}getFocusSettings(){var e;return null===(e=_(this,Vi,"f"))||void 0===e?void 0:e.getFocus()}setAutoZoomRange(e){_(this,Ki,"f").minValue=e.min,_(this,Ki,"f").maxValue=e.max}getAutoZoomRange(){return{min:_(this,Ki,"f").minValue,max:_(this,Ki,"f").maxValue}}async enableEnhancedFeatures(e){if(await m.loadWasm(),0!=m.bSupportDce4Module)throw new Error("Please set a license containing the DCE module.");e&S.EF_ENHANCED_FOCUS&&(_(this,Qi,"f").enhancedFocus=!0),e&S.EF_AUTO_ZOOM&&(_(this,Qi,"f").autoZoom=!0),e&S.EF_TAP_TO_FOCUS&&(_(this,Qi,"f").tapToFocus=!0,_(this,Vi,"f").enableTapToFocus())}disableEnhancedFeatures(e){e&S.EF_ENHANCED_FOCUS&&(_(this,Qi,"f").enhancedFocus=!1,this.setFocus({mode:"continuous"}).catch((()=>{}))),e&S.EF_AUTO_ZOOM&&(_(this,Qi,"f").autoZoom=!1,this.resetZoom().catch((()=>{}))),e&S.EF_TAP_TO_FOCUS&&(_(this,Qi,"f").tapToFocus=!1,_(this,Vi,"f").disableTapToFocus()),_(this,ki,"m",is).call(this)&&_(this,ki,"m",ts).call(this)||_(this,$i,"f").stopCharging()}_setScanRegion(e){if(null!=e&&!W(e)&&!j(e))throw TypeError("Invalid 'region'.");y(this,zi,e?JSON.parse(JSON.stringify(e)):null,"f"),_(this,Ni,"f")&&_(this,Ni,"f").setScanRegion(e)}setScanRegion(e){this._setScanRegion(e),_(this,Ni,"f")&&(null===e?(_(this,Ni,"f")._setScanRegionMaskVisible(!1),_(this,Ni,"f")._setScanLaserVisible(!1)):(0!=_(this,Ni,"f")._userSetMaskVisible&&_(this,Ni,"f")._setScanRegionMaskVisible(!0),0!=_(this,Ni,"f")._userSetLaserVisible&&_(this,Ni,"f")._setScanLaserVisible(!0)))}getScanRegion(){return JSON.parse(JSON.stringify(_(this,zi,"f")))}hasNextImageToFetch(){return!("open"!==this.getCameraState()||!_(this,Vi,"f").isVideoLoaded()||this.singleFrameMode)}startFetching(){if(this.singleFrameMode)throw Error("'startFetching()' is unavailable in 'singleFrameMode'.");_(this,Xi,"f")||(y(this,Xi,!0,"f"),_(this,ki,"m",ss).call(this))}stopFetching(){_(this,Xi,"f")&&(cs._onLog&&cs._onLog("DCE: stop fetching loop: "+Date.now()),_(this,qi,"f")&&clearTimeout(_(this,qi,"f")),y(this,Xi,!1,"f"))}fetchImage(){if(this.singleFrameMode)throw new Error("'fetchImage()' is unavailable in 'singleFrameMode'.");if(!this.video)throw new Error("The video element does not exist.");if(4!==this.video.readyState)throw new Error("The video is not loaded.");const e=this.getResolution();if(!(null==e?void 0:e.width)||!(null==e?void 0:e.height))throw new Error("The video is not loaded.");let t;if(t=Z.convert(_(this,zi,"f"),e.width,e.height),t||(t={x:0,y:0,width:e.width,height:e.height}),t.x>e.width||t.y>e.height)throw new Error("Invalid scan region.");t.x+t.width>e.width&&(t.width=e.width-t.x),t.y+t.height>e.height&&(t.height=e.height-t.y);const i={sx:t.x,sy:t.y,sWidth:t.width,sHeight:t.height,dWidth:t.width,dHeight:t.height},s=Math.max(i.dWidth,i.dHeight);if(this.canvasSizeLimit&&s>this.canvasSizeLimit){const e=this.canvasSizeLimit/s;i.dWidth>i.dHeight?(i.dWidth=this.canvasSizeLimit,i.dHeight=Math.round(i.dHeight*e)):(i.dWidth=Math.round(i.dWidth*e),i.dHeight=this.canvasSizeLimit)}const r=_(this,Vi,"f").getFrameData({position:i,pixelFormat:as.get(this.getPixelFormat())});if(!r)return null;let n;if(r.pixelFormat===Et.GREY)n=r.width;else n=4*r.width;let a=!0;0===i.sx&&0===i.sy&&i.sWidth===e.width&&i.sHeight===e.height&&(a=!1);return{bytes:r.data,width:r.width,height:r.height,stride:n,format:os.get(r.pixelFormat),tag:{imageId:this._imageId==Number.MAX_VALUE?this._imageId=0:++this._imageId,type:d.ITT_VIDEO_FRAME,isCropped:a,cropRegion:{left:t.x,top:t.y,right:t.x+t.width,bottom:t.y+t.height,isMeasuredInPercentage:!1},originalWidth:e.width,originalHeight:e.height,currentWidth:r.width,currentHeight:r.height,timeSpent:r.timeSpent,timeStamp:r.timeStamp},toCanvas:_(this,Yi,"f"),isDCEFrame:!0}}setImageFetchInterval(e){this.fetchInterval=e,_(this,Xi,"f")&&(_(this,qi,"f")&&clearTimeout(_(this,qi,"f")),y(this,qi,setTimeout((()=>{this.disposed||_(this,ki,"m",ss).call(this)}),e),"f"))}getImageFetchInterval(){return this.fetchInterval}setPixelFormat(e){y(this,Ji,e,"f")}getPixelFormat(){return _(this,Ji,"f")}takePhoto(e){if(!this.isOpen())throw new Error("Not open.");if(this.singleFrameMode)throw new Error("'takePhoto()' is unavailable in 'singleFrameMode'.");const t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),t.setAttribute("capture",""),t.style.position="fixed",t.style.left="-1px",t.style.top="-1px",t.style.width="1px",t.style.height="1px",t.style.backgroundColor="transparent",t.style.color="transparent",t.addEventListener("click",(()=>{const e=this.isOpen();this.close(),window.addEventListener("focus",(()=>{e&&this.open(),t.remove()}),{once:!0})})),t.addEventListener("change",(async()=>{const i=t.files[0],s=await(async e=>{let t=null,i=null;if("undefined"!=typeof createImageBitmap)try{if(t=await createImageBitmap(e),t)return t}catch(e){}var s;return t||(i=await(s=e,new Promise(((e,t)=>{let i=URL.createObjectURL(s),r=new Image;r.src=i,r.onload=()=>{e(r)},r.onerror=e=>{t(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}})))),i})(i),r=s instanceof HTMLImageElement?s.naturalWidth:s.width,n=s instanceof HTMLImageElement?s.naturalHeight:s.height;let a=Z.convert(_(this,zi,"f"),r,n);a||(a={x:0,y:0,width:r,height:n});const o=_(this,Zi,"f").call(this,s,r,n,a);e&&e(o)})),document.body.appendChild(t),t.click()}convertToPageCoordinates(e){const t=_(this,ki,"m",rs).call(this,e);return{x:t.pageX,y:t.pageY}}convertToClientCoordinates(e){const t=_(this,ki,"m",rs).call(this,e);return{x:t.clientX,y:t.clientY}}dispose(){this.close(),_(this,Vi,"f").dispose(),this.releaseCameraView(),this.__proto__=null;for(let e in this)delete this[e];Object.defineProperty(this,"isCameraEnhancer",{value:!0}),Object.defineProperty(this,"disposed",{value:!0})}}Bi=cs,Vi=new WeakMap,Ni=new WeakMap,Ui=new WeakMap,Gi=new WeakMap,ji=new WeakMap,Hi=new WeakMap,Zi=new WeakMap,Yi=new WeakMap,zi=new WeakMap,Ji=new WeakMap,Xi=new WeakMap,qi=new WeakMap,Qi=new WeakMap,Ki=new WeakMap,$i=new WeakMap,es=new WeakMap,ki=new WeakSet,ts=function(){return!this.videoSrc&&"opened"===_(this,Vi,"f").state},is=function(){for(let e in _(this,Qi,"f"))if(1==_(this,Qi,"f")[e])return!0;return!1},ss=function e(){if(this.disposed)return;if("open"!==this.getCameraState()||!_(this,Xi,"f"))return _(this,qi,"f")&&clearTimeout(_(this,qi,"f")),void y(this,qi,setTimeout((()=>{this.disposed||_(this,ki,"m",e).call(this)}),this.fetchInterval),"f");const t=()=>{let e;cs._onLog&&cs._onLog("DCE: start fetching a frame into buffer: "+Date.now());try{e=this.fetchImage()}catch(e){if("The video is not loaded."===(e.message||e))return;throw e}e?(this.addImageToBuffer(e),cs._onLog&&cs._onLog("DCE: finish fetching a frame into buffer: "+Date.now()),_(this,Gi,"f").fire("frameAddedToBuffer",null,{async:!0})):cs._onLog&&cs._onLog("DCE: get a invalid frame, abandon it: "+Date.now())};if(this.getImageCount()>=this.getMaximumImageCount())switch(this.getBufferOverflowProtectionMode()){case g.BOPM_BLOCK:break;case g.BOPM_UPDATE:t()}else t();_(this,qi,"f")&&clearTimeout(_(this,qi,"f")),y(this,qi,setTimeout((()=>{this.disposed||_(this,ki,"m",e).call(this)}),this.fetchInterval),"f")},rs=function(e){if(!_(this,Ni,"f"))throw new Error("Camera view is not set.");if(!this.isOpen())throw new Error("Not open.");if(!this.singleFrameMode&&!_(this,Vi,"f").isVideoLoaded())throw new Error("Video is not loaded.");if(this.singleFrameMode&&!_(this,Ni,"f")._cvsSingleFrameMode)throw new Error("No image is selected.");const t=_(this,Ni,"f")._innerComponent.getBoundingClientRect(),i=t.left,s=t.top,r=i+window.scrollX,n=s+window.scrollY,{width:a,height:o}=_(this,Ni,"f")._innerComponent.getBoundingClientRect();if(a<=0||o<=0)throw new Error("Unable to get content dimensions. Camera view may not be rendered on the page.");let h,l,d;if(this.singleFrameMode){const e=_(this,Ni,"f")._innerComponent.getContent();h=e.width,l=e.height,d="contain"}else{const e=this.getVideoEl();h=e.videoWidth,l=e.videoHeight,d=_(this,Ni,"f").getVideoFit()}const c=a/o,f=h/l;let g,u,m,w,p=1;if("contain"===d)c<f?(p=a/h,g=i+e.x*p,u=s+e.y*p+(o-l*p)/2,m=r+e.x*p,w=n+e.y*p+(o-l*p)/2):(p=o/l,g=i+e.x*p+(a-h*p)/2,u=s+e.y*p,m=r+e.x*p+(a-h*p)/2,w=n+e.y*p);else if("cover"===d)if(c<f){p=o/l;let t=e.x*p-(h*p-a)/2;t=Math.max(t,0),t=Math.min(t,a),g=i+t,u=s+e.y*p,m=r+t,w=n+e.y*p}else{p=a/h;let t=e.y*p-(l*p-o)/2;t=Math.max(t,0),t=Math.min(t,o),g=i+e.x*p,u=s+t,m=r+e.x*p,w=n+t}return{clientX:g,clientY:u,pageX:m,pageY:w}},cs._debug=!0,Wi={value:void 0},cs.browserInfo=bi;const fs="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAABQAAAkAAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCgoKCgoKCgoKCgoKCgwMDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODg4ODg4ODg4ODg4P//////////////////////////AAAAAExhdmM1OC41NAAAAAAAAAAAAAAAACQEUQAAAAAAAAJAk0uXRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAANQAbGeUEQAAHZYZ3fASqD4P5TKBgocg+Bw/8+CAYBA4XB9/4EBAEP4nB9+UOf/6gfUCAIKyjgQ/Kf//wfswAAAwQA/+MYxAYOqrbdkZGQAMA7DJLCsQxNOij///////////+tv///3RWiZGBEhsf/FO/+LoCSFs1dFVS/g8f/4Mhv0nhqAieHleLy/+MYxAYOOrbMAY2gABf/////////////////usPJ66R0wI4boY9/8jQYg//g2SPx1M0N3Z0kVJLIs///Uw4aMyvHJJYmPBYG/+MYxAgPMALBucAQAoGgaBoFQVBUFQWDv6gZBUFQVBUGgaBr5YSgqCoKhIGg7+IQVBUFQVBoGga//SsFSoKnf/iVTEFNRTMu/+MYxAYAAANIAAAAADEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV";class gs{static get soundSource(){return _(this,ls,"f",ds)}static set soundSource(e){y(this,ls,e,"f",ds),this.beepSound=new w({src:[_(this,ls,"f",ds)],onplayerror:(e,t)=>{console.warn(`Sound '${e}' playback failure: ${t}`)}})}static vibrate(){if(!navigator||!navigator.vibrate)throw new Error("Not supported.");navigator.vibrate(gs.vibrateDuration)}static beep(){gs.beepSound&&(gs.beepSound.stop(),gs.beepSound.play())}}ls=gs,gs.vibrateDuration=300,gs.beepSound=new w({src:[fs],onplayerror:(e,t)=>{console.warn(`Sound '${e}' playback failure: ${t}`)}}),ds={value:fs};const us={RectDrawingItem:re,ImageDrawingItem:class extends O{constructor(e,t,i,s){if(super(null,s),te.set(this,void 0),ie.set(this,void 0),!j(t))throw new TypeError("Invalid 'rect'.");if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement)this._setFabricObject(new u.Image(e,{left:t.x,top:t.y}));else{if(!B(e))throw new TypeError("Invalid 'image'.");{const i=document.createElement("canvas");let s;i.width=e.width,i.height=e.height;if(e.format===o.IPF_GRAYSCALED){s=new Uint8ClampedArray(e.width*e.height*4);for(let t=0;t<s.length;t+=4)s[t]=e.bytes[t/4],s[t+1]=e.bytes[t/4],s[t+2]=e.bytes[t/4],s[t+3]=255}else s=new Uint8ClampedArray(e.bytes.buffer);i.getContext("2d").putImageData(new ImageData(s,e.width,e.height),0,0),this._setFabricObject(new u.Image(i,{left:t.x,top:t.y}))}}if(i){const e=t.width/this.get("width");this.set("scaleX",e),this.set("scaleY",e)}else this.set("scaleX",t.width/this.get("width")),this.set("scaleY",t.height/this.get("height"));this.image=e,y(this,te,JSON.parse(JSON.stringify(t)),"f"),y(this,ie,i,"f"),this._mediaType="image"}extendSet(e,t){if("image"===e){if(t instanceof HTMLImageElement)return this._fabricObject.setElement(t),this.image=t,!0;if(t instanceof HTMLCanvasElement){const e=new Image;return e.src=t.toDataURL(),this._fabricObject.setElement(e),this.image=t,!0}throw new Error("Unsupported value.")}}extendGet(e){if("image"===e)return this.image}updateCoordinateBaseFromImageToView(){if(this.set("left",this.convertPropFromViewToImage(this.get("left"))),this.set("top",this.convertPropFromViewToImage(this.get("top"))),_(this,ie,"f")){const e=this.convertPropFromViewToImage(this.get("width"))/this.get("width");this.set("scaleX",e),this.set("scaleY",e)}else this.set("scaleX",this.convertPropFromViewToImage(this.get("width"))/this.get("width")),this.set("scaleY",this.convertPropFromViewToImage(this.get("height"))/this.get("height"))}updateCoordinateBaseFromViewToImage(){if(this.set("left",this.convertPropFromImageToView(this.get("left"))),this.set("top",this.convertPropFromImageToView(this.get("top"))),_(this,ie,"f")){const e=this.convertPropFromImageToView(this.get("width"))/this.get("width");this.set("scaleX",e),this.set("scaleY",e)}else this.set("scaleX",this.convertPropFromImageToView(this.get("width"))/this.get("width")),this.set("scaleY",this.convertPropFromImageToView(this.get("height"))/this.get("height"))}setPosition(e){this.setImageRect(e)}getPosition(){return this.getImageRect()}updatePosition(){_(this,te,"f")&&this.setImageRect(_(this,te,"f"))}setImage(e){const t=this.getImageRect();if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement)this.set("image",e);else{if(!B(e))throw new TypeError("Invalid 'image'.");{const t=document.createElement("canvas");let i;t.width=e.width,t.height=e.height;if(e.format===o.IPF_GRAYSCALED){i=new Uint8ClampedArray(e.width*e.height*4);for(let t=0;t<i.length;t+=4)i[t]=e.bytes[t/4],i[t+1]=e.bytes[t/4],i[t+2]=e.bytes[t/4],i[t+3]=255}else i=new Uint8ClampedArray(e.bytes.buffer);t.getContext("2d").putImageData(new ImageData(i,e.width,e.height),0,0),this.set("image",t)}}if(_(this,ie,"f")){const e=t.width/this.get("width");this.set("scaleX",e),this.set("scaleY",e)}else this.set("scaleX",t.width/this.get("width")),this.set("scaleY",t.height/this.get("height"))}getImage(){return this.image}setImageRect(e){if(!j(e))throw new TypeError("Invalid 'rect'.");if(this._drawingLayer){if("view"===this.coordinateBase)if(this.set("left",this.convertPropFromViewToImage(e.x)),this.set("top",this.convertPropFromViewToImage(e.y)),_(this,ie,"f")){const t=this.convertPropFromViewToImage(e.width)/this.get("width");this.set("scaleX",t),this.set("scaleY",t)}else this.set("scaleX",this.convertPropFromViewToImage(e.width)/this.get("width")),this.set("scaleY",this.convertPropFromViewToImage(e.height)/this.get("height"));else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");if(this.set("left",e.x),this.set("top",e.y),_(this,ie,"f")){const t=e.width/this.get("width");this.set("scaleX",t),this.set("scaleY",t)}else this.set("scaleX",e.width/this.get("width")),this.set("scaleY",e.height/this.get("height"))}this._drawingLayer.renderAll()}else y(this,te,JSON.parse(JSON.stringify(e)),"f")}getImageRect(){if(this._drawingLayer){if("view"===this.coordinateBase)return{x:this.convertPropFromImageToView(this.get("left")),y:this.convertPropFromImageToView(this.get("top")),width:this.convertPropFromImageToView(this.get("scaledWidth")),height:this.convertPropFromImageToView(this.get("scaledHeight"))};if("image"===this.coordinateBase)return{x:this.get("left"),y:this.get("top"),width:this.get("scaledWidth"),height:this.get("scaledHeight")};throw new Error("Invalid 'coordinateBase'.")}return _(this,te,"f")?JSON.parse(JSON.stringify(_(this,te,"f"))):null}},TextDrawingItem:ce,LineDrawingItem:class extends le{constructor(e,t){if(super({points:[null==e?void 0:e.startPoint,null==e?void 0:e.endPoint]},t),fe.set(this,void 0),!V(e))throw new TypeError("Invalid 'line'.");y(this,fe,JSON.parse(JSON.stringify(e)),"f"),this._mediaType="line"}extendSet(e,t){if("startPoint"===e||"endPoint"===e){t="startPoint"===e?[t,this.get("endPoint")]:[this.get("startPoint"),t];const i=this._fabricObject;if(i.group){const e=i.group;i.points=t.map((t=>({x:t.x-e.left-e.width/2,y:t.y-e.top-e.height/2}))),e.addWithUpdate()}else i.points=t;const s=i.points.length-1;return i.controls=i.points.reduce((function(e,t,i){return e["p"+i]=new u.Control({positionHandler:ne,actionHandler:he(i>0?i-1:s,oe),actionName:"modifyPolygon",pointIndex:i}),e}),{}),i._setPositionDimensions({}),!0}}extendGet(e){if("startPoint"===e||"endPoint"===e){const t=[],i=this._fabricObject;if(i.selectable&&!i.group)for(let e in i.oCoords)t.push({x:i.oCoords[e].x,y:i.oCoords[e].y});else for(let e of i.points){let s=e.x-i.pathOffset.x,r=e.y-i.pathOffset.y;const n=u.util.transformPoint({x:s,y:r},i.calcTransformMatrix());t.push({x:n.x,y:n.y})}return"startPoint"===e?t[0]:t[1]}}updateCoordinateBaseFromImageToView(){const e=this.get("startPoint"),t=this.get("endPoint");this.set("startPoint",{x:this.convertPropFromViewToImage(e.x),y:this.convertPropFromViewToImage(e.y)}),this.set("endPoint",{x:this.convertPropFromViewToImage(t.x),y:this.convertPropFromViewToImage(t.y)})}updateCoordinateBaseFromViewToImage(){const e=this.get("startPoint"),t=this.get("endPoint");this.set("startPoint",{x:this.convertPropFromImageToView(e.x),y:this.convertPropFromImageToView(e.y)}),this.set("endPoint",{x:this.convertPropFromImageToView(t.x),y:this.convertPropFromImageToView(t.y)})}setPosition(e){this.setLine(e)}getPosition(){return this.getLine()}updatePosition(){_(this,fe,"f")&&this.setLine(_(this,fe,"f"))}setPolygon(){}getPolygon(){return null}setLine(e){if(!V(e))throw new TypeError("Invalid 'line'.");if(this._drawingLayer){if("view"===this.coordinateBase)this.set("startPoint",{x:this.convertPropFromViewToImage(e.startPoint.x),y:this.convertPropFromViewToImage(e.startPoint.y)}),this.set("endPoint",{x:this.convertPropFromViewToImage(e.endPoint.x),y:this.convertPropFromViewToImage(e.endPoint.y)});else{if("image"!==this.coordinateBase)throw new Error("Invalid 'coordinateBase'.");this.set("startPoint",e.startPoint),this.set("endPoint",e.endPoint)}this._drawingLayer.renderAll()}else y(this,fe,JSON.parse(JSON.stringify(e)),"f")}getLine(){if(this._drawingLayer){if("view"===this.coordinateBase)return{startPoint:{x:this.convertPropFromImageToView(this.get("startPoint").x),y:this.convertPropFromImageToView(this.get("startPoint").y)},endPoint:{x:this.convertPropFromImageToView(this.get("endPoint").x),y:this.convertPropFromImageToView(this.get("endPoint").y)}};if("image"===this.coordinateBase)return{startPoint:this.get("startPoint"),endPoint:this.get("endPoint")};throw new Error("Invalid 'coordinateBase'.")}return _(this,fe,"f")?JSON.parse(JSON.stringify(_(this,fe,"f"))):null}},QuadDrawingItem:Ke};export{cs as CameraEnhancer,p as CameraEnhancerModule,ot as CameraView,us as DrawingItem,et as DrawingStyleManager,E as EnumDrawingItemMediaType,b as EnumDrawingItemState,S as EnumEnhancedFeatures,gs as Feedback,ht as ImageEditorView};
